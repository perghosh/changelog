<?xml version="1.0" encoding="utf-8"?>
<!--
Jump to: 
"Activities: Connect to Version", "Activities for System", "Activity: Remarks", "Activities: for requests", "Activities: Add activity child", "Activities: thread", "Activities: edit thread", "Activities: edit durations"
"Activities: for Project 2",
"Article: Add book pages",
"Books", "Books for system", "Book pages",
"Changelog: List", "Chapters: Select pages",
"Customer", 
"Edit requests for system",
"Hashtags"
"Image"
"Presentation: User"
"Projects: for System", "Projects: Connect to Version", "Projects: Edit for customer"
"Requests", "Requests: All"
"Select hashtag", "Select text for chapter",
"System: tree", "Systems: all"
"Todolist: Connect activity"
 -->
<SELECTION  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../queries.xsd"
            TYPE="query" DESCRIPTION="Changelog queries">
   <QUERY ID="Activities: Todo" DESCRIPTION="List activities that you need to do" KEY="A8AC9AC6698F874F83ED1AC9B2828D34">
      <ATTRIBUTE NAME="OUTPUT-LIST">Activities,20</ATTRIBUTE>
      <FIELD ID="TActivity2ActivityK" ALIAS="ID" TABLE="TActivity2"/>
      <FIELD ID="TSystem1FName-Lookup" ALIAS="System" TABLE="TSystem1"/>
      <FIELD ID="TActivity2FBeginDFixed" ALIAS="Start" TABLE="TActivity2" DESCRIPTION="" />
      <FIELD ID="TActivity2FDescription" ALIAS="Desc." TABLE="TActivity2" DESCRIPTION="Activity description" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="markdown|padding: 0px; font-size: 90%; max-width: 95%; overflow-x: auto; white-space: normal;|[row]|padding-left: 100px;" 
                     OUTPUT-STYLE="column|max-width: 20px;" />
      </FIELD>
      <FIELD ID="TActivity2TypeC" ALIAS="Type" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity2StateC" ALIAS="State" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity2PriorityC" ALIAS="Priority" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity2UserK" ALIAS="User" TABLE="TActivity2"/>
      <FIELD ID="TActivity2FDone" ALIAS="Closed" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <ORDER FIELD="TActivity2FBeginDFixed" INDEX="2" DESC="1" SQL="TActivity2.FBeginD" />
      <ORDERS NAME="Priority">
         <ORDER FIELD="TActivity2PriorityC" DESC="1" SQL="(SELECT _c.FRank FROM $O{CODE}TCode _c WHERE _c.CodeK=$T.PriorityC)" />
      </ORDERS>
      <ORDERS NAME="Newest">
         <ORDER FIELD="TActivity2FBeginDFixed" INDEX="2" DESC="1" SQL="TActivity2.FBeginD" />
      </ORDERS>
      <CONDITION ID="TActivity2FDeleted" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" FLAGS="0"/>
      <CONDITIONS ID="Select filter!" SELECTED="1">
         <CONDITION ID="TActivity2FDeleted" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" FLAGS="0"/>
      </CONDITIONS>
      <CONDITIONS ID="Not completed activites">
         <CONDITION ID="TActivity2StateC" TABLE="TActivity2" OPERATORNAME="NOTEQUAL" VALUE="55" />
         <CONDITION ID="TActivity2FDeleted" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" FLAGS="0"/>
      </CONDITIONS>
   </QUERY>

   <QUERY ID="Activities: Connect to Version" KEY="CA5A5A05098B4040A109E080F3778F10" DESCRIPTION="Connect activities to selection version, only unreleased versions are shown">
      <ATTRIBUTE NAME="OUTPUT-LIST">Activities,20</ATTRIBUTE>
      <FIELD ID="TActivity5ActivityK" ALIAS="ID" TABLE="TActivity5"/>
      <FIELD ID="TActivity5SystemName" ALIAS="Name" TABLE="TActivity5" DESCRIPTION="System activity is connected to"/>
      <FIELD ID="TActivity5VersionName" ALIAS="Version" TABLE="TActivity5" FIELDFLAGNAMES="edit">
         <ATTRIBUTES SERVER-LIST="SELECT CAST(0 AS INT) AS SystemVersionK, '_ no version _' AS FName UNION ALL SELECT t.SystemVersionK, (SELECT TOP 1 s.FName FROM $OTSystem s WHERE s.SystemK=t.SystemK) + ', ' + CAST(t.FVersion1 AS NVARCHAR(5)) + ':' + CAST(t.FVersion2 AS NVARCHAR(5)) + ':' + CAST(t.FVersion3 AS NVARCHAR(5)) FROM $OTSystemVersion t WHERE t.FDeleted = 0 AND t.FReleased=0 AND t.FTrailing=0 ORDER BY 2 DESC" />
         <EDIT>
DECLARE @iVersion INT = {{=TActivity5VersionName}}
DELETE FROM $OTrSystemVersionXActivity WHERE ActivityK = ${@TActivity5ActivityK} -- delete if activity is already connected
IF @iVersion IS NOT NULL OR @iVersion &gt; 0
   INSERT INTO $OTrSystemVersionXActivity(SystemVersionK,ActivityK,TargetC,ImpactC) VALUES( @iVersion, ${@TActivity5ActivityK},0,0)
         </EDIT>
      </FIELD>
      <FIELD ID="TActivity5TypeC" ALIAS="Type" TABLE="TActivity5" />
      <FIELD ID="TActivity5StateC" ALIAS="State" TABLE="TActivity5" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TActivity5FDescription" ALIAS="Description" TABLE="TActivity5">
         <ATTRIBUTES OUTPUT-FORMAT="hashtag|TActivity5.Hashtag" />
      </FIELD>
      <FIELD ID="TActivity5CreateD" ALIAS="Created" TABLE="TActivity5" FORMAT="CAST( $T.$F AS DATE )" FIELDFLAGNAMES="sql_format" />
      <CONDITION ID="TActivity5FDone" TABLE="TActivity5" OPERATOR="0" SIMPLEVALUE="NO" VALUE="0" />
      <CONDITION ID="TActivity5FDeleted" TABLE="TActivity5" OPERATOR="0" SIMPLEVALUE="NO" VALUE="0" />
      <CONDITIONS ID="Select filter!" SELECTED="1">
         <CONDITION ID="TActivity5FDone" TABLE="TActivity5" OPERATOR="0" SIMPLEVALUE="NO" VALUE="0" />
         <CONDITION ID="TActivity5FDeleted" TABLE="TActivity5" OPERATOR="0" SIMPLEVALUE="NO" VALUE="0" />
      </CONDITIONS>
      <CONDITIONS ID='{ "name": "Active", "title": "Active activities", "style": "color: #5fdba7; font-weight: bold;" }'>
         <CONDITION ID="TActivity5StateC" TABLE="TActivity5" OPERATORNAME="EQUAL" VALUE="54" SIMPLEVALUE="Active" />
      </CONDITIONS>
      <CONDITIONS ID='{ "name": "Completed but not closed", "title": "Completed activities but not closed for retirement", "style": "color: #9d9d9d; font-weight: bold;" }'>
         <CONDITION ID="TActivity5StateC" TABLE="TActivity5" OPERATORNAME="EQUAL" VALUE="55" SIMPLEVALUE="Completed" />
         <CONDITION ID="TActivity5FDone" TABLE="TActivity5" OPERATOR="0" SIMPLEVALUE="NO" VALUE="0" />
      </CONDITIONS>
      <CONDITIONS ID="All" />
      <ORDER FIELD="TActivity5ActivityK" INDEX="0" DESC="1" SQL="TActivity5.UpdateD" />
      <ORDERS NAME="Last updated">
         <ORDER FIELD="TActivity5ActivityK" INDEX="0" DESC="1" SQL="TActivity5.UpdateD" />
      </ORDERS>
   </QUERY>
   
   <QUERY ID="Activity: Remarks" DESCRIPTION="Comments for activities" KEY="3A3CCA0F5329204FA828CFF0730FDF5E">
      <FIELD ID="TActivityRemark2ActivityRemarkK" ALIAS="ID (Remark)" TABLE="TActivityRemark2"/>
      <FIELD ID="TActivityRemark2TypeC" ALIAS="Type" TABLE="TActivityRemark2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivityRemark2FRemark" ALIAS="Remark" TABLE="TActivityRemark2" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="markdown|padding: 2px;max-width: 1000px;max-height: 500px; overflow-y: auto; overflow-x: hidden; white-space: normal;" />
      </FIELD>
      <ROWEDIT>
         <EDIT NAME="new_activityremark" SIMPLE="Remark" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
-- # Add record to TActivityRemark
DECLARE @iActivity BIGINT = {{==ActivityK}};
DECLARE @iUser INT = {=UserK};

IF @iUser IS NULL
   SET @iUser = {#V user "@@user"} -- default user is active user

INSERT INTO $OTActivityRemark (ActivityK,TypeC,FRemark,UserK,UpdateD) 
VALUES(@iActivity,{=TypeC"0"},{=FRemark},@iUser,GETDATE());
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTActivityRemark')" />
         </EDIT>
      </ROWEDIT>
   </QUERY>

   <QUERY ID="Activities: for requests" DESCRIPTION="Activities connected to requests" KEY="E5310AF760F09748BB7A760B4588399A" FLAGNAMES="NOTLISTED">
      <FIELD ID="TActivity1ActivityK" ALIAS="ID" TABLE="TActivity1"/>
      <FIELD ID="TActivity1FDescription" ALIAS="Description" TABLE="TActivity1" FIELDFLAGNAMES="edit" DESCRIPTION="activity with hashtag logic">
         <EDIT>{"update":"$OPROCEDURE_UpdateBadge {=TActivity1FDescription}, 'TActivity', ${@TActivity1ActivityK}","formula":"1"}</EDIT>
      </FIELD>
      <FIELD ID="TActivity1TypeC" ALIAS="Type" TABLE="TActivity1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity1StateC" ALIAS="State" TABLE="TActivity1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity1UserK" ALIAS="User" TABLE="TActivity1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity1FBeginD" ALIAS="Start" TABLE="TActivity1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity1ParentK-SystemK" ALIAS="System" TABLE="TActivity1" FIELDFLAGNAMES="edit" />
      <ORDER FIELD="TActivity1ActivityK" INDEX="0" DESC="1" SQL="TActivity1.UpdateD" />
      <ORDERS NAME="Last updated">
         <ORDER FIELD="TActivity1ActivityK" INDEX="0" DESC="1" SQL="TActivity1.UpdateD" />
      </ORDERS>
      <ROWEDIT>
         <EDIT NAME="new_activity" SIMPLE="Activities" TYPENAME="new_row">
            <PROPERTY NAME="columns">0,FBeginD,UserK</PROPERTY>
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
-- # Add record to TActivity
DECLARE @iSystemRequest INT = {{==SystemRequestK}};
DECLARE @iSystem INT = {=ParentK};
IF @iSystem IS NULL
   SET @iSystem = (SELECT SystemK FROM $OTSystemRequest WHERE SystemRequestK = @iSystemRequest); -- get system
DECLARE @sDescription NVARCHAR(1000) = {=FDescription};  
   
DECLARE @iUser INT = {=UserK};
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TSystem');
DECLARE @dateBegin DATETIME = {=FBeginD};
IF @dateBegin IS NULL
   SET @dateBegin = DATEADD(hour, DATEDIFF(hour,0,GETDATE()), 0)


IF @iUser IS NULL
   SET @iUser = {#V user "@@user"} -- default user is active user

INSERT INTO $OTActivity (FDescription,TypeC,StateC,ServiceC,AreaC,UserK,FBeginD,CreateD,UpdateD,ParentK,table_number) 
VALUES(@sDescription,{=TypeC"0"},{=StateC"0"},0,0,@iUser,@dateBegin,GETDATE(),GETDATE(),@iSystem,@iTable);

-- # Add relation between system request and activity
DECLARE @iActivity BIGINT = (SELECT IDENT_CURRENT('$OTActivity'));
INSERT INTO $OTrSystemRequestXActivity VALUES({{=SystemRequestK}},@iActivity);

EXEC $OPROCEDURE_UpdateBadge @sDescription, 'TActivity', @iActivity
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key">
               <EXPRESSION>
DECLARE @iActivity BIGINT = (SELECT IDENT_CURRENT('$OTActivity'))
SELECT ActivityK, 
       CONVERT(CHAR(16), FBeginD, 120), 
       (SELECT u.FDisplayName + ' (' + ISNULL(u.FFirstName,'') + ' ' + ISNULL(u.FLastName,'') + ')' FROM $OTUser u WHERE u.UserK=TActivity.UserK)
FROM $OTActivity WHERE ActivityK = @iActivity 
               </EXPRESSION>
            </SQL>
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   
<!--
 | Activity connected to article, may be used to work with specifications that is changing.
 | Activity is connected firstly to TSystem and TrArticleXActivity. 
 -->
   <QUERY ID="Activities for article" DESCRIPTION="Activities connected to article" KEY="55B09801F3984917B4F141F6322F944F">
      <FIELD ID="TActivity9ActivityK" ALIAS="ID" TABLE="TActivity9"/>
      <FIELD ID="TActivity9FDescription" ALIAS="Description" TABLE="TActivity9" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="markdown" />
      </FIELD>
      <FIELD ID="TActivity9TypeC" ALIAS="Type" TABLE="TActivity9" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity9StateC" ALIAS="State" TABLE="TActivity9" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity9UserK" ALIAS="User" TABLE="TActivity9" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity9FBeginD" ALIAS="Start" TABLE="TActivity9" FIELDFLAGNAMES="edit" />
      <ORDER FIELD="TActivity9ActivityK" INDEX="0" DESC="1" SQL="TActivity9.UpdateD" />
      <ORDERS NAME="Last updated">
         <ORDER FIELD="TActivity9ActivityK" INDEX="0" DESC="1" SQL="TActivity9.UpdateD" />
      </ORDERS>
      <ROWEDIT>
         <EDIT NAME="new_activity" SIMPLE="Activities" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
-- # Add record to TActivity
DECLARE @iArticle BIGINT = {{==ArticleK}};
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TSystem');
DECLARE @iSystem INT = (SELECT ParentK FROM $OTArticle WHERE ArticleK = @iArticle AND table_number = @iTable); -- get system
DECLARE @iUser INT = {=UserK};
DECLARE @dateBegin DATETIME = {=FBeginD};
IF @dateBegin IS NULL
   SET @dateBegin = DATEADD(hour, DATEDIFF(hour,0,GETDATE()), 0)

IF @iUser IS NULL
   SET @iUser = {#V user "@@user"} -- default user is active user

INSERT INTO $OTActivity (FDescription,TypeC,StateC,ServiceC,AreaC,UserK,FBeginD,CreateD,UpdateD,ParentK,table_number) 
VALUES({=FDescription},{=TypeC"0"},{=StateC"0"},0,0,@iUser,@dateBegin,GETDATE(),GETDATE(),@iSystem,@iTable);

-- # Add relation between activity and article
DECLARE @iActivity BIGINT = (SELECT IDENT_CURRENT('$OTActivity'));
INSERT INTO $OTrArticleXActivity VALUES(@iArticle,@iActivity);
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTActivity')" />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   <QUERY ID="Activities connected to requests" DESCRIPTION="Activities connected to requests" KEY="8C85672673CD4721AE38639DBE3B2290" FLAGNAMES="NOTLISTED">
      <ATTRIBUTE NAME="OUTPUT-LIST">Conditional,1000</ATTRIBUTE>
      <FIELD ID="TActivity1ActivityK" ALIAS="ID" TABLE="TActivity1"/>
      <FIELD ID="TActivity1FDescription" ALIAS="Description" TABLE="TActivity1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="`hashtag|TActivity1.Hashtag` `markdown|padding: 1px;max-width: 800px; white-space: normal;|[row]`" />
      </FIELD>
      <FIELD ID="TActivity1TypeC" ALIAS="Type" TABLE="TActivity1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity1StateC" ALIAS="State" TABLE="TActivity1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity1UserK" ALIAS="User" TABLE="TActivity1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity1FBeginD" ALIAS="Start" TABLE="TActivity1" FIELDFLAGNAMES="edit" />
      <ORDER FIELD="TActivity1ActivityK" INDEX="0" DESC="1" SQL="TActivity1.UpdateD" />
      <ORDERS NAME="Last updated">
         <ORDER FIELD="TActivity1ActivityK" INDEX="0" DESC="1" SQL="TActivity1.UpdateD" />
      </ORDERS>
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="1900f5cf-8f4a-4116-897a-6c80a75e1b0d"><![CDATA[ return function(g) local R, db=g.result, g.db
   R:SetValue('url','[' .. 
   '{"id": "edit","title":"Edit Activity", "icon": "fa-i-cursor", "table":"TActivity2", "link": ["BFA3B6951076492FB93D8AA6B76A9C29"]}' ..    
   ']') 
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
      <QUERYLINK TYPENAME="record" NAME="Activities"  DESCRIPTION="Edit activity" KEY="BFA3B6951076492FB93D8AA6B76A9C29" QUERY="E011E9977E314F43B719979473167221">
         <EXPRESSION>
SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK=(SELECT ParentK FROM $OTActivity a WHERE ActivityK={{==[0]}} AND a.table_number=1010)
UNION All
SELECT ActivityK value, 'ActivityK' AS name, ISNULL((SELECT _c.FName FROM $O{CODE}TCode _c WHERE _c.CodeK=TypeC),' - ') + ': ' + ISNULL(CASE WHEN LEN(FDescription) >= 30 THEN LEFT(FDescription, 28) + '...' ELSE FDescription END, ' - ') simple FROM $OTActivity WHERE ActivityK={{==[0]}}
         </EXPRESSION>
         <PROPERTIES OUTPUT-WIDTH="1900" OUTPUT-HEIGHT="500" OUTPUT-POSITION="center-bottom" />
      </QUERYLINK>
   </QUERY>
   
   
   <QUERY ID="Activities: for Project" DESCRIPTION="Activities connected to system" KEY="2E8B763EB13048F4A97AF48049F9E2D4" FLAGNAMES="NOTLISTED">
      <FIELD ID="TActivity4ActivityK" ALIAS="ID" TABLE="TActivity4"/>
      <FIELD ID="TActivity4FDescription" ALIAS="Description" TABLE="TActivity4" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity4TypeC" ALIAS="Type" TABLE="TActivity4" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity4StateC" ALIAS="State" TABLE="TActivity4" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity4UserK" ALIAS="User" TABLE="TActivity4" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSystem1FName" ALIAS="System" TABLE="TSystem1" />
      <FIELD ID="TActivity4FDone" ALIAS="Closed" TABLE="TActivity4" FIELDFLAGNAMES="edit" />
      <CONDITION ID="TActivity4FDeleted" TABLE="TActivity4" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" FLAGS="0"/>
      <CONDITIONS ID="All" SELECTED="1">
         <CONDITION ID="TActivity4FDeleted" TABLE="TActivity4" OPERATOR="5" SIMPLEVALUE="DELETED" VALUE="1" />
      </CONDITIONS>
      <CONDITIONS ID="Open activities">
         <CONDITION ID="TActivity2FDeleted" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="DELETED" VALUE="1" />
         <CONDITION ID="TActivity2FDone" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="CLOSED" VALUE="1" />
      </CONDITIONS>
      <ORDER FIELD="TActivity4ActivityK" INDEX="0" DESC="1" SQL="TActivity4.UpdateD" />
      <ORDERS NAME="Last updated">
         <ORDER FIELD="TActivity4ActivityK" INDEX="0" DESC="1" SQL="TActivity4.UpdateD" />
      </ORDERS>
      <ROWEDIT>
         <EDIT NAME="new_activity" SIMPLE="Activities" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
-- # Add record to TActivity
DECLARE @iParent BIGINT
DECLARE @iSystem BIGINT = {=SystemK};
DECLARE @iCustomer BIGINT = {=CustomerK};
DECLARE @iProject BIGINT = {=ProjectK};
DECLARE @iUser INT = {=UserK};
DECLARE @dateBegin DATETIME = {=FBeginD};
IF @dateBegin IS NULL
   SET @dateBegin = DATEADD(hour, DATEDIFF(hour,0,GETDATE()), 0)


IF @iUser IS NULL
   SET @iUser = {#V user "@@user"} -- default user is active user

SET @iParent = @iSystem
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TSystem');
IF @iCustomer IS NOT NULL
BEGIN
   SET @iTable = (SELECT number FROM $Otable_number WHERE "name" = 'TCustomer');
   SET @iParent = @iCustomer
END
INSERT INTO $OTActivity (FDescription,TypeC,StateC,ServiceC,AreaC,UserK,FBeginD,CreateD,UpdateD,ParentK,table_number) 
VALUES({=FDescription},{=TypeC"0"},{=StateC"0"},0,0,@iUser,@dateBegin,GETDATE(),GETDATE(),@iParent,@iTable);

IF @iProject IS NOT NULL
BEGIN
   DECLARE @iActivity BIGINT = (SELECT IDENT_CURRENT('$OTActivity'));
   INSERT INTO $OTrProjectXActivity(ProjectK, ActivityK) VALUES( @iProject, @iActivity )
END
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTActivity')" />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   
   <QUERY ID="Activities: for Project 2" DESCRIPTION="Activities connected to project" KEY="8E433F88556C4F3EA0C41370263DB9A2" FLAGNAMES="NOTLISTED">
      <ATTRIBUTE NAME="OUTPUT-TRUNCATE">[20,50,200]|20</ATTRIBUTE>
      <FIELD ID="TActivity4ActivityK" ALIAS="ID" TABLE="TActivity4"/>
      <FIELD ID="TActivity4TypeC" ALIAS="Type" TABLE="TActivity4" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity4StateC" ALIAS="State" TABLE="TActivity4" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity4Picture" ALIAS="Picture" TABLE="TActivity4" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-INPUT="file" />
         <EDIT>
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TActivity');
IF (SELECT COUNT(*) FROM $OTImage WHERE RecordK=${@TActivity4ActivityK} AND table_number=@iTable) = 0
   INSERT INTO $OTImage (RecordK, table_number) VALUES(${@TActivity4ActivityK},@iTable)

UPDATE $OTImage SET FName={=TActivity4Picture}, FExtension={=extension}, FData=0x{{=data}}, FSize={{=size}}, MimeName={=mime} WHERE RecordK=${@TActivity2ActivityK} AND table_number=@iTable
         </EDIT>
      </FIELD>
      <FIELD ID="TActivity4FDescription" ALIAS="Description" TABLE="TActivity4" FIELDFLAGNAMES="edit">
         <EDIT>{"update":"DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE \"name\" = 'TActivity');\nDECLARE @iActivity BIGINT = ${@TActivity4ActivityK}\nDECLARE @sDescription NVARCHAR(1000) = {=TActivity4FDescription}\n\nDELETE FROM $OTrXBadge WHERE ParentK = @iActivity AND table_number = @iTable\n\nIF LEN( @sDescription ) &gt; 2\nBEGIN\n-- Add missing hashtags to Badge table\n   INSERT INTO $OTBadge (FName)\n   SELECT tag FROM $OPullTagsFromText( @sDescription ) LEFT JOIN $OTBadge _b ON tag = _b.FName\n   WHERE _b.FName IS NULL   \n\n-- Connect hashtags to Activity record\n   INSERT INTO $OTrXBadge (ParentK,table_number,BadgeK)\n   SELECT @iActivity, @iTable, _b.BadgeK\n   FROM $OTBadge _b JOIN $OPullTagsFromText( @sDescription ) ON _b.FName = tag\nEND\n","formula":"1"}</EDIT>
      </FIELD>
      <FIELD ID="TActivity4Note" ALIAS="Documentation" TABLE="TActivity4" FIELDFLAGNAMES="edit">
         <EDIT>
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TActivity');
IF (SELECT COUNT(*) FROM $OTNote WHERE RecordK=${@TActivity4ActivityK} AND table_number=@iTable) = 0
   INSERT INTO $OTNote (RecordK, table_number) VALUES(${@TActivity4ActivityK},@iTable)

UPDATE $OTNote SET FNote={=TActivity4Note} WHERE RecordK=${@TActivity4ActivityK} AND table_number=@iTable
         </EDIT>
      </FIELD>
      <FIELD ID="TActivity4UserK" ALIAS="User" TABLE="TActivity4" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity4FBeginD" ALIAS="Start" TABLE="TActivity4" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-INPUT="date|YYYY-MM-DD HH:mm|24" />
      </FIELD>
      <FIELD ID="TActivity4FDone" ALIAS="Closed" TABLE="TActivity4" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity4ParentK" ALIAS="System" TABLE="TActivity4" FIELDFLAGNAMES="edit, sql_format" FORMAT="(SELECT _s.FName FROM $OTSystem _s WHERE _s.SystemK=$T.ParentK AND $T.table_number=1010)">
         <ATTRIBUTES SERVER-LIST="SELECT _s.SystemK AS SystemK, _s.FName AS FName FROM $OTSystem _s WHERE _s.SystemK IN (SELECT _t.FKey FROM $Othread _t WHERE _t.FThreadId = (SELECT TOP 1_t1.FThreadId FROM $Othread _t1 WHERE _t1.FKey = (SELECT _p.ParentK FROM $OTProject _p WHERE ProjectK={{=TProject1ProjectK}}) AND _t1.table_number=1010)) ORDER BY 2" />
      </FIELD>
      <FIELD ID="TActivity4FSort" ALIAS="Sort" TABLE="TActivity4" FIELDFLAGNAMES="edit" />
      <CONDITION ID="TActivity4FDeleted" TABLE="TActivity4" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" FLAGS="16" />
      <ORDER FIELD="TActivity4ActivityK" INDEX="0" DESC="1" SQL="TActivity4.CreateD" />
      <ORDERS NAME="Last created">
         <ORDER FIELD="TActivity4ActivityK" INDEX="0" DESC="1" SQL="TActivity4.CreateD" />
      </ORDERS>
      <ORDERS NAME="Last updated">
         <ORDER FIELD="TActivity4ActivityK" INDEX="0" DESC="1" SQL="TActivity4.UpdateD" />
      </ORDERS>
      <ROWEDIT>
         <EDIT NAME="new_activity" SIMPLE="Activities" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION CACHE="13483578-607c-4a60-9dab-45aa931afdcf"><![CDATA[
-- # Foreign keys
DECLARE @iParent INT = {=ParentK};
DECLARE @iSystem INT = {=SystemK};
DECLARE @sDescription NVARCHAR(1000) = {=FDescription};
DECLARE @iProject INT = {=ProjectK};
DECLARE @iUser INT = {=UserK};
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TSystem');
DECLARE @dateBegin DATETIME = {=FBeginD};
IF @dateBegin IS NULL
   SET @dateBegin = DATEADD(hour, DATEDIFF(hour,0,GETDATE()), 0)


IF @iParent IS NOT NULL AND @iParent <> 0
   SET @iSystem = @iParent

IF @iSystem IS NULL
   SET @iSystem = (SELECT ParentK FROM $OTProject WHERE ProjectK = @iProject AND table_number=1010)
   
   
IF @iUser IS NULL
   SET @iUser = {#V user "@@user"} -- default user is active user
                  
-- # Add record to TActivity, main connection is TSystem
INSERT INTO $OTActivity (FDescription,TypeC,StateC,ServiceC,AreaC,UserK,FBeginD,FSort,CreateD,UpdateD,ParentK,table_number) 
VALUES(@sDescription,{=TypeC"0"},{=StateC"0"},0,0,@iUser,@dateBegin,{=FSort"0"},GETDATE(),GETDATE(),@iSystem,@iTable);

DECLARE @iActivity BIGINT = (SELECT IDENT_CURRENT('$OTActivity'));

IF @iProject IS NOT NULL
BEGIN
   INSERT INTO $OTrProjectXActivity(ProjectK, ActivityK) VALUES( @iProject, @iActivity )
END   
   
DECLARE @iTableActivity INT = (SELECT number FROM $Otable_number WHERE "name" = 'TActivity');
INSERT INTO $OTNote(RecordK,table_number,FNote) VALUES(@iActivity,@iTableActivity,{=TActivity4Note})

EXEC $OPROCEDURE_UpdateBadge @sDescription, 'TActivity', @iActivity
               ]]></EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTActivity')" />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   <QUERY ID="Activities: for selected Project" DESCRIPTION="Activities connected to project" KEY="EA5ED8A1C4E443D893B666953D572CBF">
      <ATTRIBUTE NAME="OUTPUT-LIST">Conditional,1000</ATTRIBUTE>
      <FIELD ID="TActivity4ActivityK" ALIAS="ID" TABLE="TActivity4"/>
      <FIELD ID="TActivity4TypeC-Indent" ALIAS="Type" TABLE="TActivity4"/>
      <FIELD ID="TActivity4StateC" ALIAS="State" TABLE="TActivity4" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity4FDescription" ALIAS="Description" TABLE="TActivity4" FIELDFLAGNAMES="edit">
         <!-- <ATTRIBUTES OUTPUT-FORMAT="markdown|padding: 1px;max-width: 600px; white-space: normal;" /> -->
         <ATTRIBUTES OUTPUT-FORMAT="hashtag" />
      </FIELD>
      <FIELD ID="TActivity4Note" ALIAS="Docs" TABLE="TActivity4" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="markdown||[row]|padding: 3px; opacity: 0.3; overflow-x: auto; max-height: 80px; overflow-y: auto; white-space: normal;padding-left: 20px;"
                     OUTPUT-STYLE="column|max-width: 25px;" />
         <EDIT>
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TActivity');
IF (SELECT COUNT(*) FROM $OTNote WHERE RecordK=${@TActivity4ActivityK} AND table_number=@iTable) = 0
   INSERT INTO $OTNote (RecordK, table_number) VALUES(${@TActivity4ActivityK},@iTable)
   
UPDATE $OTNote SET FNote={=TActivity4Note} WHERE RecordK=${@TActivity4ActivityK} AND table_number=@iTable
         </EDIT>
      </FIELD>
      <FIELD ID="TActivity4UserK" ALIAS="User" TABLE="TActivity4" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity4Picture" ALIAS="Pic" DESCRIPTION="Picture" TABLE="TActivity4">
         <ATTRIBUTES OUTPUT-FORMAT="image| |[row]|padding: 3px; padding-left: 10px; margin: 3px; opacity: 0.7; overflow-y: scroll;"
                     OUTPUT-STYLE="column|width: 20px;" />
      </FIELD>
      <CONDITION ID="TActivity4FDeleted" TABLE="TActivity4" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" FLAGS="16" />
      <ORDER FIELD="TActivity4ActivityK" INDEX="0" SQL="(SELECT TOP 1 _th.FThreadId FROM $Othread_header _th JOIN $Othread _t ON _th.FThreadId = _t.FThreadId AND _t.table_number=1110 WHERE _t.FKey=$T.ActivityK AND _th.table_number=1110)" />
      <ORDER FIELD="TActivity4ActivityK" INDEX="0" SQL="(SELECT TOP 1 _t.FPath FROM $Othread _t WHERE _t.FKey=$T.ActivityK AND _t.table_number=1110)" />
      <ORDERS NAME="Thread view">
         <ORDER FIELD="TActivity4ActivityK" INDEX="0" SQL="(SELECT TOP 1 _th.FThreadId FROM $Othread_header _th JOIN $Othread _t ON _th.FThreadId = _t.FThreadId AND _t.table_number=1110 WHERE _t.FKey=$T.ActivityK AND _th.table_number=1110)" />
         <ORDER FIELD="TActivity4ActivityK" INDEX="0" SQL="(SELECT TOP 1 _t.FPath FROM $Othread _t WHERE _t.FKey=$T.ActivityK AND _t.table_number=1110)" />
      </ORDERS>
      <ORDERS NAME="Last created">
         <ORDER FIELD="TActivity4ActivityK" INDEX="0" DESC="1" SQL="TActivity4.CreateD" />
      </ORDERS>
      <ORDERS NAME="Last updated">
         <ORDER FIELD="TActivity4ActivityK" INDEX="0" DESC="1" SQL="TActivity4.UpdateD" />
      </ORDERS>
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="1bb10076-ef05-4cf6-9555-1a67d0ff2d05"><![CDATA[ return function(g) local R, db=g.result, g.db
   R:SetValue('url','[' .. 
   '{"id": "edit","title":"Edit Activity", "icon": "fa-i-cursor", "table":"TActivity4", "link": ["BFA3B6951076492FB93D8AA6B76A9C29"]},' ..    
   '{"id": "activity","title":"Beam Activity", "icon": "fa-broadcast-tower", "table":"TActivity4", "link": ["C6E29A22AE72434B91FE66293CBB972F"]},' .. 
   '{"id": "activity_child","title":"Add activity sub", "icon": "fa-edit", "table":"TActivity4", "link": ["BA91BD3069824DFA8042B8799E586379"]}' .. 
   ']') 
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>

   <QUERYLINK TYPENAME="record" NAME="Activities"  DESCRIPTION="Edit activities for system" KEY="BFA3B6951076492FB93D8AA6B76A9C29" QUERY="E011E9977E314F43B719979473167221">
         <EXPRESSION>
SELECT TOP 1 r.ProjectK value, 'ProjectK' AS name, 'Project: ' + p.FName AS simple, 'TActivity2' AS "table" FROM $OTProject p JOIN $OTrProjectXActivity r ON p.ProjectK = r.ProjectK WHERE r.ActivityK={{==TActivity4}}
UNION All
SELECT ActivityK value, 'ActivityK' AS name, ISNULL((SELECT _c.FName FROM $O{CODE}TCode _c WHERE _c.CodeK=TypeC),' - ') + ': ' + ISNULL(CASE WHEN LEN(FDescription) >= 30 THEN LEFT(FDescription, 28) + '...' ELSE FDescription END, ' - ') simple, 'TActivity2' AS "table" FROM $OTActivity WHERE ActivityK={{==[0]}}
         </EXPRESSION>
         <PROPERTIES OUTPUT-WIDTH="1900" OUTPUT-HEIGHT="500" OUTPUT-POSITION="center-bottom" />
      </QUERYLINK>

      <QUERYLINK TYPENAME="message" NAME="Activity" DESCRIPTION="Send acitivity key" KEY="C6E29A22AE72434B91FE66293CBB972F" EXPRESSION="SELECT _a.ActivityK value, 'ActivityK' AS name, ISNULL((SELECT _c.FName FROM $O{CODE}TCode _c WHERE _c.CodeK=_a.TypeC),' - ') + ': ' + ISNULL(CASE WHEN LEN(FDescription) >= 30 THEN LEFT(FDescription, 28) + '...' ELSE FDescription END, ' - ') simple  FROM $OTActivity _a WHERE ActivityK={{==TActivity4}}">
         <PROPERTIES OUTPUT-COMMAND="send key" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Sub system"  DESCRIPTION="Sub activities to selected" KEY="BA91BD3069824DFA8042B8799E586379" QUERY="4BD466822F9549D1998B16C75DC0E92E">
         <EXPRESSION><![CDATA[
SELECT TOP 1 r.ProjectK value, 'ProjectK' AS name, 'Project: ' + p.FName AS simple, 'TActivity2' AS "table" FROM $OTProject p JOIN $OTrProjectXActivity r ON p.ProjectK = r.ProjectK WHERE r.ActivityK={{==TActivity4}}
UNION All
SELECT ActivityK value, 'SuperK' AS name, ISNULL((SELECT _c.FName FROM $O{CODE}TCode _c WHERE _c.CodeK=TypeC),' - ') + ': ' + ISNULL(CASE WHEN LEN(FDescription) >= 30 THEN LEFT(FDescription, 28) + '...' ELSE FDescription END, ' - ') simple, 'TActivity2' AS "table" FROM $OTActivity WHERE ActivityK={{==TActivity4}}
         ]]></EXPRESSION>
         <PROPERTIES OUTPUT-WIDTH="1250" OUTPUT-HEIGHT="300" OUTPUT-POSITION="left-bottom" />
      </QUERYLINK>
   </QUERY>
   
   <QUERY ID="Activities for Customer" DESCRIPTION="Activities connected to customer" KEY="FE2F3F06F59840809CFD19C5B1F24DF3" FLAGNAMES="NOTLISTED">
      <ATTRIBUTE NAME="OUTPUT-LIST">Conditional,1000</ATTRIBUTE>
      <ATTRIBUTE NAME="OUTPUT-TRUNCATE">[20,50,200]|50</ATTRIBUTE>
      <FIELD ID="TActivity6ActivityK" ALIAS="ID" TABLE="TActivity6"/>
      <FIELD ID="TActivity6TypeC" ALIAS="Type" TABLE="TActivity6" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity6StateC" ALIAS="State" TABLE="TActivity6" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity6PriorityC" ALIAS="Priority" TABLE="TActivity6" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity6ContextC" ALIAS="Context" TABLE="TActivity6" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity6FDescription" ALIAS="Description" TABLE="TActivity6" FIELDFLAGNAMES="edit">
         <EDIT>{"update":"$OPROCEDURE_UpdateBadge {=TActivity6FDescription}, 'TActivity', ${@TActivity6ActivityK}","formula":"1"}</EDIT>
         <ATTRIBUTES OUTPUT-FORMAT="markdown|padding: 1px;max-width: 600px; white-space: normal;" />
      </FIELD>
      <FIELD ID="TActivity6ActivityK-Id" ALIAS="Assig." TABLE="TActivity6" FORMAT="(SELECT TOP 1 _ar.FRemark FROM $OTActivityRemark _ar WHERE _ar.ActivityK=$T.ActivityK AND _ar.TypeC=125)" FIELDFLAGNAMES="sql_format">
         <ATTRIBUTES OUTPUT-FORMAT="markdown|padding: 3px; font-size: 90%; max-width: 1000px; overflow-x: auto; white-space: normal;|[row]|padding-left: 50px;"
                     OUTPUT-STYLE="column|max-width: 25px;" />
      </FIELD>
      <FIELD ID="TActivity6Note" ALIAS="Docs" TABLE="TActivity6" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="markdown|padding: 3px; font-size: 90%; max-width: 95%; overflow-x: auto; white-space: normal;|[row]|padding-left: 50px;"
                     OUTPUT-STYLE="column|max-width: 25px;" />
         <EDIT>
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TActivity');
IF (SELECT COUNT(*) FROM $OTNote WHERE RecordK=${@TActivity6ActivityK} AND table_number=@iTable) = 0
   INSERT INTO $OTNote (RecordK, table_number) VALUES(${@TActivity6ActivityK},@iTable)
   
UPDATE $OTNote SET FNote={=TActivity6Note} WHERE RecordK=${@TActivity6ActivityK} AND table_number=@iTable
         </EDIT>
      </FIELD>
      <FIELD ID="TActivity6FDone" ALIAS="Closed" TABLE="TActivity6" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity6CountRemark" ALIAS="N" TABLE="TActivity6" DESCRIPTION="Number of notes for Activity"/>
      <FIELD ID="TActivity6FBeginD" ALIAS="Start" TABLE="TActivity6" DESCRIPTION="" />
      <FIELD ID="TActivity6Picture" ALIAS="Pic" DESCRIPTION="Picture" TABLE="TActivity6">
         <ATTRIBUTES OUTPUT-FORMAT="image| |[row]|padding-left: 50px; background-color: #EEE; margin: 3px; max-height: 300px; overflow-y: scroll;"
                     OUTPUT-STYLE="column|width: 20px;" />
      </FIELD>
      <CONDITION ID="TActivity6FDeleted" TABLE="TActivity6" OPERATOR="5" SIMPLEVALUE="DELETED" VALUE="1" />
      <CONDITIONS ID="Select filter!" SELECTED="1">
         <CONDITION ID="TActivity6FDeleted" TABLE="TActivity6" OPERATOR="5" SIMPLEVALUE="DELETED" VALUE="1" />
      </CONDITIONS>
      <CONDITIONS ID="Open activities" SELECTED="1">
         <CONDITION ID="TActivity6FDeleted" TABLE="TActivity6" OPERATOR="5" SIMPLEVALUE="DELETED" VALUE="1" />
         <CONDITION ID="TActivity6FDone" TABLE="TActivity6" OPERATOR="5" SIMPLEVALUE="CLOSED" VALUE="1" />
      </CONDITIONS>
      <CONDITIONS ID="High priority activities">
         <CONDITION ID="TActivity6FDeleted" TABLE="TActivity6" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" />
         <CONDITION ID="TActivity6PriorityC" TABLE="TActivity6" OPERATORNAME="GREATER" SIMPLEVALUE="Important" VALUE="4">
            <EXPRESSION>(SELECT _c.FRank FROM $O{CODE}TCode _c WHERE _c.CodeK=$T.PriorityC)</EXPRESSION>
         </CONDITION>
      </CONDITIONS>
      <CONDITIONS ID="Do now">
         <CONDITION ID="TActivity6FDeleted" TABLE="TActivity6" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" />
         <CONDITION ID="TActivity6FDone" TABLE="TActivity6" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" />
         <CONDITION ID="TActivity6PriorityC" TABLE="TActivity6" OPERATORNAME="GREATER" SIMPLEVALUE="Do now" VALUE="6">
            <EXPRESSION>(SELECT _c.FRank FROM $O{CODE}TCode _c WHERE _c.CodeK=$T.PriorityC)</EXPRESSION>
         </CONDITION>
      </CONDITIONS>
      <ORDER FIELD="TActivity6FBeginD" DESC="1" />
      <ORDERS NAME="Latest">
         <ORDER FIELD="TActivity6FBeginD" DESC="1" />
         <ORDER FIELD="TActivity6FDone" DESC="1" />
      </ORDERS>
      <ORDERS NAME="Latest updated">
         <ORDER FIELD="TActivity6ActivityK" INDEX="0" DESC="1" SQL="TActivity6.UpdateD" />
         <ORDER FIELD="TActivity6ActivityK" INDEX="0" DESC="1" SQL="TActivity6.FDone" />
      </ORDERS>
      <SELECTCONDITIONS>
         <SELECTCONDITION ID="TActivityRemark2FRemark" TABLE="TActivityRemark2" />
      </SELECTCONDITIONS>      
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="68cb287c-125a-4adc-b649-68813e644e00"><![CDATA[ return function(g) local R, db=g.result, g.db
   R:SetValue('url','[' .. 
   '{"id": "remark","title":"View comments", "icon": "fa-align-justify", "table":"TActivity6", "link": ["3A3CCA0F5329204FA828CFF0730FDF5Eresult"]},' .. 
   '{"id": "remark","title":"Comments", "icon": "fa-edit", "table":"TActivity6", "link": ["3A3CCA0F5329204FA828CFF0730FDF5E"]},' .. 
   '{"id": "activity_child","title":"Add activity sub", "icon": "fa-edit", "table":"TActivity6", "link": ["4BD466822F9549D1998B16C75DC0E92E"]},' .. 
   '{"id": "activity","title":"Beam Activity", "icon": "fa-broadcast-tower", "table":"TActivity6", "link": ["C6E29A22AE72434B91FE66293CBB972F"]}' .. 
   ']') 
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
      <QUERYLINK TYPENAME="children" NAME="Remarks"  DESCRIPTION="Remarks" KEY="3A3CCA0F5329204FA828CFF0730FDF5E" EXPRESSION="SELECT _a.ActivityK value, 'ActivityK' AS name, ISNULL((SELECT _c.FName FROM $O{CODE}TCode _c WHERE _c.CodeK=_a.TypeC),' - ') + ': ' + ISNULL(CASE WHEN LEN(FDescription) >= 30 THEN LEFT(FDescription, 28) + '...' ELSE FDescription END, ' - ') simple  FROM $OTActivity _a WHERE ActivityK={{==TActivity6}}" />
      <QUERYLINK TYPENAME="children" NAME="Sub system"  DESCRIPTION="Sub activities to selected" KEY="4BD466822F9549D1998B16C75DC0E92E" EXPRESSION="SELECT ActivityK value, 'SuperK' AS name, LEFT( FDescription, 100 ) simple FROM $OTActivity WHERE ActivityK={{==TActivity6}}">
         <PROPERTIES OUTPUT-WIDTH="1250" OUTPUT-HEIGHT="300" OUTPUT-POSITION="left-bottom" />         
      </QUERYLINK>
      <QUERYLINK TYPENAME="message" NAME="Activity" DESCRIPTION="Send acitivity key" KEY="C6E29A22AE72434B91FE66293CBB972F" EXPRESSION="SELECT _a.ActivityK value, 'ActivityK' AS name, ISNULL((SELECT _c.FName FROM $O{CODE}TCode _c WHERE _c.CodeK=_a.TypeC),' - ') + ': ' + ISNULL(CASE WHEN LEN(FDescription) >= 30 THEN LEFT(FDescription, 28) + '...' ELSE FDescription END, ' - ') simple  FROM $OTActivity _a WHERE ActivityK={{==TActivity6}}">
         <PROPERTIES OUTPUT-COMMAND="send key" />
      </QUERYLINK>
   </QUERY>
   
   <QUERY ID="Activities: thread" DESCRIPTION="Activity thread, report friendly" KEY="4774E0E630204B6988EDF517243FAACE">
      <FIELD ID="TActivity2ActivityK" ALIAS="ID (Activity)" TABLE="TActivity2"/>
      <FIELD ID="TActivity2TypeC-Indent" ALIAS="Type" TABLE="TActivity2"/>
      <FIELD ID="TActivity2FDescription" ALIAS="Description" TABLE="TActivity2" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="`hashtag|TActivity2.Hashtag` `markdown|padding: 1px;max-width: 600px; white-space: normal;`" />
      </FIELD>
      <FIELD ID="TActivity2Note" ALIAS="Docs" TABLE="TActivity2" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="`hashtag|TActivity2.Hashtag`  `markdown||[row]|padding: 3px; opacity: 0.7; overflow-x: auto; overflow-y: scroll; white-space: normal;padding-left: 50px;`"
                     OUTPUT-STYLE="column|max-width: 25px;" />
      </FIELD>
      <FIELD ID="TActivity2FBeginD" ALIAS="Start" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity2Picture" ALIAS="Pic" DESCRIPTION="Picture" TABLE="TActivity2">
         <ATTRIBUTES OUTPUT-FORMAT="image| |[row]|padding: 3px; padding-left: 10px; margin: 3px; opacity: 0.7; overflow-y: scroll;"
                     OUTPUT-STYLE="column|width: 20px;" />
      </FIELD>
      <ORDER FIELD="TActivity2ActivityK" INDEX="0" SQL="(SELECT TOP 1 _th.FThreadId FROM $Othread_header _th JOIN $Othread _t ON _th.FThreadId = _t.FThreadId AND _t.table_number=1110 WHERE _t.FKey=TActivity2.ActivityK AND _th.table_number=1110)" />
      <ORDER FIELD="TActivity2ActivityK" INDEX="0" SQL="(SELECT TOP 1 _t.FPath FROM $Othread _t WHERE _t.FKey=TActivity2.ActivityK AND _t.table_number=1110)" />
      <ORDERS NAME="Thread view">
         <ORDER FIELD="TActivity2ActivityK" INDEX="0" SQL="(SELECT TOP 1 _th.FThreadId FROM $Othread_header _th JOIN $Othread _t ON _th.FThreadId = _t.FThreadId AND _t.table_number=1110 WHERE _t.FKey=TActivity2.ActivityK AND _th.table_number=1110)" />
         <ORDER FIELD="TActivity2ActivityK" INDEX="0" SQL="(SELECT TOP 1 _t.FPath FROM $Othread _t WHERE _t.FKey=TActivity2.ActivityK AND _t.table_number=1110)" />
      </ORDERS>
      <SELECTCONDITIONS>
         <SELECTCONDITION ID="TActivity2LevelC" TABLE="TActivity2" />
      </SELECTCONDITIONS>
   
   
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="3cb4a7c4-edc2-4e14-b3f4-701975d30613"><![CDATA[ return function(g) local R, db=g.result, g.db
   R:SetValue('url','[' .. 
   '{"id": "edit","title":"Edit Activity", "icon": "fa-i-cursor", "table":"TActivity2", "link": ["57B63173D9B440339A02E4C9F94C1A94"]},' ..    
   '{"id": "activity_child","title":"Add activity sub", "icon": "fa-edit", "table":"TActivity2", "link": ["35D39B3D77924755A2EEFCD4E903727B"]}' .. 
   ']') 
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
      
      <QUERYLINK TYPENAME="record" NAME="Activities"  DESCRIPTION="Edit activities for system" KEY="57B63173D9B440339A02E4C9F94C1A94" QUERY="E011E9977E314F43B719979473167221">
         <EXPRESSION>
DECLARE @iThread BIGINT = (SELECT FThreadId FROM $Othread WHERE table_number=1110 AND FKey={{==TActivity2}})

SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK=(SELECT ParentK FROM $OTActivity a WHERE ActivityK={{==TActivity2}} AND a.table_number=1010)
UNION All
SELECT ActivityK value, 'ThreadKey' AS name, 'Thread: ' + ISNULL(CASE WHEN LEN(FDescription) >= 30 THEN LEFT(FDescription, 28) + '...' ELSE FDescription END, ' - ') simple FROM $OTActivity WHERE table_number=1010 AND ActivityK=@iThread
UNION All
SELECT ActivityK value, 'ActivityK' AS name, ISNULL((SELECT _c.FName FROM $O{CODE}TCode _c WHERE _c.CodeK=TypeC),' - ') + ': ' + ISNULL(CASE WHEN LEN(FDescription) >= 30 THEN LEFT(FDescription, 28) + '...' ELSE FDescription END, ' - ') simple FROM $OTActivity WHERE ActivityK={{==TActivity2}}
         </EXPRESSION>
         <PROPERTIES OUTPUT-WIDTH="1900" OUTPUT-HEIGHT="500" OUTPUT-POSITION="center-bottom" />
      </QUERYLINK>
   
      <QUERYLINK TYPENAME="children" NAME="Sub system"  DESCRIPTION="Sub activities to selected" KEY="35D39B3D77924755A2EEFCD4E903727B" QUERY="4BD466822F9549D1998B16C75DC0E92E" EXPRESSION="SELECT ActivityK value, 'SuperK' AS name, LEFT( FDescription, 100 ) simple FROM $OTActivity WHERE ActivityK={{==TActivity2}}">
         <PROPERTIES OUTPUT-WIDTH="1600" OUTPUT-HEIGHT="300" OUTPUT-POSITION="left-bottom" />         
      </QUERYLINK>
      
   </QUERY>

   <QUERY ID="Activities: edit thread" DESCRIPTION="Activity thread, edit for reporting" KEY="D8B5FB8297B640B9A80E5BA0581717EF">
      <FIELD ID="TActivity2ActivityK" ALIAS="ID (Activity)" TABLE="TActivity2"/>
      <FIELD ID="TActivity2TypeC" ALIAS="Type" TABLE="TActivity2" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TActivity2StateC" ALIAS="State" TABLE="TActivity2" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TActivity2ReportC" ALIAS="Report" TABLE="TActivity2" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TActivity2FDescription" ALIAS="Description" TABLE="TActivity2" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="markdown|padding: 1px;max-width: 600px; white-space: normal;" />
      </FIELD>
      <FIELD ID="TActivity2FBeginD" ALIAS="Start" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <ORDER FIELD="TActivity2ActivityK" INDEX="0" SQL="(SELECT TOP 1 _th.FThreadId FROM $Othread_header _th JOIN $Othread _t ON _th.FThreadId = _t.FThreadId AND _t.table_number=1110 WHERE _t.FKey=TActivity2.ActivityK AND _th.table_number=1110)" />
      <ORDER FIELD="TActivity2ActivityK" INDEX="0" SQL="(SELECT TOP 1 _t.FPath FROM $Othread _t WHERE _t.FKey=TActivity2.ActivityK AND _t.table_number=1110)" />
      <ORDERS NAME="Thread view">
         <ORDER FIELD="TActivity2ActivityK" INDEX="0" SQL="(SELECT TOP 1 _th.FThreadId FROM $Othread_header _th JOIN $Othread _t ON _th.FThreadId = _t.FThreadId AND _t.table_number=1110 WHERE _t.FKey=TActivity2.ActivityK AND _th.table_number=1110)" />
         <ORDER FIELD="TActivity2ActivityK" INDEX="0" SQL="(SELECT TOP 1 _t.FPath FROM $Othread _t WHERE _t.FKey=TActivity2.ActivityK AND _t.table_number=1110)" />
      </ORDERS>
      <SELECTCONDITIONS>
         <SELECTCONDITION ID="TActivity2LevelC" TABLE="TActivity2" />
      </SELECTCONDITIONS>
      <ROWEDIT>
         <EDIT NAME="delete activity" SIMPLE="Delete activity" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $OTActivity WHERE ActivityK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   <QUERY ID="Activities: edit durations" DESCRIPTION="Activity thread, edit durations for activities" KEY="8CD248311699439198D941CCFB9EFCB1">
      <FIELD ID="TActivity2ActivityK" ALIAS="ID (Activity)" TABLE="TActivity2"/>
      <FIELD ID="TActivity2TypeC" ALIAS="Type" TABLE="TActivity2" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TActivity2FDescription" ALIAS="Description" TABLE="TActivity2">
         <ATTRIBUTES OUTPUT-FORMAT="markdown|padding: 1px;max-width: 600px; white-space: normal;" />
      </FIELD>
      <FIELD ID="TActivity2FBeginD" ALIAS="Start" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity2FTimeEstimated" ALIAS="Estimate" TABLE="TActivity2" FIELDFLAGNAMES="edit" DESCRIPTION="Estimate length in hours" />
      <FIELD ID="TActivity2FTimeActual" ALIAS="Actial" TABLE="TActivity2" FIELDFLAGNAMES="edit" DESCRIPTION="How long in hours it took to complete" />
      <FIELD ID="TActivity2FTimeSpent" ALIAS="Spent" TABLE="TActivity2" FIELDFLAGNAMES="edit" DESCRIPTION="Total length in hours including all to do activity" />
      <FIELD ID="TActivity2StateC" ALIAS="State" TABLE="TActivity2" FIELDFLAGNAMES="edit"/>
      <CONDITION ID="TActivity2FDeleted" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" FLAGS="0"/>
      <CONDITIONS ID="All" SELECTED="1">
         <CONDITION ID="TActivity2FDeleted" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="DELETED" VALUE="1" />
      </CONDITIONS>
      <CONDITIONS ID="Not completed">
         <CONDITION ID="TActivity2FDeleted" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="DELETED" VALUE="1" />
         <CONDITION ID="TActivity2StateC" TABLE="TActivity2" OPERATOR="0" SIMPLEVALUE="Not completed tasks" VALUE="1" EXPRESSION="CASE WHEN $T.$F IS NULL OR $T.$F = 0 THEN 1 ELSE (SELECT COUNT(*) FROM code.TCode _c WHERE _c.CodeK=$T.$F AND _c.type=5) END" />
      </CONDITIONS>
      
      <ORDER FIELD="TActivity2ActivityK" INDEX="0" SQL="(SELECT TOP 1 _th.FThreadId FROM $Othread_header _th JOIN $Othread _t ON _th.FThreadId = _t.FThreadId AND _t.table_number=1110 WHERE _t.FKey=TActivity2.ActivityK AND _th.table_number=1110)" />
      <ORDER FIELD="TActivity2ActivityK" INDEX="0" SQL="(SELECT TOP 1 _t.FPath FROM $Othread _t WHERE _t.FKey=TActivity2.ActivityK AND _t.table_number=1110)" />
      <ORDERS NAME="Thread view">
         <ORDER FIELD="TActivity2ActivityK" INDEX="0" SQL="(SELECT TOP 1 _th.FThreadId FROM $Othread_header _th JOIN $Othread _t ON _th.FThreadId = _t.FThreadId AND _t.table_number=1110 WHERE _t.FKey=TActivity2.ActivityK AND _th.table_number=1110)" />
         <ORDER FIELD="TActivity2ActivityK" INDEX="0" SQL="(SELECT TOP 1 _t.FPath FROM $Othread _t WHERE _t.FKey=TActivity2.ActivityK AND _t.table_number=1110)" />
      </ORDERS>
      <SELECTCONDITIONS>
         <SELECTCONDITION ID="TActivity2LevelC" TABLE="TActivity2" />
      </SELECTCONDITIONS>
      <AGGREGATES>
         <AGGREGATE NAME="sum_amount" SIMPLE="Totalt" TYPENAME="sum">
            <SQL TYPENAME="select" COMMAND="sum-service">
               <EXPRESSION>
SELECT SUM( q.FTimeEstimated ) estimate, SUM( q.FTimeActual ) actual, SUM( q.FTimeSpent ) spent
,CONCAT( 'not closed: ', SUM(todo_count), ', total: ', SUM(total_count)) todo_count
FROM (
SELECT TActivity2.FTimeEstimated, TActivity2.FTimeActual, TActivity2.FTimeSpent
,CASE WHEN TActivity2.StateC IS NULL OR TActivity2.StateC = 0 THEN  1  ELSE (SELECT COUNT(*) FROM code.TCode _c WHERE _c.CodeK=TActivity2.StateC AND _c.type=5) END AS todo_count -- 5 = task
,CASE WHEN TActivity2.StateC IS NULL OR TActivity2.StateC = 0 OR (SELECT COUNT(*) FROM code.TCode _c WHERE _c.CodeK=TActivity2.StateC AND _c.type IN(5, 6)) &gt; 0 THEN 1 ELSE 0 END AS total_count -- 5 = task, 6 = ended
{#V from} {#V where} 
) AS q
               </EXPRESSION>
               <COLUMN INDEX="0" TYPE="R8" NAME="hours" REQUIRE-TABLE="TActivity2" OUTPUT-COLUMN="4" OUTPUT-CLASS="text-focus" OUTPUT-STYLE="font-weight: 900; text-align: right; border-bottom: 2px solid;"></COLUMN>
               <COLUMN INDEX="1" TYPE="R8" NAME="hours" REQUIRE-TABLE="TActivity2" OUTPUT-COLUMN="5" OUTPUT-CLASS="text-focus" OUTPUT-STYLE="font-weight: 900; text-align: right; border-bottom: 2px solid;"></COLUMN>
               <COLUMN INDEX="2" TYPE="R8" NAME="hours" REQUIRE-TABLE="TActivity2" OUTPUT-COLUMN="6" OUTPUT-CLASS="text-focus" OUTPUT-STYLE="font-weight: 900; text-align: right; border-bottom: 2px solid;"></COLUMN>
               <COLUMN INDEX="3" TYPE="R8" NAME="hours" REQUIRE-TABLE="TActivity2" OUTPUT-COLUMN="7" OUTPUT-CLASS="text-focus" OUTPUT-STYLE="font-weight: 900; text-align: right; border-bottom: 2px solid;"></COLUMN>
            </SQL>
         </AGGREGATE>
      </AGGREGATES>
   </QUERY>
   
   <QUERY ID="Activities for System" DESCRIPTION="Activities connected to system" KEY="25CD6ED397DB44859FB0E18E78BB0FF4">
      <ATTRIBUTE NAME="OUTPUT-LIST">Activities</ATTRIBUTE>
      <ATTRIBUTE NAME="OUTPUT-TRUNCATE">[20,50,200]|50</ATTRIBUTE>
      <FIELD ID="TActivity2ActivityK" ALIAS="ID" TABLE="TActivity2"/>
      <FIELD ID="TActivity2TypeC-Indent" ALIAS="Type" TABLE="TActivity2" />
      <FIELD ID="TActivity2FDescription" ALIAS="Description" TABLE="TActivity2" FIELDFLAGNAMES="edit">
         <!--<ATTRIBUTES OUTPUT-FORMAT="markdown|padding: 1px;max-width: 600px; white-space: normal;" />-->
         <ATTRIBUTES OUTPUT-FORMAT="hashtag|TActivity2.Hashtag" />
         
         <!-- <ATTRIBUTES OUTPUT-FORMAT="`hashtag|TArticle2.Hashtag` `markdown|padding: 5px;max-width: 1000px;max-height: 500px; overflow-y: auto; overflow-x: hidden; white-space: normal;`" /> -->
      </FIELD>
      <FIELD ID="TActivity2StateC" ALIAS="State" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity2PriorityC" ALIAS="Priority" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity2ContextC" ALIAS="Context" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity2ActivityK-Id" ALIAS="Assig." TABLE="TActivity2" FORMAT="(SELECT TOP 1 _ar.FRemark FROM $OTActivityRemark _ar WHERE _ar.ActivityK=$T.ActivityK AND _ar.TypeC=125)" FIELDFLAGNAMES="sql_format">
         <ATTRIBUTES OUTPUT-FORMAT="markdown|padding: 3px; max-width: 1000px; overflow-x: auto; white-space: normal;|[row]|padding-left: 50px;"
                     OUTPUT-STYLE="column|max-width: 25px;" />
      </FIELD>
      <FIELD ID="TActivity2Note" ALIAS="Docs" TABLE="TActivity2" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="`hashtag|TActivity2.Hashtag` `markdown||[row]|padding: 3px; max-height: 100px; opacity: 0.3; overflow-x: auto; overflow-y: scroll; white-space: normal;padding-left: 50px;`"
                     OUTPUT-STYLE="column|max-width: 25px;" />
         <EDIT>
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TActivity');
IF (SELECT COUNT(*) FROM $OTNote WHERE RecordK=${@TActivity2ActivityK} AND table_number=@iTable) = 0
   INSERT INTO $OTNote (RecordK, table_number) VALUES(${@TActivity2ActivityK},@iTable)
   
UPDATE $OTNote SET FNote={=TActivity2Note} WHERE RecordK=${@TActivity2ActivityK} AND table_number=@iTable
         </EDIT>
      </FIELD>
      <FIELD ID="TActivity2FDone" ALIAS="Closed" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity2CountRemark" ALIAS="N" TABLE="TActivity2" DESCRIPTION="Number of notes for Activity"/>
      <FIELD ID="TActivity2FBeginD" ALIAS="Start" TABLE="TActivity2" DESCRIPTION="" />
      <FIELD ID="TActivity2Picture" ALIAS="Pic" DESCRIPTION="Picture" TABLE="TActivity2">
         <ATTRIBUTES OUTPUT-FORMAT="image| |[row]|padding-left: 10px; margin: 3px; max-height: 100px; opacity: 0.3; overflow-y: scroll;"
                     OUTPUT-STYLE="column|width: 20px;" />
      </FIELD>
      <CONDITION ID="TActivity2FDone" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" FLAGS="16" />
      <CONDITION ID="TActivity2FDeleted" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" FLAGS="16" />
      <CONDITIONS ID="Select filter!" SELECTED="1">
         <CONDITION ID="TActivity2FDeleted" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="DELETED" VALUE="1" />
      </CONDITIONS>
      
      <CONDITIONS ID="Task types" SELECTED="1">
         <CONDITION ID="TActivity2FDeleted" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="DELETED" VALUE="1" />
         <CONDITION ID="TActivity2TypeC" TABLE="TActivity2" OPERATORNAME="EQUAL" SIMPLEVALUE="TIME_TASK" VALUE="1">
            <EXPRESSION>(SELECT _c.type FROM $O{CODE}TCode _c WHERE _c.CodeK=$T.TypeC)</EXPRESSION>
         </CONDITION>
      </CONDITIONS>
      <CONDITIONS ID="Document types" SELECTED="1">
         <CONDITION ID="TActivity2FDeleted" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="DELETED" VALUE="1" />
         <CONDITION ID="TActivity2TypeC" TABLE="TActivity2" OPERATORNAME="EQUAL" SIMPLEVALUE="DOCS" VALUE="4">
            <EXPRESSION>(SELECT _c.type FROM $O{CODE}TCode _c WHERE _c.CodeK=$T.TypeC)</EXPRESSION>
         </CONDITION>
      </CONDITIONS>
      <CONDITIONS ID="Open activities" SELECTED="1">
         <CONDITION ID="TActivity2FDeleted" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="DELETED" VALUE="1" />
         <CONDITION ID="TActivity2FDone" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="CLOSED" VALUE="1" />
      </CONDITIONS>
      <CONDITIONS ID="High priority activities">
         <CONDITION ID="TActivity2FDeleted" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" />
         <CONDITION ID="TActivity2PriorityC" TABLE="TActivity2" OPERATORNAME="GREATER" SIMPLEVALUE="Important" VALUE="4">
            <EXPRESSION>(SELECT _c.FRank FROM $O{CODE}TCode _c WHERE _c.CodeK=$T.PriorityC)</EXPRESSION>
         </CONDITION>
      </CONDITIONS>
      <CONDITIONS ID="Do now">
         <CONDITION ID="TActivity2FDeleted" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" />
         <CONDITION ID="TActivity2FDone" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" />
         <CONDITION ID="TActivity2PriorityC" TABLE="TActivity2" OPERATORNAME="GREATER" SIMPLEVALUE="Do now" VALUE="6">
            <EXPRESSION>(SELECT _c.FRank FROM $O{CODE}TCode _c WHERE _c.CodeK=$T.PriorityC)</EXPRESSION>
         </CONDITION>
      </CONDITIONS>
      <CONDITIONS ID='{ "name": "Only roots", "title": "This is a snapshot description" }'>
         <CONDITION ID="TActivity2FDeleted" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" />
         <CONDITION ID="TActivity2SuperK" TABLE="TActivity2" SIMPLEVALUE="roots" OPERATORNAME="IS NULL" VALUE="0" />
         <CONDITION ID="TActivity2CountNodes" TABLE="TActivity2" SIMPLEVALUE="more than one" OPERATORNAME="GREATER" VALUE="1" />
      </CONDITIONS>
      <ORDER FIELD="TActivity2FBeginD" DESC="1" />
      <ORDERS NAME="Latest">
         <ORDER FIELD="TActivity2FBeginD" DESC="1" />
         <ORDER FIELD="TActivity2FDone" DESC="1" />
      </ORDERS>
      <ORDERS NAME="Latest updated">
         <ORDER FIELD="TActivity2ActivityK" INDEX="0" DESC="1" SQL="TActivity2.UpdateD" />
         <ORDER FIELD="TActivity2ActivityK" INDEX="0" DESC="1" SQL="TActivity2.FDone" />
      </ORDERS>
      <SELECTCONDITIONS>
         <SELECTCONDITION ID="TActivityRemark2FRemark" TABLE="TActivityRemark2" />
         <SELECTCONDITION ID="TActivity2Hashtag" TABLE="TActivity2" />
      </SELECTCONDITIONS>      
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="7e5eef96-bb7f-4025-b6f6-d87dfeda11c1"><![CDATA[ return function(g) local R, db=g.result, g.db
   local sSql = "SELECT COUNT(*) FROM $Othread WHERE FThreadId = (SELECT FThreadId FROM $Othread WHERE table_number=1110 AND FKey=".. R:GetParam("key") ..")";
   local iThreadCount = db:Ask( sSql )
   local sMenu = ""
   if iThreadCount > 1 then 
      sMenu = ',{"id": "view_thread","title":"View thread", "icon": "fa-stream", "table":"TActivity2", "link": ["78D0B10F2B664F6896550CDCCCC0465Aresult"]}' ..
              ',{"id": "view_thread_in_dialog","title":"View thread in dialog", "icon": "fa-stream", "table":"TActivity2", "link": ["4774E0E630204B6988EDF517243FAACEzoom"]}' ..
              ',{"id": "edit_thread","title":"Edit thread", "icon": "fa-stream", "table":"TActivity2", "link": ["D8B5FB8297B640B9A80E5BA0581717EFresult"]}' ..
              ',{"id": "edit_durations_thread","title":"Edit durations", "icon": "fa-stream", "table":"TActivity2", "link": ["8CD248311699439198D941CCFB9EFCB1result"]}'
   end
   
            
   R:SetValue('url','[' .. 
   '{"id": "edit","title":"Edit Activity", "icon": "fa-i-cursor", "table":"TActivity2", "link": ["99C02094D42F4BBF85E41F8D6EAB1CC7"]},' ..    
   '{"id": "remark","title":"View comments", "icon": "fa-align-justify", "table":"TActivity2", "link": ["3A3CCA0F5329204FA828CFF0730FDF5Eresult"]},' .. 
   '{"id": "remark","title":"Comments", "icon": "fa-edit", "table":"TActivity2", "link": ["3A3CCA0F5329204FA828CFF0730FDF5E"]},' .. 
   '{"id": "activity_child","title":"Add activity sub", "icon": "fa-edit", "table":"TActivity2", "link": ["4BD466822F9549D1998B16C75DC0E92E"]},' .. 
   '{"id": "activity","title":"Beam Activity", "icon": "fa-broadcast-tower", "table":"TActivity2", "link": ["C6E29A22AE72434B91FE66293CBB972F"]}' .. sMenu ..
   ']') 
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>

      <QUERYLINK TYPENAME="record" NAME="Activities"  DESCRIPTION="Edit activities for system" KEY="99C02094D42F4BBF85E41F8D6EAB1CC7" QUERY="E011E9977E314F43B719979473167221">
         <EXPRESSION>
SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK=(SELECT ParentK FROM $OTActivity a WHERE ActivityK={{==TActivity2}} AND a.table_number=1010)
UNION All
SELECT ActivityK value, 'ActivityK' AS name, ISNULL((SELECT _c.FName FROM $O{CODE}TCode _c WHERE _c.CodeK=TypeC),' - ') + ': ' + ISNULL(CASE WHEN LEN(FDescription) >= 30 THEN LEFT(FDescription, 28) + '...' ELSE FDescription END, ' - ') simple FROM $OTActivity WHERE ActivityK={{==TActivity2}}
         </EXPRESSION>
         <PROPERTIES OUTPUT-WIDTH="1900" OUTPUT-HEIGHT="500" OUTPUT-POSITION="center-bottom" />
      </QUERYLINK>
      
      <QUERYLINK TYPENAME="children" NAME="Remarks"  DESCRIPTION="Remarks" KEY="3A3CCA0F5329204FA828CFF0730FDF5E" EXPRESSION="SELECT _a.ActivityK value, 'ActivityK' AS name, ISNULL((SELECT _c.FName FROM $O{CODE}TCode _c WHERE _c.CodeK=_a.TypeC),' - ') + ': ' + ISNULL(CASE WHEN LEN(FDescription) >= 30 THEN LEFT(FDescription, 28) + '...' ELSE FDescription END, ' - ') simple  FROM $OTActivity _a WHERE ActivityK={{==TActivity2}}" />
      <QUERYLINK TYPENAME="children" NAME="Sub system"  DESCRIPTION="Sub activities to selected" KEY="4BD466822F9549D1998B16C75DC0E92E" EXPRESSION="SELECT ActivityK value, 'SuperK' AS name, LEFT( FDescription, 100 ) simple FROM $OTActivity WHERE ActivityK={{==TActivity2}}">
         <PROPERTIES OUTPUT-WIDTH="1600" OUTPUT-HEIGHT="300" OUTPUT-POSITION="left-bottom" />         
      </QUERYLINK>
      <QUERYLINK TYPENAME="message" NAME="Activity" DESCRIPTION="Send acitivity key" KEY="C6E29A22AE72434B91FE66293CBB972F" EXPRESSION="SELECT _a.ActivityK value, 'ActivityK' AS name, ISNULL((SELECT _c.FName FROM $O{CODE}TCode _c WHERE _c.CodeK=_a.TypeC),' - ') + ': ' + ISNULL(CASE WHEN LEN(FDescription) >= 30 THEN LEFT(FDescription, 28) + '...' ELSE FDescription END, ' - ') simple FROM $OTActivity _a WHERE ActivityK={{==TActivity2}}">
         <PROPERTIES OUTPUT-COMMAND="send key" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Thread"  DESCRIPTION="Activity thread" KEY="4774E0E630204B6988EDF517243FAACE" EXPRESSION="SELECT FThreadId value, 'ThreadKey' AS name, 'Thread' simple FROM $Othread WHERE table_number=1110 AND FKey={{==TActivity2}}">
         <PROPERTIES OUTPUT-WIDTH="1000" OUTPUT-HEIGHT="1000" OUTPUT-POSITION="left-top|-30,0" OUTPUT-ROWS="20" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Thread"  DESCRIPTION="Activity thread" KEY="78D0B10F2B664F6896550CDCCCC0465A" QUERY="4774E0E630204B6988EDF517243FAACE" EXPRESSION="SELECT FThreadId value, 'ThreadKey' AS name, 'Thread' simple FROM $Othread WHERE table_number=1110 AND FKey={{==TActivity2}}" />
      <QUERYLINK TYPENAME="children" NAME="Thread edit"  DESCRIPTION="Activity thread for editing" KEY="D8B5FB8297B640B9A80E5BA0581717EF">
         <EXPRESSION>
DECLARE @iThread BIGINT = (SELECT FThreadId FROM $Othread WHERE table_number=1110 AND FKey={{==TActivity2}})
SELECT ActivityK value, 'ThreadKey' AS name, 'Thread: ' + ISNULL(CASE WHEN LEN(FDescription) >= 30 THEN LEFT(FDescription, 28) + '...' ELSE FDescription END, ' - ') simple FROM $OTActivity WHERE table_number=1010 AND ActivityK=@iThread
         </EXPRESSION>
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Thread edit"  DESCRIPTION="Activity thread for editing" KEY="8CD248311699439198D941CCFB9EFCB1">
         <EXPRESSION>
DECLARE @iThread BIGINT = (SELECT FThreadId FROM $Othread WHERE table_number=1110 AND FKey={{==TActivity2}})
SELECT ActivityK value, 'ThreadKey' AS name, 'Thread: ' + ISNULL(CASE WHEN LEN(FDescription) >= 30 THEN LEFT(FDescription, 28) + '...' ELSE FDescription END, ' - ') simple FROM $OTActivity WHERE table_number=1010 AND ActivityK=@iThread
         </EXPRESSION>
      </QUERYLINK>
   </QUERY>
   
   
   
   
   <QUERY ID="Activities for project" DESCRIPTION="Activities connected to project" KEY="6532CEA7B733492DA49CD797B253143F">
      <ATTRIBUTE NAME="OUTPUT-LIST">Activities</ATTRIBUTE>
      <ATTRIBUTE NAME="OUTPUT-TRUNCATE">[20,50,200]|50</ATTRIBUTE>
      <FIELD ID="TActivity2ActivityK" ALIAS="ID" TABLE="TActivity2"/>
      <FIELD ID="TActivity2TypeC-Indent" ALIAS="Type" TABLE="TActivity2" />
      <FIELD ID="TActivity2FDescription" ALIAS="Description" TABLE="TActivity2" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="hashtag|TActivity2.Hashtag" />
      </FIELD>
      <FIELD ID="TActivity2StateC" ALIAS="State" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity2PriorityC" ALIAS="Priority" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity2ContextC" ALIAS="Context" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity2ActivityK-Id" ALIAS="Assig." TABLE="TActivity2" FORMAT="(SELECT TOP 1 _ar.FRemark FROM $OTActivityRemark _ar WHERE _ar.ActivityK=$T.ActivityK AND _ar.TypeC=125)" FIELDFLAGNAMES="sql_format">
         <ATTRIBUTES OUTPUT-FORMAT="markdown|padding: 3px; max-width: 1000px; overflow-x: auto; white-space: normal;|[row]|padding-left: 50px;"
                     OUTPUT-STYLE="column|max-width: 25px;" />
      </FIELD>
      <FIELD ID="TActivity2Note" ALIAS="Docs" TABLE="TActivity2" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="`hashtag|TActivity2.Hashtag` `markdown||[row]|padding: 3px; max-height: 100px; opacity: 0.3; overflow-x: auto; overflow-y: scroll; white-space: normal;padding-left: 50px;`"
                     OUTPUT-STYLE="column|max-width: 25px;" />
         <EDIT>
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TActivity');
IF (SELECT COUNT(*) FROM $OTNote WHERE RecordK=${@TActivity2ActivityK} AND table_number=@iTable) = 0
   INSERT INTO $OTNote (RecordK, table_number) VALUES(${@TActivity2ActivityK},@iTable)
   
UPDATE $OTNote SET FNote={=TActivity2Note} WHERE RecordK=${@TActivity2ActivityK} AND table_number=@iTable
         </EDIT>
      </FIELD>
      <FIELD ID="TActivity2FDone" ALIAS="Closed" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity2CountRemark" ALIAS="N" TABLE="TActivity2" DESCRIPTION="Number of notes for Activity"/>
      <FIELD ID="TActivity2FBeginD" ALIAS="Start" TABLE="TActivity2" DESCRIPTION="" />
      <FIELD ID="TActivity2Picture" ALIAS="Pic" DESCRIPTION="Picture" TABLE="TActivity2">
         <ATTRIBUTES OUTPUT-FORMAT="image| |[row]|padding-left: 10px; margin: 3px; max-height: 100px; opacity: 0.3; overflow-y: scroll;"
                     OUTPUT-STYLE="column|width: 20px;" />
      </FIELD>
      <CONDITION ID="TActivity2FDeleted" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="DELETED" VALUE="1" />
      <CONDITIONS ID="Select filter!" SELECTED="1">
         <CONDITION ID="TActivity2FDeleted" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="DELETED" VALUE="1" />
      </CONDITIONS>
      
      <CONDITIONS ID="Task types" SELECTED="1">
         <CONDITION ID="TActivity2FDeleted" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="DELETED" VALUE="1" />
         <CONDITION ID="TActivity2TypeC" TABLE="TActivity2" OPERATORNAME="EQUAL" SIMPLEVALUE="TIME_TASK" VALUE="1">
            <EXPRESSION>(SELECT _c.type FROM $O{CODE}TCode _c WHERE _c.CodeK=$T.TypeC)</EXPRESSION>
         </CONDITION>
      </CONDITIONS>
      <CONDITIONS ID="Open activities" SELECTED="1">
         <CONDITION ID="TActivity2FDeleted" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="DELETED" VALUE="1" />
         <CONDITION ID="TActivity2FDone" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="CLOSED" VALUE="1" />
      </CONDITIONS>
      <CONDITIONS ID='{ "name": "Only roots", "title": "This is a snapshot description" }'>
         <CONDITION ID="TActivity2FDeleted" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" />
         <CONDITION ID="TActivity2SuperK" TABLE="TActivity2" SIMPLEVALUE="roots" OPERATORNAME="IS NULL" VALUE="0" />
         <CONDITION ID="TActivity2CountNodes" TABLE="TActivity2" SIMPLEVALUE="more than one" OPERATORNAME="GREATER" VALUE="1" />
      </CONDITIONS>
      <ORDER FIELD="TActivity2FBeginD" DESC="1" />
      <ORDERS NAME="Latest">
         <ORDER FIELD="TActivity2FBeginD" DESC="1" />
         <ORDER FIELD="TActivity2FDone" DESC="1" />
      </ORDERS>
      <ORDERS NAME="Latest updated">
         <ORDER FIELD="TActivity2ActivityK" INDEX="0" DESC="1" SQL="TActivity2.UpdateD" />
         <ORDER FIELD="TActivity2ActivityK" INDEX="0" DESC="1" SQL="TActivity2.FDone" />
      </ORDERS>
      <SELECTCONDITIONS>
         <SELECTCONDITION ID="TActivityRemark2FRemark" TABLE="TActivityRemark2" />
         <SELECTCONDITION ID="TActivity2Hashtag" TABLE="TActivity2" />
      </SELECTCONDITIONS>      
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="7e5eef96-bb7f-4025-b6f6-d87dfeda11c1"><![CDATA[ return function(g) local R, db=g.result, g.db
   local sSql = "SELECT COUNT(*) FROM $Othread WHERE FThreadId = (SELECT FThreadId FROM $Othread WHERE table_number=1110 AND FKey=".. R:GetParam("key") ..")";
   local iThreadCount = db:Ask( sSql )
   local sMenu = ""
   if iThreadCount > 1 then 
      sMenu = ',{"id": "view_thread","title":"View thread", "icon": "fa-stream", "table":"TActivity2", "link": ["78D0B10F2B664F6896550CDCCCC0465Aresult"]}' ..
              ',{"id": "view_thread_in_dialog","title":"View thread in dialog", "icon": "fa-stream", "table":"TActivity2", "link": ["4774E0E630204B6988EDF517243FAACEzoom"]}' ..
              ',{"id": "edit_thread","title":"Edit thread", "icon": "fa-stream", "table":"TActivity2", "link": ["D8B5FB8297B640B9A80E5BA0581717EFresult"]}' ..
              ',{"id": "edit_durations_thread","title":"Edit durations", "icon": "fa-stream", "table":"TActivity2", "link": ["8CD248311699439198D941CCFB9EFCB1result"]}'
   end
   
            
   R:SetValue('url','[' .. 
   '{"id": "edit","title":"Edit Activity", "icon": "fa-i-cursor", "table":"TActivity2", "link": ["99C02094D42F4BBF85E41F8D6EAB1CC7"]},' ..    
   '{"id": "remark","title":"View comments", "icon": "fa-align-justify", "table":"TActivity2", "link": ["3A3CCA0F5329204FA828CFF0730FDF5Eresult"]},' .. 
   '{"id": "remark","title":"Comments", "icon": "fa-edit", "table":"TActivity2", "link": ["3A3CCA0F5329204FA828CFF0730FDF5E"]},' .. 
   '{"id": "activity_child","title":"Add activity sub", "icon": "fa-edit", "table":"TActivity2", "link": ["4BD466822F9549D1998B16C75DC0E92E"]},' .. 
   '{"id": "activity","title":"Beam Activity", "icon": "fa-broadcast-tower", "table":"TActivity2", "link": ["C6E29A22AE72434B91FE66293CBB972F"]}' .. sMenu ..
   ']') 
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>

      <QUERYLINK TYPENAME="record" NAME="Activities"  DESCRIPTION="Edit activities for system" KEY="99C02094D42F4BBF85E41F8D6EAB1CC7" QUERY="E011E9977E314F43B719979473167221">
         <EXPRESSION>
SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK=(SELECT ParentK FROM $OTActivity a WHERE ActivityK={{==TActivity2}} AND a.table_number=1010)
UNION All
SELECT ActivityK value, 'ActivityK' AS name, ISNULL((SELECT _c.FName FROM $O{CODE}TCode _c WHERE _c.CodeK=TypeC),' - ') + ': ' + ISNULL(CASE WHEN LEN(FDescription) >= 30 THEN LEFT(FDescription, 28) + '...' ELSE FDescription END, ' - ') simple FROM $OTActivity WHERE ActivityK={{==TActivity2}}
         </EXPRESSION>
         <PROPERTIES OUTPUT-WIDTH="1900" OUTPUT-HEIGHT="500" OUTPUT-POSITION="center-bottom" />
      </QUERYLINK>
      
      <QUERYLINK TYPENAME="children" NAME="Remarks"  DESCRIPTION="Remarks" KEY="3A3CCA0F5329204FA828CFF0730FDF5E" EXPRESSION="SELECT _a.ActivityK value, 'ActivityK' AS name, ISNULL((SELECT _c.FName FROM $O{CODE}TCode _c WHERE _c.CodeK=_a.TypeC),' - ') + ': ' + ISNULL(CASE WHEN LEN(FDescription) >= 30 THEN LEFT(FDescription, 28) + '...' ELSE FDescription END, ' - ') simple  FROM $OTActivity _a WHERE ActivityK={{==TActivity2}}" />
      <QUERYLINK TYPENAME="children" NAME="Sub system"  DESCRIPTION="Sub activities to selected" KEY="4BD466822F9549D1998B16C75DC0E92E" EXPRESSION="SELECT ActivityK value, 'SuperK' AS name, LEFT( FDescription, 100 ) simple FROM $OTActivity WHERE ActivityK={{==TActivity2}}">
         <PROPERTIES OUTPUT-WIDTH="1600" OUTPUT-HEIGHT="300" OUTPUT-POSITION="left-bottom" />         
      </QUERYLINK>
      <QUERYLINK TYPENAME="message" NAME="Activity" DESCRIPTION="Send acitivity key" KEY="C6E29A22AE72434B91FE66293CBB972F" EXPRESSION="SELECT _a.ActivityK value, 'ActivityK' AS name, ISNULL((SELECT _c.FName FROM $O{CODE}TCode _c WHERE _c.CodeK=_a.TypeC),' - ') + ': ' + ISNULL(CASE WHEN LEN(FDescription) >= 30 THEN LEFT(FDescription, 28) + '...' ELSE FDescription END, ' - ') simple FROM $OTActivity _a WHERE ActivityK={{==TActivity2}}">
         <PROPERTIES OUTPUT-COMMAND="send key" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Thread"  DESCRIPTION="Activity thread" KEY="4774E0E630204B6988EDF517243FAACE" EXPRESSION="SELECT FThreadId value, 'ThreadKey' AS name, 'Thread' simple FROM $Othread WHERE table_number=1110 AND FKey={{==TActivity2}}">
         <PROPERTIES OUTPUT-WIDTH="1000" OUTPUT-HEIGHT="1000" OUTPUT-POSITION="left-top|-30,0" OUTPUT-ROWS="20" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Thread"  DESCRIPTION="Activity thread" KEY="78D0B10F2B664F6896550CDCCCC0465A" QUERY="4774E0E630204B6988EDF517243FAACE" EXPRESSION="SELECT FThreadId value, 'ThreadKey' AS name, 'Thread' simple FROM $Othread WHERE table_number=1110 AND FKey={{==TActivity2}}" />
      <QUERYLINK TYPENAME="children" NAME="Thread edit"  DESCRIPTION="Activity thread for editing" KEY="D8B5FB8297B640B9A80E5BA0581717EF">
         <EXPRESSION>
DECLARE @iThread BIGINT = (SELECT FThreadId FROM $Othread WHERE table_number=1110 AND FKey={{==TActivity2}})
SELECT ActivityK value, 'ThreadKey' AS name, 'Thread: ' + ISNULL(CASE WHEN LEN(FDescription) >= 30 THEN LEFT(FDescription, 28) + '...' ELSE FDescription END, ' - ') simple FROM $OTActivity WHERE table_number=1010 AND ActivityK=@iThread
         </EXPRESSION>
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Thread edit"  DESCRIPTION="Activity thread for editing" KEY="8CD248311699439198D941CCFB9EFCB1">
         <EXPRESSION>
DECLARE @iThread BIGINT = (SELECT FThreadId FROM $Othread WHERE table_number=1110 AND FKey={{==TActivity2}})
SELECT ActivityK value, 'ThreadKey' AS name, 'Thread: ' + ISNULL(CASE WHEN LEN(FDescription) >= 30 THEN LEFT(FDescription, 28) + '...' ELSE FDescription END, ' - ') simple FROM $OTActivity WHERE table_number=1010 AND ActivityK=@iThread
         </EXPRESSION>
      </QUERYLINK>
   </QUERY>
   
   
   
   
   
   
   
   <QUERY ID="Activities: Reporting" KEY="41112C86D2354D46BAE1139909D8280A">
      <FIELD ID="TActivity2ActivityK" ALIAS="ID (Activity)" TABLE="TActivity2"/>
      <FIELD ID="TActivity2TypeC-Indent" ALIAS="Type" TABLE="TActivity2"/>
      <FIELD ID="TActivity2LevelC" ALIAS="Level" TABLE="TActivity2" />
      <FIELD ID="TActivity2StateC" ALIAS="State" TABLE="TActivity2"/>
      <FIELD ID="TActivity2FBeginD" ALIAS="Begin" TABLE="TActivity2" FORMAT="CONVERT(CHAR(10), $T.$F, 120)" FIELDFLAGNAMES="sql_format" />
      <FIELD ID="TActivity2FDescription" ALIAS="Description" TABLE="TActivity2">
         <ATTRIBUTES OUTPUT-FORMAT="markdown" />
      </FIELD>
      <FIELD ID="TActivity2Note" ALIAS="Docs" TABLE="TActivity2" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="markdown|padding: 3px; font-size: 90%; max-width: 95%; overflow-x: auto; white-space: normal;|[row]|padding-left: 50px;"
                     OUTPUT-STYLE="column|max-width: 25px;" />
      </FIELD>

      <ORDER FIELD="TActivity2ActivityK" INDEX="0" SQL="(SELECT TOP 1 _th.FThreadId FROM $Othread_header _th JOIN $Othread _t ON _th.FThreadId = _t.FThreadId AND _t.table_number=1110 WHERE _t.FKey=TActivity2.ActivityK AND _th.table_number=1110)" />
      <ORDER FIELD="TActivity2ActivityK" INDEX="0" SQL="(SELECT TOP 1 _t.FPath FROM $Othread _t WHERE _t.FKey=TActivity2.ActivityK AND _t.table_number=1110)" />
      <ORDERS NAME="Thread view">
         <ORDER FIELD="TActivity2ActivityK" INDEX="0" SQL="(SELECT TOP 1 _th.FThreadId FROM $Othread_header _th JOIN $Othread _t ON _th.FThreadId = _t.FThreadId AND _t.table_number=1110 WHERE _t.FKey=TActivity2.ActivityK AND _th.table_number=1110)" />
         <ORDER FIELD="TActivity2ActivityK" INDEX="0" SQL="(SELECT TOP 1 _t.FPath FROM $Othread _t WHERE _t.FKey=TActivity2.ActivityK AND _t.table_number=1110)" />
      </ORDERS>

   </QUERY>   
   
   <QUERY ID="Activities: for System" DESCRIPTION="Activities connected to system" KEY="E011E9977E314F43B719979473167221">
      <ATTRIBUTE NAME="OUTPUT-TRUNCATE">[20,50,200]|20</ATTRIBUTE>
      <FIELD ID="TActivity2ActivityK" ALIAS="ID" TABLE="TActivity2"/>
      <FIELD ID="TActivity2TypeC" ALIAS="Type" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity2LevelC" ALIAS="Level" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity2StateC" ALIAS="State" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity2ContextC" ALIAS="Context" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity2FBeginD" ALIAS="Begin" TABLE="TActivity2" FORMAT="CONVERT(CHAR(16), $T.$F, 120)" FIELDFLAGNAMES="sql_format edit">
         <!-- Format for Moment.js -->
         <ATTRIBUTES OUTPUT-INPUT="date|YYYY-MM-DD HH:mm|24" />
      </FIELD>


      <FIELD ID="TActivity2Picture" ALIAS="Picture" TABLE="TActivity2" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="image| |[row]|padding-left: 50px; background-color: #EEE; margin: 3px; max-height: 300px; overflow-y: scroll;"
                     OUTPUT-STYLE="column|width: 20px;"
                     OUTPUT-INPUT="file" />
         <EDIT>
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TActivity');
DECLARE @iSize INT = {{=size}}
DECLARE @sName NVARCHAR(200) = {=TActivity2Picture}

DELETE FROM $OTImage WHERE RecordK=${@[$T]ActivityK} AND table_number=@iTable
IF @sName IS NOT NULL AND LEN( @sName ) &gt; 0
BEGIN
   INSERT INTO $OTImage (RecordK, table_number) VALUES(${@[$T]ActivityK},@iTable)

   UPDATE $OTImage SET FName=@sName, FExtension={=extension}, FData=0x{{=data"00"}}, FSize=@iSize, MimeName={=mime} WHERE RecordK=${@[$T]ActivityK} AND table_number=@iTable
END   
         </EDIT>
      </FIELD>

      <FIELD ID="TActivity2FDescription" ALIAS="Description" TABLE="TActivity2" FIELDFLAGNAMES="edit" DESCRIPTION="activity with hashtag logic">
         <EDIT>{"update":"$OPROCEDURE_UpdateBadge {=TActivity2FDescription}, 'TActivity', ${@TActivity2ActivityK}","formula":"1"}</EDIT>
      </FIELD>
      <FIELD ID="TActivity2Note" ALIAS="Documentation" TABLE="TActivity2" FIELDFLAGNAMES="edit">
         <EDIT>
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TActivity');
IF (SELECT COUNT(*) FROM $OTNote WHERE RecordK=${@ActivityK} AND table_number=@iTable) = 0
   INSERT INTO $OTNote (RecordK, table_number) VALUES(${@ActivityK},@iTable)

UPDATE $OTNote SET FNote={=TActivity2Note} WHERE RecordK=${@ActivityK} AND table_number=@iTable
         </EDIT>
      </FIELD>
      <FIELD ID="TActivity2PriorityC" ALIAS="Priority" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity2FDone" ALIAS="Closed" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity2UserK" ALIAS="User" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <CONDITION ID="TActivity2FDone" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" FLAGS="16" />
      <CONDITION ID="TActivity2FDeleted" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" FLAGS="16" />
      <ORDER FIELD="TActivity2ActivityK" INDEX="0" DESC="1" SQL="CASE WHEN TActivity2.FBeginD IS NOT NULL THEN TActivity2.FBeginD ELSE TActivity2.CreateD END" />
      <ORDERS NAME="Priority">
         <ORDER FIELD="TActivity2PriorityC" DESC="1" SQL="(SELECT _c.FRank FROM $O{CODE}TCode _c WHERE _c.CodeK=$T.PriorityC)" />
      </ORDERS>
      <ORDERS NAME="Thread view">
         <ORDER FIELD="TActivity2ActivityK" INDEX="0" SQL="(SELECT TOP 1 _th.FThreadId FROM $Othread_header _th JOIN $Othread _t ON _th.FThreadId = _t.FThreadId AND _t.table_number=1110 WHERE _t.FKey=TActivity2.ActivityK AND _th.table_number=1110)" />
         <ORDER FIELD="TActivity2ActivityK" INDEX="0" SQL="(SELECT TOP 1 _t.FPath FROM $Othread _t WHERE _t.FKey=TActivity2.ActivityK AND _t.table_number=1110)" />
      </ORDERS>
      <CONDITIONS ID="All Activities" />
      <CONDITIONS ID="Documentation" SELECTED="1">
         <CONDITION ID="TActivity2TypeC" TABLE="TActivity2" OPERATOR="0" SIMPLEVALUE="Documentation" VALUE="3128" />
      </CONDITIONS>
      <CONDITIONS ID="High priority activities">
         <CONDITION ID="TActivity2FDeleted" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" />
         <CONDITION ID="TActivity2PriorityC" TABLE="TActivity2" OPERATORNAME="GREATER" SIMPLEVALUE="Important" VALUE="4">
            <EXPRESSION>(SELECT _c.FRank FROM $O{CODE}TCode _c WHERE _c.CodeK=$T.PriorityC)</EXPRESSION>
         </CONDITION>
      </CONDITIONS>
      <CONDITIONS ID="Open Activities" SELECTED="1">
         <CONDITION ID="TActivity2FDone" TABLE="TActivity2" OPERATOR="0" SIMPLEVALUE="NO" VALUE="0" />
      </CONDITIONS>
      <CONDITIONS ID='{ "name": "Only roots", "title": "This is a snapshot description", "style": "color: red;" }'>
         <CONDITION ID="TActivity2FDeleted" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" />
         <CONDITION ID="TActivity2SuperK" TABLE="TActivity2" SIMPLEVALUE="roots" OPERATORNAME="IS NULL" VALUE="0" />
         <CONDITION ID="TActivity2CountNodes" TABLE="TActivity2" SIMPLEVALUE="more than one" OPERATORNAME="GREATER" VALUE="1" />
      </CONDITIONS>
      <ROWEDIT>
         <EDIT NAME="new_activity" SIMPLE="Activities" TYPENAME="new_row">
            <PROPERTY NAME="columns">0,FBeginD,FDone,UserK</PROPERTY>
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION CACHE="1e415c0f-ee94-4973-9976-d71fc250434a">
-- # Add record to TActivity
DECLARE @iSystem INT = {{=SystemK}};
DECLARE @sDescription NVARCHAR(1000) = {=FDescription};

DECLARE @dateBegin DATETIME = {=FBeginD};
IF @dateBegin IS NULL  SET @dateBegin = DATEADD(hour, DATEDIFF(hour,0,GETDATE()), 0)

DECLARE @iSize INT = {{=Picture.size}}
   
DECLARE @iUser INT = {=UserK};
IF @iUser IS NULL
   SET @iUser = {#V user "@@user"} -- default user is active user
   

DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TSystem');
INSERT INTO $OTActivity (FDescription,TypeC,StateC,ContextC,ServiceC,AreaC,UserK,FBeginD,CreateD,UpdateD,ParentK,table_number) 
VALUES(@sDescription,{=TypeC"0"},{=StateC"0"},{=ContextC"0"},0,0,@iUser,@dateBegin,GETDATE(),GETDATE(),@iSystem,@iTable);

DECLARE @iActivity BIGINT = (SELECT IDENT_CURRENT('$OTActivity'));
SET @iTable = (SELECT number FROM $Otable_number WHERE "name" = 'TActivity');
INSERT INTO $OTNote(RecordK,table_number,FNote) VALUES(@iActivity,@iTable,{=TActivity2Note})

IF @iSize IS NOT NULL -- Add picture if picture size is found
BEGIN
   INSERT INTO $OTImage (RecordK, table_number, FName, FExtension, FSize, MimeName, FData) 
   VALUES(@iActivity,@iTable,{=Picture.name},{=Picture.extension}, @iSize, {=Picture.mime}, 0x{{=Picture.data"00"}})
END

EXEC $OPROCEDURE_UpdateBadge @sDescription, 'TActivity', @iActivity
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key">
               <EXPRESSION>
DECLARE @iActivity BIGINT = (SELECT IDENT_CURRENT('$OTActivity'))
SELECT ActivityK, 
       CONVERT(CHAR(16), FBeginD, 120), 
       CASE WHEN FDone = 0 THEN 'NO' ELSE 'YES' END, 
       (SELECT u.FDisplayName + ' (' + ISNULL(u.FFirstName,'') + ' ' + ISNULL(u.FLastName,'') + ')' FROM $OTUser u WHERE u.UserK=TActivity.UserK)
FROM $OTActivity WHERE ActivityK = @iActivity 
               </EXPRESSION>
            </SQL>
         </EDIT>
         <EDIT NAME="delete activity" SIMPLE="Delete Activity" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $OTActivity WHERE ActivityK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
      <QUERYLINK TYPENAME="children" NAME="Add activity child"  DESCRIPTION="Add Sub activities" KEY="4BD466822F9549D1998B16C75DC0E92E" EXPRESSION="SELECT ActivityK value, 'SuperK' AS name, LEFT( FDescription, 100 ) simple FROM $OTActivity WHERE ActivityK={{==[0]}}" />
   </QUERY>

<!-- * Create and edit sub activities -->   
   <QUERY ID="Activities: Add activity child" DESCRIPTION="Activities, for use when adding child activities" KEY="4BD466822F9549D1998B16C75DC0E92E" FLAGNAMES="NOTLISTED">
      <ATTRIBUTE NAME="OUTPUT-TRUNCATE">[20,50,200]|20</ATTRIBUTE>
      <FIELD ID="TActivity2ActivityK" ALIAS="ID" TABLE="TActivity2"/>
      <FIELD ID="TActivity2TypeC" ALIAS="Type" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity2StateC" ALIAS="State" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity2LevelC" ALIAS="Level" TABLE="TActivity2" FIELDFLAGNAMES="edit" />         
      <FIELD ID="TActivity2ReportC" ALIAS="Report" TABLE="TActivity2" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TActivity2FBeginD" ALIAS="Begin" TABLE="TActivity2" FORMAT="CONVERT(CHAR(16), $T.$F, 120)" FIELDFLAGNAMES="sql_format edit">
         <!-- Format for Moment.js -->
         <ATTRIBUTES OUTPUT-INPUT="date|YYYY-MM-DD HH:mm|24" />
      </FIELD>
      <FIELD ID="TActivity2FDescription" ALIAS="Description" TABLE="TActivity2" FIELDFLAGNAMES="edit">
         <EDIT>
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TActivity');
DECLARE @iActivity BIGINT = ${@TActivity2ActivityK}
DECLARE @sDescription NVARCHAR(1000) = {=TActivity2FDescription}

DELETE FROM $OTrXBadge WHERE ParentK = @iActivity AND table_number = @iTable

IF LEN( @sDescription ) &gt; 2
BEGIN
-- Add missing hashtags to Badge table
   INSERT INTO $OTBadge (FName)
   SELECT tag FROM $OPullTagsFromText( @sDescription ) LEFT JOIN $OTBadge _b ON tag = _b.FName
   WHERE _b.FName IS NULL   

-- Connect hashtags to Activity record
   INSERT INTO $OTrXBadge (ParentK,table_number,BadgeK)
   SELECT @iActivity, @iTable, _b.BadgeK
   FROM $OTBadge _b JOIN $OPullTagsFromText( @sDescription ) ON _b.FName = tag
END
         </EDIT>
      </FIELD>
      <FIELD ID="TActivity2Note" ALIAS="Documentation" TABLE="TActivity2" FIELDFLAGNAMES="edit">
         <EDIT>
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TActivity');
IF (SELECT COUNT(*) FROM $OTNote WHERE RecordK=${@TActivity2ActivityK} AND table_number=@iTable) = 0
   INSERT INTO $OTNote (RecordK, table_number) VALUES(${@TActivity2ActivityK},@iTable)

UPDATE $OTNote SET FNote={=TActivity2Note} WHERE RecordK=${@TActivity2ActivityK} AND table_number=@iTable
         </EDIT>
      </FIELD>
      <FIELD ID="TActivity2Picture" ALIAS="Picture" TABLE="TActivity2" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="image| |[row]|padding-left: 50px; background-color: #EEE; margin: 3px; max-height: 300px; overflow-y: scroll;"
                     OUTPUT-STYLE="column|width: 20px;"
                     OUTPUT-INPUT="file" />
         <EDIT>
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TActivity');
DECLARE @iSize INT = {{=size}}
DECLARE @sName NVARCHAR(200) = {=TActivity2Picture}

DELETE FROM $OTImage WHERE RecordK=${@[$T]ActivityK} AND table_number=@iTable
IF @sName IS NOT NULL AND LEN( @sName ) &gt; 0
BEGIN
   INSERT INTO $OTImage (RecordK, table_number) VALUES(${@[$T]ActivityK},@iTable)

   UPDATE $OTImage SET FName=@sName, FExtension={=extension}, FData=0x{{=data"00"}}, FSize=@iSize, MimeName={=mime} WHERE RecordK=${@[$T]ActivityK} AND table_number=@iTable
END   
         </EDIT>
      </FIELD>
      <FIELD ID="TActivity2PriorityC" ALIAS="Priority" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity2FDone" ALIAS="Closed" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity2UserK" ALIAS="User" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <CONDITION ID="TActivity2FDone" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" FLAGS="16" />
      <CONDITION ID="TActivity2FDeleted" TABLE="TActivity2" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" FLAGS="16" />
      <ORDER FIELD="TActivity2ActivityK" INDEX="0" DESC="1" SQL="CASE WHEN TActivity2.FBeginD IS NOT NULL THEN TActivity2.FBeginD ELSE TActivity2.CreateD END" />
      <ROWEDIT>
         <EDIT NAME="new_activity" SIMPLE="Activities" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION CACHE="9198fa53-2ed9-4d9b-9ecd-7a410affde23">
-- # Add sub activity record to parent TActivity
DECLARE @iSuper INT = {{=SuperK}}
IF @iSuper = 0 SET @iSuper = NULL

DECLARE @iSystem INT = (SELECT ParentK FROM $OTActivity WHERE ActivityK = @iSuper);
DECLARE @sDescription NVARCHAR(1000) = {=FDescription};
DECLARE @dateBegin DATETIME = {=FBeginD};
IF @dateBegin IS NULL
   SET @dateBegin = DATEADD(hour, DATEDIFF(hour,0,GETDATE()), 0)
   
DECLARE @iSize INT = {{=Picture.size}}   

DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TSystem');
INSERT INTO $OTActivity (FDescription,TypeC,StateC,LevelC,ReportC,ServiceC,AreaC,UserK,FBeginD,CreateD,UpdateD,ParentK,table_number,SuperK) 
VALUES(@sDescription,{=TypeC"0"},{=StateC"0"},{=LevelC"0"},{=ReportC"0"},0,0,{=UserK},@dateBegin,GETDATE(),GETDATE(),@iSystem,@iTable,@iSuper);

DECLARE @iActivity BIGINT = (SELECT IDENT_CURRENT('$OTActivity'));
SET @iTable = (SELECT number FROM $Otable_number WHERE "name" = 'TActivity');
INSERT INTO $OTNote(RecordK,table_number,FNote) VALUES(@iActivity,@iTable,{=TActivity2Note})

IF @iSize IS NOT NULL -- Add picture if picture size is found
BEGIN
   INSERT INTO $OTImage (RecordK, table_number, FName, FExtension, FSize, MimeName, FData) 
   VALUES(@iActivity,@iTable,{=Picture.name},{=Picture.extension}, @iSize, {=Picture.mime}, 0x{{=Picture.data"00"}})
END

IF LEN( @sDescription ) &gt; 2
BEGIN
   -- clear hashtags for Activity
   SET @iTable = (SELECT number FROM $Otable_number WHERE "name" = 'TActivity');

   -- Add missing hashtags to Badge table
   INSERT INTO $OTBadge (FName)
   SELECT tag FROM $OPullTagsFromText( @sDescription ) LEFT JOIN $OTBadge _b ON tag = _b.FName
   WHERE _b.FName IS NULL   

   -- Connect hashtags to Activity record
   INSERT INTO $OTrXBadge (ParentK,table_number,BadgeK)
   SELECT @iActivity, @iTable, _b.BadgeK
   FROM $OTBadge _b JOIN $OPullTagsFromText( @sDescription ) ON _b.FName = tag
END

DECLARE @iProject BIGINT = {=ProjectK};
IF @iProject &gt; 0 
   INSERT INTO $OTrProjectXActivity (ProjectK,ActivityK) VALUES(@iProject,@iActivity)

DECLARE @iSale BIGINT = {=SaleK};
IF @iSale &gt; 0 
   INSERT INTO $OTrSaleXActivity (SaleK,ActivityK) VALUES(@iSale,@iActivity)
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTActivity')" />
         </EDIT>
         <EDIT NAME="delete activity" SIMPLE="Delete Activity" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $OTActivity WHERE ActivityK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
   </QUERY>

   <QUERY ID="Activities: Edit" DESCRIPTION="Activities connected to customer" KEY="AC45823325E64A0FB8B0C2A4F529EDAF" FLAGNAMES="NOTLISTED">
      <ATTRIBUTE NAME="OUTPUT-TRUNCATE">[20,50,200]|20</ATTRIBUTE>
      <FIELD ID="TActivity6ActivityK" ALIAS="ID" TABLE="TActivity6"/>
      <FIELD ID="TActivity6TypeC" ALIAS="Type" TABLE="TActivity6" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity6StateC" ALIAS="State" TABLE="TActivity6" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity6FBeginD" ALIAS="Begin" TABLE="TActivity6" FORMAT="CONVERT(CHAR(16), $T.$F, 120)" FIELDFLAGNAMES="sql_format edit">
         <ATTRIBUTES OUTPUT-INPUT="date|YYYY-MM-DD HH:mm|24" />
      </FIELD>
      <FIELD ID="TActivity6Picture" ALIAS="Picture" TABLE="TActivity6" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="image| |[row]|padding-left: 50px; background-color: #EEE; margin: 3px; max-height: 300px; overflow-y: scroll;"
                     OUTPUT-STYLE="column|width: 20px;"
                     OUTPUT-INPUT="file" />
         <EDIT>EXEC application.PROCEDURE_UpdateImage 'TActivity', ${@TActivity6ActivityK}, {=TActivity6Picture}, {=extension}, {=mime}, {{=size}}, '{{=data}}'</EDIT>
      </FIELD>
      <FIELD ID="TActivity6FDescription" ALIAS="Description" TABLE="TActivity6" FIELDFLAGNAMES="edit">
         <EDIT>{"update":"$OPROCEDURE_UpdateBadge {=TActivity6FDescription}, 'TActivity', ${@TActivity6ActivityK}","formula":"1"}</EDIT>
      </FIELD>
      <FIELD ID="TActivity6Note" ALIAS="Note" TABLE="TActivity6" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="markdown|padding: 3px; font-size: 90%; max-width: 95%; overflow-x: auto; white-space: normal;|[row]|padding-left: 50px;"
                     OUTPUT-STYLE="column|max-width: 25px;" />
         <EDIT>
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TActivity');
IF (SELECT COUNT(*) FROM $OTNote WHERE RecordK=${@TActivity6ActivityK} AND table_number=@iTable) = 0
INSERT INTO $OTNote (RecordK, table_number) VALUES(${@TActivity6ActivityK},@iTable)

UPDATE $OTNote SET FNote={=TActivity6Note} WHERE RecordK=${@TActivity6ActivityK} AND table_number=@iTable
         </EDIT>
      </FIELD>
      <FIELD ID="TActivity6PriorityC" ALIAS="Priority" TABLE="TActivity6" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity6FDone" ALIAS="Closed" TABLE="TActivity6" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity6UserK" ALIAS="User" TABLE="TActivity6" FIELDFLAGNAMES="edit" />
   </QUERY>
      
   
   
   
   <QUERY ID="Activities: for Customer" DESCRIPTION="Activities connected to customer" KEY="6CC3172D6ABA4A0DB1980E903B3154BB">
      <ATTRIBUTE NAME="OUTPUT-LIST">Conditional,1000</ATTRIBUTE>
      <ATTRIBUTE NAME="OUTPUT-TRUNCATE">[20,50,200]|20</ATTRIBUTE>
      <FIELD ID="TActivity6ActivityK" ALIAS="ID" TABLE="TActivity6"/>
      <FIELD ID="TActivity6TypeC" ALIAS="Type" TABLE="TActivity6" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity6StateC" ALIAS="State" TABLE="TActivity6" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity6FBeginD" ALIAS="Begin" TABLE="TActivity6" FORMAT="CONVERT(CHAR(16), $T.$F, 120)" FIELDFLAGNAMES="sql_format edit">
         <!-- Format for Moment.js -->
         <ATTRIBUTES OUTPUT-INPUT="date|YYYY-MM-DD HH:mm|24" />
      </FIELD>
      <FIELD ID="TActivity6Picture" ALIAS="Picture" TABLE="TActivity6" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="image| |[row]|padding-left: 50px; background-color: #EEE; margin: 3px; max-height: 300px; overflow-y: scroll;"
                     OUTPUT-STYLE="column|width: 20px;"
                     OUTPUT-INPUT="file" />
         <EDIT>EXEC application.PROCEDURE_UpdateImage 'TActivity', ${@TActivity6ActivityK}, {=TActivity6Picture}, {=extension}, {=mime}, {{=size}}, '{{=data}}'</EDIT>
      </FIELD>
      <FIELD ID="TActivity6FDescription" ALIAS="Description" TABLE="TActivity6" FIELDFLAGNAMES="edit" >
         <ATTRIBUTES OUTPUT-FORMAT="hashtag|TActivity6.Hashtag" />
         <EDIT>{"update":"$OPROCEDURE_UpdateBadge {=TActivity6FDescription}, 'TActivity', ${@TActivity6ActivityK}","formula":"1"}</EDIT>
      </FIELD>
      <FIELD ID="TActivity6Note" ALIAS="Note" TABLE="TActivity6" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="markdown|padding: 3px; font-size: 90%; max-width: 95%; overflow-x: auto; white-space: normal;|[row]|padding-left: 50px;"
                     OUTPUT-STYLE="column|max-width: 25px;" />
         <EDIT>
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TActivity');
IF (SELECT COUNT(*) FROM $OTNote WHERE RecordK=${@TActivity6ActivityK} AND table_number=@iTable) = 0
   INSERT INTO $OTNote (RecordK, table_number) VALUES(${@TActivity6ActivityK},@iTable)

UPDATE $OTNote SET FNote={=TActivity6Note} WHERE RecordK=${@TActivity6ActivityK} AND table_number=@iTable
         </EDIT>
      </FIELD>
      <FIELD ID="TActivity6PriorityC" ALIAS="Priority" TABLE="TActivity6" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity6FDone" ALIAS="Closed" TABLE="TActivity6" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity6UserK" ALIAS="User" TABLE="TActivity6" FIELDFLAGNAMES="edit" />
      <CONDITION ID="TActivity6FDone" TABLE="TActivity6" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" FLAGS="16" />
      <CONDITION ID="TActivity6FDeleted" TABLE="TActivity6" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" FLAGS="16" />
      <ORDER FIELD="TActivity6ActivityK" INDEX="0" DESC="1" SQL="CASE WHEN TActivity6.FBeginD IS NOT NULL THEN TActivity6.FBeginD ELSE TActivity6.CreateD END" />
      <ORDERS NAME="Priority">
         <ORDER FIELD="TActivity6PriorityC" DESC="1" SQL="(SELECT _c.FRank FROM $O{CODE}TCode _c WHERE _c.CodeK=$T.PriorityC)" />
      </ORDERS>
      <CONDITIONS ID="All Activities" />
      <CONDITIONS ID="Documentation" SELECTED="1">
         <CONDITION ID="TActivity6TypeC" TABLE="TActivity6" OPERATOR="0" SIMPLEVALUE="Documentation" VALUE="3128" />
      </CONDITIONS>
      <CONDITIONS ID="High priority activities">
         <CONDITION ID="TActivity6FDeleted" TABLE="TActivity6" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" />
         <CONDITION ID="TActivity6PriorityC" TABLE="TActivity6" OPERATORNAME="GREATER" SIMPLEVALUE="Important" VALUE="4">
            <EXPRESSION>(SELECT _c.FRank FROM $O{CODE}TCode _c WHERE _c.CodeK=$T.PriorityC)</EXPRESSION>
         </CONDITION>
      </CONDITIONS>
      <CONDITIONS ID="Open Activities" SELECTED="1">
         <CONDITION ID="TActivity6FDone" TABLE="TActivity6" OPERATOR="0" SIMPLEVALUE="NO" VALUE="0" />
      </CONDITIONS>
      
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="e5d90502-2ec4-4986-872f-b65d402237e0">
               <![CDATA[ return function(g) local R, db, sE=g.result, g.db, g.result:GetParam("event");
R:SetValue('url','[' .. 
   '{"id": "activity_edit","title":"Edit activity", "icon": "fa-i-cursor", "table":"TActivity6", "link": ["51EF724A29DE48238FEE97273AB0ADB7"]}' .. 
   ']') 
end  ]]>
            </CODE>
         </SCRIPT>
      </SCRIPTS>
      
      <QUERYLINK TYPENAME="record" NAME="Activity"  DESCRIPTION="Edit Activity" KEY="51EF724A29DE48238FEE97273AB0ADB7" QUERY="AC45823325E64A0FB8B0C2A4F529EDAF">
         <EXPRESSION>
SELECT CustomerK value, 'CustomerK' AS name, FName simple  FROM $OTCustomer WHERE CustomerK=(SELECT a.ParentK FROM $OTActivity a WHERE a.ActivityK={{==TActivity6}} AND a.table_number=1030)
UNION All
SELECT ActivityK value, 'ActivityK' AS name, ISNULL((SELECT _c.FName FROM $O{CODE}TCode _c WHERE _c.CodeK=TypeC),' - ') + ': ' + ISNULL(CASE WHEN LEN(FDescription) >= 30 THEN LEFT(FDescription, 28) + '...' ELSE FDescription END, ' - ') simple FROM $OTActivity WHERE ActivityK={{==[0]}}
         </EXPRESSION>
         <PROPERTIES OUTPUT-WIDTH="1900" OUTPUT-HEIGHT="500" OUTPUT-POSITION="center-bottom" />
      </QUERYLINK>
      
      
      
      <ROWEDIT>
         <EDIT NAME="new_activity" SIMPLE="Activities" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
-- # Add record to TActivity
DECLARE @iCustomer INT = {{=CustomerK}};
DECLARE @sDescription NVARCHAR(1000) = {=FDescription};
DECLARE @dateBegin DATETIME = {=FBeginD};
IF @dateBegin IS NULL
   SET @dateBegin = DATEADD(hour, DATEDIFF(hour,0,GETDATE()), 0)
   
DECLARE @iSize INT = {{=Picture.size}}

DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TCustomer');
INSERT INTO $OTActivity (FDescription,TypeC,StateC,ServiceC,AreaC,UserK,FBeginD,CreateD,UpdateD,ParentK,table_number) 
VALUES(@sDescription,{=TypeC"0"},{=StateC"0"},0,0,{=UserK},@dateBegin,GETDATE(),GETDATE(),@iCustomer,@iTable);

DECLARE @iActivity BIGINT = (SELECT IDENT_CURRENT('$OTActivity'));
SET @iTable = (SELECT number FROM $Otable_number WHERE "name" = 'TActivity');
INSERT INTO $OTNote(RecordK,table_number,FNote) VALUES(@iActivity,@iTable,{=TActivity6Note})

IF @iSize IS NOT NULL -- Add picture if picture size is found
BEGIN
   INSERT INTO $OTImage (RecordK, table_number, FName, FExtension, FSize, MimeName, FData) 
   VALUES(@iActivity,@iTable,{=Picture.name},{=Picture.extension}, @iSize, {=Picture.mime}, 0x{{=Picture.data"00"}})
END

IF LEN( @sDescription ) &gt; 2
BEGIN
   -- Add missing hash tags to Badge table
   INSERT INTO $OTBadge (FName)
   SELECT tag FROM $OPullTagsFromText( @sDescription ) LEFT JOIN $OTBadge _b ON tag = _b.FName
   WHERE _b.FName IS NULL   

   -- Connect hash tags to Activity record
   INSERT INTO $OTrXBadge (ParentK,table_number,BadgeK)
   SELECT @iActivity, @iTable, _b.BadgeK
   FROM $OTBadge _b JOIN $OPullTagsFromText( @sDescription ) ON _b.FName = tag
END

               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTActivity')" />
         </EDIT>
      </ROWEDIT>
   </QUERY>

   <QUERY ID="Activities: for Sale" DESCRIPTION="Activities connected to sale" KEY="D1ED8FCC75B744C89D4E0286CDF35998" FLAGNAMES="NOTLISTED">
      <ATTRIBUTE NAME="OUTPUT-TRUNCATE">[20,50,200]|20</ATTRIBUTE>
      <FIELD ID="TActivity11ActivityK" ALIAS="ID" TABLE="TActivity11"/>
      <FIELD ID="TActivity11TypeC" ALIAS="Type" TABLE="TActivity11" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity11StateC" ALIAS="State" TABLE="TActivity11" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity11FBeginD" ALIAS="Begin" TABLE="TActivity11" FORMAT="CONVERT(CHAR(16), $T.$F, 120)" FIELDFLAGNAMES="sql_format edit">
         <!-- Format for Moment.js -->
         <ATTRIBUTES OUTPUT-INPUT="date|YYYY-MM-DD HH:mm|24" />
      </FIELD>
      <FIELD ID="TActivity11FDescription" ALIAS="Description" TABLE="TActivity11" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity11Note" ALIAS="Documentation" TABLE="TActivity11" FIELDFLAGNAMES="edit">
         <EDIT>
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TActivity');
IF (SELECT COUNT(*) FROM $OTNote WHERE RecordK=${@TActivity11ActivityK} AND table_number=@iTable) = 0
   INSERT INTO $OTNote (RecordK, table_number) VALUES(${@TActivity11ActivityK},@iTable)

UPDATE $OTNote SET FNote={=TActivity11Note} WHERE RecordK=${@TActivity11ActivityK} AND table_number=@iTable
         </EDIT>
      </FIELD>
      <FIELD ID="TActivity11PriorityC" ALIAS="Priority" TABLE="TActivity11" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity11FDone" ALIAS="Closed" TABLE="TActivity11" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity11UserK" ALIAS="User" TABLE="TActivity11" FIELDFLAGNAMES="edit" />
      <CONDITION ID="TActivity11FDone" TABLE="TActivity11" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" FLAGS="16" />
      <CONDITION ID="TActivity11FDeleted" TABLE="TActivity11" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" FLAGS="16" />
      <ORDER FIELD="TActivity11ActivityK" INDEX="0" DESC="1" SQL="CASE WHEN TActivity11.FBeginD IS NOT NULL THEN TActivity11.FBeginD ELSE TActivity11.CreateD END" />
      <ORDERS NAME="Priority">
         <ORDER FIELD="TActivity11PriorityC" DESC="1" SQL="(SELECT _c.FRank FROM $O{CODE}TCode _c WHERE _c.CodeK=$T.PriorityC)" />
      </ORDERS>
      <CONDITIONS ID="All Activities" />
      <CONDITIONS ID="Documentation" SELECTED="1">
         <CONDITION ID="TActivity11TypeC" TABLE="TActivity11" OPERATOR="0" SIMPLEVALUE="Documentation" VALUE="3128" />
      </CONDITIONS>
      <CONDITIONS ID="High priority activities">
         <CONDITION ID="TActivity11FDeleted" TABLE="TActivity11" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" />
         <CONDITION ID="TActivity11PriorityC" TABLE="TActivity11" OPERATORNAME="GREATER" SIMPLEVALUE="Important" VALUE="4">
            <EXPRESSION>(SELECT _c.FRank FROM $O{CODE}TCode _c WHERE _c.CodeK=$T.PriorityC)</EXPRESSION>
         </CONDITION>
      </CONDITIONS>
      <CONDITIONS ID="Open Activities" SELECTED="1">
         <CONDITION ID="TActivity11FDone" TABLE="TActivity11" OPERATOR="0" SIMPLEVALUE="NO" VALUE="0" />
      </CONDITIONS>
      <ROWEDIT>
         <EDIT NAME="new_activity" SIMPLE="Activities" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
-- # Add record to TActivity
DECLARE @iSale INT = {{=SaleK}};
DECLARE @iCustomer BIGINT = {=ParentK};
IF @iCustomer IS NULL
   SET @iCustomer = (SELECT CustomerK FROM $OTSale WHERE SaleK = @iSale); -- get customer
                  
DECLARE @dateBegin DATETIME = {=FBeginD};
IF @dateBegin IS NULL
   SET @dateBegin = DATEADD(hour, DATEDIFF(hour,0,GETDATE()), 0)

DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TCustomer');
INSERT INTO $OTActivity (FDescription,TypeC,StateC,ServiceC,AreaC,UserK,FBeginD,CreateD,UpdateD,ParentK,table_number) 
VALUES({=FDescription},{=TypeC"0"},{=StateC"0"},0,0,{=UserK},@dateBegin,GETDATE(),GETDATE(),@iCustomer,@iTable);

DECLARE @iActivity BIGINT = (SELECT IDENT_CURRENT('$OTActivity'));
SET @iTable = (SELECT number FROM $Otable_number WHERE "name" = 'TActivity');
INSERT INTO $OTNote(RecordK,table_number,FNote) VALUES(@iActivity,@iTable,{=TActivity11Note})

-- # Add relation between sale and activity
INSERT INTO $OTrSaleXActivity VALUES(@iSale,@iActivity);
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTActivity')" />
         </EDIT>
      </ROWEDIT>
   </QUERY>

   <QUERY ID="Book: Configure page tree" FLAGS="1" KEY="77DA92916CBF41D5819B3532A32EC550" DESCRIPTION="Optimized to manage the tree strucutre for book pages">
      <ATTRIBUTE NAME="OUTPUT-TRUNCATE">[50,200]|50</ATTRIBUTE>
      <FIELD ID="TArticle2ArticleK" ALIAS="ID" TABLE="TArticle2"/>
      <FIELD ID="TArticle2SuperK" ALIAS="Parent" TABLE="TArticle2" FIELDFLAGNAMES="edit">
         <EDIT><![CDATA[
DECLARE @iSuper BIGINT = {{=TArticle2SuperK"NULL"}}
IF @iSuper <> ${@[$T]ArticleK}
BEGIN
   UPDATE $OTArticle SET SuperK=@iSuper WHERE ArticleK = ${@[$T]ArticleK};
   EXEC $OPROCEDURE_ChangeParentTreeNode 1160, ${@[$T]ArticleK}, @iSuper;
END
ELSE IF @iSuper IS NULL
   EXEC $OPROCEDURE_DeleteTreeNode 1160, ${@[$T]ArticleK}
         ]]></EDIT>
      </FIELD>
      <FIELD ID="TArticle2FBrief" ALIAS="Brief" TABLE="TArticle2" />
      <FIELD ID="TArticle2FText" ALIAS="Text" TABLE="TArticle2" FIELDFLAGNAMES="edit" />
      <ORDER FIELD="TArticle2SuperK" SQL="(SELECT TOP 1 ISNULL(_ac.FIndex,1000000) FROM $OTArticleChapter _ac JOIN $OTrArticleChapterXArticle x ON _ac.ArticleChapterK=x.ArticleChapterK WHERE x.ArticleK=$T.ArticleK)" />
      <ORDER FIELD="TArticle2SuperK" SQL="$T.FPage" />
      <ORDERS NAME="Chapters">
         <ORDER FIELD="TArticle2SuperK" SQL="(SELECT TOP 1 ISNULL(_ac.FIndex,1000000) FROM $OTArticleChapter _ac JOIN $OTrArticleChapterXArticle x ON _ac.ArticleChapterK=x.ArticleChapterK WHERE x.ArticleK=$T.ArticleK)" />
         <ORDER FIELD="TArticle2SuperK" SQL="$T.FPage" />
      </ORDERS>
   </QUERY>
   
   
   <QUERY ID="Article: Add book pages" FLAGS="1" KEY="536D18CD34572E4684CFC8E6FE3C06C0" >
      <ATTRIBUTE NAME="OUTPUT-TRUNCATE">[20,100]|100</ATTRIBUTE>
      <FIELD ID="TArticle2ArticleK" ALIAS="ID" TABLE="TArticle2"/>
      <FIELD ID="TArticle2FChapterName-Chapter" ALIAS="Chapter" TABLE="TArticle2" FIELDFLAGNAMES="edit">
         <ATTRIBUTE NAME="SERVER-CONDITIONLIST">
DECLARE @iBook BIGINT = {=TArticleBook1ArticleBookK};
IF @iBook IS NULL
   SET @iBook = (SELECT TOP 1 x.ArticleBookK FROM $OTrArticleBookXArticle x WHERE x.ArticleK={=TArticle2ArticleK})
SELECT TOP 200 t.FName _id, t.FName _name FROM $OTArticleChapter t WHERE t.ArticleBookK=@iBook ORDER BY 2 DESC            
         </ATTRIBUTE>
         <ATTRIBUTE NAME="SERVER-LIST">
DECLARE @iBook BIGINT = {=TArticleBook1ArticleBookK};
IF @iBook IS NULL
   SET @iBook = (SELECT TOP 1 x.ArticleBookK FROM $OTrArticleBookXArticle x WHERE x.ArticleK={=TArticle2ArticleK})
SELECT TOP 200 CAST(0 AS BIGINT) AS ArticleChapterK, '_ no chapter _' AS FChapterName UNION ALL SELECT t.ArticleChapterK, t.FName FROM $OTArticleChapter t WHERE t.ArticleBookK=@iBook ORDER BY 2 DESC            
         </ATTRIBUTE>
         <EDIT>
DECLARE @iChapter BIGINT = {{=TArticle2FChapterName-Chapter}}
DELETE FROM $OTrArticleChapterXArticle WHERE ArticleK = ${@TArticle2ArticleK} -- delete if article is already connected
IF @iChapter IS NOT NULL OR @iChapter &gt; 0
   INSERT INTO $OTrArticleChapterXArticle(ArticleChapterK,ArticleK) VALUES( @iChapter, ${@TArticle2ArticleK})
         </EDIT>
      </FIELD>
      <!-- <FIELD ID="TArticle2FChapterName" ALIAS="Chapter" TABLE="TArticle2" FIELDFLAGNAMES="edit" /> -->
      <FIELD ID="TArticle2FBrief" ALIAS="Brief" TABLE="TArticle2" FIELDFLAGNAMES="edit">
         <EDIT>
{
"update":"DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE \"name\" = 'TArticle');\nDECLARE @iArticle INT = ${@TArticle2ArticleK}\nDECLARE @sBrief NVARCHAR(500) = {=TArticle2FBrief}\n\nDELETE FROM $OTrXBadge WHERE ParentK = @iArticle AND table_number = @iTable\n\nIF LEN( @sBrief ) &gt; 2\nBEGIN\n   INSERT INTO $OTBadge (FName)\n   SELECT tag FROM $OPullTagsFromText( @sBrief ) LEFT JOIN $OTBadge _b ON tag = _b.FName\n   WHERE _b.FName IS NULL   \n\n   INSERT INTO $OTrXBadge (ParentK,table_number,BadgeK)\n   SELECT @iArticle, @iTable, _b.BadgeK\n   FROM $OTBadge _b JOIN $OPullTagsFromText( @sBrief ) ON _b.FName = tag\nEND",
"formula":"1"
}         </EDIT>
      </FIELD>
      <FIELD ID="TArticle2FText" ALIAS="Text" TABLE="TArticle2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TArticle2TypeC" ALIAS="Type" TABLE="TArticle2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TArticle2LevelC" ALIAS="Level" TABLE="TArticle2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TArticle2FPage" ALIAS="Page" TABLE="TArticle2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TArticle2TargetC" ALIAS="Target" TABLE="TArticle2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TArticle2VersionName" ALIAS="Version" TABLE="TArticle2" FIELDFLAGNAMES="edit">
         <ATTRIBUTES SERVER-LIST="SELECT CAST(0 AS INT) AS SystemVersionK, '_ no version _' AS FName UNION ALL SELECT t.SystemVersionK, CAST(t.FVersion1 AS NVARCHAR(5)) + ':' + CAST(t.FVersion2 AS NVARCHAR(5)) + ':' + CAST(t.FVersion3 AS NVARCHAR(5)) + ' - ' + (SELECT TOP 1 s.FName FROM $OTSystem s WHERE s.SystemK=t.SystemK) FROM $OTSystemVersion t WHERE t.FDeleted = 0 AND t.SystemK = (SELECT ParentK FROM $OTArticleBook WHERE ArticleBookK={==TArticleBook1ArticleBookK}) ORDER BY 2 DESC" />
         <EDIT>
DECLARE @iVersion INT = {{=TArticle2VersionName}}
DELETE FROM $OTrSystemVersionXArticle WHERE ArticleK = ${@TArticle2ArticleK} -- delete if article is already connected
IF @iVersion IS NOT NULL OR @iVersion &gt; 0
   INSERT INTO $OTrSystemVersionXArticle(SystemVersionK,ArticleK,CreateD,UpdateD) VALUES( @iVersion, ${@TArticle2ArticleK},GETDATE(),GETDATE())
         </EDIT>
      </FIELD>
      <FIELD ID="TArticle2Picture" ALIAS="Picture" TABLE="TArticle2" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-INPUT="file" />
         <EDIT>EXEC application.PROCEDURE_UpdateImage 'TArticle', ${@[$T]ArticleK}, {=TArticle2Picture}, {=extension}, {=mime}, {{=size}}, '{{=data}}'</EDIT>
      </FIELD>
      <FIELD ID="TArticle2ConnectionC" ALIAS="Connection" TABLE="TArticle2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TArticle2FSticky" ALIAS="Sticky" TABLE="TArticle2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TArticle2StateC" ALIAS="State" TABLE="TArticle2" FIELDFLAGNAMES="edit" />
      <ORDER FIELD="TArticle2FChapterName-Chapter" SQL="(SELECT TOP 1 ISNULL(_ac.FIndex,1000000) FROM $OTArticleChapter _ac JOIN $OTrArticleChapterXArticle x ON _ac.ArticleChapterK=x.ArticleChapterK WHERE x.ArticleK=$T.ArticleK)" />
      <ORDER FIELD="TArticle2FPage" />
      <ORDERS NAME="Chapters">
         <ORDER FIELD="TArticle2FPage" SQL="(SELECT TOP 1 ISNULL(_ac.FIndex,1000000) FROM $OTArticleChapter _ac JOIN $OTrArticleChapterXArticle x ON _ac.ArticleChapterK=x.ArticleChapterK WHERE x.ArticleK=$T.ArticleK)" />
         <ORDER FIELD="TArticle2FPage" />
      </ORDERS>
<!--      
      <CONDITION ID="TArticle2LevelC-Rank" TABLE="TArticle2" OPERATORNAME="LESS" VALUE="6" />
      <CONDITION ID="TArticle2FPage" TABLE="TArticle2" OPERATORNAME="GREATEREQUAL" VALUE="0" />
-->      
      <CONDITIONS ID="All" SELECTED="1" />
      <CONDITIONS ID="Admins">
         <CONDITION ID="TArticle2LevelC-Rank" TABLE="TArticle2" OPERATORNAME="LESS" VALUE="6" />
         <CONDITION ID="TArticle2FPage" TABLE="TArticle2" OPERATORNAME="GREATEREQUAL" VALUE="0" />
      </CONDITIONS>
      <CONDITIONS ID="Advanced">
         <CONDITION ID="TArticle2FPage" TABLE="TArticle2" OPERATORNAME="GREATEREQUAL" VALUE="0" />
      </CONDITIONS>
      <ROWEDIT>
         <EDIT NAME="new_article" SIMPLE="Activities" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION CACHE="0efd73ff-2e79-40b5-acfc-eff328fbd82f">
-- # Add record to TArticle table, records will also connect to table TArtcileBook using relation table TrArticleBookXArticle
DECLARE @iBook BIGINT = {{=ArticleBookK}};
DECLARE @iArticle BIGINT = {{=ArticleK}};
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TArticle');

DECLARE @iSuper BIGINT = {{=SuperK}}
IF @iSuper = 0 
   SET @iSuper = NULL

IF @iSuper IS NOT NULL -- If super than set book to same as super article
   SET @iBook = (SELECT TOP 1 ArticleBookK FROM $OTrArticleBookXArticle WHERE ArticleK = @iSuper);
   
IF @iBook IS NULL
   SET @iBook = {{=TArticleBook1ArticleBookK}};
   
IF @iBook IS NULL AND @iArticle IS NOT NULL
   SET @iBook = (SELECT TOP 1 ArticleBookK FROM $OTrArticleBookXArticle WHERE ArticleK=@iArticle)


DECLARE @iSystem INT = (SELECT ParentK FROM $OTArticleBook WHERE ArticleBookK=@iBook)
DECLARE @sBrief NVARCHAR(500) = {=FBrief};
DECLARE @iUser INT = {=UserK};
DECLARE @iChapter BIGINT = {=TArticle2FChapterName-Chapter}
DECLARE @iPage INT = {=FPage};
DECLARE @iSize INT = {{=Picture.size}}

IF @iUser IS NULL
   SET @iUser = {#V user "@@user"} -- default user is active user
   
IF @iPage IS NULL AND @iChapter IS NOT NULL
   SET @iPage = ISNULL((SELECT MAX(a.FPage) + 10 FROM $OTArticle a JOIN $OTrArticleChapterXArticle x ON a.ArticleK=x.ArticleK WHERE x.ArticleChapterK=@iChapter), 10)

INSERT INTO $OTArticle(SuperK,UserK,FBrief,FText,TypeC,LevelC,TargetC,StateC,LanguageC,FPage,FSticky,CreateD,UpdateD,ParentK,table_number)
VALUES(@iSuper,@iUser,@sBrief,{=FText},{=TypeC"0"},{=LevelC"0"},{=TargetC"0"},{=StateC"0"},0,@iPage,{=FSticky"0"},GETDATE(),GETDATE(),@iSystem,1010)

-- # Add relation between book and article
SET @iArticle = (SELECT IDENT_CURRENT('$OTArticle'));
INSERT INTO $OTrArticleBookXArticle(ArticleBookK,ArticleK) VALUES(@iBook,@iArticle);

IF @iChapter IS NOT NULL
   INSERT INTO $OTrArticleChapterXArticle(ArticleChapterK,ArticleK) VALUES(@iChapter,@iArticle)

IF LEN( @sBrief ) &gt; 2
BEGIN
   INSERT INTO $OTBadge (FName)
   SELECT tag FROM $OPullTagsFromText( @sBrief ) LEFT JOIN $OTBadge _b ON tag = _b.FName
   WHERE _b.FName IS NULL   

   INSERT INTO $OTrXBadge (ParentK,table_number,BadgeK)
   SELECT @iArticle, @iTable, _b.BadgeK
   FROM $OTBadge _b JOIN $OPullTagsFromText( @sBrief ) ON _b.FName = tag
END

IF @iSize IS NOT NULL -- Add picture if picture size is found
BEGIN
   EXEC application.PROCEDURE_UpdateImage @iTable, @iArticle, {=Picture.name},{=Picture.extension}, {=Picture.mime}, @iSize, '{{=Picture.data"00"}}'
END
               </EXPRESSION>
            </SQL>
            <PROPERTY NAME="columns">ArticleK,FPage</PROPERTY>
            <SQL TYPENAME="select" COMMAND="select-key">
               <EXPRESSION>
DECLARE @iArticle BIGINT = (SELECT IDENT_CURRENT('$OTArticle'))
SELECT ArticleK, FPage FROM $OTArticle WHERE ArticleK = @iArticle
               </EXPRESSION>
            </SQL>
         </EDIT>
      </ROWEDIT>
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE><![CDATA[ return function(g) local R, db=g.result, g.db
   R:SetValue('url','[' .. 
   '{"id": "slides","title":"Add to presentation", "icon": "fa-edit", "table":"TArticle2", "link": ["941FCC75BEFEC84EA15A695E9CDEDB43"]}' .. 
   ']') 
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
      
      <QUERYLINK TYPENAME="children" NAME="Slides"  DESCRIPTION="Add slides to presentation" KEY="941FCC75BEFEC84EA15A695E9CDEDB43" EXPRESSION="SELECT ArticleK AS value, 'ArticleK' AS name, FBrief AS simple FROM $OTArticle WHERE ArticleK={{==TArticle2}}">
         <PROPERTIES OUTPUT-WIDTH="1000" OUTPUT-HEIGHT="700" OUTPUT-POSITION="right-top" />
      </QUERYLINK>
   </QUERY>
   
   <QUERY ID="Article: Edit settings" KEY="AC8A9D401F89564EB220601C9ACA1B45" FLAGNAMES="NOTLISTED">
      <FIELD ID="TArticle2ArticleK" ALIAS="ID (Article)" TABLE="TArticle2"/>
      <FIELD ID="TArticle2FBrief" ALIAS="Brief" TABLE="TArticle2" />
      <FIELD ID="TArticle2TypeC" ALIAS="Type" TABLE="TArticle2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TArticle2StateC" ALIAS="State" TABLE="TArticle2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TArticle2LevelC" ALIAS="Level" TABLE="TArticle2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TArticle2FDepreciated" ALIAS="Depreciated" TABLE="TArticle2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TArticle2FDeleted" ALIAS="Deleted" TABLE="TArticle2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TArticle2FPage" ALIAS="Page" TABLE="TArticle2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TArticle2FText" ALIAS="Text" TABLE="TArticle2" FORMAT="CASE WHEN LEN($T.$F) &gt; 50 THEN CAST( $T.$F AS NVARCHAR( 48 ) ) + '...' ELSE $T.$F END" FIELDFLAGNAMES="sql_format" />
   </QUERY>
   
   <QUERY ID="Select hashtag" FLAGS="9" KEY="F6530633A2125642AC1FE83A39FE6026" FLAGNAMES="NOTLISTED">
      <FIELD ID="TBadge2BadgeK" ALIAS="ID" TABLE="TBadge2">
         <ATTRIBUTES OUTPUT-FORMAT="html|div|font-weight: bold; color: green;|@html &lt;i class='fas fa-external-link-alt' title='Select chapter (key: {value})' data-column='{column}' data-value='{value}'&gt;&lt;/i&gt;" />
      </FIELD>
      <FIELD ID="TBadge2FName" ALIAS="Name" TABLE="TBadge2">
         <ATTRIBUTES OUTPUT-FORMAT="html|div|font-weight: bold; color: #6ca0dc;" />         
      </FIELD>
      <ORDER FIELD="TBadge2FName" />
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="590398e1-01b4-4834-bbec-2e87ba4e84cc"><![CDATA[ return function(g) local R, db, sE=g.result, g.db, g.result:GetParam("event");
   R:SetValue('url','{"link": ["3A6199888668428BB73C6F26DDD67E6Dresult"],"table":"TArticle2"}' )
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
      <QUERYLINK TYPENAME="children" KEY="3A6199888668428BB73C6F26DDD67E6D" QUERY="AEA4B9753D454B6DAE0CDCE9922D6223" EXPRESSION="SELECT BadgeK AS value, 'ArticleK-BadgeK' AS name, FName AS simple , NULL AS table_id, 0 AS operator, 'condition_id' AS action FROM $OTBadge WHERE BadgeK={{=[0]}}" />
   </QUERY>   
  
   <QUERY ID="Book pages" KEY="AEA4B9753D454B6DAE0CDCE9922D6223">
      <ATTRIBUTE NAME="LUA-GETRESULT"><![CDATA[
-- If sticky condition is found in query, it has help. Remove it when query has been executed.
return function( g ) -- g = {q=q,result=result,db=db,application=application,user=user,on=1|2} on = 1 = before query is executed, on = 2 = after query has been executed
--[[
   local q = g.q
   local iSticky = q:GetConditionCount("TArticle2FSticky") -- count sticky conditions
   local iKeyCount = q:GetConditionCount("TArticle2ArticleK") -- count key conditions
   if iSticky == 0 then return end
   if g.on == 1 then -- if g.on == 1 then it is called before query is executed
      if iKeyCount > 1 then q:SetOrder({order_name="Reverse page order"})
      elseif iKeyCount == 1 then
         q:RemoveCondition({value="9417"})  
      end
   elseif g.on == 2 then -- if g.on == 2 then this is called after query is executed
      if iKeyCount > 1 then q:SetOrder({order_name="Thread view"}) end
      q:RemoveCondition({id="TArticle2FSticky"})  
   end
]]
end
      ]]></ATTRIBUTE>
      <FIELD ID="TArticle2ArticleK" ALIAS="ID" TABLE="TArticle2"/>
      <FIELD ID="TArticle2FChapterName-Chapter" ALIAS="Chapter" TABLE="TArticle2">
         <ATTRIBUTES OUTPUT-FORMAT="html|b|letter-spacing: 3px;font-size:250%; color: black;|[rowbefore one]" />
      </FIELD>
      <FIELD ID="TArticle2FBrief-Indent" ALIAS="Brief" TABLE="TArticle2">
         <ATTRIBUTES OUTPUT-FORMAT="hashtag|TArticle2.Hashtag" />
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='font-size:120%; font-weight: bold; color: #483D8B;'" />
      </FIELD>
      <FIELD ID="TArticle2CountLink" ALIAS="Links" TABLE="TArticle2" DESCRIPTION="Number of links for text">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 25px;" />
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right;' class='mark_note'|/^[1-9]" />
      </FIELD>
      <FIELD ID="TArticle2TypeC" ALIAS="Type" TABLE="TArticle2" />
      <FIELD ID="TArticle2TargetC" ALIAS="Target" TABLE="TArticle2" />
      <FIELD ID="TArticle2LevelC" ALIAS="Level" TABLE="TArticle2" />
      <FIELD ID="TArticle2FText" ALIAS="Text" TABLE="TArticle2">
         <ATTRIBUTES OUTPUT-FORMAT="`hashtag|TArticle2.Hashtag` `markdown|max-width: 1000px; overflow-x: auto; white-space: normal;|[row]|margin: 1em 3em; padding-left: 20px;max-width: 95%; border-left: 2px solid #CCC;`"
                     OUTPUT-STYLE="column|max-width: 20px;" />
      </FIELD>
      <FIELD ID="TArticle2FPage" ALIAS="Page" TABLE="TArticle2" />
      <FIELD ID="TArticle2VersionNameMajor" ALIAS="Version" TABLE="TArticle2" />
      <FIELD ID="TArticle2UpdateD" ALIAS="Updated" TABLE="TArticle2" FORMAT="CONVERT(VARCHAR, $T.$F, 12)" FIELDFLAGNAMES="sql_format" />
      <FIELD ID="TArticle2Picture" ALIAS="Pic" DESCRIPTION="Picture" TABLE="TArticle2">
         <ATTRIBUTES OUTPUT-FORMAT="image| |[row]|padding-left: 50px; margin: 3px;"
                     OUTPUT-STYLE="column|width: 20px;" />
      </FIELD>
      <FIELD ID="TArticle2ConnectionC" ALIAS="Connection" TABLE="TArticle2" FIELDFLAGNAMES="edit" />
      <ORDER FIELD="TArticle2ArticleK" SQL="ISNULL($T.FSticky,0)" DESC="1"/>
      <ORDER FIELD="TArticle2FChapterName-Chapter" SQL="ISNULL( (SELECT TOP 1 _ac.FIndex FROM $OTArticleChapter _ac JOIN $OTrArticleChapterXArticle x ON _ac.ArticleChapterK=x.ArticleChapterK WHERE x.ArticleK=$T.ArticleK), 1000000)" />
      <ORDER FIELD="TArticle2FPage" />
      <ORDERS NAME="Chapters">
         <ORDER FIELD="TArticle2FPage" SQL="ISNULL( (SELECT TOP 1 _ac.FIndex FROM $OTArticleChapter _ac JOIN $OTrArticleChapterXArticle x ON _ac.ArticleChapterK=x.ArticleChapterK WHERE x.ArticleK=$T.ArticleK), 1000000)" />
         <ORDER FIELD="TArticle2FPage" />
      </ORDERS>
      <ORDERS NAME="Thread view">
         <ORDER FIELD="TArticle2FPage" SQL="(SELECT TOP 1 ISNULL(_ac.FIndex,1000000) FROM $OTArticleChapter _ac JOIN $OTrArticleChapterXArticle x ON _ac.ArticleChapterK=x.ArticleChapterK WHERE x.ArticleK=$T.ArticleK)" />
         <ORDER FIELD="TArticle2ArticleK" INDEX="0" SQL="(SELECT TOP 1 _th.FThreadId FROM $Othread_header _th JOIN $Othread _t ON _th.FThreadId = _t.FThreadId AND _t.table_number=1160 WHERE _t.FKey=$T.ArticleK AND _th.table_number=1160)" />
         <ORDER FIELD="TArticle2ArticleK" INDEX="0" SQL="(SELECT TOP 1 _t.FPath FROM $Othread _t WHERE _t.FKey=$T.ArticleK AND _t.table_number=1160)" />
      </ORDERS>
      <ORDERS NAME="Reverse page order" DESCRIPTION="Usefull when result shows one selected post in combination with help about selection">
         <ORDER FIELD="TArticle2FPage" DESC="1" />
      </ORDERS>
      <GROUP OPERATORNAME="OR">#OR</GROUP>
      <GROUP OPERATORNAME="OR">OR2</GROUP>
      <!-- 
      <CONDITION ID="TArticle2FSticky" TABLE="TArticle2" OPERATORNAME="EQUAL" VALUE="9417" GROUP="#OR" CONDITIONFLAGNAMES="no_value no_merge" >
            <EXPRESSION>TArticle2.ArticleK IN (9410,9417)</EXPRESSION>
      </CONDITION>
      -->
      <CONDITION ID="TArticle2FDeleted" TABLE="TArticle2" OPERATORNAME="NOTEQUAL" VALUE="1" GROUP="OR2" />
      <CONDITION ID="TArticle2FDepreciated" TABLE="TArticle2" OPERATORNAME="NOTEQUAL" VALUE="1" GROUP="OR2" />
      <CONDITION ID="TArticle2StateC" TABLE="TArticle2" OPERATORNAME="NOTEQUAL" VALUE="4241" GROUP="OR2" SIMPLEVALUE="Draft" />
      <CONDITIONS ID="Admins">
         <CONDITION ID="TArticle2LevelC-Rank" TABLE="TArticle2" OPERATORNAME="LESS" VALUE="6" />
         <CONDITION ID="TArticle2FPage" TABLE="TArticle2" OPERATORNAME="GREATEREQUAL" VALUE="0" />
         <CONDITION ID="TArticle2StateC" TABLE="TArticle2" OPERATORNAME="NOTEQUAL" VALUE="4241" SIMPLEVALUE="Draft" />
      </CONDITIONS>
      <CONDITIONS ID="Advanced">
         <CONDITION ID="TArticle2FPage" TABLE="TArticle2" OPERATORNAME="GREATEREQUAL" VALUE="0" />
         <CONDITION ID="TArticle2StateC" TABLE="TArticle2" OPERATORNAME="NOTEQUAL" VALUE="4241" SIMPLEVALUE="Draft" />
      </CONDITIONS>
      <CONDITIONS ID="All" SELECTED="1">
         <CONDITION ID="TArticle2FDeleted" TABLE="TArticle2" OPERATORNAME="NOTEQUAL" VALUE="1" />
         <CONDITION ID="TArticle2FDepreciated" TABLE="TArticle2" OPERATORNAME="NOTEQUAL" VALUE="1" />
         <CONDITION ID="TArticle2StateC" TABLE="TArticle2" OPERATORNAME="NOTEQUAL" VALUE="4241" SIMPLEVALUE="Draft" />
      </CONDITIONS>
      <CONDITIONS ID="All including removed and drafts" />
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="9b2851c1-9bf0-4637-85ad-448257cb7685">
      <![CDATA[ return function(g) local R, db, sE=g.result, g.db, g.result:GetParam("event");
if sE == "click" then
   local iKeyPressed = R:GetParam("pressed")
   local iColumn = R:GetParam("column")
   if iKeyPressed == 0 then
      if iColumn == 3 then
         R:SetValue('url','{"link": ["A876BB4D3C6E4F6186E4C6EE66A59535zoom"],"table":"TArticle2"}' )  return
      end
   
      --R:SetValue('url','{"link": ["55B09801F3984917B4F141F6322F944Fresult"],"table":"TArticle2"}' )
   else
      if iColumn == 3 then
         R:SetValue('url','{"link": ["DC1A7EB9210B405B9B29A471896EB7C8"],"table":"TArticle2"}' )  return
      end

      --R:SetValue('url','{"title":"Activity - Edit", "link": ["55B09801F3984917B4F141F6322F944F"],"table":"TArticle2"}' )
   end
   return
end
            
R:SetValue('url','[' .. 
   '{"id": "edit","title":"Edit", "icon": "fa-i-cursor", "table":"TArticle2", "link": ["C7252C1F202240859C1A771ACB1A5D66"]},' ..    
   '{"id": "book","title":"View book", "icon": "fa-align-justify", "table":"TArticle2", "link": ["E5BB2FA1C43C45BDB1E725AB77D4F511zoom"]},' .. 
   '{"id": "article","title":"Beam Article", "icon": "fa-broadcast-tower", "table":"TArticle2", "link": ["E670C9938FFA48D3BAFCE7950E788958"]},' .. 
   '{"id": "article","title":"Beam Article as parent", "icon": "fa-broadcast-tower", "table":"TArticle2", "link": ["86B6247058994054BBF9A4E2186D1E06"]},' .. 
   '{"id": "articles_add_sub","title":"Add sub pages", "icon": "fa-edit", "table":"TArticle2", "link": ["13C70C99D62244D4BC74ACD57876F865"]},' ..
   '{"id": "chapter_view","title":"View chapters", "icon": "fa-align-justify", "table":"TArticleBook1", "link": ["71C91DEE3C5A4FDC8EC1114C7C18033Bzoom"]},' ..
   '{"id": "chapter_edit","title":"Chapters", "icon": "fa-edit", "table":"TArticleBook1", "link": ["53EEB85A00D04192ACC5215D7C6758DA"]},' ..
   '{"id": "links_view","title":"View links", "icon": "fa-align-justify", "table":"TArticle2", "link": ["A876BB4D3C6E4F6186E4C6EE66A59535zoom"]},' ..
   '{"id": "links_edit","title":"Edit links", "icon": "fa-edit", "table":"TArticle2", "link": ["DC1A7EB9210B405B9B29A471896EB7C8"]},' ..
   '{"id": "activity_edit","title":"Activity - Edit", "icon": "fa-edit", "table":"TArticle2", "link": ["55B09801F3984917B4F141F6322F944F"]},' ..
   '{"id": "activity_view","title":"Activity - View", "icon": "fa-align-justify", "table":"TArticle2", "link": ["55B09801F3984917B4F141F6322F944Fzoom"]},' ..    
   '{"id": "image_edit","title":"Images", "icon": "fa-edit", "table":"TArticle2", "link": ["5A8CCAEA79B5714FAF28174D76FBFBD1"]},' ..
   '{"id": "slides","title":"Add to presentation", "icon": "fa-edit", "table":"TArticle3", "link": ["941FCC75BEFEC84EA15A695E9CDEDB43"]}' .. 
   ']') 
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
      
      <QUERYLINK TYPENAME="record" NAME="Articles"  DESCRIPTION="Edit article" KEY="C7252C1F202240859C1A771ACB1A5D66" QUERY="536D18CD34572E4684CFC8E6FE3C06C0">
         <EXPRESSION>
SELECT TOP 1 ab.ArticleBookK AS value, 'TArticleBook1ArticleBookK' AS name, ab.FHeader  AS simple FROM $OTArticleBook ab JOIN $OTrArticleBookXArticle x ON ab.ArticleBookK=x.ArticleBookK WHERE x.ArticleK={{==TArticle2}}
UNION All
SELECT ArticleK value, 'ArticleK' AS name, (CASE WHEN FBrief IS NOT NULL THEN FBrief WHEN FHeader IS NOT NULL THEN FHeader ELSE LEFT(FText, 50) END) AS simple FROM $OTArticle WHERE ArticleK={{==TArticle2}}
         </EXPRESSION>
         <PROPERTIES OUTPUT-WIDTH="1900" OUTPUT-HEIGHT="500" OUTPUT-POSITION="center-bottom" />
      </QUERYLINK>

      <QUERYLINK TYPENAME="children" NAME="Books" DESCRIPTION="Books" KEY="E5BB2FA1C43C45BDB1E725AB77D4F511" QUERY="BDF6B05C0CF66F46817740CD67DB4ADF">
         <EXPRESSION>
SELECT TOP 1 ab.ArticleBookK AS value, 'ArticleBookK' AS name, ab.FHeader AS simple, 'TArticleBook1' AS "table" FROM $OTArticleBook ab JOIN $OTrArticleBookXArticle x ON ab.ArticleBookK=x.ArticleBookK WHERE x.ArticleK={{==TArticle2}}
         </EXPRESSION>
         <PROPERTIES OUTPUT-WIDTH="1100" OUTPUT-HEIGHT="300" OUTPUT-POSITION="right-bottom" />
      </QUERYLINK>

      <QUERYLINK TYPENAME="children" NAME="Articles"  DESCRIPTION="Edit articles" KEY="13C70C99D62244D4BC74ACD57876F865" QUERY="536D18CD34572E4684CFC8E6FE3C06C0">
         <EXPRESSION>
SELECT ArticleK AS value, 'SuperK' AS name, (CASE WHEN FBrief IS NOT NULL THEN FBrief WHEN FHeader IS NOT NULL THEN FHeader ELSE LEFT(FText, 50) END) AS simple FROM $OTArticle WHERE ArticleK={{==TArticle2}}
UNION ALL
SELECT ArticleBookK, 'TArticleBook1ArticleBookK', FHeader FROM $OTArticleBook WHERE ArticleBookK=(SELECT TOP 1 x.ArticleBookK FROM $OTrArticleBookXArticle x WHERE x.ArticleK={{==TArticle2}})
         </EXPRESSION>
         <PROPERTIES OUTPUT-WIDTH="2000" OUTPUT-HEIGHT="700" OUTPUT-POSITION="left-bottom" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Activities" DESCRIPTION="Edit articles" KEY="55B09801F3984917B4F141F6322F944F" EXPRESSION="SELECT ArticleK value, 'ArticleK' AS name, (CASE WHEN FBrief IS NOT NULL THEN FBrief WHEN FHeader IS NOT NULL THEN FHeader ELSE LEFT(FText, 50) END) AS simple  FROM $OTArticle WHERE ArticleK={{==TArticle2}}">
         <PROPERTIES OUTPUT-WIDTH="1200" OUTPUT-HEIGHT="700" OUTPUT-POSITION="right-bottom" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Slides"  DESCRIPTION="Add slides to presentation" KEY="941FCC75BEFEC84EA15A695E9CDEDB43" EXPRESSION="SELECT ArticleK AS value, 'ArticleK' AS name, FBrief AS simple FROM $OTArticle WHERE ArticleK={{==TArticle2}}">
         <PROPERTIES OUTPUT-WIDTH="1000" OUTPUT-HEIGHT="700" OUTPUT-POSITION="right-top" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Images"  DESCRIPTION="Add image" KEY="5A8CCAEA79B5714FAF28174D76FBFBD1" EXPRESSION="SELECT ArticleK AS value, 'ArticleK' AS name, FBrief AS simple FROM $OTArticle WHERE ArticleK={{==TArticle2}}">
         <PROPERTIES OUTPUT-WIDTH="700" OUTPUT-HEIGHT="250" OUTPUT-POSITION="left-bottom" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Chapters: view"  KEY="71C91DEE3C5A4FDC8EC1114C7C18033B" QUERY="D789DF86FAC34562850121D27756C3CE" 
                 EXPRESSION="SELECT x.ArticleBookK AS value, 'ArticleBookK' AS name, (SELECT _ab.FHeader FROM $OTArticleBook _ab WHERE _ab.ArticleBookK = x.ArticleBookK) AS simple FROM $OTArticle a JOIN $OTrArticleBookXArticle x ON a.ArticleK = x.ArticleK WHERE x.ArticleK = {{==TArticleBook1}}">
         <PROPERTIES OUTPUT-WIDTH="400" OUTPUT-HEIGHT="600" OUTPUT-POSITION="right-top|-30,100" OUTPUT-ROWS="20" />
      </QUERYLINK>
      
      <!-- book list 
      <QUERYLINK TYPENAME="children" NAME="Book list: view" DESCRIPTION="View book list" KEY="5F5318B0F4304988AFC5DBC4622C9EA9" QUERY="BDF6B05C0CF66F46817740CD67DB4ADF" 
                 EXPRESSION="SELECT TOP 1 abl.ArticleBookListK AS value, 'ArticleBookListK' AS name, abl.FName AS simple  FROM $OTArticleBookList abl JOIN $OTrArticleBookXArticleBookList x ON abl.ArticleBookListK=x.ArticleBookListK WHERE abl.ArticleBookListK = {=TArticleBookList2}">
         <PROPERTIES OUTPUT-WIDTH="700" OUTPUT-HEIGHT="150" OUTPUT-POSITION="right-bottom|-30,0" />
      </QUERYLINK>
      -->
      
      <!-- book list new -->
      <QUERYLINK TYPENAME="children" NAME="Book list: view" DESCRIPTION="View book list" KEY="DEA117A909DE4B94A8D70C39D58C474D" 
                 EXPRESSION="SELECT abl.ArticleBookListK AS value, 'ArticleBookListK' AS name, abl.FName AS simple  FROM $OTArticleBookList abl WHERE abl.ArticleBookListK = {=TArticleBookList2}">
         <PROPERTIES OUTPUT-WIDTH="700" OUTPUT-HEIGHT="150" OUTPUT-POSITION="right-bottom|-30,0" />
      </QUERYLINK>
      
      <QUERYLINK TYPENAME="children" NAME="Select chapter"  KEY="B510C1D203054C4D98B0215AAE499B5E" QUERY="834B38CB86B0453E8497FE460DECE8C0">
         <EXPRESSION TYPENAME="UPDATE">
UPDATE $OTArticleBook SET FCount1 = ISNULL(FCount1,0) + 1 WHERE ArticleBookK={{==TArticleBook1}};
         </EXPRESSION>
         <EXPRESSION>
SELECT ArticleBookK AS value, 'ArticleBookK' AS name, FHeader AS simple  FROM $OTArticleBook WHERE ArticleBookK={{==TArticleBook1}};
         </EXPRESSION>
         <PROPERTIES OUTPUT-WIDTH="400" OUTPUT-HEIGHT="600" OUTPUT-POSITION="right-top|-30,100" OUTPUT-ROWS="20" />
      </QUERYLINK>
      
      <QUERYLINK TYPENAME="children" NAME="Select hashtag"  KEY="1020353390C04EC29BBB190BD4899306" QUERY="F6530633A2125642AC1FE83A39FE6026">
         <EXPRESSION>
SELECT ArticleBookK AS value, 'ArticleBookK' AS name, FHeader AS simple  FROM $OTArticleBook WHERE ArticleBookK={{==TArticleBook1}};
         </EXPRESSION>
         <PROPERTIES OUTPUT-WIDTH="350" OUTPUT-HEIGHT="280" OUTPUT-POSITION="right-bottom|-30,0" OUTPUT-ROWS="10" />
      </QUERYLINK>
      

      <QUERYLINK TYPENAME="children" NAME="Links"  DESCRIPTION="Edit links" KEY="DC1A7EB9210B405B9B29A471896EB7C8" EXPRESSION="SELECT ArticleK AS value, 'ArticleK' AS name, FBrief AS simple FROM $OTArticle WHERE ArticleK={{==TArticle2}}">
         <PROPERTIES OUTPUT-WIDTH="700" OUTPUT-HEIGHT="250" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Links" DESCRIPTION="View links" KEY="A876BB4D3C6E4F6186E4C6EE66A59535" EXPRESSION="SELECT ArticleK AS value, 'ArticleK' AS name, FBrief AS simple FROM $OTArticle WHERE ArticleK={{==TArticle2}}">
         <PROPERTIES OUTPUT-WIDTH="500" OUTPUT-HEIGHT="200" OUTPUT-POSITION="center-top" />
      </QUERYLINK>
      
      
      <QUERYLINK TYPENAME="children" NAME="Chapters"  DESCRIPTION="Edit chapters" KEY="53EEB85A00D04192ACC5215D7C6758DA" 
                 EXPRESSION="SELECT x.ArticleBookK AS value, 'ArticleBookK' AS name, (SELECT _ab.FHeader FROM $OTArticleBook _ab WHERE _ab.ArticleBookK = x.ArticleBookK) AS simple FROM $OTArticle a JOIN $OTrArticleBookXArticle x ON a.ArticleK = x.ArticleK WHERE x.ArticleK = {{==TArticleBook1}}">
         <PROPERTIES OUTPUT-WIDTH="700" OUTPUT-HEIGHT="250" OUTPUT-POSITION="left-top" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="message" NAME="Article" DESCRIPTION="Beam article key" KEY="E670C9938FFA48D3BAFCE7950E788958" EXPRESSION="SELECT ArticleK value, 'ArticleK' AS name, (CASE WHEN FBrief IS NOT NULL THEN FBrief WHEN FHeader IS NOT NULL THEN FHeader ELSE LEFT(FText, 50) END) AS simple  FROM $OTArticle WHERE ArticleK={{==TArticle2}}">
         <PROPERTIES OUTPUT-COMMAND="send key" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="message" NAME="Article" DESCRIPTION="Beam article key as parent" KEY="86B6247058994054BBF9A4E2186D1E06" EXPRESSION="SELECT ArticleK value, 'SuperK' AS name, (CASE WHEN FBrief IS NOT NULL THEN FBrief WHEN FHeader IS NOT NULL THEN FHeader ELSE LEFT(FText, 50) END) AS simple  FROM $OTArticle WHERE ArticleK={{==TArticle2}}">
         <PROPERTIES OUTPUT-COMMAND="send key" />
      </QUERYLINK>
   </QUERY>
   
   <QUERY ID="Article links" DESCRIPTION="Links article" KEY="DC1A7EB9210B405B9B29A471896EB7C8" FLAGNAMES="NOTLISTED">
      <ATTRIBUTE NAME="OUTPUT-TRUNCATE">[20,50,200]|50</ATTRIBUTE>
      <FIELD ID="TLink6LinkK" ALIAS="ID" TABLE="TLink6"/>
      <FIELD ID="TLink6TypeC" ALIAS="Type" TABLE="TLink6" FIELDFLAGNAMES="edit" />
      <FIELD ID="TLink6FUrl" ALIAS="Url" TABLE="TLink6" FIELDFLAGNAMES="edit" />
      <FIELD ID="TLink6FName" ALIAS="Name" TABLE="TLink6" FIELDFLAGNAMES="edit" />
      <FIELD ID="TLink6FDescription" ALIAS="Description" TABLE="TLink6" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="new_link" SIMPLE="Book link" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
DECLARE @iArticle BIGINT = {{=ArticleK}}
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TArticle');
INSERT INTO $OTLink(ParentK,table_number,TypeC,FUrl,FName,FDescription,CreateD,UpdateD)
VALUES(@iArticle,@iTable,{=TypeC"0"},{=FUrl},{=FName},{=FDescription},GETDATE(),GETDATE())
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTLink')" />
         </EDIT>
         <EDIT NAME="delete link" SIMPLE="Delete link" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $OTLink WHERE LinkK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
   </QUERY>

   <QUERY ID="Open links for article" DESCRIPTION="Links related to book" KEY="A876BB4D3C6E4F6186E4C6EE66A59535">
      <ATTRIBUTE NAME="OUTPUT-TRUNCATE">[20,50,200]|50</ATTRIBUTE>
      <FIELD ID="TLink6LinkK" ALIAS="ID" TABLE="TLink6"/>
      <FIELD ID="TLink6TypeC" ALIAS="Type" TABLE="TLink6" />
      <FIELD ID="TLink6FUrl-Goto" ALIAS="Link" TABLE="TLink6" />
      <FIELD ID="TLink6FDescription" ALIAS="Description" TABLE="TLink6">
         <ATTRIBUTES OUTPUT-FORMAT="markdown|padding: 0px; padding-bottom: 25px; width: 97%; overflow-x: auto; white-space: normal;|[row]"
                     OUTPUT-STYLE="column|max-width: 20px;" />
      </FIELD>
   </QUERY>
   
   
   <QUERY ID="Print book pages" KEY="721FF87318124BDC9CCE19EB67A3244B">
      <FIELD ID="TArticle2TypeC" ALIAS="Type" TABLE="TArticle2" />
      <FIELD ID="TArticle2TargetC" ALIAS="Target" TABLE="TArticle2" />
      <FIELD ID="TArticle2LevelC" ALIAS="Level" TABLE="TArticle2" />
      <FIELD ID="TArticle2FText" ALIAS="Text" TABLE="TArticle2">
         <ATTRIBUTES OUTPUT-FORMAT="markdown|padding: 0px; padding-bottom: 25px; width: 97%; overflow-x: auto; white-space: normal;|[row]"
                     OUTPUT-STYLE="column|max-width: 30px;" />
      </FIELD>
      <FIELD ID="TArticle2FPage" ALIAS="Page" TABLE="TArticle2" />
      <ORDER FIELD="TArticle2FPage" />
   </QUERY>

   <QUERY ID="Chapters" KEY="53EEB85A00D04192ACC5215D7C6758DA" FLAGNAMES="NOTLISTED">
      <FIELD ID="TArticleChapter1ArticleChapterK" ALIAS="ID (Chapter)" TABLE="TArticleChapter1"/>
      <FIELD ID="TArticleChapter1SuperK" ALIAS="Parent" TABLE="TArticleChapter1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES SERVER-LIST="SELECT CAST(NULL AS INT) AS ArticleChapterK, '_ no parent _' AS FName UNION ALL SELECT _ac.ArticleChapterK, COALESCE(_ac.FName,_ac.FHeader,'') FROM $OTArticleChapter _ac  WHERE _ac.ArticleBookK={{=TArticleBook1ArticleBookK}} ORDER BY 2" />
      </FIELD>
      <FIELD ID="TArticleChapter1FName" ALIAS="Name" TABLE="TArticleChapter1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TArticleChapter1FIndex" ALIAS="Index" TABLE="TArticleChapter1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TArticleChapter1TypeC" ALIAS="Type" TABLE="TArticleChapter1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TArticleChapter1StateC" ALIAS="State" TABLE="TArticleChapter1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TArticleChapter1FText" ALIAS="Description" TABLE="TArticleChapter1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TArticleChapter1FHelp" ALIAS="Help" TABLE="TArticleChapter1" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="new_chapter" SIMPLE="Chapters" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION CACHE="00000000-0000-0000-0000-000000000000">
DECLARE @iBook BIGINT = {{=ArticleBookK}};
DECLARE @iSuper INT = {{=SuperK}}
IF @iSuper = 0 SET @iSuper = NULL

INSERT INTO $OTArticleChapter (ArticleBookK,SuperK,FName,TypeC,FText,FIndex,FHelp,CreateD,UpdateD) 
VALUES(@iBook,@iSuper,{=FName},{=TypeC"0"},{=FText},{=FIndex},{=FHelp},GETDATE(),GETDATE());
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTArticleChapter')" />
         </EDIT>
         <EDIT NAME="delete chapter" SIMPLE="Delete Chapter" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $OTArticleChapter WHERE ArticleChapterK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   
   <!-- TODO: fixa den här så den fungerar som ett fönster för att navigera kapitel i bok -->
   <QUERY ID="Chapters: Select pages" KEY="D789DF86FAC34562850121D27756C3CE" FLAGNAMES="NOTLISTED">
      <FIELD ID="TArticleChapter1ArticleChapterK" ALIAS="ID (Chapter)" TABLE="TArticleChapter1">
         <ATTRIBUTES OUTPUT-FORMAT="html|div|font-weight: bold; color: green;|@html &lt;i class='fas fa-external-link-alt' title='Select chapter (key: {value})' data-column='{column}' data-value='{value}'&gt;&lt;/i&gt;" />         
      </FIELD>
      <FIELD ID="TArticleChapter1FName-Indent" ALIAS="Name" TABLE="TArticleChapter1">
         <ATTRIBUTES OUTPUT-FORMAT="html|div|font-weight: bold; color: blue;" />         
      </FIELD>
      <FIELD ID="TArticleChapter1FIndex" ALIAS="Index" TABLE="TArticleChapter1" DESCRIPTION="Chapter index, in what order chapters are" />
      <FIELD ID="TArticleChapter1CountArticle" ALIAS="Count" TABLE="TArticleChapter1" DESCRIPTION="Articles connected to chapter" />
      <FIELD ID="TArticleChapter1FText" ALIAS="Desc" TABLE="TArticleChapter1" DESCRIPTION="Chapter description">
         <ATTRIBUTES OUTPUT-FORMAT="html|div|margin: 0.1em 1em 0.5em; padding-left: 5px; max-width: 95%; border-left: 2px solid #CCC; color: #555; font-style: italic; overflow-x: auto;|[row]" 
                     OUTPUT-STYLE="column|max-width: 20px;" />
      </FIELD>
      <ORDER FIELD="TArticleChapter1FIndex" />
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="a57d6c2a-e84f-4298-b944-86b6ced5d7ed"><![CDATA[ return function(g) local R, db, sE=g.result, g.db, g.result:GetParam("event");
   R:SetValue('url','{"link": ["977D109C27F74F5BBAD94FC6BC1B05F5result"],"table":"TArticle2"}' )
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
      <QUERYLINK TYPENAME="children" KEY="977D109C27F74F5BBAD94FC6BC1B05F5" QUERY="AEA4B9753D454B6DAE0CDCE9922D6223">
         <EXPRESSION>
DECLARE @iChapter BIGINT = {{=[0]}}
SELECT ArticleChapterK AS value, 'ChapterThreadPath' AS name,CONCAT( (SELECT b.FHeader FROM $OTArticleBook b WHERE b.ArticleBookK=TArticleChapter.ArticleBookK ), ': ', FName) AS simple, NULL AS table_id, 0 AS operator, 'condition_id' AS action FROM $OTArticleChapter WHERE ArticleChapterK=@iChapter
         </EXPRESSION>
      </QUERYLINK>
   </QUERY>
   
   <QUERY ID="Select text for chapter" KEY="834B38CB86B0453E8497FE460DECE8C0" FLAGNAMES="NOTLISTED">
      <FIELD ID="TArticleChapter1ArticleChapterK" ALIAS="ID (Chapter)" TABLE="TArticleChapter1">
         <ATTRIBUTES OUTPUT-FORMAT="html|div|font-weight: bold; color: green;|@html &lt;i class='fas fa-external-link-alt' title='Select chapter (key: {value})' data-column='{column}' data-value='{value}'&gt;&lt;/i&gt;" />         
      </FIELD>
      <FIELD ID="TArticleChapter1FName" ALIAS="Name" TABLE="TArticleChapter1">
         <ATTRIBUTES OUTPUT-FORMAT="html|div|font-weight: bold; color: #4f86f7;" />         
      </FIELD>
      <FIELD ID="TArticleChapter1FText" ALIAS="Desc" TABLE="TArticleChapter1" DESCRIPTION="Chapter description">
         <ATTRIBUTES OUTPUT-FORMAT="html|div|margin: 0.1em 1em 0.5em; padding-left: 5px; max-width: 95%; border-left: 2px solid #CCC; color: #555; font-style: italic; overflow-x: auto;|[row]" 
                     OUTPUT-STYLE="column|max-width: 20px;" />
      </FIELD>
      <FIELD ID="TArticleChapter1FHelp" ALIAS="(?)" TABLE="TArticleChapter1">
         <ATTRIBUTES OUTPUT-FORMAT="markdown||[rowbefore]|&lt;div class='bg-info' style='border-radius: 10px; padding: 2px;' &gt;&lt;div class='bg-info' style='margin: 0px 15px; text-align: right;' &gt; &lt;/div&gt;&lt;/div&gt;" />
      </FIELD>
      <CONDITION ID="TArticleChapter1CountArticle" TABLE="TArticleChapter1" OPERATORNAME="GREATER" SIMPLEVALUE="1 page or more" VALUE="0" />
      <ORDER FIELD="TArticleChapter1ArticleChapterK" SQL="TArticleChapter1.FIndex" />
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="7a3172c3-2837-4176-aae4-9ca99b6547ed"><![CDATA[ return function(g) local R, db, sE=g.result, g.db, g.result:GetParam("event");
   R:SetValue('url','{"link": ["977D109C27F74F5BBAD94FC6BC1B05F5result"],"table":"TArticle2"}' )
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
      <QUERYLINK TYPENAME="children" KEY="977D109C27F74F5BBAD94FC6BC1B05F5" QUERY="AEA4B9753D454B6DAE0CDCE9922D6223">
         <EXPRESSION>
DECLARE @iChapter BIGINTT = {{=[0]}}
SELECT ArticleChapterK AS value, 'ChapterThreadPath' AS name,CONCAT( (SELECT b.FHeader FROM $OTArticleBook b WHERE b.ArticleBookK=TArticleChapter.ArticleBookK ), ': ', FName) AS simple, NULL AS table_id, 0 AS operator, 'condition_id' AS action FROM $OTArticleChapter WHERE ArticleChapterK=@iChapter
-- SELECT ArticleChapterK AS value, 'ArticleK-ArticleChapterK' AS name,CONCAT( (SELECT b.FHeader FROM $OTArticleBook b WHERE b.ArticleBookK=TArticleChapter.ArticleBookK ), ': ', FName) AS simple, NULL AS table_id, 0 AS operator, 'condition_id' AS action FROM $OTArticleChapter WHERE ArticleChapterK={{=[0]}}
         </EXPRESSION>
      </QUERYLINK>
   </QUERY>
   

   <QUERY ID="Book lists: edit" KEY="671312291974C54B8184B98830571C4C" DESCRIPTION="Lists book lists, booklists are used to group books">
      <FIELD ID="TArticleBookList1ArticleBookListK" ALIAS="ID" TABLE="TArticleBookList1"/>
      <FIELD ID="TArticleBookList1FName" ALIAS="Name" TABLE="TArticleBookList1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TArticleBookList1FDescription" ALIAS="Description" TABLE="TArticleBookList1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TArticleBookList1TypeC" ALIAS="Type" TABLE="TArticleBookList1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TArticleBookList1StateC" ALIAS="State" TABLE="TArticleBookList1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TArticleBookList1FReady" ALIAS="Ready" TABLE="TArticleBookList1" FIELDFLAGNAMES="edit" />
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="b263932d-81ae-44d0-a643-f54ffbf51d46"><![CDATA[ return function(g) local R, db, sE=g.result, g.db, g.result:GetParam("event");
   R:SetValue('url','[' .. 
'{"id": "books","title":"Connect books to list", "icon": "fa-edit", "table":"TArticleBookList1", "link": ["E245D87B1014497C823BCBD515AE9C97"]}' ..
   ']') 
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
      <ROWEDIT>
         <EDIT NAME="new_booklist" SIMPLE="Book link" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
DECLARE @iSystem BIGINT = {{=SystemK}}
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TSystem');

INSERT INTO $OTArticleBookList(ParentK,table_number,FName,FDescription,TypeC,StateC,FReady,CreateD,UpdateD)
VALUES(@iSystem,@iTable,{=FName"''"},{=FDescription"''"},{=TypeC"0"},{=StateC"0"},{=FReady"0"},GETDATE(),GETDATE())
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTArticleBookList')" />
         </EDIT>
         <EDIT NAME="delete link" SIMPLE="Delete link" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $OTArticleBookList WHERE ArticleBookListK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
      <QUERYLINK TYPENAME="children" NAME="Connect books"  DESCRIPTION="Connect books to list" KEY="E245D87B1014497C823BCBD515AE9C97" EXPRESSION="SELECT ArticleBookListK value, 'ArticleBookListK' AS name, FName AS Simple FROM $OTArticleBookList WHERE ArticleBookListK={{==[0]}}">
         <PROPERTIES OUTPUT-WIDTH="700" OUTPUT-HEIGHT="300" OUTPUT-POSITION="left-center" />
      </QUERYLINK>
   </QUERY>
   
   <QUERY ID="Book list: Connect books" KEY="E245D87B1014497C823BCBD515AE9C97" DESCRIPTION="Connect books to book list" FLAGNAMES="NOTLISTED">
      <ATTRIBUTE NAME="OUTPUT-LIST">Activities,20</ATTRIBUTE>
      <FIELD ID="TrArticleBookXArticleBookList1rArticleBookXArticleBookListK" ALIAS="ID" TABLE="TrArticleBookXArticleBookList1"/>
      <FIELD ID="TrArticleBookXArticleBookList1ArticleBookK" ALIAS="Book" TABLE="TrArticleBookXArticleBookList1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TrArticleBookXArticleBookList1FDescription" ALIAS="Description" TABLE="TrArticleBookXArticleBookList1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TrArticleBookXArticleBookList1FOrder" ALIAS="Order" TABLE="TrArticleBookXArticleBookList1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TrArticleBookXArticleBookList1FHelp" ALIAS="(?)" TABLE="TrArticleBookXArticleBookList1" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="new_connected_book" SIMPLE="Book link" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
DECLARE @iArticleBookList BIGINT = {{==ArticleBookListK}}
INSERT INTO $OTrArticleBookXArticleBookList(ArticleBookListK,ArticleBookK,FDescription,FHelp,FOrder)
VALUES(@iArticleBookList,{=ArticleBookK},{=FDescription},{=FHelp},{=FOrder"0"})
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTrArticleBookXArticleBookList')" />
         </EDIT>
         <EDIT NAME="delete link" SIMPLE="Delete link" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $OTrArticleBookXArticleBookList WHERE rArticleBookXArticleBookListK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   <QUERY ID="Book lists" KEY="C5611B772767477CA61A1402BF92359D" FLAGNAMES="NOTLISTED">
      <FIELD ID="ArticleBookListK" ALIAS="ID" TABLE="TArticleBookList1" />
      <FIELD ID="FName" ALIAS="Book name" TABLE="TArticleBookList1" />
      <FIELD ID="FDescription" ALIAS="Description" TABLE="TArticleBookList1" />
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="833cece5-e9e6-461d-8749-45eb21824d95"><![CDATA[ return function(g) local R, db, sE=g.result, g.db, g.result:GetParam("event");
            
R:SetValue('url','[' .. 
   '{"id": "books","title":"Books in list", "icon": "fa-align-justify", "table":"TArticleBook1", "query": "C5611B772767477CA61A1402BF92359D", "link": ["BDF6B05C0CF66F46817740CD67DB4ADFzoom"]}' ..
   ']') 
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
      <QUERYLINK TYPENAME="children" DESCRIPTION="Lists books for list" KEY="BDF6B05C0CF66F46817740CD67DB4ADF" EXPRESSION="SELECT ArticleBookListK AS value, 'ArticleBookListK' AS name, FName AS simple, 'TArticleBook1' AS _table  FROM $OTArticleBookList WHERE ArticleBookListK={{==[0]}}">
         <PROPERTIES OUTPUT-WIDTH="800" OUTPUT-HEIGHT="300" OUTPUT-POSITION="right-bottom" />         
      </QUERYLINK>
   </QUERY>

   <QUERY ID="Book list" KEY="DEA117A909DE4B94A8D70C39D58C474D" FLAGNAMES="NOTLISTED">
      <PROPERTY NAME="LINKS_FROM">BDF6B05C0CF66F46817740CD67DB4ADF</PROPERTY>
      <FIELD ID="TArticleBook1ArticleBookK" ALIAS="ID (Book)" TABLE="TArticleBook1"/>
      <FIELD ID="TrArticleBookXArticleBookList1FDescription" ALIAS="Indented header" TABLE="TrArticleBookXArticleBookList1"/>
      <FIELD ID="TrArticleBookXArticleBookList1FHelp" ALIAS="(?)" TABLE="TrArticleBookXArticleBookList1">
         <ATTRIBUTES OUTPUT-FORMAT="markdown||[rowbefore]|&lt;div class='bg-info' style='border-radius: 10px; padding: 2px;' &gt;&lt;div style='margin: 0px 15px; text-align: right;' &gt; &lt;/div&gt;&lt;/div&gt;" />
      </FIELD>
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="0331911e-0927-4eea-8b43-67d44fd34381"><![CDATA[ return function(g) local R, db, sE=g.result, g.db, g.result:GetParam("event");
-- if sE == "click" then
   R:SetValue('url','{"link": ["BE8050ECC27B40168DC885F809DDD043result","B510C1D203054C4D98B0215AAE499B5Ezoom"],"table":"TArticleBook1"}' )
--   return
-- end
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
      <QUERYLINK TYPENAME="children" NAME="Read pages"  DESCRIPTION="Read articles" KEY="BE8050ECC27B40168DC885F809DDD043" QUERY="AEA4B9753D454B6DAE0CDCE9922D6223" EXPRESSION="SELECT ArticleBookK AS value, 'ArticleBookK' AS name, FHeader AS simple  FROM $OTArticleBook WHERE ArticleBookK={{==TArticleBook1}}">
         <PROPERTIES OUTPUT-WIDTH="1000" OUTPUT-HEIGHT="500" OUTPUT-POSITION="left-bottom" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Select chapter"  KEY="B510C1D203054C4D98B0215AAE499B5E" QUERY="834B38CB86B0453E8497FE460DECE8C0" EXPRESSION="SELECT ArticleBookK AS value, 'ArticleBookK' AS name, FHeader AS simple  FROM $OTArticleBook WHERE ArticleBookK={{==TArticleBook1}}">
         <PROPERTIES OUTPUT-WIDTH="400" OUTPUT-HEIGHT="600" OUTPUT-POSITION="right-top|-50,100" OUTPUT-ROWS="20" />
      </QUERYLINK>
   </QUERY>

   <QUERY ID="Books for system" KEY="BDF6B05C0CF66F46817740CD67DB4ADF">
      <ATTRIBUTE NAME="OUTPUT-LIST">Conditional,1000</ATTRIBUTE>
      <FIELD ID="TArticleBook1ArticleBookK" ALIAS="ID (Book)" TABLE="TArticleBook1"/>
      <FIELD ID="TArticleBook1Indent.FHeader" ALIAS="Indented header" TABLE="TArticleBook1"/>
      <FIELD ID="TArticleBook1FName" ALIAS="Name" TABLE="TArticleBook1">
         <ATTRIBUTES OUTPUT-FORMAT="hashtag|TArticleBook1.Hashtag" />
      </FIELD>
      <FIELD ID="TArticleBook1TypeC" ALIAS="Type" TABLE="TArticleBook1"/>
      <FIELD ID="TArticleBook1StateC" ALIAS="State" TABLE="TArticleBook1"/>
      <FIELD ID="TArticleBook1UpdateD" ALIAS="Update" TABLE="TArticleBook1" FORMAT="CAST( $T.$F AS DATE )" FIELDFLAGNAMES="sql_format" />
      <FIELD ID="TArticleBook1FReleased" ALIAS="Released" TABLE="TArticleBook1" FORMAT="CAST( $T.$F AS DATE )" FIELDFLAGNAMES="sql_format" />
      <FIELD ID="TArticleBook1CountArticle" ALIAS="Pages" TABLE="TArticleBook1" DESCRIPTION="Pages or text records in book">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 25px;" />
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right; padding-right: 0.5em;' class='mark_note'|/^[1-9]" />
      </FIELD>
      <FIELD ID="TArticleBook1Note" ALIAS="Note" TABLE="TArticleBook1">
         <ATTRIBUTES OUTPUT-FORMAT="`hashtag|TArticleBook1.Hashtag`  `markdown||[row]|padding: 0px; opacity: 0.7; overflow-x: auto; overflow-y: scroll; white-space: normal;padding-left: 50px;`"
                     OUTPUT-STYLE="column|max-width: 25px;" />
      </FIELD>
      <FIELD ID="TArticleBook1CountLink" ALIAS="Links" TABLE="TArticleBook1" DESCRIPTION="Number of added links for book">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 25px;" />
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right; padding-right: 0.5em;' class='mark_note'|/^[1-9]" />
      </FIELD>
      <ORDER FIELD="TArticleBook1ArticleBookK" INDEX="0" SQL="(SELECT TOP 1 _th.FThreadId FROM $Othread_header _th JOIN $Othread _t ON _th.FThreadId = _t.FThreadId AND _t.table_number=1170 WHERE _t.FKey=TArticleBook1.ArticleBookK AND _th.table_number=1170)" />
      <ORDER FIELD="TArticleBook1ArticleBookK" INDEX="0" SQL="(SELECT TOP 1 _t.FPath FROM $Othread _t WHERE _t.FKey=TArticleBook1.ArticleBookK AND _t.table_number=1170)" />
      <ORDERS NAME="Latest modified book pages" DESCRIPTION="Order books after last modified page in book">
         <ORDER FIELD="TArticleBook1ArticleBookK" DESC="1" SQL="(SELECT TOP 1 _a.UpdateD FROM $OTrArticleBookXArticle x JOIN $OTArticle _a ON x.ArticleK=_a.ArticleK WHERE x.ArticleBookK=TArticleBook1.ArticleBookK ORDER BY _a.UpdateD DESC)" />
      </ORDERS>
      <ORDERS NAME="Thread view">
         <ORDER FIELD="TArticleBook1ArticleBookK" INDEX="0" SQL="(SELECT TOP 1 _th.FThreadId FROM $Othread_header _th JOIN $Othread _t ON _th.FThreadId = _t.FThreadId AND _t.table_number=1170 WHERE _t.FKey=TArticleBook1.ArticleBookK AND _th.table_number=1170)" />
         <ORDER FIELD="TArticleBook1ArticleBookK" INDEX="0" SQL="(SELECT TOP 1 _t.FPath FROM $Othread _t WHERE _t.FKey=TArticleBook1.ArticleBookK AND _t.table_number=1170)" />
      </ORDERS>
      <CONDITIONS ID="Select filter!" SELECTED="1"/>
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="1466e83e-3ad5-4587-b543-1bc6c58ecaf3"><![CDATA[ return function(g) local R, db, sE=g.result, g.db, g.result:GetParam("event");
if sE == "click" then
   local iColumn = R:GetParam("column")
   if iColumn == 6 then
      R:SetValue('url','{"link": ["BE8050ECC27B40168DC885F809DDD043result"],"table":"TArticleBook1"}' ) return
   elseif iColumn == 8 then
      R:SetValue('url','{"link": ["8512DA4837284DDF9657704D65823506zoom"],"table":"TArticleBook1"}' ) return
   else
      R:SetValue('url','{"link": ["BE8050ECC27B40168DC885F809DDD043result","90E4B34E56D8410580E1FCAE5CB0CC37zoom"],"table":"TArticleBook1"}' )
      return
   end      
end
            
R:SetValue('url','[' .. 
   '{"id": "edit","title":"Edit Book", "icon": "fa-i-cursor", "table":"TArticleBook1", "link": ["644CCA1BB65A49F3929BD49E67811AA3"]},' ..    
   '{"child": "Edit"},' .. 
   '{"id": "articles_add","title":"Add book pages", "icon": "fa-edit", "table":"TArticleBook1", "link": ["536D18CD34572E4684CFC8E6FE3C06C0"]},' ..
   '{"id": "articles_add_child","title":"Article tree", "icon": "fa-edit", "table":"TArticleBook1", "link": ["77DA92916CBF41D5819B3532A32EC550"]},' ..
   '{"id": "articles_settings","title":"Edit pages settings", "icon": "fa-edit", "table":"TArticleBook1", "link": ["AC8A9D401F89564EB220601C9ACA1B45"]},' ..
   '{"id": "links","title":"Edit links", "icon": "fa-edit", "table":"TArticleBook1", "link": ["A406796504D34476B183AEECCF2724D4"]},' ..
   '{"id": "book","title":"Add child books", "icon": "fa-share-alt-square", "table":"TArticleBook1", "link": ["03B52D05DBC340268B279B1EDFED5ACC"]},' .. 
   '{"id": "chapters","title":"Edit chapters", "icon": "fa-edit", "table":"TArticleBook1", "link": ["53EEB85A00D04192ACC5215D7C6758DA"]},' ..    
   '{"parent": 1},' ..
   '{"id": "articles_view","title":"View book pages", "icon": "fa-align-justify", "table":"TArticleBook1", "link": ["BE8050ECC27B40168DC885F809DDD043result"]},' ..
   '{"id": "articles_view","title":"Print book pages", "icon": "fa-print", "table":"TArticleBook1", "link": ["721FF87318124BDC9CCE19EB67A3244Bresult"]},' ..
   '{"id":"---------"},' ..
   '{"id": "chapters","title":"Select chapter", "icon": "fa-map-marker", "table":"TArticleBook1", "link": ["90E4B34E56D8410580E1FCAE5CB0CC37zoom"]},' ..
   '{"id": "links","title":"View links", "icon": "fa-align-justify", "table":"TArticleBook1", "link": ["8512DA4837284DDF9657704D65823506zoom"]},' ..
   '{"id": "book","title":"Lists with book", "icon": "fa-share-alt-square", "table":"TArticleBook1", "link": ["92C7A02509014461AAE56AAF9EBF8C7Czoom"]},' ..
   '{"id":"---------"},' ..
   '{"id": "system","title":"View system", "icon": "fa-align-justify", "table":"TArticleBook1", "link": ["51631D5334E94251B38234D3E6C63AC9result"]},' ..
   '{"id": "book_beam","title":"Beam book key", "icon": "fa-broadcast-tower", "table":"TArticleBook1", "link": ["9DBE11E5C05F4C8FB3A85C1EF790C8D2"]}' ..
   ']') 
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
      
      <QUERYLINK TYPENAME="record" NAME="Books"  DESCRIPTION="Edit Book" KEY="644CCA1BB65A49F3929BD49E67811AA3" QUERY="87595A00949C31499CE831438BA08D94">
         <EXPRESSION>
SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK=(SELECT ParentK FROM $OTArticleBook ab WHERE ab.ArticleBookK={{==TArticleBook1}} AND ab.table_number=1010)
UNION All
SELECT ArticleBookK value, 'ArticleBookK' AS name, COALESCE(FHeader,FName) AS simple FROM $OTArticleBook WHERE ArticleBookK={{==TArticleBook1}}
         </EXPRESSION>
         <PROPERTIES OUTPUT-WIDTH="1900" OUTPUT-HEIGHT="500" OUTPUT-POSITION="center-bottom" />
      </QUERYLINK>
      
      <QUERYLINK TYPENAME="children" NAME="Articles"  DESCRIPTION="Edit articles" KEY="536D18CD34572E4684CFC8E6FE3C06C0" EXPRESSION="SELECT ArticleBookK AS value, 'ArticleBookK' AS name, FHeader AS simple  FROM $OTArticleBook WHERE ArticleBookK={{==TArticleBook1}}">
         <PROPERTIES OUTPUT-WIDTH="2000" OUTPUT-HEIGHT="700" OUTPUT-POSITION="left-bottom" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Articles to configure tree"  DESCRIPTION="Edit article tree" KEY="77DA92916CBF41D5819B3532A32EC550" EXPRESSION="SELECT ArticleBookK AS value, 'ArticleBookK' AS name, FHeader AS simple  FROM $OTArticleBook WHERE ArticleBookK={{==TArticleBook1}}">
         <PROPERTIES OUTPUT-WIDTH="700" OUTPUT-HEIGHT="500" OUTPUT-POSITION="center-top" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Activities"  DESCRIPTION="Edit articles" KEY="AC8A9D401F89564EB220601C9ACA1B45" EXPRESSION="SELECT ArticleBookK AS value, 'ArticleBookK' AS name, FHeader AS simple  FROM $OTArticleBook WHERE ArticleBookK={{==TArticleBook1}}">
         <PROPERTIES OUTPUT-WIDTH="1200" OUTPUT-HEIGHT="500" OUTPUT-POSITION="left-bottom" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Read pages"  DESCRIPTION="Read articles" KEY="BE8050ECC27B40168DC885F809DDD043" QUERY="AEA4B9753D454B6DAE0CDCE9922D6223" EXPRESSION="SELECT ArticleBookK AS value, 'ArticleBookK' AS name, FHeader AS simple  FROM $OTArticleBook WHERE ArticleBookK={{==TArticleBook1}}">
         <PROPERTIES OUTPUT-WIDTH="1000" OUTPUT-HEIGHT="500" OUTPUT-POSITION="left-bottom" />
      </QUERYLINK>

      <QUERYLINK TYPENAME="children" NAME="Pages"  DESCRIPTION="Show pages for book in main" KEY="5BD90062851847438FE6B456AA9F2624" QUERY="AEA4B9753D454B6DAE0CDCE9922D6223" EXPRESSION="SELECT ArticleBookK AS value, 'ArticleBookK' AS name, FHeader AS simple  FROM $OTArticleBook WHERE ArticleBookK={{==TArticleBook1}}" />

      <QUERYLINK TYPENAME="children" NAME="Print pages"  DESCRIPTION="Print articles" KEY="721FF87318124BDC9CCE19EB67A3244B" EXPRESSION="SELECT ArticleBookK AS value, 'ArticleBookK' AS name, FHeader AS simple  FROM $OTArticleBook WHERE ArticleBookK={{==TArticleBook1}}" />
      <QUERYLINK TYPENAME="children" NAME="Edit book links"  DESCRIPTION="Add links to book" KEY="A406796504D34476B183AEECCF2724D4" EXPRESSION="SELECT ArticleBookK AS value, 'ArticleBookK' AS name, FHeader AS simple  FROM $OTArticleBook WHERE ArticleBookK={{==TArticleBook1}}" />
      <QUERYLINK TYPENAME="children" NAME="View book links"  DESCRIPTION="Add links to book" KEY="8512DA4837284DDF9657704D65823506" EXPRESSION="SELECT ArticleBookK AS value, 'ArticleBookK' AS name, FHeader AS simple  FROM $OTArticleBook WHERE ArticleBookK={{==TArticleBook1}}">
         <PROPERTIES OUTPUT-WIDTH="600" OUTPUT-HEIGHT="300" OUTPUT-POSITION="left-bottom" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Chapters"  KEY="53EEB85A00D04192ACC5215D7C6758DA" EXPRESSION="SELECT ArticleBookK AS value, 'ArticleBookK' AS name, FHeader AS simple  FROM $OTArticleBook WHERE ArticleBookK={{==TArticleBook1}}">
         <PROPERTIES OUTPUT-WIDTH="1000" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Select chapter"  KEY="90E4B34E56D8410580E1FCAE5CB0CC37" QUERY="D789DF86FAC34562850121D27756C3CE" EXPRESSION="SELECT ArticleBookK AS value, 'ArticleBookK' AS name, FHeader AS simple  FROM $OTArticleBook WHERE ArticleBookK={{==TArticleBook1}}">
         <PROPERTIES OUTPUT-WIDTH="400" OUTPUT-HEIGHT="600" OUTPUT-POSITION="right-top|-50,100" OUTPUT-ROWS="20" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Sub book"  DESCRIPTION="Sub books to selected" KEY="03B52D05DBC340268B279B1EDFED5ACC" EXPRESSION="SELECT ArticleBookK AS value, 'SuperK' AS name, FHeader AS simple  FROM $OTArticleBook WHERE ArticleBookK={{==TArticleBook1}}" />
      <QUERYLINK TYPENAME="message" NAME="Book" DESCRIPTION="Beam book key" KEY="9DBE11E5C05F4C8FB3A85C1EF790C8D2" EXPRESSION="SELECT ArticleBookK AS value, 'ArticleBookK' AS name, FHeader AS simple  FROM $OTArticleBook WHERE ArticleBookK={{==TArticleBook1}}">
         <PROPERTIES OUTPUT-COMMAND="send key" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME=""  DESCRIPTION="Lists books is connected to book" KEY="92C7A02509014461AAE56AAF9EBF8C7C" QUERY="C5611B772767477CA61A1402BF92359D" EXPRESSION="SELECT ArticleBookK AS value, 'TArticleBookList1ArticleBookK' AS name, FHeader AS simple, 'TArticleBookList1' AS table  FROM $OTArticleBook WHERE ArticleBookK={{==TArticleBook1}}" />

      <QUERYLINK TYPENAME="children" NAME="System" KEY="51631D5334E94251B38234D3E6C63AC9" QUERY="F12429A8B23A06449ABA71A4A88D853E">
         <EXPRESSION>
SELECT ParentK AS value, 'SystemK' AS name, FHeader AS simple, 'TSystem1' as "table" FROM $OTArticleBook WHERE table_number = 1010 AND ArticleBookK={{==TArticleBook1}}
         </EXPRESSION>
      </QUERYLINK>
   </QUERY>

   <QUERY ID="Book links" DESCRIPTION="Links related to book" KEY="A406796504D34476B183AEECCF2724D4" FLAGNAMES="NOTLISTED">
      <ATTRIBUTE NAME="OUTPUT-TRUNCATE">[20,50,200]|50</ATTRIBUTE>
      <FIELD ID="TLink5LinkK" ALIAS="ID" TABLE="TLink5"/>
      <FIELD ID="TLink5TypeC" ALIAS="Type" TABLE="TLink5" FIELDFLAGNAMES="edit" />
      <FIELD ID="TLink5FUrl" ALIAS="Url" TABLE="TLink5" FIELDFLAGNAMES="edit" />
      <FIELD ID="TLink5FName" ALIAS="Name" TABLE="TLink5" FIELDFLAGNAMES="edit" />
      <FIELD ID="TLink5FDescription" ALIAS="Description" TABLE="TLink5" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="new_link" SIMPLE="Book link" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
DECLARE @iBook INT = {{=ArticleBookK}}
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TArticleBook');
INSERT INTO $OTLink(ParentK,table_number,TypeC,FUrl,FName,FDescription,CreateD,UpdateD)
VALUES(@iBook,@iTable,{=TypeC"0"},{=FUrl},{=FName},{=FDescription},GETDATE(),GETDATE())
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTLink')" />
         </EDIT>
         <EDIT NAME="delete link" SIMPLE="Delete link" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $OTLink WHERE LinkK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
   </QUERY>

   <QUERY ID="Open links for book" DESCRIPTION="Links related to book" KEY="8512DA4837284DDF9657704D65823506">
      <ATTRIBUTE NAME="OUTPUT-TRUNCATE">[20,50,200]|50</ATTRIBUTE>
      <FIELD ID="TLink5LinkK" ALIAS="ID" TABLE="TLink5"/>
      <FIELD ID="TLink5TypeC" ALIAS="Type" TABLE="TLink5" />
      <FIELD ID="TLink5FUrl-Goto" ALIAS="Link" TABLE="TLink5" />
      <FIELD ID="TLink5FDescription" ALIAS="Description" TABLE="TLink5">
         <ATTRIBUTES OUTPUT-FORMAT="`hashtag|TLink5.Hashtag` `markdown|padding: 0px; padding-bottom: 25px; width: 97%; overflow-x: auto; white-space: normal;|[row]`"
                     OUTPUT-STYLE="column|max-width: 20px;" />
      </FIELD>
   </QUERY>

   <QUERY ID="Books: Add sub" DESCRIPTION="List books" KEY="03B52D05DBC340268B279B1EDFED5ACC" FLAGNAMES="NOTLISTED">
      <FIELD ID="TArticleBook1ArticleBookK" ALIAS="ID (Book)" TABLE="TArticleBook1"/>
      <FIELD ID="TArticleBook1FHeader" ALIAS="Header" TABLE="TArticleBook1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TArticleBook1FName" ALIAS="Name" TABLE="TArticleBook1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TArticleBook1TypeC" ALIAS="Type" TABLE="TArticleBook1" FIELDFLAGNAMES="edit"/>
      <ROWEDIT>
         <EDIT NAME="new_book" SIMPLE="Books" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
-- # Add record to TArticleBook
DECLARE @iSystem INT
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TSystem');
DECLARE @iSuper INT = {{=SuperK}}
IF @iSuper = 0 
   SET @iSuper = NULL
ELSE   
   SET @iSystem = (SELECT ParentK FROM $OTArticleBook WHERE ArticleBookK = @iSuper AND table_number=@iTable);
   
DECLARE @iUser INT = {=UserK};
IF @iUser IS NULL
   SET @iUser = {#V user "@@user"} -- default user is active user
   
   
INSERT INTO $OTArticleBook (FHeader,FName,TypeC,StateC,LanguageC,UserK,CreateD,UpdateD,ParentK,table_number,SuperK) 
VALUES({=FHeader},{=FName},{=TypeC"0"},0,0,@iUser,GETDATE(),GETDATE(),@iSystem,@iTable,@iSuper);
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTArticleBook')" />
         </EDIT>
      </ROWEDIT>
   </QUERY>

   <QUERY ID="Books" DESCRIPTION="List books" KEY="8610140C5C7D4A42B42A32316C5BB3AA">
      <ATTRIBUTE NAME="OUTPUT-LIST">Important,3</ATTRIBUTE>
      <PROPERTY NAME="LINKS_FROM">BDF6B05C0CF66F46817740CD67DB4ADF</PROPERTY>
      <FIELD ID="TArticleBook1ArticleBookK" ALIAS="ID (Book)" TABLE="TArticleBook1"/>
      <FIELD ID="TSystem1FName" ALIAS="System" TABLE="TSystem1">
         <ATTRIBUTES OUTPUT-FORMAT="html|b|letter-spacing: 2px;font-size:120%; color: black;|[rowbefore one]" />
      </FIELD>
      <FIELD ID="TArticleBook1FHeader" ALIAS="Book" TABLE="TArticleBook1">
         <ATTRIBUTES OUTPUT-FORMAT="hashtag|TArticleBook1.Hashtag" />
      </FIELD>
      <FIELD ID="TArticleBook1TypeC" ALIAS="Type" TABLE="TArticleBook1"/>
      <FIELD ID="TArticleBook1StateC" ALIAS="State" TABLE="TArticleBook1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TArticleBook1PriorityC" ALIAS="Priority" TABLE="TArticleBook1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TArticleBook1CountArticle" ALIAS="Pages" TABLE="TArticleBook1" DESCRIPTION="Pages or text records in book">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 25px;" />
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right; padding-right: 0.5em;' class='mark_note'|/^[1-9]" />
      </FIELD>
      <FIELD ID="TArticleBook1CountLink" ALIAS="Links" TABLE="TArticleBook1" DESCRIPTION="Number of added links for book">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 25px;" />
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right; padding-right: 0.5em;' class='mark_note'|/^[1-9]" />
      </FIELD>
      <FIELD ID="TArticleBook1CreateD" ALIAS="Create" TABLE="TArticleBook1"/>
      <CONDITION ID="TArticleBook1CountArticle" TABLE="TArticleBook1" OPERATORNAME="GREATER" SIMPLEVALUE="1 page or more" VALUE="0" />
      <CONDITIONS ID="All books" SELECTED="1"/>
      <CONDITIONS ID="Books with pages" SELECTED="1">
         <CONDITION ID="TArticleBook1CountArticle" TABLE="TArticleBook1" OPERATORNAME="GREATER" SIMPLEVALUE="1 page or more" VALUE="0" />
      </CONDITIONS>
      <CONDITIONS ID="Active books">
         <CONDITION ID="TArticleBook1StateC" TABLE="TArticleBook1" OPERATORNAME="GREATER" SIMPLEVALUE="Important" VALUE="7">
            <EXPRESSION>(SELECT _c.FRank FROM $O{CODE}TCode _c WHERE _c.CodeK=$T.StateC)</EXPRESSION>
         </CONDITION>
      </CONDITIONS>
      <CONDITIONS ID="Active and released">
         <CONDITION ID="TArticleBook1StateC" TABLE="TArticleBook1" OPERATORNAME="GREATER" SIMPLEVALUE="Important" VALUE="5">
            <EXPRESSION>(SELECT _c.FRank FROM $O{CODE}TCode _c WHERE _c.CodeK=$T.StateC)</EXPRESSION>
         </CONDITION>
      </CONDITIONS>
      <CONDITIONS ID="Important books">
         <CONDITION ID="TArticleBook1PriorityC" TABLE="TArticleBook1" OPERATORNAME="GREATER" SIMPLEVALUE="Important" VALUE="4">
            <EXPRESSION>(SELECT _c.FRank FROM $O{CODE}TCode _c WHERE _c.CodeK=$T.PriorityC)</EXPRESSION>
         </CONDITION>
      </CONDITIONS>
      <CONDITIONS ID="XML: Create systems">
         <CONDITION ID="TSystem1SystemK" TABLE="TSystem1" OPERATOR="0" SIMPLEVALUE="XML files for select configuration" VALUE="57" />
      </CONDITIONS>
      <SELECTCONDITIONS>
         <SELECTCONDITION ID="UserK" TABLE="TArticleBook1"/>
      </SELECTCONDITIONS>
      <ORDER FIELD="TArticleBook1CreateD" DESC="1" />
      <ORDERS NAME="Latest modified book pages" DESCRIPTION="Order books after last modified page in book">
         <ORDER FIELD="TArticleBook1ArticleBookK" DESC="1" SQL="(SELECT TOP 1 _a.UpdateD FROM $OTrArticleBookXArticle x JOIN $OTArticle _a ON x.ArticleK=_a.ArticleK WHERE x.ArticleBookK=TArticleBook1.ArticleBookK ORDER BY _a.UpdateD DESC)" />
      </ORDERS>
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="52acf963-47e2-4535-b064-12e9378d5503">
               <![CDATA[ return function(g) local R, db, sE=g.result, g.db, g.result:GetParam("event");
if sE == "click" then 
   local iColumn = R:GetParam("column")
   if iColumn == 7 then
      R:SetValue('url','{"link": ["8512DA4837284DDF9657704D65823506zoom"],"table":"TArticleBook1"}' ) return
   elseif iColumn == 6 then
      R:SetValue('url','{"link": ["BE8050ECC27B40168DC885F809DDD043zoom"],"table":"TArticleBook1"}' )  
   else
      R:SetValue('url','{"link": ["5BD90062851847438FE6B456AA9F2624result","90E4B34E56D8410580E1FCAE5CB0CC37zoom"],"table":"TArticleBook1"}' )  
   end      
   return 
end

R:SetValue('url','[' .. 
   '{"id": "edit","title":"Edit Book", "icon": "fa-i-cursor", "table":"TArticleBook1", "link": ["644CCA1BB65A49F3929BD49E67811AA3"]},' ..    
   '{"child": "Edit"},' .. 
   '{"id": "articles_add","title":"Add book pages", "icon": "fa-edit", "table":"TArticleBook1", "link": ["536D18CD34572E4684CFC8E6FE3C06C0"]},' ..
   '{"id": "articles_add_child","title":"Article tree", "icon": "fa-edit", "table":"TArticleBook1", "link": ["77DA92916CBF41D5819B3532A32EC550"]},' ..
   '{"id": "articles_settings","title":"Edit pages settings", "icon": "fa-edit", "table":"TArticleBook1", "link": ["AC8A9D401F89564EB220601C9ACA1B45"]},' ..
   '{"id": "links","title":"Edit links", "icon": "fa-edit", "table":"TArticleBook1", "link": ["A406796504D34476B183AEECCF2724D4"]},' ..
   '{"id": "book","title":"Add child books", "icon": "fa-share-alt-square", "table":"TArticleBook1", "link": ["03B52D05DBC340268B279B1EDFED5ACC"]},' .. 
   '{"id": "chapters","title":"Edit chapters", "icon": "fa-edit", "table":"TArticleBook1", "link": ["53EEB85A00D04192ACC5215D7C6758DA"]},' ..    
   '{"parent": 1},' ..
   '{"id": "chapters","title":"Select chapter", "icon": "fa-map-marker", "table":"TArticleBook1", "link": ["90E4B34E56D8410580E1FCAE5CB0CC37zoom"]},' ..   
   '{"id": "links","title":"View links", "icon": "fa-align-justify", "table":"TArticleBook1", "link": ["8512DA4837284DDF9657704D65823506zoom"]},' ..
   '{"id": "articles_view","title":"View book pages", "icon": "fa-align-justify", "table":"TArticleBook1", "link": ["5BD90062851847438FE6B456AA9F2624result"]}' ..    
   ']') 
end  ]]>
            </CODE>
         </SCRIPT>
      </SCRIPTS>
   </QUERY>



   <QUERY ID="Books: for systems" KEY="87595A00949C31499CE831438BA08D94" FLAGNAMES="NOTLISTED">
      <FIELD ID="TArticleBook1ArticleBookK" ALIAS="ID" TABLE="TArticleBook1"/>
      <FIELD ID="TArticleBook1FHeader" ALIAS="Header" TABLE="TArticleBook1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TArticleBook1FName" ALIAS="Name" TABLE="TArticleBook1" FIELDFLAGNAMES="edit">
         <EDIT>
{
"update":"DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE \"name\" = 'TArticleBook');\nDECLARE @iArticleBook BIGINT = ${@TArticleBook1ArticleBookK}\nDECLARE @sName NVARCHAR(1000) = {=TArticleBook1FName}\n\nDELETE FROM $OTrXBadge WHERE ParentK = @iArticleBook AND table_number = @iTable\n\nIF LEN( @sName ) &gt; 2\nBEGIN\n-- Add missing hashtags to Badge table\n   INSERT INTO $OTBadge (FName)\n   SELECT tag FROM $OPullTagsFromText( @sName ) LEFT JOIN $OTBadge _b ON tag = _b.FName\n   WHERE _b.FName IS NULL   \n\n-- Connect hashtags to ArticleBook record\n   INSERT INTO $OTrXBadge (ParentK,table_number,BadgeK)\n   SELECT @iArticleBook, @iTable, _b.BadgeK\n   FROM $OTBadge _b JOIN $OPullTagsFromText( @sName ) ON _b.FName = tag\nEND\n",
"formula":"1"
}         </EDIT>
      </FIELD>
      <FIELD ID="TArticleBook1Note" ALIAS="Note" TABLE="TArticleBook1" FIELDFLAGNAMES="edit">
         <EDIT>
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TArticleBook');
IF (SELECT COUNT(*) FROM $OTNote WHERE RecordK=${@ArticleBookK} AND table_number=@iTable) = 0
   INSERT INTO $OTNote (RecordK, table_number) VALUES(${@ArticleBookK},@iTable)

UPDATE $OTNote SET FNote={=TArticleBook1Note} WHERE RecordK=${@ArticleBookK} AND table_number=@iTable
         </EDIT>
      </FIELD>
      <FIELD ID="TArticleBook1TypeC" ALIAS="Type" TABLE="TArticleBook1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TArticleBook1StateC" ALIAS="State" TABLE="TArticleBook1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TArticleBook1LevelC" ALIAS="Level" TABLE="TArticleBook1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TArticleBook1PriorityC" ALIAS="Priority" TABLE="TArticleBook1" FIELDFLAGNAMES="edit"/>
      <ROWEDIT>
         <EDIT NAME="new_book" SIMPLE="Books" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
DECLARE @iSystem INT = {{=SystemK}};
DECLARE @sHeader NVARCHAR(1000) = {=FHeader};
DECLARE @sName NVARCHAR(500) = {=FName};

DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TSystem');
INSERT INTO $OTArticleBook (FHeader,FName,TypeC,StateC,LanguageC,LevelC,PriorityC,UserK,CreateD,UpdateD,ParentK,table_number) 
VALUES(@sHeader,@sName,{=TypeC"0"},{=StateC"0"},0,{=LevelC"0"},{=StateC"0"},{=UserK},GETDATE(),GETDATE(),@iSystem,@iTable);

DECLARE @iArticleBook BIGINT = (SELECT IDENT_CURRENT('$OTArticleBook'));
SET @iTable = (SELECT number FROM $Otable_number WHERE "name" = 'TArticleBook');
INSERT INTO $OTNote(RecordK,table_number,FNote) VALUES(@iArticleBook,@iTable,{=TArticleBook1Note})

DECLARE @iBook BIGINT = (SELECT IDENT_CURRENT('$OTArticleBook'));

SET @sHeader = CONCAT(@sHeader, ' ', @sName)
EXEC $OPROCEDURE_UpdateBadge @sHeader, 'TArticleBook', @iBook
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTArticleBook')" />
         </EDIT>
         <EDIT NAME="delete book" SIMPLE="Delete book" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-book" EXPRESSION='DELETE FROM $OTArticleBook WHERE ArticleBookK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
   </QUERY>

   <QUERY ID="Customer" KEY="B124EF3E32790A44817150F735A04C64" DESCRIPTION="List customers.&lt;br&gt;Open or edit sales from customer.&lt;br&gt;Open or edit contacts from customer.">
      <ATTRIBUTE NAME="OUTPUT-LIST">Primary</ATTRIBUTE>
      <FIELD ID="TCustomer1CustomerK" ALIAS="ID" TABLE="TCustomer1"/>
      <FIELD ID="TCustomer1FName-Indent" ALIAS="Name" TABLE="TCustomer1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TCustomer1FDescription" ALIAS="Description" TABLE="TCustomer1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="hashtag|TCustomer1.Hashtag" />
         <EDIT>{"update":"application.PROCEDURE_UpdateBadge {=TCustomer1FDescription}, 'TCustomer', ${@TCustomer1CustomerK}","formula":"1"}</EDIT>
      </FIELD>
      <FIELD ID="TCustomer1CountActivity" ALIAS="act" TABLE="TCustomer1" DESCRIPTION="Number of activities not closed for Customer">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 25px;" />
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right;' class='mark_note'|/^[1-9]" />
         <CONDITIONGROUP>
            <FIELDCONDITION ID="FDone" OPERATOR="0" VALUE="0" SIMPLEVALUE="NO"/>
         </CONDITIONGROUP>
      </FIELD>
      <FIELD ID="TCustomer1CountSale" ALIAS="sale" TABLE="TCustomer1" DESCRIPTION="Number of activities not closed for Customer">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 25px;" />
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right;' class='mark_note'|/^[1-9]" />
         <CONDITIONGROUP>
            <FIELDCONDITION ID="FDone" OPERATOR="0" VALUE="0" SIMPLEVALUE="NO"/>
         </CONDITIONGROUP>
      </FIELD>
      <FIELD ID="TCustomer1TypeC" ALIAS="Type" TABLE="TCustomer1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TCustomer1CategoryC" ALIAS="Category" TABLE="TCustomer1" FIELDFLAGNAMES="edit" />
      <ORDER FIELD="TCustomer1CustomerK" INDEX="0" SQL="(SELECT TOP 1 _th.FThreadId FROM $Othread_header _th JOIN $Othread _t ON _th.FThreadId = _t.FThreadId AND _t.table_number=1030 WHERE _t.FKey=TCustomer1.CustomerK AND _th.table_number=1030)" />
      <ORDER FIELD="TCustomer1CustomerK" INDEX="0" SQL="(SELECT TOP 1 _t.FPath FROM $Othread _t WHERE _t.FKey=TCustomer1.CustomerK AND _t.table_number=1030)" />
      <ORDERS NAME="Thread view">
         <ORDER FIELD="TCustomer1CustomerK" INDEX="0" SQL="(SELECT TOP 1 _th.FThreadId FROM $Othread_header _th JOIN $Othread _t ON _th.FThreadId = _t.FThreadId AND _t.table_number=1030 WHERE _t.FKey=TCustomer1.CustomerK AND _th.table_number=1030)" />
         <ORDER FIELD="TCustomer1CustomerK" INDEX="0" SQL="(SELECT TOP 1 _t.FPath FROM $Othread _t WHERE _t.FKey=TCustomer1.CustomerK AND _t.table_number=1030)" />
      </ORDERS>
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="36187800-32b6-4df7-8bfd-98d385d57ab5">
               <![CDATA[ return function(g) local R, db, sE=g.result, g.db, g.result:GetParam("event");
if sE == "click" then
   local iKeyPressed = R:GetParam("pressed")
   local iColumn = R:GetParam("column")
   if iKeyPressed == 0 then
      if iColumn == 3 then R:SetValue('url','{"link": ["6CC3172D6ABA4A0DB1980E903B3154BBzoom"],"table":"TCustomer1"}' )  return
      elseif iColumn == 4 then R:SetValue('url','{"link": ["72BC3FA82387944DA6339CB436BF2E7Bzoom"],"table":"TCustomer1"}' )  return end
   else
      if iColumn == 3 then R:SetValue('url','{"title":"Activities: edit","link": ["6CC3172D6ABA4A0DB1980E903B3154BB"],"table":"TCustomer1"}' ) return
      elseif iColumn == 4 then R:SetValue('url','{"title":"Sales: edit","link": ["72BC3FA82387944DA6339CB436BF2E7B"],"table":"TCustomer1"}' ) return
      end
   end
end

R:SetValue('url','[' .. 
   '{"id": "activities","title":"Activities: edit", "icon": "fa-edit", "table":"TCustomer1", "link": ["6CC3172D6ABA4A0DB1980E903B3154BB"]},' .. 
   '{"id": "view_activities","title":"Activities: view", "icon": "fa-align-justify", "table":"TCustomer1", "link": ["FE2F3F06F59840809CFD19C5B1F24DF3zoom"]},' .. 
   '{"id": "view_sales","title":"View Sales", "icon": "fa-align-justify", "table":"TCustomer1", "link": ["72BC3FA82387944DA6339CB436BF2E7Bzoom"]},' ..    
   '{"id": "add_sales","title":"Edit Sales", "icon": "fa-edit", "table":"TCustomer1", "link": ["72BC3FA82387944DA6339CB436BF2E7B"]},' ..
   
   '{"id": "projects_result","title":"Projects: view", "icon": "fa-align-justify", "table":"TCustomer1", "link": ["5864AECD6D92494D9A3EC402D487C137zoom"]},' .. 
   '{"id": "projects_edit","title":"Projects: edit", "icon": "fa-edit", "table":"TCustomer1", "link": ["D43E71E96DC64255A8DFE9EC9CB0AC5E"]},' ..
   
   
   '{"id": "contacts","title":"Contacts: edit", "icon": "fa-edit", "table":"TCustomer1", "link": ["424450A706EED440BD039F13A03FF5E2"]},' .. 
   '{"id": "customer","title":"Customer: Add child", "icon": "fa-edit", "table":"TCustomer1", "link": ["5F70F8EA4C1D41D3993D8BDE9EFF040C"]},' .. 
   '{"id": "numbers","title":"Phone: edit", "icon": "fa-edit", "table":"TCustomer1", "link": ["5BB3A19846F64BDD9D091344A54BBB68"]},' ..
   '{"id": "chapters","title":"Chapters: edit", "icon": "fa-edit", "table":"TCustomer1", "link": ["9A191B5846864460B621D8BAFDF36767"]}' ..    ']') 
end  ]]>
            </CODE>
         </SCRIPT>
      </SCRIPTS>

      <ROWEDIT>
         <EDIT NAME="new_customer" SIMPLE="Customers" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION CACHE="17430650-c3b0-4c55-befd-fa30f99c1f11">
DECLARE @sDescription NVARCHAR(1000) = {=FDescription};
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TCustomer');

INSERT INTO $OTCustomer (GlobalK,FName,FDescription,TypeC,CategoryC,CreateD,UpdateD) 
VALUES({#V user "@@global"}, {=FName},@sDescription,{=TypeC},{=CategoryC},GETDATE(),GETDATE())

DECLARE @iCustomer BIGINT = (SELECT IDENT_CURRENT('$OTCustomer'));
EXEC $OPROCEDURE_UpdateBadge @sDescription, 'TCustomer', @iCustomer
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTCustomer')" />
         </EDIT>
      </ROWEDIT>
      
      <QUERYLINK TYPENAME="children" NAME="Activities"  DESCRIPTION="View activities for system" KEY="FE2F3F06F59840809CFD19C5B1F24DF3" EXPRESSION="SELECT CustomerK value, 'CustomerK' AS name, FName simple  FROM $OTCustomer WHERE CustomerK={{==TCustomer1}}">
         <PROPERTIES OUTPUT-WIDTH="1200" OUTPUT-HEIGHT="600" OUTPUT-POSITION="right-top" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Activities"  DESCRIPTION="Edit activities for customer" KEY="6CC3172D6ABA4A0DB1980E903B3154BB" EXPRESSION="SELECT CustomerK value, 'CustomerK' AS name, FName simple  FROM $OTCustomer WHERE CustomerK={{==TCustomer1}}">
         <PROPERTIES OUTPUT-WIDTH="1900" OUTPUT-HEIGHT="600" OUTPUT-POSITION="center-bottom" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Add Sale"  KEY="72BC3FA82387944DA6339CB436BF2E7B" EXPRESSION="SELECT CustomerK value, 'CustomerK' AS name, FName simple  FROM $OTCustomer WHERE CustomerK={{==TCustomer1}}">
         <PROPERTIES OUTPUT-WIDTH="800" OUTPUT-HEIGHT="400" OUTPUT-POSITION="right-bottom" />
      </QUERYLINK>
      
      <QUERYLINK TYPENAME="children" NAME="Projects"  DESCRIPTION="View projects for customer" KEY="5864AECD6D92494D9A3EC402D487C137" EXPRESSION="SELECT CustomerK value, 'CustomerK' AS name, FName simple  FROM $OTCustomer WHERE CustomerK={{==TCustomer1}}">
         <PROPERTIES OUTPUT-WIDTH="1000" OUTPUT-HEIGHT="250" OUTPUT-POSITION="right-center"  />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Projects"  DESCRIPTION="Edit projects for customer" KEY="D43E71E96DC64255A8DFE9EC9CB0AC5E" EXPRESSION="SELECT CustomerK value, 'CustomerK' AS name, FName simple  FROM $OTCustomer WHERE CustomerK={{==TCustomer1}}">
         <PROPERTIES OUTPUT-WIDTH="1000" OUTPUT-HEIGHT="350" OUTPUT-POSITION="right-bottom"  />
      </QUERYLINK>
      
      
      <QUERYLINK TYPENAME="children" NAME="Contacts"  DESCRIPTION="Edit contacts for customer" KEY="424450A706EED440BD039F13A03FF5E2" EXPRESSION="SELECT CustomerK value, 'CustomerK' AS name, FName simple  FROM $OTCustomer WHERE CustomerK={{==TCustomer1}}">
         <PROPERTIES OUTPUT-WIDTH="1200" OUTPUT-HEIGHT="500" OUTPUT-POSITION="center-top" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Number"  KEY="5BB3A19846F64BDD9D091344A54BBB68" DESCRIPTION="Edit number/phone for customer" EXPRESSION="SELECT CustomerK value, 'CustomerK' AS name, FName AS simple FROM $OTCustomer WHERE CustomerK={{==TCustomer1}}">
         <PROPERTIES OUTPUT-WIDTH="800" OUTPUT-HEIGHT="300" OUTPUT-POSITION="left-bottom" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Chapters"  KEY="9A191B5846864460B621D8BAFDF36767" DESCRIPTION="Edit chapters" EXPRESSION="SELECT CustomerK value, 'CustomerK' AS name, FName AS simple FROM $OTCustomer WHERE CustomerK={{==TCustomer1}}">
         <PROPERTIES OUTPUT-WIDTH="800" OUTPUT-HEIGHT="300" OUTPUT-POSITION="right-center" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Child customer" KEY="5F70F8EA4C1D41D3993D8BDE9EFF040C" EXPRESSION="SELECT CustomerK value, 'SuperK' AS name, FName AS simple FROM $OTCustomer WHERE CustomerK={{==TCustomer1}}" />
   </QUERY>
   
   <QUERY ID="Customer: Add child" KEY="5F70F8EA4C1D41D3993D8BDE9EFF040C">
      <FIELD ID="TCustomer1CustomerK" ALIAS="ID" TABLE="TCustomer1"/>
      <FIELD ID="TCustomer1FName" ALIAS="Name" TABLE="TCustomer1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TCustomer1FDescription" ALIAS="Description" TABLE="TCustomer1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="hashtag|TCustomer1.Hashtag" />
         <EDIT>{"update":"application.PROCEDURE_UpdateBadge {=TCustomer1FDescription}, 'TCustomer', ${@TCustomer1CustomerK}","formula":"1"}</EDIT>
      </FIELD>
      <FIELD ID="TCustomer1TypeC" ALIAS="Type" TABLE="TCustomer1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TCustomer1CategoryC" ALIAS="Category" TABLE="TCustomer1" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="new_system" SIMPLE="Systems" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION CACHE="06dd90bb-1bd3-464b-885a-ecc1160d7129">
DECLARE @iSuper INT = {{=SuperK}}
IF @iSuper = 0 SET @iSuper = NULL
DECLARE @sDescription NVARCHAR(1000) = {=FDescription};

DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TCustomer');

INSERT INTO $OTCustomer (GlobalK,SuperK,FName,FDescription,TypeC,CategoryC,CreateD,UpdateD) 
VALUES({#V user "@@global"}, @iSuper, {=FName},@sDescription,{=TypeC},{=CategoryC},GETDATE(),GETDATE())

DECLARE @iCustomer BIGINT = (SELECT IDENT_CURRENT('$OTCustomer'));
EXEC $OPROCEDURE_UpdateBadge @sDescription, 'TCustomer', @iCustomer
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTSystem')" />
         </EDIT>
         <EDIT NAME="delete system" SIMPLE="Delete System" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $OTSystem WHERE SystemK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   <QUERY ID="Customer chapters" KEY="9A191B5846864460B621D8BAFDF36767" DESCRIPTION="Edit customer chapters">
      <FIELD ID="TCustomerChapter1CustomerChapterK" ALIAS="ID (Chapter)" TABLE="TCustomerChapter1"/>
      <FIELD ID="TCustomerChapter1SuperK" ALIAS="Parent" TABLE="TCustomerChapter1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES SERVER-LIST="SELECT CAST(NULL AS INT) AS CustomerChapterK, '_ no parent _' AS FName UNION ALL SELECT _cc.CustomerChapterK, COALESCE(_cc.FName,_cc.FHeader,'') FROM $OTCustomerChapter _cc  WHERE _cc.CustomerK={{=TCustomer1CustomerK}} ORDER BY 2" />
      </FIELD>
      <FIELD ID="TCustomerChapter1FName" ALIAS="Name" TABLE="TCustomerChapter1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TCustomerChapter1FIndex" ALIAS="Index" TABLE="TCustomerChapter1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TCustomerChapter1FTypeName" ALIAS="Type name" TABLE="TCustomerChapter1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TCustomerChapter1TypeC" ALIAS="Type" TABLE="TCustomerChapter1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TCustomerChapter1StateC" ALIAS="State" TABLE="TCustomerChapter1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TCustomerChapter1FText" ALIAS="Description" TABLE="TCustomerChapter1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TCustomerChapter1FHelp" ALIAS="Help" TABLE="TCustomerChapter1" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="new_chapter" SIMPLE="Chapters" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION CACHE="00000000-0000-0000-0000-000000000000">
DECLARE @iCustomer BIGINT = {{=CustomerK}};
INSERT INTO $OTCustomerChapter (CustomerK,FName,TypeC,FText,FIndex,FTypeName,FHelp,CreateD,UpdateD) 
VALUES(@iCustomer,{=FName},{=TypeC"0"},{=FText},{=FIndex},{=FTypeName},{=FHelp},GETDATE(),GETDATE());
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTCustomerChapter')" />
         </EDIT>
         <EDIT NAME="delete chapter" SIMPLE="Delete Chapter" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $OTCustomerChapter WHERE CustomerChapterK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   
   <QUERY ID="Customer contacts" KEY="424450A706EED440BD039F13A03FF5E2">
      <ATTRIBUTE NAME="OUTPUT-LIST">Sales,50</ATTRIBUTE>
      <FIELD ID="TCustomerContact1CustomerContactK" ALIAS="ID (Contact)" TABLE="TCustomerContact1"/>
      <FIELD ID="TCustomerContact1FFirstName" ALIAS="First name" TABLE="TCustomerContact1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TCustomerContact1FLastName" ALIAS="Last name" TABLE="TCustomerContact1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TCustomerContact1FNickname" ALIAS="Nick" TABLE="TCustomerContact1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TCustomerContact1FMail" ALIAS="Mail" TABLE="TCustomerContact1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TCustomerContact1FMobile" ALIAS="Mobile" TABLE="TCustomerContact1" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="new_sale" SIMPLE="Sales" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
-- # Add record to TCustomerContact
DECLARE @iCustomer INT = {{=CustomerK}};

INSERT INTO $OTCustomerContact (CustomerK,FFirstName,FLastName,FNickname,FMail,FMobile,CreateD,UpdateD) 
VALUES(@iCustomer,{=FFirstName},{=FLastName},{=FNickname},{=FMail},{=FMobile},GETDATE(),GETDATE());

               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTCustomerContact')" />
         </EDIT>
      </ROWEDIT>
   </QUERY>

   <QUERY ID="Number" KEY="5BB3A19846F64BDD9D091344A54BBB68">
      <ATTRIBUTE NAME="OUTPUT-LIST">Sales,50</ATTRIBUTE>
      <FIELD ID="TNumber1NumberK" ALIAS="ID" TABLE="TNumber1"/>
      <FIELD ID="TNumber1TypeC" ALIAS="Type" TABLE="TNumber1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TNumber1FNumber" ALIAS="Number" TABLE="TNumber1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TNumber1FDescription" ALIAS="Description" TABLE="TNumber1" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="new_number" SIMPLE="Number" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
-- # Add record to TNumber
DECLARE @iCustomer INT = {{=CustomerK}};

INSERT INTO $OTNumber (ParentK,TypeC,FNumber,FDescription,CreateD,UpdateD) 
VALUES(@iCustomer,{=TypeC},{=FNumber},{=FDescription},GETDATE(),GETDATE());
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTNumber')" />
         </EDIT>
      </ROWEDIT>
   </QUERY>

   
   <QUERY ID="Sales" KEY="72BC3FA82387944DA6339CB436BF2E7B">
      <ATTRIBUTE NAME="OUTPUT-LIST">Sales,50</ATTRIBUTE>
      <FIELD ID="TSale1SaleK" ALIAS="ID" TABLE="TSale1"/>
      <FIELD ID="TSale1FName" ALIAS="Name" TABLE="TSale1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSale1TypeC" ALIAS="Type" TABLE="TSale1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSale1StateC" ALIAS="State" TABLE="TSale1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSale1FBeginD" ALIAS="Date" TABLE="TSale1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSale1FAmount" ALIAS="Amount" TABLE="TSale1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSale1FInvoice" ALIAS="Invoice" TABLE="TSale1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSale1UserK" ALIAS="User" TABLE="TSale1" FIELDFLAGNAMES="edit" />
      <CONDITION ID="TSale1StateC" TABLE="TSale1" SIMPLEVALUE="Open" VALUE="4140" OPERATORNAME="EQUAL" />   
      <CONDITIONS ID="All"/>
      <CONDITIONS ID="Open" SELECTED="1">
         <CONDITION ID="TSale1StateC" TABLE="TSale1" SIMPLEVALUE="Open" VALUE="4140" OPERATORNAME="EQUAL" />   
      </CONDITIONS>
      <ROWEDIT>
         <EDIT NAME="new_sale" SIMPLE="Sales" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
-- # Add record to TSale
DECLARE @iCustomer INT = {{=CustomerK}};
DECLARE @dateBegin DATETIME = {=FBeginD};
IF @dateBegin IS NULL
   SET @dateBegin = DATEADD(hour, DATEDIFF(hour,0,GETDATE()), 0)

INSERT INTO $OTSale (CustomerK,FName,FAmount,FInvoice,TypeC,StateC,ProbabilityC,ReasonC,StalledC,CurrencyC,UserK,FBeginD,CreateD,UpdateD) 
VALUES(@iCustomer,{=FName},{=FAmount},{=FInvoice},{=TypeC"0"},{=StateC"0"},0,0,0,0,{=UserK},@dateBegin,GETDATE(),GETDATE());
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTSale')" />
         </EDIT>
      </ROWEDIT>
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="940ac6b4-8b1a-44a9-bf06-2fb07bc3f3a0">
               <![CDATA[ return function(g) local R, db=g.result, g.db
R:SetValue('url','[' .. 
   '{"id": "activities","title":"Activities: edit", "icon": "fa-edit", "table":"TSale1", "link": ["D1ED8FCC75B744C89D4E0286CDF35998"]},' ..
   '{"id": "add_salesservice","title":"Edit Sales service", "icon": "fa-edit", "table":"TSale1", "link": ["06A5026D23EC924FBEDDA748F7110795"]},' ..
   '{"id": "sum_salesservice","title":"Sum Sales service", "icon": "fa-align-justify", "table":"TSale1", "link": ["1C0D51E5E0BE48D99DEDD0A2375A0AA4result"]},' ..
   '{"id": "add_contact","title":"Edit sale contacts", "icon": "fa-edit", "table":"TSale1", "link": ["CE36A50BF69F4E46AC1B003ACB1D8879"]},' ..    
   '{"id": "todolist","title":"Connect todolist", "icon": "fa-edit", "table":"TSale1", "link": ["1801ED84B5BAA7409A6F5B90A99C413C"]}' ..
   ']') 
end  ]]>
            </CODE>
         </SCRIPT>
      </SCRIPTS>
      <QUERYLINK TYPENAME="children" NAME="Activities"  DESCRIPTION="Edit activities for sale" KEY="D1ED8FCC75B744C89D4E0286CDF35998" EXPRESSION="SELECT SaleK value, 'SaleK' AS name, FName AS simple FROM $OTSale WHERE SaleK={{==TSale1}}">
         <PROPERTIES OUTPUT-WIDTH="1900" OUTPUT-HEIGHT="600" OUTPUT-POSITION="center-bottom" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Edit Sale service"  KEY="06A5026D23EC924FBEDDA748F7110795" EXPRESSION="SELECT SaleK value, 'SaleK' AS name, FName AS simple FROM $OTSale WHERE SaleK={{==TSale1}}">
         <PROPERTIES OUTPUT-WIDTH="1400" OUTPUT-HEIGHT="500" OUTPUT-POSITION="right-top" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Sum Sale service"  KEY="1C0D51E5E0BE48D99DEDD0A2375A0AA4" EXPRESSION="SELECT SaleK value, 'SaleK' AS name, FName AS simple FROM $OTSale WHERE SaleK={{==TSale1}}" />
      <QUERYLINK TYPENAME="children" NAME="Edit sale contacts"  KEY="CE36A50BF69F4E46AC1B003ACB1D8879" EXPRESSION="SELECT SaleK value, 'SaleK' AS name, FName AS simple FROM $OTSale WHERE SaleK={{==TSale1}}" />
      <QUERYLINK TYPENAME="children" NAME="Connect todolist"  KEY="1801ED84B5BAA7409A6F5B90A99C413C" EXPRESSION="SELECT SaleK value, 'SaleK' AS name, FName AS simple FROM $OTSale WHERE SaleK={{==TSale1}}">
         <PROPERTIES OUTPUT-WIDTH="500" OUTPUT-HEIGHT="300" OUTPUT-POSITION="left-bottom" />
      </QUERYLINK>
      <AGGREGATES>
         <AGGREGATE NAME="sum_amount" SIMPLE="Totalt" TYPENAME="sum">
            <SQL TYPENAME="select" COMMAND="sum-service">
               <EXPRESSION>
SELECT SUM( q.FAmount ) "amount" FROM (SELECT TSale1.FAmount {#V from} {#V where} ) AS q
               </EXPRESSION>
               <COLUMN INDEX="0" TYPE="R8" NAME="amount" REQUIRE-TABLE="TSale1" FORMAT="string.format_currency( ...2, @this, '{ &quot;decimal_count&quot;:0, &quot;currency_symbol&quot;:&quot;&quot;, &quot;thousand_separator&quot;:&quot; &quot; }' )" OUTPUT-COLUMN="5" OUTPUT-CLASS="text-focus" OUTPUT-STYLE="font-weight: 900; text-align: right; border-bottom: 2px solid;"></COLUMN>
            </SQL>
         </AGGREGATE>
      </AGGREGATES>
   </QUERY>
   
   <QUERY ID="Connect sale and todolist" DESCRIPTION="Connect sales with todolists" KEY="1801ED84B5BAA7409A6F5B90A99C413C" FLAGNAMES="NOTLISTED">
      <FIELD ID="TrSaleXTodolist1rSaleXTodolistK" ALIAS="ID (Sale - Todo list)" TABLE="TrSaleXTodolist1"/>
      <FIELD ID="TrSaleXTodolist1TodoListK" ALIAS="List" TABLE="TrSaleXTodolist1" FIELDFLAGNAMES="edit"/>
      <ROWEDIT>
         <EDIT NAME="new_sale-todolist" SIMPLE="Sale-Todolist" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
-- # Add record to TrSaleXTodolist
DECLARE @iSale BIGINT = {{=SaleK}};
INSERT INTO $OTrSaleXTodolist (SaleK,TodoListK) VALUES(@iSale,{=TodoListK});
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTrSaleXTodolist')" />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   <QUERY ID="Edit sale contacts" KEY="CE36A50BF69F4E46AC1B003ACB1D8879" DESCRIPTION="Add or remove sale contacts">
      <FIELD ID="TrSaleXCustomerContact1rSaleXCustomerContactK" ALIAS="ID (Contact)" TABLE="TrSaleXCustomerContact1"/>
      <FIELD ID="CustomerContactK" ALIAS="Contact" TABLE="TrSaleXCustomerContact1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES SERVER-LIST="SELECT CustomerContactK, ISNULL(FFirstName,'') + ' ' + ISNULL(FLastName,'') FROM $OTCustomerContact WHERE CustomerK=(SELECT s.CustomerK FROM $OTSale s WHERE s.SaleK = {{=TSale1SaleK}}) ORDER BY 2" /> 
      </FIELD>
      <FIELD ID="TrSaleXCustomerContact1RoleC" ALIAS="Role" TABLE="TrSaleXCustomerContact1" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="new_sale" SIMPLE="Sales" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
-- # Add record to TrSaleXCustomerContact
DECLARE @iSale BIGINT = {{=SaleK}};

INSERT INTO $OTrSaleXCustomerContact (SaleK,CustomerContactK,RoleC,CreateD,UpdateD) 
VALUES(@iSale,{=CustomerContactK},{=RoleC},GETDATE(),GETDATE());
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTrSaleXCustomerContact')" />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   
   <QUERY ID="Sale Service" KEY="06A5026D23EC924FBEDDA748F7110795" DESCRIPTION="Work tasks for sale" FLAGNAMES="NOTLISTED">
      <FIELD ID="TSaleService1SaleServiceK" ALIAS="ID" TABLE="TSaleService1"/>
      <FIELD ID="TSaleService1ActivityK-Name" ALIAS="Activity" TABLE="TSaleService1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSaleService1FDescription" ALIAS="Description" TABLE="TSaleService1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSaleService1FBeginD" ALIAS="Begin" TABLE="TSaleService1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-INPUT="date|YYYY-MM-DD HH:mm|24" />
      </FIELD>
      <FIELD ID="TSaleService1FTimeSpent" ALIAS="Time spent" TABLE="TSaleService1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSaleService1FTimeCharge" ALIAS="Time charge" TABLE="TSaleService1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSaleService1TypeC" ALIAS="Type" TABLE="TSaleService1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSaleService1RateC" ALIAS="Rate" TABLE="TSaleService1" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="new_saleservice" SIMPLE="Sale service" TYPENAME="new_row">
            <PROPERTY NAME="columns">SaleServiceK,FTimeSpent</PROPERTY>
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION CACHE="a0975929-d636-4829-88bc-0d0db07c2b0c">
-- # Add record to TSaleService
DECLARE @iSale BIGINT = {{=SaleK}};
DECLARE @iCustomer INT = {=CustomerK};
DECLARE @dateBegin DATETIME = {=FBeginD};
DECLARE @dateEnd DATETIME = {=FEndD};
DECLARE @iUser INT = {=UserK};
DECLARE @dSpent FLOAT = {=FTimeSpent};
DECLARE @dCharge FLOAT = {=FTimeCharge};

IF @iCustomer IS NULL
   SET @iCustomer = (SELECT CustomerK FROM $OTSale WHERE SaleK=@iSale)

IF @dateBegin IS NULL
   SET @dateBegin = DATEADD(hour, DATEDIFF(hour,0,GETDATE()), 0)
   
IF @dSpent IS NULL SET @dSpent = @dCharge
   
IF @dateEnd IS NULL
BEGIN
   IF @dSpent IS NOT NULL SET @dateEnd = (SELECT DATEADD( SECOND, @dSpent * 3600, @dateBegin ))
END
   
   
IF @iUser IS NULL
   SET @iUser = {#V user "@@user"} -- default user is active user
   
INSERT INTO $OTSaleService (SaleK, CustomerK, FDescription,   TypeC,      RateC,      UserK, FBeginD,   FEndD,   FTimeSpent,FTimeCharge,CreateD,  UpdateD) 
VALUES                     (@iSale,@iCustomer,{=FDescription},{=TypeC"0"},{=RateC"0"},@iUser,@dateBegin,@dateEnd,@dSpent,   @dCharge,   GETDATE(),GETDATE());
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key">
               <EXPRESSION>
DECLARE @iSaleService BIGINT = (SELECT IDENT_CURRENT('$OTSaleService'))
SELECT SaleServiceK, FTimeSpent FROM $OTSaleService WHERE SaleServiceK = @iSaleService
               </EXPRESSION>
            </SQL>
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   <QUERY ID="Sum Sale Service" KEY="1C0D51E5E0BE48D99DEDD0A2375A0AA4" DESCRIPTION="Sum sales work">
      <FIELD ID="TSaleService1FDescription" ALIAS="Description" TABLE="TSaleService1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="html|div|padding: 5px;max-width: 800px;max-height: 500px; overflow-y: auto; overflow-x: hidden; white-space: normal;" />         
      </FIELD>
      <FIELD ID="TSaleService1FBeginD" ALIAS="Date" TABLE="TSaleService1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSaleService1FTimeCharge" ALIAS="Charge time" TABLE="TSaleService1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSaleService1RateC" ALIAS="Rate" TABLE="TSaleService1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSaleService1TypeC" ALIAS="Type" TABLE="TSaleService1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSaleService1SaleServiceK" ALIAS="ID" TABLE="TSaleService1"/>
      <AGGREGATES>
         <AGGREGATE NAME="sum_amount" SIMPLE="Totalt" TYPENAME="sum">
            <SQL TYPENAME="select" COMMAND="sum-service">
               <EXPRESSION>
SELECT CAST( SUM( q.FTimeCharge ) AS NVARCHAR(30) ) + ' hours' AS "hours", SUM( _c.FInteger0 * q.FTimeCharge ) AS "amount" FROM
(SELECT TSaleService1.FTimeCharge, TSaleService1.RateC {#V from} {#V where} ) AS q JOIN $O{CODE}TCode _c ON q.RateC=_c.CodeK
WHERE _c.GroupK=181 AND _c.CodeK=q.RateC

               </EXPRESSION>
               <COLUMN INDEX="0" TYPE="R8" NAME="hours" REQUIRE-TABLE="TSaleService1" OUTPUT-COLUMN="2" OUTPUT-CLASS="text-focus" OUTPUT-STYLE="font-weight: 900; text-align: right; border-bottom: 2px solid;"></COLUMN>
               <COLUMN INDEX="1" TYPE="R8" NAME="amount" REQUIRE-TABLE="TSaleService1" FORMAT="string.format_currency( ...2, @this, '{ &quot;decimal_count&quot;:0, &quot;currency_symbol&quot;:&quot;&quot;, &quot;thousand_separator&quot;:&quot; &quot; }' )" OUTPUT-COLUMN="3" OUTPUT-CLASS="text-focus" OUTPUT-STYLE="font-weight: 900; text-align: right; border-bottom: 2px solid;"></COLUMN>
            </SQL>
         </AGGREGATE>
         <AGGREGATE NAME="vat" SIMPLE="Moms" TYPENAME="sum">
            <SQL TYPENAME="select" COMMAND="sum-service">
               <EXPRESSION>
SELECT 'VAT' AS "Name", SUM( _c.FInteger0 * q.FTimeCharge ) * 0.25 AS "amount" FROM
(SELECT TSaleService1.FTimeCharge, TSaleService1.RateC {#V from} {#V where} ) AS q JOIN $O{CODE}TCode _c ON q.RateC=_c.CodeK
WHERE _c.GroupK=181 AND _c.CodeK=q.RateC

               </EXPRESSION>
               <COLUMN INDEX="0" TYPE="R8" NAME="name" REQUIRE-TABLE="TSaleService1" OUTPUT-COLUMN="2" OUTPUT-CLASS="text-focus" OUTPUT-STYLE="font-weight: 900; text-align: right; border-bottom: 2px solid;"></COLUMN>
               <COLUMN INDEX="1" TYPE="R8" NAME="amount" REQUIRE-TABLE="TSaleService1" FORMAT="string.format_currency( ...2, @this, '{ &quot;decimal_count&quot;:0, &quot;currency_symbol&quot;:&quot;&quot;, &quot;thousand_separator&quot;:&quot; &quot; }' )" OUTPUT-COLUMN="3" OUTPUT-CLASS="text-focus" OUTPUT-STYLE="font-weight: 900; text-align: right; border-bottom: 2px solid;"></COLUMN>
            </SQL>
         </AGGREGATE>
         <AGGREGATE NAME="total" SIMPLE="Moms" TYPENAME="sum">
            <SQL TYPENAME="select" COMMAND="sum-service">
               <EXPRESSION>
SELECT 'Total' AS "Name", SUM( _c.FInteger0 * q.FTimeCharge ) * 1.25 AS "amount" FROM
(SELECT TSaleService1.FTimeCharge, TSaleService1.RateC {#V from} {#V where} ) AS q JOIN $O{CODE}TCode _c ON q.RateC=_c.CodeK
WHERE _c.GroupK=181 AND _c.CodeK=q.RateC

               </EXPRESSION>
               <COLUMN INDEX="0" TYPE="R8" NAME="name" REQUIRE-TABLE="TSaleService1" OUTPUT-COLUMN="2" OUTPUT-CLASS="text-focus" OUTPUT-STYLE="font-weight: 900; text-align: right; border-bottom: 2px solid;"></COLUMN>
               <COLUMN INDEX="1" TYPE="R8" NAME="amount" REQUIRE-TABLE="TSaleService1" FORMAT="string.format_currency( ...2, @this, '{ &quot;decimal_count&quot;:0, &quot;currency_symbol&quot;:&quot;&quot;, &quot;thousand_separator&quot;:&quot; &quot; }' )" OUTPUT-COLUMN="3" OUTPUT-CLASS="text-focus" OUTPUT-STYLE="font-weight: 900; text-align: right; border-bottom: 2px solid;"></COLUMN>
            </SQL>
         </AGGREGATE>
      </AGGREGATES>
   </QUERY>   
   
   <QUERY ID="System Books" KEY="EC6EF6AFA3554865A7DC39DA6222BE95" FLAGNAMES="NOTLISTED">
      <FIELD ID="TArticleBook1ArticleBookK" ALIAS="ID" TABLE="TArticleBook1"/>
      <FIELD ID="TArticleBook1SuperK" ALIAS="Parent" TABLE="TArticleBook1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES SERVER-LIST="SELECT CAST(NULL AS INT) AS ArticleBookK, '_ no parent _' AS FHeader UNION ALL SELECT _ab.ArticleBookK, _ab.FHeader FROM $OTArticleBook _ab JOIN $OTSystem _s ON _ab.ParentK=_s.SystemK AND _ab.table_number=1010  WHERE _ab.FHeader IS NOT NULL AND _ab.FDeleted=0 AND _ab.FDepreciated=0 AND _s.SystemK={{=TSystem1SystemK}} ORDER BY 2" />
      </FIELD>
      <FIELD ID="TArticleBook1FHeader" ALIAS="Header" TABLE="TArticleBook1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TArticleBook1FName" ALIAS="Name" TABLE="TArticleBook1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TArticleBook1TypeC" ALIAS="Type" TABLE="TArticleBook1" FIELDFLAGNAMES="edit"/>
   </QUERY>
   
   <QUERY ID="Presentation todolist" KEY="737734E0BC4F4A1B81C0285E4BC335CE" FLAGNAMES="NOTLISTED">
      <FIELD ID="TTodoList4FName" ALIAS="Name" TABLE="TTodoList4" FIELDFLAGNAMES="edit" />
      <FIELD ID="TTodoList4TodoListK" ALIAS="ID (List)" TABLE="TTodoList4"/>
      <FIELD ID="TTodoList4TypeC" ALIAS="Type" TABLE="TTodoList4" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="new_todolist" SIMPLE="Sales" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
-- # Add record to TSale
DECLARE @iArticlePresentation INT = {{=ArticlePresentationK}};
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TArticlePresentation');
DECLARE @iUser INT = {=UserK};

IF @iUser IS NULL
   SET @iUser = {#V user "@@user"} -- default user is active user

INSERT INTO $OTTodoList (FName,TypeC,UserK,CreateD,UpdateD,ParentK,table_number) 
VALUES({=FName},{=TypeC"0"},@iUser,GETDATE(),GETDATE(),@iArticlePresentation,@iTable);
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTTodoList')" />
         </EDIT>
      </ROWEDIT>
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE>
               <![CDATA[ return function(g) local R, db=g.result, g.db
R:SetValue('url','[' .. 
   '{"id": "todo_view","title":"Edit todo list", "icon": "fa-edit", "table":"TTodoList4", "link": ["78027020EA7AD348B057D4C7FBA190A0"]},' ..
   '{"id": "todo_edit","title":"View todo list", "icon": "fa-align-justify", "table":"TTodoList4", "link": ["78027020EA7AD348B057D4C7FBA190A0result"]},' ..
   ']') 
end  ]]>
            </CODE>
         </SCRIPT>
      </SCRIPTS>
<!-- 
      <QUERYLINK TYPENAME="children" NAME="Todo"  DESCRIPTION="Edit todolist" KEY="78027020EA7AD348B057D4C7FBA190A0" EXPRESSION="SELECT TodoListK value, 'TodoListK' AS name, FName AS simple FROM $OTTodoList WHERE TodoListK={{==TTodoList4}}">
         <PROPERTIES OUTPUT-WIDTH="1200" OUTPUT-HEIGHT="400" OUTPUT-POSITION="right-top" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Todo"  DESCRIPTION="Edit todolist" KEY="18F6A263B2288A41A26A20BE5F7B664A" EXPRESSION="SELECT TodoListK value, 'TodoListK' AS name, FName AS simple FROM $OTTodoList WHERE TodoListK={{==TTodoList4}}">
         <PROPERTIES OUTPUT-WIDTH="400" OUTPUT-HEIGHT="250" OUTPUT-POSITION="left-bottom" />
      </QUERYLINK>
-->            
   </QUERY>
   
   
   <QUERY ID="System todolists" KEY="1E4485B89FCA8F4CB8D9A1DAFB00A498">
      <FIELD ID="TTodoList1TodoListK" ALIAS="ID (List)" TABLE="TTodoList1"/>
      <FIELD ID="TTodoList1FName" ALIAS="Name" TABLE="TTodoList1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TTodoList1TypeC" ALIAS="Type" TABLE="TTodoList1" FIELDFLAGNAMES="edit" />
      <ORDER INDEX="0" DESC="1" SQL="TTodoList1.CreateD" />
      <ORDERS NAME="Created">
         <ORDER INDEX="0" DESC="1" SQL="TTodoList1.CreateD" />
      </ORDERS>
      <ORDERS NAME="Updated">
         <ORDER INDEX="0" DESC="1" SQL="TTodoList1.UpdateD" />
      </ORDERS>
      <ROWEDIT>
         <EDIT NAME="new_todolist" SIMPLE="Sales" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
-- # Add record to TSale
DECLARE @iSystem INT = {{=SystemK}};
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TSystem');
DECLARE @iUser INT = {=UserK};

IF @iUser IS NULL
   SET @iUser = {#V user "@@user"} -- default user is active user

INSERT INTO $OTTodoList (FName,TypeC,UserK,CreateD,UpdateD,ParentK,table_number) 
VALUES({=FName},{=TypeC"0"},@iUser,GETDATE(),GETDATE(),@iSystem,@iTable);
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTTodoList')" />
         </EDIT>
      </ROWEDIT>
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="bcce26e3-9314-48d9-a831-a3d8a8886ff0">
               <![CDATA[ return function(g) local R, db, sE=g.result, g.db, g.result:GetParam("event");
if sE == "click" then
   local iKeyPressed = R:GetParam("pressed")
   R:SetValue('url','{"link": ["78027020EA7AD348B057D4C7FBA190A0"],"table":"TTodoList1"}' ) return
end

R:SetValue('url','[' .. 
   '{"id": "todo_beam","title":"Beam List", "icon": "fa-broadcast-tower", "table":"TTodoList1", "link": ["D17F8228AF8E46568478F605D74D7199"]},' .. 
   '{"id": "todo_view","title":"Edit todo list", "icon": "fa-edit", "table":"TTodoList1", "link": ["78027020EA7AD348B057D4C7FBA190A0"]},' ..
   '{"id": "todo_edit","title":"View todo list", "icon": "fa-align-justify", "table":"TTodoList1", "link": ["78027020EA7AD348B057D4C7FBA190A0result"]},' ..
   '{"id": "todo_connect_activity","title":"Connect Activity", "icon": "fa-edit", "table":"TTodoList1", "link": ["18F6A263B2288A41A26A20BE5F7B664A"]}' ..
   ']') 
end  ]]>
            </CODE>
         </SCRIPT>
      </SCRIPTS>
      <QUERYLINK TYPENAME="message" NAME="Todo" DESCRIPTION="Beam todo list key" KEY="D17F8228AF8E46568478F605D74D7199" EXPRESSION="SELECT TodoListK value, 'TodoListK' AS name, FName AS simple FROM $OTTodoList WHERE TodoListK={{==TTodoList1}}">
         <PROPERTIES OUTPUT-COMMAND="send key" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Todo"  DESCRIPTION="Edit todolist" KEY="78027020EA7AD348B057D4C7FBA190A0" EXPRESSION="SELECT TodoListK value, 'TodoListK' AS name, FName AS simple FROM $OTTodoList WHERE TodoListK={{==TTodoList1}}">
         <PROPERTIES OUTPUT-WIDTH="1100" OUTPUT-HEIGHT="400" OUTPUT-POSITION="right-top|0,100" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Todo"  DESCRIPTION="Edit todolist" KEY="18F6A263B2288A41A26A20BE5F7B664A" EXPRESSION="SELECT TodoListK value, 'TodoListK' AS name, FName AS simple FROM $OTTodoList WHERE TodoListK={{==TTodoList1}}">
         <PROPERTIES OUTPUT-WIDTH="400" OUTPUT-HEIGHT="250" OUTPUT-POSITION="left-bottom" />
      </QUERYLINK>
   </QUERY>
   
   <QUERY ID="Todolist: Connect activity" KEY="18F6A263B2288A41A26A20BE5F7B664A" FLAGNAMES="NOTLISTED" DESCRIPTION="Connections between Activities and TodoLists">
      <FIELD ID="TrActivityXTodoList2rActivityXTodoListK" ALIAS="ID" TABLE="TrActivityXTodoList2"/>
      <FIELD ID="TrActivityXTodoList2ActivityK" ALIAS="Activity" TABLE="TrActivityXTodoList2" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="new_activity_todlist" SIMPLE="Activity-Todolist" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
-- # Add relation between activity and todo list
DECLARE @iActivity BIGINT = {{=ActivityK}};
DECLARE @iTodoList BIGINT = {{=TodoListK}};

INSERT INTO $OTrActivityXTodoList (ActivityK,TodoListK) 
VALUES(@iActivity,@iTodoList);
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTrActivityXTodoList')" />
         </EDIT>
      </ROWEDIT>
   </QUERY>

   <QUERY ID="Todo" DESCRIPTION="Todo items in todo list" KEY="78027020EA7AD348B057D4C7FBA190A0">
      <ATTRIBUTE NAME="OUTPUT-TRUNCATE">[20,50,200]|20</ATTRIBUTE>
      <FIELD ID="TTodo1TodoK" ALIAS="ID (Todo)" TABLE="TTodo1"/>
      <FIELD ID="TTodo1TypeC" ALIAS="Type" TABLE="TTodo1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TTodo1StateC" ALIAS="State" TABLE="TTodo1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TTodo1FReady" ALIAS="Ready" TABLE="TTodo1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TTodo1FClosed" ALIAS="Closed" TABLE="TTodo1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TTodo1FDescription" ALIAS="Description" TABLE="TTodo1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="markdown|padding: 0px; font-size: 90%; max-width: 95%; overflow-x: auto; white-space: normal;|[row]|padding-left: 100px;" 
                     OUTPUT-STYLE="column|max-width: 20px;" />
      </FIELD>
      <FIELD ID="TTodo1UserK" ALIAS="User" TABLE="TTodo1" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="new_todolist" SIMPLE="Sales" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
-- # Add record to TSale
DECLARE @DTReady DATETIME = NULL
DECLARE @DTClosed DATETIME = NULL
DECLARE @iReady SMALLINT = {=FReady"0"}
DECLARE @iClosed SMALLINT = {=FClosed"0"}
DECLARE @iTodoList BIGINT = {{=TodoListK}};
DECLARE @iUser INT = {=UserK};

IF @iReady = 1
   SET @DTReady = GETDATE()
   
IF @iClosed = 1
   SET @DTClosed = GETDATE()

IF @iUser IS NULL
   SET @iUser = {#V user "@@user"} -- default user is active user
   
INSERT INTO $OTTodo(TodoListK,UserK,TypeC,StateC,FDescription,FReady,FReadyD,FClosed,FClosedD,CreateD,UpdateD) 
VALUES(@iTodoList,@iUser,{=TypeC"0"},{=StateC"0"},{=FDescription},@iReady,@DTReady,@iClosed,@DTClosed,GETDATE(),GETDATE());
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTTodo')" />
         </EDIT>
         <EDIT NAME="delete todo" SIMPLE="Delete todo item" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $OTTodo WHERE TodoK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   <QUERY ID="Activities: List and mark completed" DESCRIPTION="Query to make it easy setting complete mark" KEY="F525D5884F7D71409176198CB33CCB33">
      <ATTRIBUTE NAME="OUTPUT-LIST">Activities</ATTRIBUTE>
      <FIELD ID="TActivity2ActivityK" ALIAS="ID" TABLE="TActivity2"/>
      <FIELD ID="TSystem1FName" ALIAS="System" TABLE="TSystem1"/>
      <FIELD ID="TActivity2FDescription" ALIAS="Desc." TABLE="TActivity2" DESCRIPTION="Activity description">
         <ATTRIBUTES OUTPUT-FORMAT="markdown|padding: 0px; font-size: 90%; max-width: 1000px; overflow-x: auto; white-space: normal;|[row]|padding-left: 100px;" 
                     OUTPUT-STYLE="column|max-width: 30px;" />
      </FIELD>
      <FIELD ID="TActivity2FBeginD" ALIAS="Start" TABLE="TActivity2" FORMAT="CONVERT(CHAR(16), $T.$F, 120)" FIELDFLAGNAMES="sql_format edit">
         <!-- Format for Moment.js -->
         <ATTRIBUTES OUTPUT-INPUT="date|YYYY-MM-DD HH:mm|24" />
      </FIELD>
      <FIELD ID="TActivity2FEndD" ALIAS="End" TABLE="TActivity2" FORMAT="CONVERT(CHAR(16), $T.$F, 120)" FIELDFLAGNAMES="sql_format edit">
         <!-- Format for Moment.js -->
         <ATTRIBUTES OUTPUT-INPUT="date|YYYY-MM-DD HH:mm|24" />
      </FIELD>
      <FIELD ID="TActivity2TypeC" ALIAS="Type" TABLE="TActivity2"/>
      <FIELD ID="TActivity2StateC" ALIAS="State" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity2PriorityC" ALIAS="Priority" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity2FDone" ALIAS="Closed" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TActivity2UserK" ALIAS="User" TABLE="TActivity2" FIELDFLAGNAMES="edit" />
      <ORDER FIELD="TActivity2FBeginD" DESC="1" />
      <CONDITION ID="TActivity2FDone" TABLE="TActivity2" OPERATOR="0" SIMPLEVALUE="NO" VALUE="0" />      
      <CONDITIONS ID="All Activities" />
      <CONDITIONS ID="Open Activities" SELECTED="1">
         <CONDITION ID="TActivity2FDone" TABLE="TActivity2" OPERATOR="0" SIMPLEVALUE="NO" VALUE="0" />
      </CONDITIONS>
   </QUERY>
   
   <QUERY ID="Articles: For System" KEY="E09B7E7DFF434EBF9A3E24678E4D8815">
      <ATTRIBUTE NAME="OUTPUT-LIST">Conditional,1000</ATTRIBUTE>
      <FIELD ID="TArticle1ArticleK" ALIAS="ID" TABLE="TArticle1"/>
      <FIELD ID="TArticle1FHeader" ALIAS="Header" TABLE="TArticle1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TArticle1FText" ALIAS="Text" TABLE="TArticle1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="markdown|padding: 5px; font-size: 90%; max-width: 1000px; overflow-x: auto; white-space: normal;|[row]|padding-left: 100px;"
                     OUTPUT-STYLE="column|max-width: 30px;" />
      </FIELD>
      <FIELD ID="TArticle1TypeC" ALIAS="Type" TABLE="TArticle1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TArticle1UpdateD" ALIAS="Updated" TABLE="TArticle1" FORMAT="CONVERT(CHAR(16), $T.$F, 120)" FIELDFLAGNAMES="sql_format" />
      <FIELD ID="TArticle1FSearchText" ALIAS="Search" TABLE="TArticle1" />
   </QUERY>
   
   
   <QUERY ID="Articles: For System edit" KEY="E9F72F7E7F2E354AB7FC7E2D67684274" FLAGNAMES="NOTLISTED">
      <ATTRIBUTE NAME="OUTPUT-TRUNCATE">[20,50,200]|20</ATTRIBUTE>
      <FIELD ID="TArticle1ArticleK" ALIAS="ID" TABLE="TArticle1"/>
      <FIELD ID="TArticle1FHeader" ALIAS="Header" TABLE="TArticle1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TArticle1FText" ALIAS="Text" TABLE="TArticle1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="markdown|padding: 5px;max-width: 1000px;max-height: 500px; overflow-y: auto; overflow-x: hidden; white-space: normal;" />
      </FIELD>
      <FIELD ID="TArticle1TypeC" ALIAS="Type" TABLE="TArticle1" FIELDFLAGNAMES="edit" />
      <!-- 
      <FIELD ID="TArticle1SuperK" ALIAS="Parent" TABLE="TArticle1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES SERVER-LIST="SELECT CAST(NULL AS INT) AS ArticleK, '_ no parent _' AS FName UNION ALL SELECT ArticleK, FBrief FROM $OTArticle WHERE FBrief &gt; ' ' AND FDeleted = 0 AND FDepreciated = 0 ORDER BY 2" /> 
      </FIELD>
      -->
      <ROWEDIT>
         <EDIT NAME="new_article" SIMPLE="Articles" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
DECLARE @iSystem INT = {{=SystemK}};
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TSystem');
DECLARE @iUser INT = {=UserK};

IF @iUser IS NULL
   SET @iUser = {#V user "@@user"} -- default user is active user

INSERT INTO $OTArticle (UserK,FText,LevelC,TypeC,LanguageC,CreateD,UpdateD,ParentK,table_number) 
VALUES(@iUser,{=FText},{=LevelC"0"},{=TypeC"0"},0,GETDATE(),GETDATE(),@iSystem,@iTable)
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTArticle')" />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   
   <QUERY ID="Articles: For System Book" KEY="F1CB0BEFD0E94C8CA1BD46DA933E8E6E" FLAGNAMES="NOTLISTED" DESCRIPTION="Adding articles for selected book attached to system">
      <FIELD ID="TArticle2ArticleK" ALIAS="ID" TABLE="TArticle2"/>
      <FIELD ID="TArticle2TypeC" ALIAS="Type" TABLE="TArticle2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TArticle2LevelC" ALIAS="Level" TABLE="TArticle2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TArticle2FText" ALIAS="Text" TABLE="TArticle2" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="markdown|padding: 5px;max-width: 1000px;max-height: 500px; overflow-y: auto; overflow-x: hidden; white-space: normal;" />
      </FIELD>
      <!-- 
      <FIELD ID="TArticle2SuperK" ALIAS="Parent" TABLE="TArticle2" FIELDFLAGNAMES="edit">
         <ATTRIBUTES SERVER-LIST="SELECT CAST(NULL AS INT) AS ArticleK, '_ no parent _' AS FName UNION ALL SELECT ArticleK, FBrief FROM $OTArticle WHERE FBrief &gt; ' ' AND FDeleted = 0 AND FDepreciated = 0 ORDER BY 2" /> 
      </FIELD>
      -->
      <ROWEDIT>
         <EDIT NAME="new_article" SIMPLE="Articles" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
-- # Add record to TArticle
DECLARE @iBook INT = {{=ArticleBookK}};
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TSystem');
DECLARE @iSystem INT = (SELECT ParentK FROM $OTArticleBook WHERE ArticleBookK = @iBook);
DECLARE @iUser INT = {=UserK};

IF @iUser IS NULL
   SET @iUser = {#V user "@@user"} -- default user is active user

INSERT INTO $OTArticle (UserK,FText,LevelC,TypeC,LanguageC,CreateD,UpdateD,ParentK,table_number) 
VALUES(@iUser,{=FText},{=LevelC"0"},{=TypeC"0"},0,GETDATE(),GETDATE(),@iSystem,@iTable)

-- # Add relation between book and article
DECLARE @iArticle INT = (SELECT IDENT_CURRENT('$OTArticle'));
INSERT INTO $OTrArticleBookXArticle(ArticleBookK,ArticleK) VALUES(@iBook,@iArticle);

               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTArticle')" />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   
   <QUERY ID="Articles">
      <FIELD ID="TArticle1ArticleK" ALIAS="ID" TABLE="TArticle1"/>
      <FIELD ID="TSystem1FName" ALIAS="Name" TABLE="TSystem1"/>
      <FIELD ID="TArticle1LevelC" ALIAS="Level" TABLE="TArticle1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TArticle1TypeC" ALIAS="Type" TABLE="TArticle1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TArticle1FText" ALIAS="Text" TABLE="TArticle1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="markdown|padding: 5px;max-width: 1000px;max-height: 500px; overflow-y: auto; overflow-x: hidden; white-space: normal;" />
      </FIELD>
      <FIELD ID="TArticle1SuperK" ALIAS="Parent" TABLE="TArticle1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES SERVER-LIST="SELECT CAST(NULL AS INT) AS ArticleK, '_ no parent _' AS FName UNION ALL SELECT ArticleK, FBrief FROM $OTArticle WHERE FBrief &gt; ' ' AND FDeleted = 0 AND FDepreciated = 0 ORDER BY 2" /> 
      </FIELD>
   </QUERY>
   
   
   
   <QUERY ID="Changelog" KEY="2AC749C19C8F7049BD8E16091EB40214" FLAGNAMES="NOTLISTED">
      <ATTRIBUTE NAME="OUTPUT-LIST">Conditional,1000</ATTRIBUTE>
      <FIELD ID="TSystem1ShortName" ALIAS="System" TABLE="TSystem1"/>
      <FIELD ID="VChangelog1TypeC" ALIAS="Type" TABLE="VChangelog1"/>
      <FIELD ID="VChangelog1FDescription" ALIAS="Description" TABLE="VChangelog1">
         <ATTRIBUTES OUTPUT-FORMAT="markdown" />
      </FIELD>
      <FIELD ID="VChangelog1CreateD" ALIAS="Create" TABLE="VChangelog1" FORMAT="CAST( $T.$F AS DATE )" FIELDFLAGNAMES="sql_format" />
      <FIELD ID="VChangelog1FVersion1" ALIAS="Major" TABLE="VChangelog1"/>
      <FIELD ID="VChangelog1FVersion2" ALIAS="Minor" TABLE="VChangelog1"/>
      <FIELD ID="VChangelog1FVersion3" ALIAS="Patch" TABLE="VChangelog1"/>
   </QUERY>
   
   
   <QUERY ID="Changelog: List" KEY="65136A5A6EAF9A4795BD3C1B63BDBC2A" DESCRIPTION="Changelog information for systems">
      <ATTRIBUTE NAME="OUTPUT-LIST">Important,3</ATTRIBUTE>
      <FIELD ID="VChangelog1KeyK" ALIAS="ID" TABLE="VChangelog1"/>
      <FIELD ID="VChangelog1TypeC" ALIAS="Type" TABLE="VChangelog1"/>
      <FIELD ID="VChangelog1FDescription" ALIAS="Description" TABLE="VChangelog1">
         <ATTRIBUTES OUTPUT-FORMAT="hashtag|VChangelog1.Hashtag" />
      </FIELD>
      <FIELD ID="VChangelog1ImpactC" ALIAS="Impact" TABLE="VChangelog1"/>
      <FIELD ID="VChangelog1CreateD" ALIAS="Date" TABLE="VChangelog1" FORMAT="CAST( $T.$F AS DATE )" FIELDFLAGNAMES="sql_format" />
      <FIELD ID="VChangelog1FNote" ALIAS="Note" TABLE="VChangelog1">
         <ATTRIBUTES OUTPUT-FORMAT="`hashtag|VChangelog1.Hashtag` `markdown|max-width: 1000px; overflow-x: auto; white-space: normal;|[row]|margin: 1em 3em; padding-left: 20px;max-width: 95%; border-left: 2px solid #CCC;`"
                     OUTPUT-STYLE="column|max-width: 20px;" />
      </FIELD>
      <FIELD ID="VChangelog1VersionNameAndSystem" ALIAS="Version" TABLE="VChangelog1">
         <ATTRIBUTES OUTPUT-FORMAT="html|b|letter-spacing: 3px;font-size:200%; color: black;|[rowbefore one]" />         
      </FIELD>
      <ORDER FIELD="VChangelog1TypeC" SQL="$T.SystemCounter" DESC="1" />
      <ORDER FIELD="VChangelog1CreateD" DESC="1" />
      <ORDERS NAME="Versions">
         <ORDER FIELD="VChangelog1TypeC" SQL="$T.SystemCounter" DESC="1" />
         <ORDER FIELD="VChangelog1CreateD" DESC="1" />
      </ORDERS>
      <CONDITION ID="TSystem1SystemK" TABLE="TSystem1" OPERATOR="0" SIMPLEVALUE="28" VALUE="28" FLAGS="0"/>
      <CONDITIONS ID="All" />
      <CONDITIONS ID="Selection core" SELECTED="1">
         <CONDITION ID="TSystem1SystemK" TABLE="TSystem1" OPERATOR="0" SIMPLEVALUE="28" VALUE="28" FLAGS="0"/>
      </CONDITIONS>
      <CONDITIONS ID="Selection core latest">
         <CONDITION ID="TSystem1SystemK" TABLE="TSystem1" OPERATOR="0" SIMPLEVALUE="28" VALUE="28" FLAGS="0"/>
         <CONDITION ID="VChangelog1FVersion1" TABLE="VChangelog1" OPERATOR="0" SIMPLEVALUE="Latest version" 
                    VALUE="($T.FVersion1 * 1000000 + $T.FVersion2 * 1000 + $T.FVersion3) = (SELECT MAX(s.FVersion1 * 1000000 + s.FVersion2 * 1000 + s.FVersion3) FROM application.TSystemVersion s WHERE s.SystemK = 28)" 
                    CONDITIONFLAGS="1792" />
      </CONDITIONS>
      <CONDITIONS ID="Latest, all systems">
         <CONDITION ID="TSystem1SystemK" TABLE="TSystem1" OPERATORNAME="IS NOT NULL" SIMPLEVALUE="empty" VALUE="0" FLAGS="0">
            <EXPRESSION PART="from">
JOIN (
SELECT s.SystemK SystemK, MAX(s.FVersion1 * 1000000 + s.FVersion2 * 1000 + s.FVersion3) Version
FROM application.TSystemVersion s
GROUP BY s.SystemK
) _max ON (VChangelog1.FVersion1 * 1000000 + VChangelog1.FVersion2 * 1000 + VChangelog1.FVersion3) = _max.Version AND "TSystem1"."SystemK" = _max.SystemK
            </EXPRESSION>
         </CONDITION>
      </CONDITIONS>
      <SELECTCONDITIONS>
         <SELECTCONDITION ID="FVersion1" TABLE="VChangelog1"/>
         <SELECTCONDITION ID="FVersion2" TABLE="VChangelog1"/>
         <SELECTCONDITION ID="FVersion3" TABLE="VChangelog1"/>
      </SELECTCONDITIONS>
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="f2816c8d-a840-45bc-9179-d93a0494f99a"><![CDATA[ return function(g) local R, db=g.result, g.db
local iThreadCount;
local iKey = R:GetParam("key")            print("iKey = " .. iKey);
local iTable = iKey % 10;                 print("iTable = " .. iTable);
iKey = (iKey - (iKey % 10)) / 10;         print("iKey = " .. iKey);

local sMenu = ""

if iTable == 0 then -- 0 = Activity
   local sSql = "SELECT COUNT(*) FROM $Othread WHERE FThreadId = (SELECT FThreadId FROM $Othread WHERE table_number=1110 AND FKey=".. iKey ..")" -- count number of thread items in thread activitiy belongs to if any
   iThreadCount = db:Ask( sSql )
   if iThreadCount > 1 then
      sMenu = ',{"id": "view_thread","title":"View thread", "key": '.. iKey ..' "icon": "fa-stream", "table":"TActivity2", "link": ["78D0B10F2B664F6896550CDCCCC0465Aresult"]}' ..
              ',{"id": "view_thread_in_dialog","title":"View thread in dialog", "icon": "fa-stream", "table":"TActivity2", "link": ["4774E0E630204B6988EDF517243FAACEzoom"]}' ..
              ',{"id": "edit_thread","title":"Edit thread", "icon": "fa-stream", "table":"TActivity2", "link": ["D8B5FB8297B640B9A80E5BA0581717EFresult"]}' ..
              ',{"id": "edit_durations_thread","title":"Edit durations", "icon": "fa-stream", "table":"TActivity2", "link": ["8CD248311699439198D941CCFB9EFCB1result"]}'
   end
   
   if string.len( sMenu ) > 0 then
      R:SetValue('url','[' .. 
         '{"id": "activity","title":"Beam Activity", "icon": "fa-broadcast-tower", "table":"TActivity2", "link": ["C6E29A22AE72434B91FE66293CBB972F"]}' .. sMenu ..
      ']') 
   end
else 
end

end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
   </QUERY>

   <QUERY ID="Changelog: Settings" KEY="0F310E09EBFD49478C192E9CD50E556B" DESCRIPTION="Modify codes for changelog">
      <ATTRIBUTE NAME="OUTPUT-LIST">Work</ATTRIBUTE>
      <FIELD ID="VChangelog1KeyK" ALIAS="ID" TABLE="VChangelog1"/>
      <FIELD ID="TSystem1FName" ALIAS="System" TABLE="TSystem1"/>
      <FIELD ID="VChangelog1VersionName" ALIAS="Version" TABLE="VChangelog1"/>
      <FIELD ID="VChangelog1TypeC" ALIAS="Type" TABLE="VChangelog1"/>
      <FIELD ID="VChangelog1ImpactC" ALIAS="Impact" TABLE="VChangelog1" FIELDFLAGNAMES="edit">
         <EDIT>
DECLARE @iKey BIGINT = ${@VChangelog1KeyK}
DECLARE @iTable INT = @iKey % 10
SET @iKey = @iKey / 10
IF @iTable = 0 
   UPDATE $OTrSystemVersionXActivity SET ImpactC={{==VChangelog1ImpactC}} WHERE rSystemVersionXActivityK = @iKey
IF @iTable = 1 
   UPDATE $OTrSystemVersionXProject SET ImpactC={{==VChangelog1ImpactC}} WHERE rSystemVersionXProjectK = @iKey
IF @iTable = 2 
   UPDATE $OTLog SET ImpactC={{==VChangelog1ImpactC}} WHERE LogK = @iKey
         </EDIT>
      </FIELD>
      <FIELD ID="VChangelog1FDescription" ALIAS="Description" TABLE="VChangelog1">
         <ATTRIBUTES OUTPUT-FORMAT="markdown" />
      </FIELD>
      <CONDITION ID="TSystem1SystemK" TABLE="TSystem1" OPERATOR="0" SIMPLEVALUE="28" VALUE="28" FLAGS="0"/>
      <CONDITIONS ID="All" />
      <CONDITIONS ID="Selection core" SELECTED="1">
         <CONDITION ID="TSystem1SystemK" TABLE="TSystem1" OPERATOR="0" SIMPLEVALUE="28" VALUE="28" FLAGS="0"/>
      </CONDITIONS>
      <CONDITIONS ID="Latest, all systems">
         <CONDITION ID="TSystem1SystemK" TABLE="TSystem1" OPERATORNAME="IS NOT NULL" SIMPLEVALUE="empty" VALUE="0" FLAGS="0">
            <EXPRESSION PART="from">
JOIN (
SELECT s.SystemK SystemK, MAX(s.FVersion1 * 1000000 + s.FVersion2 * 1000 + s.FVersion3) Version
FROM application.TSystemVersion s
GROUP BY s.SystemK
) _max ON (VChangelog1.FVersion1 * 1000000 + VChangelog1.FVersion2 * 1000 + VChangelog1.FVersion3) = _max.Version AND "TSystem1"."SystemK" = _max.SystemK
            </EXPRESSION>
         </CONDITION>
      </CONDITIONS>
   </QUERY>

   <QUERY ID="Presentation: User" TITLE="User presentation" KEY="D582520447CC884FBAC5FBDE221DD141">
      <ATTRIBUTE NAME="OUTPUT-LIST">Tutorial,30</ATTRIBUTE>
      <FIELD ID="TrArticlePresentationXArticle1TypeC" ALIAS="Type" TABLE="TrArticlePresentationXArticle1"/>
      <FIELD ID="TArticle3FBrief" ALIAS="Brief" TABLE="TArticle3"/>
      <FIELD ID="TArticle3FText" ALIAS="Text" TABLE="TArticle3">
         <ATTRIBUTES OUTPUT-FORMAT="markdown|padding: 0px; font-size: 110%; max-width: 97%; overflow-x: auto; white-space: normal;  border: 2px solid grey; border-radius: 10px; padding: 20px;|[row]|padding-left: 50px;" 
                     OUTPUT-STYLE="column|max-width: 20px;" />
      </FIELD>
      <SELECTCONDITIONS>
         <SELECTCONDITION ID="TArticlePresentation1ArticlePresentationK-Name" TABLE="TArticlePresentation1"/>
      </SELECTCONDITIONS>
   </QUERY>
   
   <QUERY ID="Projects: all" DESCRIPTION="Projects connected to system" KEY="6f0511a2d4624e12aa35123245e553a0">
      <ATTRIBUTE NAME="OUTPUT-LIST">Work,100</ATTRIBUTE>
      <FIELD ID="TProject1ProjectK" ALIAS="ID" TABLE="TProject1"/>
      <FIELD ID="TProject1FName" ALIAS="Name" TABLE="TProject1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TProject1TypeC" ALIAS="Type" TABLE="TProject1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TProject1StateC" ALIAS="State" TABLE="TProject1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TProject1UserK" ALIAS="User" TABLE="TProject1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TProject1FBeginD" ALIAS="Begin" TABLE="TProject1" FIELDFLAGNAMES="edit,sql_format" FORMAT="CAST( $T.$F AS DATE )">
         <!-- Format for Moment.js -->
         <ATTRIBUTES OUTPUT-INPUT="date|YYYY-MM-DD|24" />
      </FIELD>
      <FIELD ID="TProject1FDone" ALIAS="Completed" TABLE="TProject1" FIELDFLAGNAMES="edit" />
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE><![CDATA[ return function(g) local R, db=g.result, g.db
   R:SetValue('url','[' .. 
   '{"id": "activities","title":"Edit activities for project", "icon": "fa-edit", "table":"TProject1", "link": ["2E8B763EB13048F4A97AF48049F9E2D4"]}' .. 
   ']') 
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
      <QUERYLINK TYPENAME="children" NAME="Activities"  DESCRIPTION="Edit activities for project" KEY="2E8B763EB13048F4A97AF48049F9E2D4" 
                 EXPRESSION="SELECT SystemK value, 'SystemK' AS name, 'System: ' + FName simple, 'TSystem1' _table FROM $OTSystem WHERE SystemK = ( SELECT ParentK FROM $OTProject WHERE ProjectK={{==TProject1}} AND table_number=1010) UNION ALL SELECT ProjectK value, 'ProjectK' AS name, 'Project: ' + FName simple, 'TProject1'  FROM $OTProject WHERE ProjectK={{==TProject1}}">
         <PROPERTIES OUTPUT-WIDTH="1600" OUTPUT-HEIGHT="500" OUTPUT-POSITION="right-bottom" />
      </QUERYLINK>
   </QUERY>
   
   
   <QUERY ID="Projects for System" DESCRIPTION="Projects connected to system" KEY="AC8F938FFFFF45488251BD417A41656F">
      <ATTRIBUTE NAME="OUTPUT-LIST">Conditional,1000</ATTRIBUTE>
      <FIELD ID="TProject1ProjectK" ALIAS="ID (Project)" TABLE="TProject1"/>
      <FIELD ID="TProject1TypeC" ALIAS="Type" TABLE="TProject1" />
      <FIELD ID="TProject1FName" ALIAS="Name" TABLE="TProject1">
         <ATTRIBUTES OUTPUT-FORMAT="hashtag|TProject1.Hashtag" />
      </FIELD>
      <FIELD ID="TProject1Note" ALIAS="Docs" TABLE="TProject1">
         <ATTRIBUTES OUTPUT-FORMAT="`hashtag|TProject1.Hashtag` `markdown|padding: 0px; font-size: 90%; max-width: 95%; overflow-x: auto; white-space: normal;|[row]|padding-left: 100px;`"
                     OUTPUT-STYLE="column|max-width: 30px;" />
      </FIELD>
      <FIELD ID="TProject1UserK" ALIAS="User" TABLE="TProject1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TProject1FBeginD" ALIAS="Begin" TABLE="TProject1" FIELDFLAGNAMES="edit" />
      <ORDER FIELD="TProject1FBeginD" INDEX="5" DESC="1" />
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="032b259b-fde3-4cc2-8be6-c733a90c9a2d"><![CDATA[ return function(g) local R, db=g.result, g.db
   R:SetValue('url','[' .. 
   '{"id": "project","title":"Edit project", "icon": "fa-i-cursor", "table":"TProject1", "link": ["702FF3905BEB4DA39114C09516B4AC08"]},' .. 
   '{"id": "article","title":"Activities: view", "icon": "fa-align-justify", "table":"TProject1", "link": ["EA5ED8A1C4E443D893B666953D572CBFzoom"]},' .. 
   '{"id": "activities","title":"Edit activities", "icon": "fa-edit", "table":"TProject1", "link": ["8E433F88556C4F3EA0C41370263DB9A2"]},' .. 
   '{"id": "phase","title":"Add phase", "icon": "fa-edit", "table":"TProject1", "link": ["68648A00910D1B408CE5DD417B83DE88"]}' ..    
   ']') 
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
      
      <QUERYLINK TYPENAME="record" NAME="Project"  DESCRIPTION="Edit projects for system" KEY="702FF3905BEB4DA39114C09516B4AC08" QUERY="29BCDED64B4B4DD7A63CFAAB970F38DA">
         <EXPRESSION>
SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK=(SELECT ParentK FROM $OTProject p WHERE ProjectK={{==TProject1}} AND p.table_number=1010)
UNION All
SELECT ProjectK value, 'ProjectK' AS name, FName simple FROM $OTProject WHERE ProjectK={{==TProject1}}
         </EXPRESSION>
         <PROPERTIES OUTPUT-WIDTH="1000" OUTPUT-HEIGHT="350" OUTPUT-POSITION="right-bottom"  />
      </QUERYLINK>
      

      <QUERYLINK TYPENAME="children" NAME="Activities"  DESCRIPTION="View activities for project" KEY="EA5ED8A1C4E443D893B666953D572CBF"
                 EXPRESSION="SELECT ProjectK value, 'ProjectK' AS name, 'Project: ' + FName AS simple FROM $OTProject WHERE ProjectK={{==TProject1}}">
         <PROPERTIES OUTPUT-WIDTH="1100" OUTPUT-HEIGHT="500" OUTPUT-POSITION="left-top|0,100" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Activities"  DESCRIPTION="Edit activities for project" KEY="8E433F88556C4F3EA0C41370263DB9A2" 
                 EXPRESSION="SELECT ProjectK value, 'ProjectK' AS name, 'Project: ' + FName AS simple FROM $OTProject WHERE ProjectK={{==TProject1}}">
         <PROPERTIES OUTPUT-WIDTH="1600" OUTPUT-HEIGHT="500" OUTPUT-POSITION="right-bottom" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="ProjectPhase"  DESCRIPTION="Edit project phases" KEY="68648A00910D1B408CE5DD417B83DE88" EXPRESSION="SELECT ProjectK value, 'ProjectK' AS name, 'Project: ' + FName AS simple FROM $OTProject WHERE ProjectK={{==TProject1}}">
         <PROPERTIES OUTPUT-WIDTH="1600" OUTPUT-HEIGHT="350" OUTPUT-POSITION="right-center|0,200" />
      </QUERYLINK>
   </QUERY>
   
   <QUERY ID="Projects for Customer" DESCRIPTION="Projects connected to customer" KEY="5864AECD6D92494D9A3EC402D487C137">
      <ATTRIBUTE NAME="OUTPUT-LIST">Conditional,1000</ATTRIBUTE>
      <FIELD ID="TProject2ProjectK" ALIAS="ID (Project)" TABLE="TProject2"/>
      <FIELD ID="TProject2TypeC" ALIAS="Type" TABLE="TProject2" />
      <FIELD ID="TProject2FName" ALIAS="Name" TABLE="TProject2">
         <ATTRIBUTES OUTPUT-FORMAT="hashtag|TProject2.Hashtag" />
      </FIELD>
      <FIELD ID="TProject2Note" ALIAS="Docs" TABLE="TProject2">
         <ATTRIBUTES OUTPUT-FORMAT="`hashtag|TProject2.Hashtag` `markdown|padding: 0px; font-size: 90%; max-width: 95%; overflow-x: auto; white-space: normal;|[row]|padding-left: 100px;`"
                     OUTPUT-STYLE="column|max-width: 30px;" />
      </FIELD>
      <FIELD ID="TProject2UserK" ALIAS="User" TABLE="TProject2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TProject2FBeginD" ALIAS="Begin" TABLE="TProject2" FIELDFLAGNAMES="edit" />
      <ORDER FIELD="TProject2FBeginD" INDEX="5" DESC="1" />
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="767a13f1-f3ce-45c3-9a68-a8116922be04"><![CDATA[ return function(g) local R, db=g.result, g.db
   R:SetValue('url','[' .. 
   '{"id": "project","title":"Edit project", "icon": "fa-i-cursor", "table":"TProject2", "link": ["4A4BBF00943A4D629951C2E0A824F5FB"]},' .. 
   '{"id": "article","title":"Activities: view", "icon": "fa-align-justify", "table":"TProject2", "link": ["6532CEA7B733492DA49CD797B253143Fzoom"]},' .. 
   '{"id": "activities","title":"Edit activities", "icon": "fa-edit", "table":"TProject2", "link": ["8E433F88556C4F3EA0C41370263DB9A2"]},' .. 
   '{"id": "phase","title":"Add phase", "icon": "fa-edit", "table":"TProject2", "link": ["68648A00910D1B408CE5DD417B83DE88"]}' ..    
   ']') 
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
      
      <QUERYLINK TYPENAME="record" NAME="Project"  DESCRIPTION="Edit projects for customer" KEY="4A4BBF00943A4D629951C2E0A824F5FB" QUERY="D43E71E96DC64255A8DFE9EC9CB0AC5E">
         <EXPRESSION>
SELECT CustomerK value, 'CustomerK' AS name, FName AS simple, 'TCustomer1' FROM $OTCustomer WHERE CustomerK=(SELECT ParentK FROM $OTProject p WHERE CustomerK={{==TProject2}} AND p.table_number=1030)
UNION All
SELECT ProjectK value, 'ProjectK' AS name, FName simple, 'TProject2' FROM $OTProject WHERE ProjectK={{==TProject2}}
         </EXPRESSION>
         <PROPERTIES OUTPUT-WIDTH="1000" OUTPUT-HEIGHT="350" OUTPUT-POSITION="right-bottom"  />
      </QUERYLINK>
      

      <QUERYLINK TYPENAME="children" NAME="Activities"  DESCRIPTION="View activities for project" KEY="6532CEA7B733492DA49CD797B253143F"
                 EXPRESSION="SELECT ProjectK value, 'ProjectK' AS name, 'Project: ' + FName AS simple FROM $OTProject WHERE ProjectK={{==TProject2}}">
         <PROPERTIES OUTPUT-WIDTH="1100" OUTPUT-HEIGHT="500" OUTPUT-POSITION="left-top|0,100" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Activities"  DESCRIPTION="Edit activities for project" KEY="8E433F88556C4F3EA0C41370263DB9A2" 
                 EXPRESSION="SELECT ProjectK value, 'ProjectK' AS name, 'Project: ' + FName AS simple FROM $OTProject WHERE ProjectK={{==TProject2}}">
         <PROPERTIES OUTPUT-WIDTH="1600" OUTPUT-HEIGHT="500" OUTPUT-POSITION="right-bottom" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="ProjectPhase"  DESCRIPTION="Edit project phases" KEY="68648A00910D1B408CE5DD417B83DE88" EXPRESSION="SELECT ProjectK value, 'ProjectK' AS name, 'Project: ' + FName AS simple, 'TProject1' FROM $OTProject WHERE ProjectK={{==TProject2}}">
         <PROPERTIES OUTPUT-WIDTH="1600" OUTPUT-HEIGHT="350" OUTPUT-POSITION="right-center|0,200" />
      </QUERYLINK>
   </QUERY>
   
   
   <QUERY ID="Projects: Edit for System" DESCRIPTION="Projects connected to system" KEY="29BCDED64B4B4DD7A63CFAAB970F38DA" FLAGNAMES="NOTLISTED">
      <ATTRIBUTE NAME="OUTPUT-LIST">Conditional,1000</ATTRIBUTE>
      <FIELD ID="TProject1ProjectK" ALIAS="ID (Project)" TABLE="TProject1"/>
      <FIELD ID="TProject1TypeC" ALIAS="Type" TABLE="TProject1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TProject1FName" ALIAS="Name" TABLE="TProject1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="hashtag|TProject1.Hashtag" />
         <EDIT ESCAPE="1">{
"update":"application.PROCEDURE_UpdateBadge {=TProject1FName},  'TProject', ${@TProject1ProjectK} \
","formula":"1"}
         </EDIT>
      </FIELD>
      <FIELD ID="TProject1Note" ALIAS="Documentation" TABLE="TProject1" FIELDFLAGNAMES="edit" DESCRIPTION="Text for project">
         <ATTRIBUTES OUTPUT-FORMAT="markdown|padding: 0px; font-size: 90%; max-width: 95%; overflow-x: auto; white-space: normal;|[row]|padding-left: 100px;"
                     OUTPUT-STYLE="column|max-width: 30px;" />
         <EDIT>
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TProject');
IF (SELECT COUNT(*) FROM $OTNote WHERE RecordK=${@TProject1ProjectK} AND table_number=@iTable) = 0
   INSERT INTO $OTNote (RecordK, table_number,CreateD) VALUES(${@TProject1ProjectK},@iTable,GETDATE())
   
UPDATE $OTNote SET FNote={=TProject1Note}, UpdateD=GETDATE() WHERE RecordK=${@TProject1ProjectK} AND table_number=@iTable
         </EDIT>
      </FIELD>
      <FIELD ID="TProject1UserK" ALIAS="User" TABLE="TProject1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TProject1FBeginD" ALIAS="Begin" TABLE="TProject1" FIELDFLAGNAMES="edit" />
      <ORDER FIELD="TProject1FBeginD" INDEX="5" DESC="1" />
      
      <QUERYLINK TYPENAME="record" NAME="Activities"  DESCRIPTION="Edit activities for system" KEY="4A4BBF00943A4D629951C2E0A824F5FB" QUERY="E011E9977E314F43B719979473167221">
         <EXPRESSION>
DECLARE @iThread BIGINT = (SELECT FThreadId FROM $Othread WHERE table_number=1050 AND FKey={{==TProject1}})

SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK=(SELECT ParentK FROM $OTProject p WHERE ProjectK={{==TProject1}} AND a.table_number=1050)
UNION All
SELECT ProjectK value, 'ThreadKey' AS name, 'Thread: ' + FName FROM $OTProject WHERE table_number=1050 AND ProjectK=@iThread
UNION All
SELECT ProjectK value, 'ProjectK' AS name, FName simple FROM $OTProject WHERE ProjectK={{==TProject1}}
         </EXPRESSION>
         <PROPERTIES OUTPUT-WIDTH="1900" OUTPUT-HEIGHT="500" OUTPUT-POSITION="center-bottom" />
      </QUERYLINK>
      

      <ROWEDIT>
         <EDIT NAME="new_project" SIMPLE="Projects" TYPENAME="new_row">
            <PROPERTY NAME="columns">ProjectK,UserK,FBeginD</PROPERTY>
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION CACHE="5656912d-6bba-479f-9472-f9ed83d73bfc">
-- # Add record to TProject
DECLARE @iSystem INT = {{=SystemK}};
DECLARE @DTBegin DATETIME = {=FBegin};
DECLARE @iUser INT = {=UserK};
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TSystem');
DECLARE @sName NVARCHAR(500) = {=FName"''"};

IF @DTBegin IS NULL
   SET @DTBegin = DATEADD(hour, DATEDIFF(hour,0,GETDATE()), 0);

IF @iUser IS NULL
   SET @iUser = {#V user "@@user"} -- default user is active user
   
INSERT INTO $OTProject (FName,TypeC,UserK,FBeginD,CreateD,UpdateD,ParentK,table_number) 
VALUES(@sName,{=TypeC},@iUser,@DTBegin,GETDATE(),GETDATE(),@iSystem,@iTable);

SET @iTable = (SELECT number FROM $Otable_number WHERE "name" = 'TProject');
DECLARE @iProject BIGINT = (SELECT IDENT_CURRENT('$OTProject'));

INSERT INTO $OTNote(RecordK,table_number,FNote,CreateD,UpdateD)
VALUES(@iProject,@iTable,{=TProject1Note},GETDATE(),GETDATE());

EXEC $OPROCEDURE_UpdateBadge @sName, 'TProject', @iProject
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTProject')">
               <EXPRESSION>
DECLARE @iProject BIGINT = (SELECT IDENT_CURRENT('$OTProject'));
SELECT ProjectK, (SELECT _u.FDisplayName + ' (' + ISNULL(_u.FFirstName,'') + ' ' + ISNULL(_u.FLastName,'') + ')' FROM $OTUser _u WHERE _u.UserK=TProject.UserK), CONVERT(CHAR(16), FBeginD, 120) FROM  $OTProject WHERE ProjectK=@iProject;
               </EXPRESSION>
            </SQL>
         </EDIT>
         <EDIT NAME="delete project" SIMPLE="Delete Project" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $OTProject WHERE ProjectK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   <QUERY ID="Projects: Edit for customer" DESCRIPTION="Projects connected to customer" KEY="D43E71E96DC64255A8DFE9EC9CB0AC5E" FLAGNAMES="NOTLISTED">
      <ATTRIBUTE NAME="OUTPUT-LIST">Conditional,1000</ATTRIBUTE>
      <FIELD ID="TProject2ProjectK" ALIAS="ID (Project)" TABLE="TProject2"/>
      <FIELD ID="TProject2TypeC" ALIAS="Type" TABLE="TProject2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TProject2FName" ALIAS="Name" TABLE="TProject2" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="hashtag|TProject2.Hashtag" />
         <EDIT ESCAPE="1">{
"update":"application.PROCEDURE_UpdateBadge {=TProject2FName},  'TProject', ${@TProject2ProjectK} \
","formula":"1"}
         </EDIT>
      </FIELD>
      <FIELD ID="TProject2Note" ALIAS="Documentation" TABLE="TProject2" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="markdown|padding: 0px; font-size: 90%; max-width: 95%; overflow-x: auto; white-space: normal;|[row]|padding-left: 100px;"
                     OUTPUT-STYLE="column|max-width: 30px;" />
         <EDIT>
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TProject');
IF (SELECT COUNT(*) FROM $OTNote WHERE RecordK=${@TProject2ProjectK} AND table_number=@iTable) = 0
   INSERT INTO $OTNote (RecordK, table_number,CreateD) VALUES(${@TProject2ProjectK},@iTable,GETDATE())
   
UPDATE $OTNote SET FNote={=TProject2Note}, UpdateD=GETDATE() WHERE RecordK=${@TProject2ProjectK} AND table_number=@iTable
         </EDIT>
      </FIELD>
      <FIELD ID="TProject2UserK" ALIAS="User" TABLE="TProject2" FIELDFLAGNAMES="edit" />
      <FIELD ID="TProject2FBeginD" ALIAS="Begin" TABLE="TProject2" FIELDFLAGNAMES="edit" />
      <ORDER FIELD="TProject2FBeginD" INDEX="5" DESC="1" />
      
      <QUERYLINK TYPENAME="record" NAME="Activities"  DESCRIPTION="Edit activities for system" KEY="4A4BBF00943A4D629951C2E0A824F5FB" QUERY="E011E9977E314F43B719979473167221">
         <EXPRESSION>
DECLARE @iThread BIGINT = (SELECT FThreadId FROM $Othread WHERE table_number=1050 AND FKey={{==TProject2}})

SELECT CustomerK value, 'CustomerK' AS name, FName AS simple FROM $OTSystem WHERE SystemK=(SELECT ParentK FROM $OTProject p WHERE ProjectK={{==TProject2}} AND a.table_number=1050)
UNION All
SELECT ProjectK value, 'ThreadKey' AS name, 'Thread: ' + FName FROM $OTProject WHERE table_number=1050 AND ProjectK=@iThread
UNION All
SELECT ProjectK value, 'ProjectK' AS name, FName simple FROM $OTProject WHERE ProjectK={{==TProject2}}
         </EXPRESSION>
         <PROPERTIES OUTPUT-WIDTH="1900" OUTPUT-HEIGHT="500" OUTPUT-POSITION="center-bottom" />
      </QUERYLINK>
      

      <ROWEDIT>
         <EDIT NAME="new_project" SIMPLE="Projects" TYPENAME="new_row">
            <PROPERTY NAME="columns">ProjectK,UserK,FBeginD</PROPERTY>
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION CACHE="f39067f4-56d7-4967-a209-1c7f97f46159">
-- # Add record to TProject
DECLARE @iCustomer INT = {{=CustomerK}};
DECLARE @DTBegin DATETIME = {=FBegin};
DECLARE @iUser INT = {=UserK};
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TCustomer');
DECLARE @sName NVARCHAR(500) = {=FName"''"};

IF @DTBegin IS NULL
   SET @DTBegin = DATEADD(hour, DATEDIFF(hour,0,GETDATE()), 0);

IF @iUser IS NULL
   SET @iUser = {#V user "@@user"} -- default user is active user
   
INSERT INTO $OTProject (FName,TypeC,UserK,FBeginD,CreateD,UpdateD,ParentK,table_number) 
VALUES(@sName,{=TypeC},@iUser,@DTBegin,GETDATE(),GETDATE(),@iCustomer,@iTable);

SET @iTable = (SELECT number FROM $Otable_number WHERE "name" = 'TProject');
DECLARE @iProject BIGINT = (SELECT IDENT_CURRENT('$OTProject'));

INSERT INTO $OTNote(RecordK,table_number,FNote,CreateD,UpdateD)
VALUES(@iProject,@iTable,{=TProject2Note},GETDATE(),GETDATE());

EXEC $OPROCEDURE_UpdateBadge @sName, 'TProject', @iProject
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTProject')">
               <EXPRESSION>
DECLARE @iProject BIGINT = (SELECT IDENT_CURRENT('$OTProject'));
SELECT ProjectK, (SELECT _u.FDisplayName + ' (' + ISNULL(_u.FFirstName,'') + ' ' + ISNULL(_u.FLastName,'') + ')' FROM $OTUser _u WHERE _u.UserK=TProject.UserK), CONVERT(CHAR(16), FBeginD, 120) FROM  $OTProject WHERE ProjectK=@iProject;
               </EXPRESSION>
            </SQL>
         </EDIT>
         <EDIT NAME="delete project" SIMPLE="Delete Project" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $OTProject WHERE ProjectK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   
   
   <QUERY ID="Projects: Connect to Version" KEY="74344EDB55A64E0194402CE4444EC16D" DESCRIPTION="Connect projects to selection version, only unreleased versions are shown">
      <ATTRIBUTE NAME="OUTPUT-LIST">Projects,30</ATTRIBUTE>
      <FIELD ID="TProject1ProjectK" ALIAS="ID" TABLE="TProject1"/>
      <FIELD ID="TSystem1FName" ALIAS="Name" TABLE="TSystem1"/>
      <FIELD ID="TProject1VersionName" ALIAS="Version" TABLE="TProject1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES SERVER-LIST="SELECT CAST(0 AS INT) AS SystemVersionK, '_ no version _' AS FName UNION ALL SELECT t.SystemVersionK, (SELECT TOP 1 s.FName FROM $OTSystem s WHERE s.SystemK=t.SystemK) + ', ' + CAST(t.FVersion1 AS NVARCHAR(5)) + ':' + CAST(t.FVersion2 AS NVARCHAR(5)) + ':' + CAST(t.FVersion3 AS NVARCHAR(5)) FROM $OTSystemVersion t WHERE t.FDeleted = 0 AND t.FReleased=0 ORDER BY 2 DESC" />
         <EDIT>
DECLARE @iVersion INT = {{=TProject1VersionName}}
DELETE FROM $OTrSystemVersionXProject WHERE ProjectK = ${@TProject1ProjectK} -- delete if activity is already connected
IF @iVersion IS NOT NULL OR @iVersion &gt; 0
   INSERT INTO $OTrSystemVersionXProject(SystemVersionK,ProjectK,TargetC,ImpactC) VALUES( @iVersion, ${@TProject1ProjectK},0,0)
         </EDIT>
      </FIELD>
      <FIELD ID="TProject1TypeC" ALIAS="Type" TABLE="TProject1" />
      <FIELD ID="TProject1StateC" ALIAS="State" TABLE="TProject1" />
      <FIELD ID="TProject1Name" ALIAS="Name" TABLE="TProject1" />
      <FIELD ID="TProject1FDescription" ALIAS="Description" TABLE="TProject1" FORMAT="CASE WHEN LEN($T.$F) &gt; 80 THEN CAST( $T.$F AS NVARCHAR( 80 ) ) + '...' ELSE $T.$F END" FIELDFLAGNAMES="sql_format" />
      <FIELD ID="TProject1CreateD" ALIAS="Created" TABLE="TProject1" FORMAT="CAST( $T.$F AS DATE )" FIELDFLAGNAMES="sql_format" />
      <CONDITION ID="TProject1FDone" TABLE="TProject1" OPERATOR="0" SIMPLEVALUE="NO" VALUE="0" />
      <CONDITION ID="TProject1FDeleted" TABLE="TProject1" OPERATOR="0" SIMPLEVALUE="NO" VALUE="0" />
      <ORDER FIELD="TProject1ProjectK" INDEX="0" DESC="1" SQL="TProject1.UpdateD" />
      <ORDERS NAME="Last updated">
         <ORDER FIELD="TProject1ProjectK" INDEX="0" DESC="1" SQL="TProject1.UpdateD" />
      </ORDERS>
   </QUERY>
   
   <QUERY ID="Project phase" DESCRIPTION="Add phases to project" KEY="68648A00910D1B408CE5DD417B83DE88">
      <ATTRIBUTE NAME="LUA-UPDATEVALUE"><![CDATA[
return function( g )
if g.on == 1 then
   local edit = g.edit;
   if edit:HasValue({"TypeC","LevelC","StateC"}) == true then
      local sInsert = [[   
INSERT INTO $OTProjectHistory( ProjectK, ProjectPhaseK, TypeC, StateC, PriorityC, LevelC, FDescription, CreateD )
SELECT ProjectK, ProjectPhaseK, TypeC, StateC, PriorityC, LevelC, FDescription, GETDATE() FROM $OTProjectPhase
WHERE ProjectPhaseK=]] .. edit:GetValue("TProjectPhase1ProjectPhaseK");
      local dbdata = g.application:GetDatabaseData();
      sInsert = dbdata:FormatSQL( sInsert )
      g.db:Execute(sInsert);
   end
end   
end
      ]]></ATTRIBUTE>
      <FIELD ID="TProjectPhase1ProjectPhaseK" ALIAS="ID" TABLE="TProjectPhase1"/>
      <FIELD ID="TProjectPhase1CustomerChapterK" ALIAS="Phase" TABLE="TProjectPhase1" />
      <FIELD ID="TProjectPhase1FName" ALIAS="Name" TABLE="TProjectPhase1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TProjectPhase1FDescription" ALIAS="Description" TABLE="TProjectPhase1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TProjectPhase1FBeginD" ALIAS="Begin" TABLE="TProjectPhase1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TProjectPhase1FEndD" ALIAS="End" TABLE="TProjectPhase1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TProjectPhase1TypeC" ALIAS="Type" TABLE="TProjectPhase1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TProjectPhase1StateC" ALIAS="State" TABLE="TProjectPhase1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TProjectPhase1LevelC" ALIAS="Level" TABLE="TProjectPhase1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TProjectPhase1CustomerContactK" ALIAS="Contact" TABLE="TProjectPhase1" FIELDFLAGNAMES="edit">
         <ATTRIBUTE NAME="SERVER-LIST">
SELECT CustomerContactK, COALESCE(_cc.FNickname, _cc.FFirstName) FROM $OTCustomerContact _cc WHERE _cc.CustomerK = (SELECT ParentK FROM $OTProject WHERE ProjectK={=TProject1ProjectK})            
         </ATTRIBUTE>
         <EDIT>
SELECT CustomerContactK, COALESCE(_cc.FNickname, _cc.FFirstName) FROM $OTCustomerContact _cc WHERE _cc.CustomerK = (SELECT ParentK FROM $OTProject WHERE ProjectK={=ProjectK})
         </EDIT>
<!--
         <EDIT>
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TProject');
IF (SELECT COUNT(*) FROM $OTNote WHERE RecordK=${@TProject2ProjectK} AND table_number=@iTable) = 0
   INSERT INTO $OTNote (RecordK, table_number,CreateD) VALUES(${@TProject2ProjectK},@iTable,GETDATE())
   
UPDATE $OTNote SET FNote={=TProject2Note}, UpdateD=GETDATE() WHERE RecordK=${@TProject2ProjectK} AND table_number=@iTable
         </EDIT>
-->         
      </FIELD>
      <ORDER FIELD="TProjectPhase1FBeginD" />
      <SELECTCONDITIONS>
         <!-- <SELECTCONDITION ID="TCustomerContact1FFirstName" TABLE="TCustomerContact1" /> -->
         <SELECTCONDITION ID="TProjectPhase1CustomerContactK" TABLE="TProjectPhase1" />
      </SELECTCONDITIONS>
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE><![CDATA[ return function(g) local R, db, sE=g.result, g.db, g.result:GetParam("event");
   R:SetValue('url','[' .. 
   '{"id": "activities","title":"Activities: connect", "icon": "fa-edit", "table":"TProjectPhase1", "link": ["0B725A57F50564458304C6156A67F633"]}' .. 
   ']') 
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
      <QUERYLINK TYPENAME="children" NAME="Activities"  DESCRIPTION="Connect activities" KEY="0B725A57F50564458304C6156A67F633" EXPRESSION="SELECT ProjectPhaseK value, 'ProjectPhaseK' AS name, FName AS simple FROM $OTProjectPhase WHERE ProjectPhaseK={{==TProjectPhase1}}">
         <PROPERTIES OUTPUT-WIDTH="500" OUTPUT-HEIGHT="250" OUTPUT-POSITION="right-center" />
      </QUERYLINK>
      <ROWEDIT>
         <EDIT NAME="new_projectphase" SIMPLE="New Phase" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
DECLARE @iProject BIGINT = {==ProjectK}
DECLARE @DTBegin DATETIME = {=FBegin};
DECLARE @DTEnd DATETIME = {=FEnd};

IF @DTBegin IS NULL
   SET @DTBegin = GETDATE()
IF @DTEnd IS NULL
   SET @DTEnd = @DTBegin


INSERT INTO $OTProjectPhase(ProjectK,TypeC,StateC,LevelC,FBeginD,FExactBeginD,FEndD,FExactEndD,FName,FDescription,CreateD,UpdateD) 
VALUES(@iProject,{=TypeC},{=StateC},{=LevelC},@DTBegin,@DTBegin,@DTEnd,@DTEnd,{=FName},{=FDescription},GETDATE(),GETDATE());
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTProjectPhase')" />
         </EDIT>

         <EDIT NAME="add_soccer_skills" SIMPLE="Soccer skills" TYPENAME="new_sheet" DESCRIPTION="Create phases for soccer skills">
            <SQL TYPENAME="insert" COMMAND="insert-sheet">
               <EXPRESSION><![CDATA[
SET NOCOUNT ON

BEGIN TRY
   DECLARE @iUser INT = {#V user "@@user"};
   DECLARE @iProject BIGINT = {==ProjectK}
   DECLARE @iContactK BIGINT = {==CustomerContactK}
   DECLARE @iLevel INT = 0
   
   DECLARE @iCount INT = (SELECT COUNT(*) FROM $OTProjectPhase WHERE CustomerContactK=@iContactK)
   
   IF @iCount = 0
   BEGIN
      IF @iLevel = 0
         SET @iLevel = (SELECT TOP 1 ISNULL(CodeK,0) FROM $O{CODE}TCode WHERE GroupK = 283 AND FDefault = 1)
   
      DECLARE @iCustomer BIGINT = (SELECT ParentK FROM $OTProject WHERE ProjectK = @iProject)
      IF @iCustomer IS NULL
         RAISERROR('EXPRESSION: Customer was not found for Project with key set to %d', 17, -1, @iProject)
   
      DECLARE @iChapterCode INT = (SELECT c.CodeK FROM $O{CODE}TCode c WHERE c.FSystemName = 'grade' AND c.GroupK=300);
      IF @iChapterCode IS NULL
         RAISERROR('EXPRESSION: No grade key found, to generate you need a code with the system name grade', 17, -1 )
   
      DECLARE @tCodes TABLE (codek INT); -- table has keys to generated  project phases
      INSERT INTO @tCodes
      SELECT CustomerChapterK FROM $OTCustomerChapter WHERE CustomerK=@iCustomer AND TypeC=@iChapterCode
   
      INSERT INTO $OTProjectPhase (ProjectK, UserK, CreateD, UpdateD, FBeginD, LevelC, CustomerContactK, CustomerChapterK, FActive )
      SELECT @iProject, @iUser, GETDATE(), GETDATE(), GETDATE(), @iLevel, @iContactK, codek, 1 FROM @tCodes
   END
   
END TRY
BEGIN CATCH 
   THROW;
END CATCH
-- RAISERROR('EXPRESSION: REDDY', 17, -1 )


            ]]></EXPRESSION>               
            </SQL>
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   <QUERY ID="Project phase: Activities" DESCRIPTION="View connected activities to project phase" KEY="0B725A57F50564458304C6156A67F633">
      <FIELD ID="TrProjectPhaseXActivity1rProjectPhaseXActivityK" ALIAS="ID" TABLE="TrProjectPhaseXActivity1"/>
      <FIELD ID="TrProjectPhaseXActivity1ActivityK" ALIAS="Activity" TABLE="TrProjectPhaseXActivity1" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="connect_activity" SIMPLE="Connect Activity" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
-- # Add record to TrProjectPhaseXActivity
DECLARE @iProjectPhase BIGINT = {{=ProjectPhaseK}};
INSERT INTO $OTrProjectPhaseXActivity (ProjectPhaseK,ActivityK) VALUES(@iProjectPhase,{=@iActivityK});
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTrProjectPhaseXActivity')" />
         </EDIT>
         <EDIT NAME="delete activity" SIMPLE="Delete connection to Activity" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $O$OTrProjectPhaseXActivity WHERE rProjectPhaseXActivityK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   

   <QUERY ID="Requests: All" DESCRIPTION="View and edit requests" KEY="9EEDF06D9A4CDE42B1F1BF18243DADF7">
      <ATTRIBUTE NAME="OUTPUT-LIST">Important</ATTRIBUTE>
      <FIELD ID="TSystemRequest1SystemRequestK" ALIAS="ID" TABLE="TSystemRequest1"/>
      <FIELD ID="TSystem1FName" ALIAS="Name" TABLE="TSystem1"/>
      <FIELD ID="TSystemRequest1FBrief" ALIAS="Brief" TABLE="TSystemRequest1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="hashtag|TSystemRequest1.Hashtag" />
         <EDIT ESCAPE="1">{
"update":"application.PROCEDURE_UpdateBadge {=TSystemRequest1FBrief},  'TSystemRequest', ${@TSystemRequest1SystemRequestK} \
","formula":"1"}
         </EDIT>
      </FIELD>
      <FIELD ID="TSystemRequest1FText" ALIAS="Text" TABLE="TSystemRequest1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="markdown|padding: 0px; font-size: 90%; max-width: 95%; overflow-x: auto; white-space: normal;|[row]|padding-left: 100px;"
                     OUTPUT-STYLE="column|max-width: 30px;" />
      </FIELD>
      <FIELD ID="TSystemRequest1TypeC" ALIAS="Type" TABLE="TSystemRequest1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSystemRequest1StateC" ALIAS="State" TABLE="TSystemRequest1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSystemRequest1CountActivity" ALIAS="Act." TABLE="TSystemRequest1" DESCRIPTION="Number of activites">
         <!-- https://stackoverflow.com/questions/18359925/draw-an-arrow-inside-table-cell-using-css -->
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right;' class='mark_note'|/^[1-9]" />
      </FIELD>
      <FIELD ID="TSystemRequest1FBegin" ALIAS="Start" TABLE="TSystemRequest1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSystemRequest1CreateD" ALIAS="Created" TABLE="TSystemRequest1" FORMAT="CAST( $T.$F AS DATE )" FIELDFLAGNAMES="sql_format" />
      <FIELD ID="TSystemRequest1FDone" ALIAS="Closed" TABLE="TSystemRequest1" FIELDFLAGNAMES="edit"/>
      <ORDER FIELD="TSystemRequest1FBegin" DESC="1" />
      <CONDITION ID="TSystemRequest1FDone" TABLE="TSystemRequest1" OPERATOR="0" SIMPLEVALUE="Not closed" VALUE="0" FLAGS="0"/>
      <CONDITIONS ID="Select filter!">
         <CONDITION ID="TSystemRequest1FDeleted" TABLE="TSystemRequest1" OPERATOR="0" SIMPLEVALUE="0" VALUE="0" FLAGS="0"/>
      </CONDITIONS>
      <CONDITIONS ID="Not closed" SELECTED="1">
         <CONDITION ID="TSystemRequest1FDone" TABLE="TSystemRequest1" OPERATOR="0" SIMPLEVALUE="Not closed" VALUE="0" FLAGS="0"/>
      </CONDITIONS>
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="14e518d9-ba56-4bd4-8d59-6a7da1237bbb"><![CDATA[ return function(g) local R, db, sE=g.result, g.db, g.result:GetParam("event");
if sE == "click" then
   local iColumn = R:GetParam("column")
   if iColumn == 6 then
      local iKeyPressed = R:GetParam("pressed")
      if iKeyPressed == 0 then
         R:SetValue('url','{"link": ["8C85672673CD4721AE38639DBE3B2290zoom"],"table":"TSystemRequest1"}' )
      else
         R:SetValue('url','{"link": ["E5310AF760F09748BB7A760B4588399A"],"table":"TSystemRequest1"}' )
      end
      return
   end
end
            
   R:SetValue('url','[' .. 
   '{"id": "activities","title":"Activities: view", "icon": "fa-align-justify", "table":"TSystemRequest1", "link": ["8C85672673CD4721AE38639DBE3B2290zoom"]},' .. 
   '{"id": "activities","title":"Add activities to request", "icon": "fa-edit", "table":"TSystemRequest1", "link": ["E5310AF760F09748BB7A760B4588399A"]}' .. 
   ']') 
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
      <QUERYLINK TYPENAME="children" NAME="Activities"  DESCRIPTION="View Activities" KEY="8C85672673CD4721AE38639DBE3B2290" EXPRESSION="SELECT SystemRequestK value, 'SystemRequestK' AS name, FBrief AS simple FROM $OTSystemRequest WHERE SystemRequestK={{==TSystemRequest1}}">
         <PROPERTIES OUTPUT-WIDTH="1200" OUTPUT-HEIGHT="250" OUTPUT-POSITION="left-top" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Activities"  DESCRIPTION="Edit activities for requsts" KEY="E5310AF760F09748BB7A760B4588399A" EXPRESSION="SELECT SystemRequestK value, 'SystemRequestK' AS name, FBrief AS simple FROM $OTSystemRequest WHERE SystemRequestK={{==TSystemRequest1}}">
         <PROPERTIES OUTPUT-WIDTH="1200" OUTPUT-HEIGHT="250" OUTPUT-POSITION="right-bottom" />
      </QUERYLINK>
   </QUERY>
   
   <QUERY ID="Requests" KEY="8DE134A0A74C43E7896A256A644EDB92">
      <FIELD ID="TSystemRequest1SystemRequestK" ALIAS="ID" TABLE="TSystemRequest1"/>
      <FIELD ID="TSystemRequest1FBegin" ALIAS="Date" TABLE="TSystemRequest1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TSystemRequest1TypeC" ALIAS="Type" TABLE="TSystemRequest1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TSystemRequest1FBrief" ALIAS="Brief" TABLE="TSystemRequest1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="hashtag|TSystemRequest1.Hashtag" />
         <EDIT ESCAPE="1">{
"update":"application.PROCEDURE_UpdateBadge {=TSystemRequest1FBrief},  'TSystemRequest', ${@TSystemRequest1SystemRequestK} \
","formula":"1"}
         </EDIT>
      </FIELD>
      <FIELD ID="TSystemRequest1FDone" ALIAS="Closed" TABLE="TSystemRequest1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TSystemRequest1FText" ALIAS="Text" TABLE="TSystemRequest1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="`hashtag|TSystemRequest1.Hashtag` `markdown|padding: 3px; font-size: 11%; overflow-x: auto; white-space: normal;|[row]|padding-left: 50px;`"
                     OUTPUT-STYLE="column|max-width: 25px;" />

      </FIELD>
      <FIELD ID="TSystemRequest1Picture" ALIAS="Pic" DESCRIPTION="Picture" TABLE="TSystemRequest1">
         <ATTRIBUTES OUTPUT-FORMAT="image| |[row]|padding-left: 10px; margin: 3px; max-height: 100px; opacity: 0.3; overflow-y: scroll;"
                     OUTPUT-STYLE="column|width: 20px;" />
      </FIELD>
      <CONDITION ID="TSystemRequest1FDone" TABLE="TSystemRequest1" OPERATOR="0" SIMPLEVALUE="Not closed" VALUE="0" FLAGS="0"/>
      <CONDITION ID="TSystemRequest1FDeleted" TABLE="TSystemRequest1" OPERATOR="5" SIMPLEVALUE="Not deleted" VALUE="1" FLAGS="0"/>
      <CONDITION ID="TSystemRequest1FDeleted" TABLE="TSystemRequest1" OPERATOR="5" SIMPLEVALUE="Not deleted" VALUE="1" FLAGS="0"/>
      <CONDITIONS ID="Select filter!">
         <CONDITION ID="TSystemRequest1FDeleted" TABLE="TSystemRequest1" OPERATOR="5" SIMPLEVALUE="Not deleted" VALUE="1" FLAGS="0"/>
      </CONDITIONS>
      <CONDITIONS ID="Not closed" SELECTED="1">
         <CONDITION ID="TSystemRequest1FDone" TABLE="TSystemRequest1" OPERATOR="0" SIMPLEVALUE="Not closed" VALUE="0" FLAGS="0"/>
      </CONDITIONS>
      <CONDITIONS ID='{"name":"Requests without activities", "title":"View not closed requests without connected activity" }'>
         <CONDITION ID="TSystemRequest1CountActivity" TABLE="TSystemRequest1" OPERATOR="0" SIMPLEVALUE="Zero activities" VALUE="0" FLAGS="0"/>
         <CONDITION ID="TSystemRequest1FDone" TABLE="TSystemRequest1" OPERATOR="0" SIMPLEVALUE="Not closed" VALUE="0" FLAGS="0"/>
      </CONDITIONS>
      <CONDITIONS ID='{ "name": "All", "title": "All requets, includs deleted", "style": "color: rgb(190,190,190); " }' />
      
      <ORDER INDEX="1" DESC="1" />
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="2e0b4784-4ec7-490e-823f-b6daf5bc6a88"><![CDATA[ return function(g) local R, db, sE=g.result, g.db, g.result:GetParam("event");
   R:SetValue('url','[' .. 
   '{"id": "edit","title":"Edit Request", "icon": "fa-i-cursor", "table":"TSystemRequest1", "link": ["ABD3CAB3AD27A5419FFB978647AF1E17"]},' ..    
   '{"id": "activities","title":"Activities: view", "icon": "fa-align-justify", "table":"TSystemRequest1", "link": ["8C85672673CD4721AE38639DBE3B2290zoom"]},' .. 
   '{"id": "activities_edit","title":"Add activities to request", "icon": "fa-edit", "table":"TSystemRequest1", "link": ["E5310AF760F09748BB7A760B4588399A"]}' .. 
   ']') 
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>

      <QUERYLINK TYPENAME="record" NAME="Edit request"  DESCRIPTION="Edit request" KEY="ABD3CAB3AD27A5419FFB978647AF1E17">
         <EXPRESSION>
SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK=(SELECT _sr.SystemK FROM $OTSystemRequest _sr WHERE SystemRequestK={{==[0]}})
UNION All
SELECT SystemRequestK value, 'SystemRequestK' AS name, FBrief simple FROM $OTSystemRequest WHERE SystemRequestK={{==[0]}}
         </EXPRESSION>
         <PROPERTIES OUTPUT-WIDTH="*" OUTPUT-HEIGHT="400" OUTPUT-POSITION="center-bottom" />
      </QUERYLINK>
      
      <QUERYLINK TYPENAME="children" NAME="Activities"  DESCRIPTION="View Activities" KEY="8C85672673CD4721AE38639DBE3B2290" EXPRESSION="SELECT SystemRequestK value, 'SystemRequestK' AS name, FBrief AS simple FROM $OTSystemRequest WHERE SystemRequestK={{==TSystemRequest1}}">
         <PROPERTIES OUTPUT-WIDTH="1200" OUTPUT-HEIGHT="250" OUTPUT-POSITION="left-top" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Activities"  DESCRIPTION="Edit activities for requsts" KEY="E5310AF760F09748BB7A760B4588399A" EXPRESSION="SELECT SystemRequestK value, 'SystemRequestK' AS name, FBrief AS simple FROM $OTSystemRequest WHERE SystemRequestK={{==TSystemRequest1}}">
         <PROPERTIES OUTPUT-WIDTH="1400" OUTPUT-HEIGHT="250" OUTPUT-POSITION="right-bottom" />
      </QUERYLINK>
   </QUERY>


   <QUERY ID="Edit requests for system" KEY="ABD3CAB3AD27A5419FFB978647AF1E17" FLAGNAMES="NOTLISTED">
      <ATTRIBUTE NAME="OUTPUT-TRUNCATE">[20,50,200]|50</ATTRIBUTE>
      <FIELD ID="TSystemRequest1SystemRequestK" ALIAS="ID" TABLE="TSystemRequest1"/>
      <FIELD ID="TSystemRequest1TypeC" ALIAS="Type" TABLE="TSystemRequest1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TSystemRequest1StateC" ALIAS="State" TABLE="TSystemRequest1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TSystemRequest1PriorityC" ALIAS="Priority" TABLE="TSystemRequest1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TSystemRequest1FBrief" ALIAS="Brief" TABLE="TSystemRequest1" FIELDFLAGNAMES="edit">
         <EDIT ESCAPE="1">{
"update":
"DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE \"name\" = 'TSystemRequest'); \
DECLARE @iSystemRequest BIGINT = ${@TSystemRequest1SystemRequestK}\
DECLARE @sBrief NVARCHAR(200) = {=TSystemRequest1FBrief}\
\
DELETE FROM $OTrXBadge WHERE ParentK = @iSystemRequest AND table_number = @iTable\
\
IF LEN( @sBrief ) &gt; 2\
BEGIN\
   -- Add missing hashtags to Badge table\
   INSERT INTO $OTBadge (FName)\
   SELECT tag FROM $OPullTagsFromText( @sBrief ) LEFT JOIN $OTBadge _b ON tag = _b.FName WHERE _b.FName IS NULL\
   \
   -- Connect hashtags to Request record\
   INSERT INTO $OTrXBadge (ParentK,table_number,BadgeK)\
   SELECT @iSystemRequest, @iTable, _b.BadgeK\
   FROM $OTBadge _b JOIN $OPullTagsFromText( @sBrief ) ON _b.FName = tag\
END\
","formula":"1"}</EDIT>
      </FIELD>
      <FIELD ID="TSystemRequest1FText" ALIAS="Text" TABLE="TSystemRequest1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TSystemRequest1FBegin" ALIAS="Date" TABLE="TSystemRequest1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TSystemRequest1FWaiting" ALIAS="Waiting" TABLE="TSystemRequest1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TSystemRequest1Picture" ALIAS="Picture" TABLE="TSystemRequest1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="image| |[row]|padding-left: 50px; background-color: #EEE; margin: 3px; max-height: 300px; overflow-y: scroll;"
                     OUTPUT-STYLE="column|width: 20px;"
                     OUTPUT-INPUT="file" />
         <EDIT>
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TSystemRequest');
DECLARE @iSize INT = {{=size}}
DECLARE @sName NVARCHAR(200) = {=TSystemRequest1Picture}

DELETE FROM $OTImage WHERE RecordK=${@[$T]SystemRequestK} AND table_number=@iTable
IF @sName IS NOT NULL AND LEN( @sName ) &gt; 0
BEGIN
   INSERT INTO $OTImage (RecordK, table_number) VALUES(${@[$T]SystemRequestK},@iTable)
   UPDATE $OTImage SET FName=@sName, FExtension={=extension}, FData=0x{{=data"00"}}, FSize=@iSize, MimeName={=mime} WHERE RecordK=${@[$T]SystemRequestK} AND table_number=@iTable
END   
         </EDIT>
      </FIELD>
      <FIELD ID="TSystemRequest1FDone" ALIAS="Closed" TABLE="TSystemRequest1" FIELDFLAGNAMES="edit">
         <EDIT>{"update":"UPDATE $OTSystemRequest SET FDoneD = GETDATE() WHERE SystemRequestK = ${@TSystemRequest1SystemRequestK}","formula":"1"}</EDIT>
      </FIELD>
      <ORDER INDEX="6" FIELD="TSystemRequest1FBegin" DESC="1" />
      <ROWEDIT>
         <EDIT NAME="new_request" SIMPLE="New request" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION CACHE="00000000-0000-0000-0000-000000000000">
DECLARE @DTBegin DATETIME = {=FBegin};
DECLARE @bDone BIT = {=FDone}
IF @bDone IS NULL
   SET @bDone = 0
   
DECLARE @iSize INT = {{=Picture.size}}   
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TSystemRequest');
   
IF @DTBegin IS NULL
   SET @DTBegin = GETDATE()
INSERT INTO $OTSystemRequest(SystemK,TypeC,StateC,PriorityC,FBrief,FText,FBegin,FDone,FWaiting,CreateD,UpdateD) 
VALUES({{=SystemK}},{=TypeC},{=StateC},{=PriorityC},{=FBrief"''"},{=FText},@DTBegin,@bDone,{=FWaiting"1"},GETDATE(),GETDATE());

IF @iSize IS NOT NULL -- Add picture if picture size is found
BEGIN
   DECLARE @iSystemRequest BIGINT = (SELECT IDENT_CURRENT('$OTSystemRequest'));
   INSERT INTO $OTImage (RecordK, table_number, FName, FExtension, FSize, MimeName, FData) 
   VALUES(@iSystemRequest,@iTable,{=Picture.name},{=Picture.extension}, @iSize, {=Picture.mime}, 0x{{=Picture.data"00"}})
END
               </EXPRESSION>
            </SQL>
            <PROPERTY NAME="columns">0,FWaiting</PROPERTY>
            <SQL TYPENAME="select" COMMAND="select-key">
               <EXPRESSION>
DECLARE @key BIGINT = (SELECT IDENT_CURRENT('$OTSystemRequest'));
SELECT SystemRequestK,
       CASE WHEN FWaiting = 0 THEN 'NO' ELSE 'YES' END
FROM $OTSystemRequest WHERE SystemRequestK = @key
               </EXPRESSION>
            </SQL>
         </EDIT>
      </ROWEDIT>
      <CONDITION ID="TSystemRequest1FDone" TABLE="TSystemRequest1" OPERATOR="0" SIMPLEVALUE="Not closed" VALUE="0" FLAGS="0"/>
      <CONDITIONS ID="Select filter!">
         <CONDITION ID="TSystemRequest1FDeleted" TABLE="TSystemRequest1" OPERATOR="5" SIMPLEVALUE="Not deleted" VALUE="1" FLAGS="0"/>
      </CONDITIONS>
      <CONDITIONS ID="Not closed" SELECTED="1">
         <CONDITION ID="TSystemRequest1FDone" TABLE="TSystemRequest1" OPERATOR="0" SIMPLEVALUE="Not closed" VALUE="0" FLAGS="0"/>
      </CONDITIONS>
   </QUERY>
   
   <QUERY ID="Hashtags" FLAGS="1" KEY="51ADF6C6B8A09747BB293C94933A276C">
      <ATTRIBUTE NAME="OUTPUT-LIST">Primary,1</ATTRIBUTE>
      <FIELD ID="TBadge1BadgeK" ALIAS="ID" TABLE="TBadge1"/>
      <FIELD ID="TBadge1FName" ALIAS="Name" TABLE="TBadge1"/>
      <FIELD ID="TBadge1CountActivity" ALIAS="#activities" TABLE="TBadge1" DESCRIPTION="number of activities">
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right;' class='mark_note'|/^[1-9]" />
      </FIELD>
      <FIELD ID="TBadge1CountArticle" ALIAS="#articles" TABLE="TBadge1" DESCRIPTION="number of articles">
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right;' class='mark_note'|/^[1-9]" />
      </FIELD>
      <FIELD ID="TBadge1CountArticleBook" ALIAS="#books" TABLE="TBadge1" DESCRIPTION="number of books">
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right;' class='mark_note'|/^[1-9]" />
      </FIELD>
      <FIELD ID="TBadge1CountRequest" ALIAS="#requests" TABLE="TBadge1" DESCRIPTION="number of requests">
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right;' class='mark_note'|/^[1-9]" />
      </FIELD>
      <FIELD ID="TBadge1CountProject" ALIAS="#projects" TABLE="TBadge1" DESCRIPTION="number of projects">
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right;' class='mark_note'|/^[1-9]" />
      </FIELD>
      <FIELD ID="TBadge1CountSystem" ALIAS="#systems" TABLE="TBadge1" DESCRIPTION="number of systems">
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right;' class='mark_note'|/^[1-9]" />
      </FIELD>
      <FIELD ID="TBadge1CountCustomer" ALIAS="#customers" TABLE="TBadge1" DESCRIPTION="number of customers">
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right;' class='mark_note'|/^[1-9]" />
      </FIELD>
      <FIELD ID="TBadge1CountLink" ALIAS="#links" TABLE="TBadge1" DESCRIPTION="number of links">
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right;' class='mark_note'|/^[1-9]" />
      </FIELD>
      <SELECTCONDITIONS>
         <SELECTCONDITION ID="TBadge1FName-Activity" TABLE="TBadge1" DATA-SIMPLE="Activity hashtags" />
         <SELECTCONDITION ID="TBadge1FName-Article" TABLE="TBadge1" DATA-SIMPLE="Article hashtags" />
         <SELECTCONDITION ID="FName-Book" TABLE="TBadge1" DATA-SIMPLE="Book hashtags" />
         <SELECTCONDITION ID="TBadge1FName-Request" TABLE="TBadge1" DATA-SIMPLE="Request hashtags" />
         <SELECTCONDITION ID="TBadge1FName-Project" TABLE="TBadge1" DATA-SIMPLE="Project hashtags" />
         <SELECTCONDITION ID="TBadge1FName-System" TABLE="TBadge1" DATA-SIMPLE="System hashtags" />
         <SELECTCONDITION ID="TBadge1FName-Customer" TABLE="TBadge1" DATA-SIMPLE="Customer hashtags" />
      </SELECTCONDITIONS>
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="2ff80865-8af9-4e16-906f-6fec9bf7040b"><![CDATA[ return function(g) local R, db, sE=g.result, g.db, g.result:GetParam("event");
if sE == "click" then
   local iKeyPressed = R:GetParam("pressed")
   local iColumn = R:GetParam("column")
   if iKeyPressed == 0 then
      if iColumn == 2 then
         R:SetValue('url','{"link": ["E7AD8F06B6B84D5F917ABDD35DBE8E97zoom"],"table":"TActivity2"}' )  return
      elseif iColumn == 3 then
         R:SetValue('url','{"link": ["140F8AA4B140418EB7670B5035C73D96zoom"],"table":"TArticle2"}' )  return
      elseif iColumn == 4 then
         R:SetValue('url','{"link": ["E5BB2FA1C43C45BDB1E725AB77D4F511zoom"],"table":"TArticleBook1"}' )  return
      elseif iColumn == 5 then
         R:SetValue('url','{"link": ["05DE02812DC84D9AA1B2CD3B781F8202zoom"],"table":"TSystemRequest1"}' )  return
      elseif iColumn == 6 then
         R:SetValue('url','{"link": ["747D9261C3F646DBAF6AAA1481EFD8D4zoom"],"table":"TProject1"}' )  return
      elseif iColumn == 7 then
         R:SetValue('url','{"link": ["A7FF336AE8B7469FAC5501C19BFE7EA6zoom"],"table":"TSystem1"}' )  return
      elseif iColumn == 8 then
         R:SetValue('url','{"link": ["0DC85D11E1AE4EB1B72759A563F96E38zoom"],"table":"TCustomer1"}' )  return
      elseif iColumn == 9 then
         R:SetValue('url','{"link": ["2A4B9A642ACE4C6F8AEB1A4EC7391474zoom"],"table":"TLink1"}' )  return
      end
   end
end

   R:SetValue('url','[' .. 
   '{"id": "activitie","title":"Activities", "icon": "fa-align-justify", "table":"TActivity2", "link": ["E7AD8F06B6B84D5F917ABDD35DBE8E97zoom"]},' .. 
   '{"id": "article","title":"Articles", "icon": "fa-align-justify", "table":"TArticle2", "link": ["140F8AA4B140418EB7670B5035C73D96zoom"]},' .. 
   '{"id": "book","title":"Books", "icon": "fa-align-justify", "table":"TArticle2", "link": ["E5BB2FA1C43C45BDB1E725AB77D4F511zoom"]},' .. 
   '{"id": "request","title":"Requests", "icon": "fa-align-justify", "table":"TSystemRequest1", "link": ["05DE02812DC84D9AA1B2CD3B781F8202zoom"]},' .. 
   '{"id": "project","title":"Projects", "icon": "fa-align-justify", "table":"TSystemRequest1", "link": ["747D9261C3F646DBAF6AAA1481EFD8D4zoom"]},' .. 
   '{"id": "system","title":"Systems", "icon": "fa-align-justify", "table":"TSystem1", "link": ["A7FF336AE8B7469FAC5501C19BFE7EA6zoom"]},' .. 
   '{"id": "customer","title":"Customer", "icon": "fa-align-justify", "table":"TCustomer1", "link": ["0DC85D11E1AE4EB1B72759A563F96E38zoom"]},' .. 
   '{"id": "link","title":"Links", "icon": "fa-align-justify", "table":"TLink1", "link": ["2A4B9A642ACE4C6F8AEB1A4EC7391474zoom"]}' .. 
   ']') 

            
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
      <QUERYLINK TYPENAME="children" NAME="Activities"  DESCRIPTION="View activities for hashtag" KEY="E7AD8F06B6B84D5F917ABDD35DBE8E97" QUERY="25CD6ED397DB44859FB0E18E78BB0FF4" EXPRESSION="SELECT FName value, 'Hashtag' AS name, FName AS simple FROM $OTBadge WHERE BadgeK={{=[0]}}">
         <PROPERTIES OUTPUT-WIDTH="1200" OUTPUT-HEIGHT="600" OUTPUT-POSITION="right-top" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Articles"  DESCRIPTION="Read articles" KEY="140F8AA4B140418EB7670B5035C73D96" QUERY="AEA4B9753D454B6DAE0CDCE9922D6223" EXPRESSION="SELECT FName value, 'Hashtag' AS name, FName AS simple FROM $OTBadge WHERE BadgeK={{=[0]}}">
         <PROPERTIES OUTPUT-WIDTH="1200" OUTPUT-HEIGHT="600" OUTPUT-POSITION="left-bottom" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Books"  DESCRIPTION="Books" KEY="E5BB2FA1C43C45BDB1E725AB77D4F511" QUERY="BDF6B05C0CF66F46817740CD67DB4ADF" EXPRESSION="SELECT FName value, 'Hashtag' AS name, FName AS simple FROM $OTBadge WHERE BadgeK={{=[0]}}">
         <PROPERTIES OUTPUT-WIDTH="1100" OUTPUT-HEIGHT="300" OUTPUT-POSITION="right-bottom" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Requests"  DESCRIPTION="Requests" KEY="05DE02812DC84D9AA1B2CD3B781F8202" QUERY="9EEDF06D9A4CDE42B1F1BF18243DADF7" EXPRESSION="SELECT FName value, 'Hashtag' AS name, FName AS simple FROM $OTBadge WHERE BadgeK={{=[0]}}">
         <PROPERTIES OUTPUT-WIDTH="1100" OUTPUT-HEIGHT="300" OUTPUT-POSITION="left-top" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Projects"  DESCRIPTION="Projects" KEY="747D9261C3F646DBAF6AAA1481EFD8D4" QUERY="AC8F938FFFFF45488251BD417A41656F" EXPRESSION="SELECT FName value, 'Hashtag' AS name, FName AS simple FROM $OTBadge WHERE BadgeK={{=[0]}}">
         <PROPERTIES OUTPUT-WIDTH="1000" OUTPUT-HEIGHT="250" OUTPUT-POSITION="right-center"  />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Systems"  DESCRIPTION="Systems" KEY="A7FF336AE8B7469FAC5501C19BFE7EA6" QUERY="F12429A8B23A06449ABA71A4A88D853E" EXPRESSION="SELECT FName value, 'Hashtag' AS name, FName AS simple FROM $OTBadge WHERE BadgeK={{=[0]}}">
         <PROPERTIES OUTPUT-WIDTH="1100" OUTPUT-HEIGHT="300" OUTPUT-POSITION="left-bottom" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Customer"  DESCRIPTION="Customer" KEY="0DC85D11E1AE4EB1B72759A563F96E38" QUERY="B124EF3E32790A44817150F735A04C64" EXPRESSION="SELECT FName value, 'Hashtag' AS name, FName AS simple FROM $OTBadge WHERE BadgeK={{=[0]}}">
         <PROPERTIES OUTPUT-WIDTH="1100" OUTPUT-HEIGHT="300" OUTPUT-POSITION="left-center" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Link"  DESCRIPTION="Customer" KEY="2A4B9A642ACE4C6F8AEB1A4EC7391474" QUERY="435f275c-cb30-4ea7-81ac-f452c520410f" EXPRESSION="SELECT FName value, 'Hashtag' AS name, FName AS simple FROM $OTBadge WHERE BadgeK={{=[0]}}">
         <PROPERTIES OUTPUT-WIDTH="800" OUTPUT-HEIGHT="200" OUTPUT-POSITION="center-top" />
      </QUERYLINK>
   </QUERY>
<!-- TActivity2.Hashtag -->   
   
   <QUERY ID="Image" KEY="5A8CCAEA79B5714FAF28174D76FBFBD1">
      <FIELD ID="TImage1ImageK" ALIAS="ID" TABLE="TImage1"/>
      <FIELD ID="TImage1FName" ALIAS="FName" TABLE="TImage1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TImage1FFolder" ALIAS="FFolder" TABLE="TImage1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TImage1FDescription" ALIAS="FDescription" TABLE="TImage1" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="new_image" SIMPLE="Image" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION CACHE="00000000-0000-0000-0000-000000000000">
DECLARE @iArticle BIGINT = {==ArticleK}
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TArticle');
                  
INSERT INTO $OTImage(ParentK,table_number,FName,FFolder,FDescription,CreateD,UpdateD) 
VALUES(@iArticle,@iTable,{=FName"''"},{=FFolder},{=FDescription},GETDATE(),GETDATE())
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTImage')" />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   <QUERY ID="Presentation" KEY="C655699FA17A224F8FB61AE637C9F52F">
      <FIELD ID="TArticlePresentation1ArticlePresentationK" ALIAS="ID (Presentation)" TABLE="TArticlePresentation1"/>
      <FIELD ID="TArticlePresentation1TypeC" ALIAS="Type" TABLE="TArticlePresentation1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TArticlePresentation1FName" ALIAS="Name" TABLE="TArticlePresentation1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TArticlePresentation1FDescription" ALIAS="Description" TABLE="TArticlePresentation1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TArticlePresentation1FReleasedD" ALIAS="Released" TABLE="TArticlePresentation1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TArticlePresentation1FReady" ALIAS="Ready" TABLE="TArticlePresentation1" FIELDFLAGNAMES="edit"/>
      <ROWEDIT>
         <EDIT NAME="new_request" SIMPLE="New request" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
DECLARE @iSystem INT = {{=SystemK}};
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TSystem');
DECLARE @iUser INT = {=UserK};

IF @iUser IS NULL
   SET @iUser = {#V user "@@user"} -- default user is active user
   
INSERT INTO $OTArticlePresentation (UserK,FName,FDescription,TypeC,StateC,CreateD,UpdateD,ParentK,table_number) 
VALUES(@iUser,{=FName},{=FDescription},{=TypeC"0"},0,GETDATE(),GETDATE(),@iSystem,@iTable)
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTArticlePresentation')" />
         </EDIT>
      </ROWEDIT>
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE><![CDATA[ return function(g) local R, db=g.result, g.db
   R:SetValue('url','[' .. 
   '{"id": "activities","title":"Slides", "icon": "fa-edit", "table":"TArticlePresentation1", "link": ["7F94DDBA71744EEC837A71BE99C105A4"]},' .. 
   '{"id": "todolist","title":"Todolist: edit", "icon": "fa-edit", "table":"TArticlePresentation1", "link": ["737734E0BC4F4A1B81C0285E4BC335CE"]}' .. 
   ']') 
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
      <QUERYLINK TYPENAME="children" NAME="Slides"  DESCRIPTION="Edit articles" KEY="7F94DDBA71744EEC837A71BE99C105A4" EXPRESSION="SELECT ArticlePresentationK AS value, 'ArticlePresentationK' AS name, FName AS simple FROM $OTArticlePresentation WHERE ArticlePresentationK={{==TArticlePresentation1}}">
         <PROPERTIES OUTPUT-WIDTH="1000" OUTPUT-HEIGHT="700" OUTPUT-POSITION="right-top" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Todolist"  DESCRIPTION="Edit todolist" KEY="737734E0BC4F4A1B81C0285E4BC335CE" EXPRESSION="SELECT ArticlePresentationK AS value, 'ArticlePresentationK' AS name, FName AS simple FROM $OTArticlePresentation WHERE ArticlePresentationK={{==TArticlePresentation1}}" />
   </QUERY>
   
   <QUERY ID="Slides" DESCRIPTION="Create slides" KEY="941FCC75BEFEC84EA15A695E9CDEDB43">
      <FIELD ID="TrArticlePresentationXArticle1rArticlePresentationXArticleK" ALIAS="ID (Slide)" TABLE="TrArticlePresentationXArticle1"/>
      <FIELD ID="TrArticlePresentationXArticle1ArticlePresentationK" ALIAS="Presentation name" TABLE="TrArticlePresentationXArticle1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES SERVER-LIST="SELECT ArticlePresentationK, FName FROM $OTArticlePresentation ORDER BY 2" /> 
      </FIELD>
      <FIELD ID="TrArticlePresentationXArticle1FName" ALIAS="Name" TABLE="TrArticlePresentationXArticle1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TrArticlePresentationXArticle1FDevelop" ALIAS="Develop" TABLE="TrArticlePresentationXArticle1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TrArticlePresentationXArticle1FPage" ALIAS="Page" TABLE="TrArticlePresentationXArticle1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TrArticlePresentationXArticle1FOrder" ALIAS="Order" TABLE="TrArticlePresentationXArticle1" FIELDFLAGNAMES="edit"/>
      <ROWEDIT>
         <EDIT NAME="new_slide" SIMPLE="New slide" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
DECLARE @iArticlePresentation BIGINT = {{=ArticlePresentationK}};
DECLARE @iArticle BIGINT = {{=ArticleK}};
DECLARE @iUser INT = {#V user "@@user"};
DECLARE @sName NVARCHAR(1000) = {=FName};
IF @sName IS NULL OR LEN(@sName) = 0
   SET @sName = (SELECT FBrief FROM $OTArticle WHERE ArticleK=@iArticle);
   
INSERT INTO $OTrArticlePresentationXArticle (ArticlePresentationK,ArticleK,UserK,FName,FDevelop,FPage,FOrder) 
VALUES(@iArticlePresentation,@iArticle,@iUser,@sName,{=FDevelop},{=FPage},{=FOrder})
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTrArticlePresentationXArticle')" />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   <!--
    | Add slides for selected presentation
    |-->
   <QUERY ID="Presentation: Slides" DESCRIPTION="Add slides to presentation" KEY="7F94DDBA71744EEC837A71BE99C105A4" FLAGNAMES="NOTLISTED">
      <FIELD ID="TrArticlePresentationXArticle1rArticlePresentationXArticleK" ALIAS="ID (Slide)" TABLE="TrArticlePresentationXArticle1"/>
      <FIELD ID="TrArticlePresentationXArticle1ArticleK" ALIAS="Article" TABLE="TrArticlePresentationXArticle1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TrArticlePresentationXArticle1FName" ALIAS="Name" TABLE="TrArticlePresentationXArticle1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TrArticlePresentationXArticle1FDevelop" ALIAS="Develop" TABLE="TrArticlePresentationXArticle1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TrArticlePresentationXArticle1FPage" ALIAS="Page" TABLE="TrArticlePresentationXArticle1" FIELDFLAGNAMES="edit"/>
      <FIELD ID="TrArticlePresentationXArticle1FOrder" ALIAS="Order" TABLE="TrArticlePresentationXArticle1" FIELDFLAGNAMES="edit"/>
      <ROWEDIT>
         <EDIT NAME="new_slide" SIMPLE="New slide" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
DECLARE @iArticlePresentation INT = {{=ArticlePresentationK}};
DECLARE @iArticle INT = {{=ArticleK}};
DECLARE @iUser INT = {#V user "@@user"};
DECLARE @sName NVARCHAR(1000) = {=FName};
IF @sName IS NULL
   SET @sName = (SELECT FBrief FROM $OTArticle WHERE ArticleK=@iArticle);

   
INSERT INTO $OTrArticlePresentationXArticle (ArticlePresentationK,ArticleK,UserK,FName,FDevelop,FPage,FOrder) 
VALUES(@iArticlePresentation,@iArticle,@iUser,@sName,{=FDevelop},{=FPage},{=FOrder})
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTrArticlePresentationXArticle')" />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   <QUERY ID="Systems: all" DESCRIPTION="Active systems" KEY="7C262055E3601A43ABAC7E5CC0C3F868">
      <FIELD ID="TSystem1SystemK" ALIAS="ID (System)" TABLE="TSystem1"/>
      <FIELD ID="TSystem1FName" ALIAS="Name" TABLE="TSystem1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSystem1FAbbreviation" ALIAS="Short" TABLE="TSystem1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSystem1FDescription" ALIAS="Description" TABLE="TSystem1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="hashtag|TSystem1.Hashtag" />
         <EDIT>{"update":"DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE \"name\" = 'TSystem');\nDECLARE @iSystem BIGINT = ${@TSystem1SystemK}\nDECLARE @sDescription NVARCHAR(1000) = {=TSystem1FDescription}\n\nDELETE FROM $OTrXBadge WHERE ParentK = @iSystem AND table_number = @iTable\n\nIF LEN( @sDescription ) &gt; 2\nBEGIN\n-- Add missing hashtags to Badge table\n   INSERT INTO $OTBadge (FName)\n   SELECT tag FROM $OPullTagsFromText( @sDescription ) LEFT JOIN $OTBadge _b ON tag = _b.FName\n   WHERE _b.FName IS NULL   \n\n-- Connect hashtags to System record\n   INSERT INTO $OTrXBadge (ParentK,table_number,BadgeK)\n   SELECT @iSystem, @iTable, _b.BadgeK\n   FROM $OTBadge _b JOIN $OPullTagsFromText( @sDescription ) ON _b.FName = tag\nEND\n","formula":"1"}</EDIT>
      </FIELD>
      <FIELD ID="TSystem1TypeC" ALIAS="Type" TABLE="TSystem1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSystem1PriorityC" ALIAS="Priority" TABLE="TSystem1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSystem1SuperK-Name" ALIAS="Parent" TABLE="TSystem1">
         <ATTRIBUTES SERVER-LIST="SELECT CAST(NULL AS INT) AS SystemK, '_ no parent _' AS FName UNION ALL SELECT SystemK, FName FROM $OTSystem WHERE FDeleted = 0 AND FIdle = 0 ORDER BY 2" />
      </FIELD>
      <FIELD ID="TSystem1CountRequest" ALIAS="Cnt.req." TABLE="TSystem1" />
      <CONDITION ID="TSystem1FDeleted" TABLE="TSystem1" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" FLAGS="0"/>
      <CONDITIONS ID="Select filter!" SELECTED="1"/>
      <CONDITIONS ID="Systems with Activities not closed">
         <CONDITION ID="TSystem1CountActivity" TABLE="TSystem1" OPERATORNAME="GREATER" VALUE="0">
            <CONDITIONGROUP>
               <FIELDCONDITION ID="FDone" OPERATOR="0" VALUE="0" SIMPLEVALUE="NO"/>
            </CONDITIONGROUP>
         </CONDITION>
      </CONDITIONS>
      <CONDITIONS ID="Systems with Projects not closed">
         <CONDITION ID="TSystem1CountProject" TABLE="TSystem1" OPERATORNAME="GREATER" VALUE="0">
            <CONDITIONGROUP>
               <FIELDCONDITION ID="FDone" OPERATOR="0" VALUE="0" SIMPLEVALUE="NO"/>
            </CONDITIONGROUP>
         </CONDITION>
      </CONDITIONS>
      <CONDITIONS ID="Systems with Requests not closed">
         <CONDITION ID="TSystem1CountRequest" TABLE="TSystem1" OPERATORNAME="GREATER" VALUE="0">
            <CONDITIONGROUP>
               <FIELDCONDITION ID="FDone" OPERATOR="0" VALUE="0" SIMPLEVALUE="NO"/>
            </CONDITIONGROUP>
         </CONDITION>
      </CONDITIONS>
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="86be085c-a3bd-48ca-97c6-35ad08e2518b"><![CDATA[ return function(g) local R, db=g.result, g.db
   R:SetValue('url','[' .. 
   '{"id": "activities","title":"Activities", "icon": "fa-edit", "table":"TSystem1", "link": ["E011E9977E314F43B719979473167221"]},' .. 
   '{"id": "projects","title":"Projects", "icon": "fa-edit", "table":"TSystem1", "link": ["AC8F938FFFFF45488251BD417A41656F"]},' .. 
   '{"id": "systemrequest","title":"System requests", "icon": "fa-edit", "table":"TSystem1", "link": ["ABD3CAB3AD27A5419FFB978647AF1E17"]},' .. 
   '{"id": "systemversion","title":"System versions", "icon": "fa-edit", "table":"TSystem1", "link": ["DB7C2B1E88DF2B4EA265C49A3D7FB59C"]}' .. 
   ']') 
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
      <QUERYLINK TYPENAME="children" NAME="Activities"  DESCRIPTION="Edit activities for system" KEY="E011E9977E314F43B719979473167221" EXPRESSION="SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK={{==TSystem1}}">
         <PROPERTIES OUTPUT-WIDTH="1900" OUTPUT-HEIGHT="600" OUTPUT-POSITION="center-bottom" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="System requests"  DESCRIPTION="Edit requests for system" KEY="ABD3CAB3AD27A5419FFB978647AF1E17" EXPRESSION="SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK={{==TSystem1}}">
         <PROPERTIES OUTPUT-WIDTH="1000" OUTPUT-HEIGHT="500" OUTPUT-POSITION="right-bottom" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Projects"  DESCRIPTION="Edit projects for system" KEY="AC8F938FFFFF45488251BD417A41656F" EXPRESSION="SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK={{==TSystem1}}">
         <PROPERTIES OUTPUT-WIDTH="1400" OUTPUT-HEIGHT="250"  />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="System versions"  DESCRIPTION="Versions for active system" KEY="DB7C2B1E88DF2B4EA265C49A3D7FB59C" EXPRESSION="SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK={{==TSystem1}}">
         <PROPERTIES OUTPUT-WIDTH="900" OUTPUT-HEIGHT="500" OUTPUT-POSITION="right-top" />
      </QUERYLINK>
      <ROWEDIT>
         <EDIT NAME="new_system" SIMPLE="Systems" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
DECLARE @iSuper INT = {{=SuperK}}
IF @iSuper = 0 SET @iSuper = NULL
INSERT INTO $OTSystem(GlobalK,UserK,SuperK,FName,FDescription,TypeC,CreateD,UpdateD) 
VALUES({#V user "@@global"}, {#V user "@@user"},@iSuper,{=FName"''"},{=FDescription},{=TypeC},GETDATE(),GETDATE());

INSERT INTO $OTNote(RecordK,table_number,FNote) VALUES( (SELECT IDENT_CURRENT('$OTSystem')), 1010, {=TSystem1Note});
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTSystem')" />
         </EDIT>
         <EDIT NAME="delete system" SIMPLE="Delete System" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $OTSystem WHERE SystemK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   <QUERY ID="System: Add sub system" KEY="05CC0280D7A3DB4883C3324C2D355A0A">
      <FIELD ID="TSystem1SystemK" ALIAS="ID (System)" TABLE="TSystem1"/>
      <FIELD ID="TSystem1FName" ALIAS="Name" TABLE="TSystem1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSystem1FDescription" ALIAS="Description" TABLE="TSystem1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="hashtag|TSystem1.Hashtag" />
         <EDIT>{"update":"DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE \"name\" = 'TSystem');\nDECLARE @iSystem BIGINT = ${@TSystem1SystemK}\nDECLARE @sDescription NVARCHAR(1000) = {=TSystem1FDescription}\n\nDELETE FROM $OTrXBadge WHERE ParentK = @iSystem AND table_number = @iTable\n\nIF LEN( @sDescription ) &gt; 2\nBEGIN\n-- Add missing hashtags to Badge table\n   INSERT INTO $OTBadge (FName)\n   SELECT tag FROM $OPullTagsFromText( @sDescription ) LEFT JOIN $OTBadge _b ON tag = _b.FName\n   WHERE _b.FName IS NULL   \n\n-- Connect hashtags to System record\n   INSERT INTO $OTrXBadge (ParentK,table_number,BadgeK)\n   SELECT @iSystem, @iTable, _b.BadgeK\n   FROM $OTBadge _b JOIN $OPullTagsFromText( @sDescription ) ON _b.FName = tag\nEND\n","formula":"1"}</EDIT>
      </FIELD>
      <FIELD ID="TSystem1Note" ALIAS="Note" TABLE="TSystem1" FIELDFLAGNAMES="edit" 
             ORDEREXPRESSION="CAST( (SELECT TOP 1 _n.FNote FROM $OTNote _n WHERE _n.RecordK=$T.SystemK AND _n.table_number=1010) AS NVARCHAR(50))">
         <ATTRIBUTES OUTPUT-FORMAT="markdown" />
         <EDIT>UPDATE $OTNote SET FNote={=TSystem1Note} WHERE RecordK=${@TSystem1SystemK} AND table_number=1010</EDIT>
      </FIELD>
      <FIELD ID="TSystem1TypeC" ALIAS="Type" TABLE="TSystem1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSystem1StateC" ALIAS="State" TABLE="TSystem1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSystem1PriorityC" ALIAS="Priority" TABLE="TSystem1" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="new_system" SIMPLE="Systems" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
DECLARE @iSuper INT = {{=SuperK}}
IF @iSuper = 0 SET @iSuper = NULL
DECLARE @sDescription NVARCHAR(1000) = {=FDescription};
INSERT INTO $OTSystem(GlobalK,UserK,SuperK,FName,FDescription,TypeC,StateC,PriorityC,CreateD,UpdateD) 
VALUES({#V user "@@global"}, {#V user "@@user"},@iSuper,{=FName"''"},@sDescription,{=TypeC},{=StateC},{=PriorityC},GETDATE(),GETDATE());

DECLARE @iSystem BIGINT = (SELECT IDENT_CURRENT('$OTSystem'));
INSERT INTO $OTNote(RecordK,table_number,FNote) VALUES( @iSystem, 1010, {=TSystem1Note});
EXEC $OPROCEDURE_UpdateBadge @sDescription, 'TSystem', @iSystem
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTSystem')" />
         </EDIT>
         <EDIT NAME="delete system" SIMPLE="Delete System" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $OTSystem WHERE SystemK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   
   <QUERY ID="System: tree" KEY="F12429A8B23A06449ABA71A4A88D853E" DESCRIPTION="View systems as tree&lt;br&gt;Systems can be connected in a tree like structure. Open information related to systems.">
      <ATTRIBUTE NAME="OUTPUT-LIST">Primary,1</ATTRIBUTE>
      <ATTRIBUTE NAME="LUA-GETRESULT"><![CDATA[
return function( g )
if g.on == 2 then
   local dbdata = g.application:GetDatabaseData();
   local sSQL = dbdata:FormatSQL( "INSERT INTO $Oclick_history(table_number, FKey, FWhen, FFrom ) VALUES(1010,0,GETDATE(), 'TEST')" )
   g.db:Execute(sSQL);
end   
end
      ]]></ATTRIBUTE>
      <FIELD ID="TSystem1SystemK" ALIAS="ID" TABLE="TSystem1">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 25px;" />
      </FIELD>
      <FIELD ID="TSystem1FName-Indent" ALIAS="Indented Name" TABLE="TSystem1" DESCRIPTION="Indented System name to show where system is located in system tree" />
      <FIELD ID="TSystem1CountActivity" ALIAS="act" TABLE="TSystem1" DESCRIPTION="Number of activities not closed for System">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 25px;" />
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right;' class='mark_note'|/^[1-9]" />
         <CONDITIONGROUP>
            <FIELDCONDITION ID="FDone" OPERATOR="0" VALUE="0" SIMPLEVALUE="NO"/>
            <FIELDCONDITION ID="TypeCType" OPERATOR="0" VALUE="1" SIMPLEVALUE="time"/>
            <FIELDCONDITION ID="TypeCType" OPERATOR="0" VALUE="5" SIMPLEVALUE="task"/>
         </CONDITIONGROUP>
      </FIELD>
      <FIELD ID="TSystem1CountRequest" ALIAS="req" TABLE="TSystem1" DESCRIPTION="Number of requests not closed for System">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 25px;" />
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right;' class='mark_note'|/^[1-9]" />
         <CONDITIONGROUP>
            <FIELDCONDITION ID="FDone" OPERATOR="0" VALUE="0" SIMPLEVALUE="NO"/>
         </CONDITIONGROUP>
      </FIELD>
      <FIELD ID="TSystem1CountProject" ALIAS="prj" TABLE="TSystem1" DESCRIPTION="Number of projects not closed for System">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 25px;" />
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right;' class='mark_note'|/^[1-9]" />
         <CONDITIONGROUP>
            <FIELDCONDITION ID="FDone" OPERATOR="0" VALUE="0" SIMPLEVALUE="NO"/>
         </CONDITIONGROUP>
      </FIELD>
      <FIELD ID="TSystem1CountBooks" ALIAS="book" TABLE="TSystem1" DESCRIPTION="Attached books with information about the system">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 25px;" />
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right;' class='mark_note'|/^[1-9]" />
      </FIELD>
      <FIELD ID="TSystem1CountTodoListAndTodo" ALIAS="todo" TABLE="TSystem1" DESCRIPTION="Number of todos not ready">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 25px;" />
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right;' class='mark_note'|/^[1-9]" />
         <CONDITIONGROUP>
            <FIELDCONDITION ID="FReady" OPERATOR="0" VALUE="0" SIMPLEVALUE="NO"/>
            <FIELDCONDITION ID="FClosed" OPERATOR="0" VALUE="0" SIMPLEVALUE="NO"/>
         </CONDITIONGROUP>
      </FIELD>
      <FIELD ID="TSystem1FDescription" ALIAS="Description" TABLE="TSystem1">
         <ATTRIBUTES OUTPUT-FORMAT="hashtag|TSystem1.Hashtag" />
      </FIELD>
      <FIELD ID="TSystem1TypeC" ALIAS="Type" TABLE="TSystem1" />
      <FIELD ID="TSystem1ThreadShortName" ALIAS="Thread" TABLE="TSystem1"/>
      <ORDER FIELD="TSystem1SystemK" INDEX="0" SQL="(SELECT TOP 1 _th.FThreadId FROM $Othread_header _th JOIN $Othread _t ON _th.FThreadId = _t.FThreadId AND _t.table_number=1010 WHERE _t.FKey=TSystem1.SystemK AND _th.table_number=1010)" />
      <ORDER FIELD="TSystem1SystemK" INDEX="0" SQL="(SELECT TOP 1 _t.FPath FROM $Othread _t WHERE _t.FKey=TSystem1.SystemK AND _t.table_number=1010)" />
      <ORDERS NAME="Thread view">
         <ORDER FIELD="TSystem1SystemK" INDEX="0" SQL="(SELECT TOP 1 _th.FThreadId FROM $Othread_header _th JOIN $Othread _t ON _th.FThreadId = _t.FThreadId AND _t.table_number=1010 WHERE _t.FKey=TSystem1.SystemK AND _th.table_number=1010)" />
         <ORDER FIELD="TSystem1SystemK" INDEX="0" SQL="(SELECT TOP 1 _t.FPath FROM $Othread _t WHERE _t.FKey=TSystem1.SystemK AND _t.table_number=1010)" />
      </ORDERS>

      <ORDERS NAME="Recent articles">
         <ORDER FIELD="TSystem1SystemK" SQL="(SELECT TOP 1 _a.UpdateD FROM $OTArticle _a WHERE _a.ParentK=$T.SystemK AND _a.table_number = 1010 ORDER BY 1 DESC)" DESC="1" />
      </ORDERS>

      <ORDERS NAME="Recent activities">
         <ORDER FIELD="TSystem1SystemK" SQL="(SELECT TOP 1 _a.UpdateD FROM $OTActivity _a WHERE _a.ParentK=$T.SystemK AND _a.table_number = 1010 ORDER BY 1 DESC)" DESC="1" />
      </ORDERS>

      <ORDERS NAME="Recent projects">
         <ORDER FIELD="TSystem1SystemK" SQL="(SELECT TOP 1 _p.UpdateD FROM $OTProject _p WHERE _p.ParentK=$T.SystemK AND _p.table_number = 1010 ORDER BY 1 DESC)" DESC="1" />
      </ORDERS>
      
      <ORDERS NAME="Recent requets" DESCRIPTION="Sort result based on last new or updated request">
         <ORDER FIELD="TSystem1SystemK" SQL="(SELECT TOP 1 _sr.UpdateD FROM $OTSystemRequest _sr WHERE _sr.SystemK=$T.SystemK ORDER BY 1 DESC)" DESC="1" />
      </ORDERS>
      
      <CONDITIONS ID="Select filter!" SELECTED="1"/>
      <CONDITIONS ID="Development tutorials">
         <CONDITION ID="TSystem1PriorityC" TABLE="TSystem1" OPERATORNAME="EQUAL" VALUE="4158" />
      </CONDITIONS>
      <CONDITIONS ID="Selection tutorials">
         <CONDITION ID="TSystem1PriorityC" TABLE="TSystem1" OPERATORNAME="EQUAL" VALUE="4161" />
      </CONDITIONS>
      <CONDITIONS ID='{ "name": "Only roots", "title": "Root systems is systems with sub systems, systems organized like a tree", "style": "font-weight: 900;" }'>
         <CONDITION ID="TSystem1FDeleted" TABLE="TSystem1" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" />
         <CONDITION ID="TSystem1SuperK" TABLE="TSystem1" SIMPLEVALUE="roots" OPERATORNAME="IS NULL" VALUE="0" />
         <CONDITION ID="TSystem1CountNodes" TABLE="TSystem1" SIMPLEVALUE="more than one" OPERATORNAME="GREATER" VALUE="1" />
      </CONDITIONS>
      <CONDITIONS ID="Has urgent activities">
         <CONDITION ID="TSystem1SuperK" TABLE="TSystem1" OPERATORNAME="GREATER" VALUE="0" SIMPLEVALUE="One or more">
            <EXPRESSION>
(SELECT COUNT(*) FROM $OTActivity _a 
WHERE _a.ParentK = $T.SystemK AND 
_a.table_number=1010 AND
(SELECT COUNT(*) FROM $O{CODE}TCode _c WHERE _c.CodeK=_a.PriorityC AND _c.FRank &gt; 6) &gt; 0 AND
_a.FDone = 0)
            </EXPRESSION>
         </CONDITION>
      </CONDITIONS>
      <CONDITIONS ID="Systems with Activities not closed">
         <CONDITION ID="TSystem1CountActivity" TABLE="TSystem1" OPERATORNAME="GREATER" VALUE="0">
            <CONDITIONGROUP>
               <FIELDCONDITION ID="FDone" OPERATOR="0" VALUE="0" SIMPLEVALUE="NO"/>
            </CONDITIONGROUP>
         </CONDITION>
      </CONDITIONS>
      <CONDITIONS ID="Systems with Projects not closed">
         <CONDITION ID="TSystem1CountProject" TABLE="TSystem1" OPERATORNAME="GREATER" VALUE="0">
            <CONDITIONGROUP>
               <FIELDCONDITION ID="FDone" OPERATOR="0" VALUE="0" SIMPLEVALUE="NO"/>
            </CONDITIONGROUP>
         </CONDITION>
      </CONDITIONS>
      <CONDITIONS ID="Systems with Requests not closed">
         <CONDITION ID="TSystem1CountRequest" TABLE="TSystem1" OPERATORNAME="GREATER" VALUE="0">
            <CONDITIONGROUP>
               <FIELDCONDITION ID="FDone" OPERATOR="0" VALUE="0" SIMPLEVALUE="NO"/>
            </CONDITIONGROUP>
         </CONDITION>
      </CONDITIONS>
      <CONDITIONS ID='{ "name": "Systems with Books", "title": "Systems with attached books.", "style": "color: rgb(65,105,225); " }'>
         <CONDITION ID="TSystem1CountBooks" TABLE="TSystem1" OPERATORNAME="GREATER" VALUE="0" />
      </CONDITIONS>
      <CONDITIONS ID='{ "name": "Systems with Articles", "title": "Systems with attached articles.", "style": "color: rgb(65,105,225); " }'>
         <CONDITION ID="TSystem1CountArticle" TABLE="TSystem1" OPERATORNAME="GREATER" VALUE="0" />
      </CONDITIONS>
      <CONDITIONS ID='{ "name": "Systems with Versions", "title": "Systems that has versions attached to them.", "style": "color: rgb(65,105,225); " }'>
         <CONDITION ID="TSystem1CountVersion" TABLE="TSystem1" OPERATORNAME="GREATER" VALUE="0" />
      </CONDITIONS>
      <CONDITIONS ID='{ "name": "Customer systems", "title": "Customer specific systems", "style": "color: rgb(46,139,87); font-weight: 900;" }'>
         <CONDITION ID="TSystem1CountProperty" TABLE="TSystem1" OPERATORNAME="GREATER" VALUE="0">
            <CONDITIONGROUP>
               <FIELDCONDITION ID="FName" OPERATOR="0" VALUE="1" SIMPLEVALUE="Customer system"/>
            </CONDITIONGROUP>
         </CONDITION>
      </CONDITIONS>
      <SELECTCONDITIONS>
         <SELECTCONDITION ID="TSystem1PriorityC" TABLE="TSystem1"/>
         <SELECTCONDITION ID="TSystem1SystemK-RequestNotDone" TABLE="TSystem1"/>
         <SELECTCONDITION ID="TSystem1Hashtag" TABLE="TSystem1"/>
      </SELECTCONDITIONS>
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="d2b433ce-b381-4d39-85dc-819bd36eb6a5"><![CDATA[ return function(g) local R, db, sE=g.result, g.db, g.result:GetParam("event");
if sE == "click" then
   local iKeyPressed = R:GetParam("pressed")
   local iColumn = R:GetParam("column")
   if iKeyPressed == 0 then
      if iColumn == 2 then
         R:SetValue('url','{"link": ["25CD6ED397DB44859FB0E18E78BB0FF4zoom"],"table":"TSystem1"}' )  return
      elseif iColumn == 3 then
         R:SetValue('url','{"link": ["8DE134A0A74C43E7896A256A644EDB92zoom"],"table":"TSystem1"}' )  return
      elseif iColumn == 4 then
         R:SetValue('url','{"link": ["AC8F938FFFFF45488251BD417A41656Fzoom"],"table":"TSystem1"}' )  return
      elseif iColumn == 5 then
         R:SetValue('url','{"link": ["BDF6B05C0CF66F46817740CD67DB4ADFzoom"],"table":"TSystem1"}' )  return
      elseif iColumn == 6 then
         R:SetValue('url','{"link": ["1E4485B89FCA8F4CB8D9A1DAFB00A498zoom"],"table":"TSystem1"}' )  return
      end
   else
      if iColumn == 2 then
         R:SetValue('url','{"title":"Activities: edit","link": ["E011E9977E314F43B719979473167221"],"table":"TSystem1"}' )  return
      elseif iColumn == 3 then
         R:SetValue('url','{"title":"Requests: edit","link": ["ABD3CAB3AD27A5419FFB978647AF1E17"],"table":"TSystem1"}' )  return
      elseif iColumn == 4 then
         R:SetValue('url','{"title":"Projects: edit","link": ["29BCDED64B4B4DD7A63CFAAB970F38DA"],"table":"TSystem1"}' )  return
      elseif iColumn == 5 then
         R:SetValue('url','{"title":"Books: edit","link": ["87595A00949C31499CE831438BA08D94"],"table":"TSystem1"}' )  return
      elseif iColumn == 6 then
         R:SetValue('url','{"title":"Todolist: edit","link": ["1E4485B89FCA8F4CB8D9A1DAFB00A498"],"table":"TSystem1"}' )  return
      end
   end
end
   R:SetValue('url','[' .. 
   '{"id": "edit","title":"Edit System", "icon": "fa-i-cursor", "table":"TSystem1", "link": ["3FE1BB73CAA04ADEA91029BABC69BF83"]},' .. 
   '{"child": "Todos"},' .. 
   '{"id": "todolist_edit","title":"Todolist: edit", "icon": "fa-edit", "table":"TSystem1", "link": ["1E4485B89FCA8F4CB8D9A1DAFB00A498"]},' .. 
   '{"id": "todolist_view","title":"Todolist: view", "icon": "fa-align-justify", "table":"TSystem1", "link": ["1E4485B89FCA8F4CB8D9A1DAFB00A498result"]},' .. 
   '{"id": "systemintent_edit","title":"Goals: edit", "icon": "fa-edit", "table":"TSystem1", "link": ["8C0797AC0D60CF44A43E39B0949970ED"]},' ..
   '{"id": "systemintent_view","title":"Goals: view", "icon": "fa-align-justify", "table":"TSystem1", "link": ["155C43F91CCA4892B4E35E9C8A5259CEzoom"]},' ..
   '{"parent": 1},' ..
   '{"child": "Support"},' .. 
   '{"id": "systemrequest","title":"Requests: edit", "icon": "fa-edit", "table":"TSystem1", "link": ["ABD3CAB3AD27A5419FFB978647AF1E17"]},' .. 
   '{"id": "links","title":"Links: View", "icon": "fa-align-justify", "table":"TSystem1", "link": ["435f275c-cb30-4ea7-81ac-f452c520410fzoom"]},' .. 
   '{"id": "links","title":"Links: Add", "icon": "fa-edit", "table":"TSystem1", "link": ["78A78FCEB1784D1693A9699D30E1ED10"]},' .. 
   '{"parent": 1},' ..
   '{"child": "Presentation"},' .. 
   '{"id": "books_result","title":"Books: view", "icon": "fa-align-justify", "table":"TSystem1", "query": "F12429A8B23A06449ABA71A4A88D853E", "link": ["BDF6B05C0CF66F46817740CD67DB4ADFzoom"]},' ..
   '{"id": "books_edit","title":"Books: edit", "icon": "fa-edit", "table":"TSystem1", "link": ["87595A00949C31499CE831438BA08D94"]},' .. 
   '{"id": "booklist_edit","title":"Book lists: edit", "icon": "fa-edit", "table":"TSystem1", "link": ["7E6E8134F62042868C9EC8FAB1AA6623"]},' .. 
   '{"id": "article","title":"Articles: view", "icon": "fa-align-justify", "table":"TSystem1", "link": ["E09B7E7DFF434EBF9A3E24678E4D8815result"]},' .. 
   '{"id": "article","title":"Articles: edit", "icon": "fa-edit", "table":"TSystem1", "link": ["E9F72F7E7F2E354AB7FC7E2D67684274"]},' .. 
   '{"id": "books_connect","title":"Connect books", "icon": "fa-sitemap", "table":"TSystem1", "link": ["EC6EF6AFA3554865A7DC39DA6222BE95"]},' .. 
   '{"id": "presentation","title":"Presentation: view", "icon": "fa-sitemap", "table":"TSystem1", "link": ["C655699FA17A224F8FB61AE637C9F52Fresult"]},' .. 
   '{"id": "presentation","title":"Presentation: edit", "icon": "fa-sitemap", "table":"TSystem1", "link": ["C655699FA17A224F8FB61AE637C9F52F"]},' .. 
   '{"parent": 1},' .. 
   '{"child": "Configure"},' .. 
   '{"id": "systemversion","title":"Versions: edit", "icon": "fa-edit", "table":"TSystem1", "link": ["DB7C2B1E88DF2B4EA265C49A3D7FB59C"]},' .. 
   '{"id": "properties","title":"Properties: edit", "icon": "fa-edit", "table":"TSystem1", "link": ["4426B10022F6154E914DA4745769BD40"]},' .. 
   '{"id": "connect_customer","title":"Customer: edit connected", "icon": "fa-edit", "table":"TSystem1", "link": ["66E465435EA9B04789754574AE0874D3"]},' .. 
   '{"id": "system_view_sub_tree","title":"System: view sub tree", "icon": "fa-stream", "table":"TSystem1", "link": ["7D7C9283AFE34C97BDABC82A158A9E33result"]},' .. 
   '{"id": "system","title":"System: Add subs", "icon": "fa-edit", "table":"TSystem1", "link": ["05CC0280D7A3DB4883C3324C2D355A0A"]},' .. 
   '{"parent": 1},' .. 
   '{"id": "activities","title":"Activities", "icon": "fa-align-justify", "table":"TSystem1", "link": ["25CD6ED397DB44859FB0E18E78BB0FF4zoom"]},' .. 
   '{"id": "activities","title":"Activities: edit", "icon": "fa-edit", "table":"TSystem1", "link": ["E011E9977E314F43B719979473167221"]},' .. 
   '{"id": "projects_result","title":"Projects: view", "icon": "fa-align-justify", "table":"TSystem1", "link": ["AC8F938FFFFF45488251BD417A41656Fzoom"]},' .. 
   '{"id": "projects_edit","title":"Projects: edit", "icon": "fa-edit", "table":"TSystem1", "link": ["29BCDED64B4B4DD7A63CFAAB970F38DA"]},' ..
   '{"id": "systemrequest","title":"Requests", "icon": "fa-align-justify", "table":"TSystem1", "link": ["8DE134A0A74C43E7896A256A644EDB92zoom"]}' ..
   --'{"id": "systemrequest","title":"Todo items", "icon": "fa-align-justify", "table":"TSystem1", "link": ["6751CF1641AE47C38F8E13FF46674C99zoom"]},' ..    
   ']') 
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
      
      <!-- EDIT ACTIVE SYSTEM RECORD -->
      <QUERYLINK TYPENAME="record" NAME="System"  DESCRIPTION="Edit system record" KEY="3FE1BB73CAA04ADEA91029BABC69BF83" QUERY="7C262055E3601A43ABAC7E5CC0C3F868" EXPRESSION="SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK={{==TSystem1}}">
         <PROPERTIES OUTPUT-WIDTH="1200" OUTPUT-HEIGHT="400" OUTPUT-POSITION="center-top" />
      </QUERYLINK>
      
      
      <QUERYLINK TYPENAME="children" NAME="Activities"  DESCRIPTION="View activities for system" KEY="25CD6ED397DB44859FB0E18E78BB0FF4" EXPRESSION="SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK={{==TSystem1}}">
         <PROPERTIES OUTPUT-WIDTH="1200" OUTPUT-HEIGHT="600" OUTPUT-POSITION="right-top" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Activities"  DESCRIPTION="Edit activities for system" KEY="E011E9977E314F43B719979473167221" EXPRESSION="SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK={{==TSystem1}}">
         <PROPERTIES OUTPUT-WIDTH="1900" OUTPUT-HEIGHT="500" OUTPUT-POSITION="right-bottom" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Articles"  DESCRIPTION="Articles active system" KEY="E09B7E7DFF434EBF9A3E24678E4D8815" EXPRESSION="SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK={{==TSystem1}}" />
      <QUERYLINK TYPENAME="children" NAME="Articles"  DESCRIPTION="Articles active system edit" KEY="E9F72F7E7F2E354AB7FC7E2D67684274" EXPRESSION="SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK={{==TSystem1}}">
         <PROPERTIES OUTPUT-WIDTH="1200" OUTPUT-HEIGHT="500" OUTPUT-POSITION="right-top" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Books"  DESCRIPTION="Books" KEY="BDF6B05C0CF66F46817740CD67DB4ADF" EXPRESSION="SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK={{==TSystem1}}">
         <PROPERTIES OUTPUT-WIDTH="1100" OUTPUT-HEIGHT="300" OUTPUT-POSITION="right-bottom" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="System books"  DESCRIPTION="Edit book" KEY="87595A00949C31499CE831438BA08D94" EXPRESSION="SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK={{==TSystem1}}">
         <PROPERTIES OUTPUT-WIDTH="1100" OUTPUT-HEIGHT="450" OUTPUT-POSITION="left-top" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Book lists"  DESCRIPTION="Edit book" KEY="7E6E8134F62042868C9EC8FAB1AA6623" QUERY="671312291974C54B8184B98830571C4C" EXPRESSION="SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK={{==TSystem1}}">
         <PROPERTIES OUTPUT-WIDTH="800" OUTPUT-HEIGHT="250" OUTPUT-POSITION="left-bottom" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Connect books"  DESCRIPTION="Connect books" KEY="EC6EF6AFA3554865A7DC39DA6222BE95" EXPRESSION="SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK={{==TSystem1}}">
         <PROPERTIES OUTPUT-WIDTH="800" OUTPUT-HEIGHT="450" OUTPUT-POSITION="left-center" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Links"  DESCRIPTION="System links" KEY="78A78FCEB1784D1693A9699D30E1ED10" EXPRESSION="SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK={{==TSystem1}}">
         <PROPERTIES OUTPUT-WIDTH="1200" OUTPUT-HEIGHT="200" OUTPUT-POSITION="right-top" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Links"  DESCRIPTION="System links" KEY="435f275c-cb30-4ea7-81ac-f452c520410f" EXPRESSION="SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK={{==TSystem1}}">
         <PROPERTIES OUTPUT-WIDTH="800" OUTPUT-HEIGHT="200" OUTPUT-POSITION="center-top" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Projects"  DESCRIPTION="View projects for system" KEY="AC8F938FFFFF45488251BD417A41656F" EXPRESSION="SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK={{==TSystem1}}">
         <PROPERTIES OUTPUT-WIDTH="1000" OUTPUT-HEIGHT="250" OUTPUT-POSITION="right-center"  />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Projects"  DESCRIPTION="Edit projects for system" KEY="29BCDED64B4B4DD7A63CFAAB970F38DA" EXPRESSION="SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK={{==TSystem1}}">
         <PROPERTIES OUTPUT-WIDTH="1000" OUTPUT-HEIGHT="350" OUTPUT-POSITION="right-bottom"  />
      </QUERYLINK>

      <QUERYLINK TYPENAME="children" NAME="Todolist"  DESCRIPTION="Edit todolist" KEY="1E4485B89FCA8F4CB8D9A1DAFB00A498" EXPRESSION="SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK={{==TSystem1}}">
         <PROPERTIES OUTPUT-WIDTH="700" OUTPUT-HEIGHT="300" OUTPUT-POSITION="left-top|0,50" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Goals edit"  DESCRIPTION="Edit goals" KEY="8C0797AC0D60CF44A43E39B0949970ED" EXPRESSION="SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK={{==TSystem1}}">
         <PROPERTIES OUTPUT-WIDTH="1200" OUTPUT-HEIGHT="500" OUTPUT-POSITION="right-top"  />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Goals view"  DESCRIPTION="View goals" KEY="155C43F91CCA4892B4E35E9C8A5259CE" EXPRESSION="SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK={{==TSystem1}}">
         <PROPERTIES OUTPUT-WIDTH="800" OUTPUT-HEIGHT="500" OUTPUT-POSITION="right-top"  />
      </QUERYLINK>
      <QUERYLINK TYPENAME="record" NAME="Requests"  DESCRIPTION="View requests for system" KEY="8DE134A0A74C43E7896A256A644EDB92" EXPRESSION="SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK={{==TSystem1}}">
         <PROPERTIES OUTPUT-WIDTH="1000" OUTPUT-HEIGHT="400" OUTPUT-POSITION="left-center" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="System requests"  DESCRIPTION="Edit requests for selected system" KEY="ABD3CAB3AD27A5419FFB978647AF1E17" EXPRESSION="SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK={{==TSystem1}}">
         <PROPERTIES OUTPUT-WIDTH="*" OUTPUT-HEIGHT="400" OUTPUT-POSITION="center-bottom" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="System properties" DESCRIPTION="Set properties for system" KEY="4426B10022F6154E914DA4745769BD40" EXPRESSION="SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK={{==TSystem1}}">
         <PROPERTIES ALL-VARIABLE="1" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="System versions"  DESCRIPTION="Versions for active system" KEY="DB7C2B1E88DF2B4EA265C49A3D7FB59C" EXPRESSION="SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK={{==TSystem1}}">
         <PROPERTIES OUTPUT-WIDTH="900" OUTPUT-HEIGHT="500" OUTPUT-POSITION="right-top" />
      </QUERYLINK>

      <QUERYLINK TYPENAME="children" NAME="System tree"  DESCRIPTION="Sub systems to selected" KEY="7D7C9283AFE34C97BDABC82A158A9E33" QUERY="7D7C9283AFE34C97BDABC82A158A9E33">
         <EXPRESSION>
SELECT TOP 1 th.FThreadId, 'ThreadNumber' AS name, s.FName AS simple FROM $OTSystem s JOIN $Othread t ON s.SystemK=t.FKey JOIN $Othread_header th ON th.FThreadId = t.FThreadId AND t.table_number=1010 WHERE t.FKey={{==TSystem1}}
         </EXPRESSION>
      </QUERYLINK>
  
      <QUERYLINK TYPENAME="children" NAME="Sub system"  DESCRIPTION="Sub systems to selected" KEY="05CC0280D7A3DB4883C3324C2D355A0A" EXPRESSION="SELECT SystemK value, 'SuperK' AS name, FName AS simple FROM $OTSystem WHERE SystemK={{==TSystem1}}" />
      <QUERYLINK TYPENAME="children" NAME="Connect customer"  DESCRIPTION="Edit connected customers" KEY="66E465435EA9B04789754574AE0874D3" EXPRESSION="SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK={{==TSystem1}}" />
      <QUERYLINK TYPENAME="children" NAME="Edit presentation"  DESCRIPTION="Add presentation to system" KEY="C655699FA17A224F8FB61AE637C9F52F" EXPRESSION="SELECT SystemK value, 'SystemK' AS name, FName AS simple FROM $OTSystem WHERE SystemK={{==TSystem1}}">
         <PROPERTIES OUTPUT-WIDTH="900" OUTPUT-HEIGHT="300" OUTPUT-POSITION="center-top" />
      </QUERYLINK>
   </QUERY>
   
   
   
   
   <QUERY ID="System: single tree" KEY="7D7C9283AFE34C97BDABC82A158A9E33" DESCRIPTION="View a single tree">
      <ATTRIBUTE NAME="OUTPUT-LIST">Work,1000</ATTRIBUTE>
      <PROPERTY NAME="LINKS_FROM">F12429A8B23A06449ABA71A4A88D853E</PROPERTY>
      <FIELD ID="TSystem1SystemK" ALIAS="ID" TABLE="TSystem1">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 25px;" />
      </FIELD>
      <FIELD ID="TSystem1FName-Indent" ALIAS="Indented Name" TABLE="TSystem1" DESCRIPTION="Indented System name to show where system is located in system tree" />
      <FIELD ID="TSystem1CountActivity" ALIAS="act" TABLE="TSystem1" DESCRIPTION="Number of activities not closed for System">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 25px;" />
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right;' class='mark_note'|/^[1-9]" />
         <CONDITIONGROUP>
            <FIELDCONDITION ID="FDone" OPERATOR="0" VALUE="0" SIMPLEVALUE="NO"/>
         </CONDITIONGROUP>
      </FIELD>
      <FIELD ID="TSystem1CountRequest" ALIAS="req" TABLE="TSystem1" DESCRIPTION="Number of requests not closed for System">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 25px;" />
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right;' class='mark_note'|/^[1-9]" />
         <CONDITIONGROUP>
            <FIELDCONDITION ID="FDone" OPERATOR="0" VALUE="0" SIMPLEVALUE="NO"/>
         </CONDITIONGROUP>
      </FIELD>
      <FIELD ID="TSystem1CountProject" ALIAS="prj" TABLE="TSystem1" DESCRIPTION="Number of projects not closed for System">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 25px;" />
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right;' class='mark_note'|/^[1-9]" />
         <CONDITIONGROUP>
            <FIELDCONDITION ID="FDone" OPERATOR="0" VALUE="0" SIMPLEVALUE="NO"/>
         </CONDITIONGROUP>
      </FIELD>
      <FIELD ID="TSystem1CountBooks" ALIAS="book" TABLE="TSystem1" DESCRIPTION="Attached books with information about the system">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 25px;" />
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right;' class='mark_note'|/^[1-9]" />
      </FIELD>
      <FIELD ID="TSystem1CountTodoListAndTodo" ALIAS="todo" TABLE="TSystem1" DESCRIPTION="Number of todos not ready">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 25px;" />
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right;' class='mark_note'|/^[1-9]" />
         <CONDITIONGROUP>
            <FIELDCONDITION ID="FReady" OPERATOR="0" VALUE="0" SIMPLEVALUE="NO"/>
            <FIELDCONDITION ID="FClosed" OPERATOR="0" VALUE="0" SIMPLEVALUE="NO"/>
         </CONDITIONGROUP>
      </FIELD>
      <FIELD ID="TSystem1TypeC" ALIAS="Type" TABLE="TSystem1" />
      <FIELD ID="TSystem1ThreadShortName" ALIAS="Thread" TABLE="TSystem1"/>
      <ORDER FIELD="TSystem1SystemK" INDEX="0" SQL="(SELECT TOP 1 _th.FThreadId FROM $Othread_header _th JOIN $Othread _t ON _th.FThreadId = _t.FThreadId AND _t.table_number=1010 WHERE _t.FKey=TSystem1.SystemK AND _th.table_number=1010)" />
      <ORDER FIELD="TSystem1SystemK" INDEX="0" SQL="(SELECT TOP 1 _t.FPath FROM $Othread _t WHERE _t.FKey=TSystem1.SystemK AND _t.table_number=1010)" />
      <ORDERS NAME="Thread view">
         <ORDER FIELD="TSystem1SystemK" INDEX="0" SQL="(SELECT TOP 1 _th.FThreadId FROM $Othread_header _th JOIN $Othread _t ON _th.FThreadId = _t.FThreadId AND _t.table_number=1010 WHERE _t.FKey=TSystem1.SystemK AND _th.table_number=1010)" />
         <ORDER FIELD="TSystem1SystemK" INDEX="0" SQL="(SELECT TOP 1 _t.FPath FROM $Othread _t WHERE _t.FKey=TSystem1.SystemK AND _t.table_number=1010)" />
      </ORDERS>
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="3a0e17d1-7cdd-4b0d-a185-528bd913fd16"><![CDATA[ return function(g) local R, db, sE=g.result, g.db, g.result:GetParam("event");
if sE == "click" then
   local iKeyPressed = R:GetParam("pressed")
   local iColumn = R:GetParam("column")
   if iKeyPressed == 0 then
      if iColumn == 2 then
         R:SetValue('url','{"link": ["25CD6ED397DB44859FB0E18E78BB0FF4zoom"],"table":"TSystem1"}' )  return
      elseif iColumn == 3 then
         R:SetValue('url','{"link": ["8DE134A0A74C43E7896A256A644EDB92zoom"],"table":"TSystem1"}' )  return
      elseif iColumn == 4 then
         R:SetValue('url','{"link": ["AC8F938FFFFF45488251BD417A41656Fzoom"],"table":"TSystem1"}' )  return
      elseif iColumn == 5 then
         R:SetValue('url','{"link": ["BDF6B05C0CF66F46817740CD67DB4ADFzoom"],"table":"TSystem1"}' )  return
      elseif iColumn == 6 then
         R:SetValue('url','{"link": ["1E4485B89FCA8F4CB8D9A1DAFB00A498zoom"],"table":"TSystem1"}' )  return
      end
   else
      if iColumn == 2 then
         R:SetValue('url','{"title":"Activities: edit","link": ["E011E9977E314F43B719979473167221"],"table":"TSystem1"}' )  return
      elseif iColumn == 3 then
         R:SetValue('url','{"title":"Requests: edit","link": ["ABD3CAB3AD27A5419FFB978647AF1E17"],"table":"TSystem1"}' )  return
      elseif iColumn == 4 then
         R:SetValue('url','{"title":"Projects: edit","link": ["AC8F938FFFFF45488251BD417A41656F"],"table":"TSystem1"}' )  return
      elseif iColumn == 5 then
         R:SetValue('url','{"title":"Books: edit","link": ["87595A00949C31499CE831438BA08D94"],"table":"TSystem1"}' )  return
      elseif iColumn == 6 then
         R:SetValue('url','{"title":"Todolist: edit","link": ["1E4485B89FCA8F4CB8D9A1DAFB00A498"],"table":"TSystem1"}' )  return
      end
   end
end
            
   R:SetValue('url','[' .. 
   '{"id": "activities","title":"Activities", "icon": "fa-align-justify", "table":"TSystem1", "link": ["25CD6ED397DB44859FB0E18E78BB0FF4zoom"]},' .. 
   '{"id": "activities","title":"Activities: edit", "icon": "fa-edit", "table":"TSystem1", "link": ["E011E9977E314F43B719979473167221"]},' .. 
   '{"id": "projects_result","title":"Projects: view", "icon": "fa-align-justify", "table":"TSystem1", "link": ["AC8F938FFFFF45488251BD417A41656Fzoom"]},' .. 
   '{"id": "projects_edit","title":"Projects: edit", "icon": "fa-edit", "table":"TSystem1", "link": ["AC8F938FFFFF45488251BD417A41656F"]},' ..
   '{"id": "systemrequest","title":"Requests", "icon": "fa-align-justify", "table":"TSystem1", "link": ["8DE134A0A74C43E7896A256A644EDB92zoom"]},' ..    
   --'{"id": "systemrequest","title":"Todo items", "icon": "fa-align-justify", "table":"TSystem1", "link": ["6751CF1641AE47C38F8E13FF46674C99zoom"]},' ..    
   '{"child": "Todos"},' .. 
   '{"id": "todolist_edit","title":"Todolist: edit", "icon": "fa-edit", "table":"TSystem1", "link": ["1E4485B89FCA8F4CB8D9A1DAFB00A498"]},' .. 
   '{"id": "todolist_view","title":"Todolist: view", "icon": "fa-align-justify", "table":"TSystem1", "link": ["1E4485B89FCA8F4CB8D9A1DAFB00A498result"]},' .. 
   '{"id": "systemintent_edit","title":"Goals: edit", "icon": "fa-edit", "table":"TSystem1", "link": ["8C0797AC0D60CF44A43E39B0949970ED"]},' ..
   '{"id": "systemintent_view","title":"Goals: view", "icon": "fa-align-justify", "table":"TSystem1", "link": ["155C43F91CCA4892B4E35E9C8A5259CEzoom"]},' ..
   '{"parent": 1},' ..
   '{"child": "Support"},' .. 
   '{"id": "systemrequest","title":"Requests: edit", "icon": "fa-edit", "table":"TSystem1", "link": ["ABD3CAB3AD27A5419FFB978647AF1E17"]},' .. 
   '{"id": "links","title":"Links: View", "icon": "fa-align-justify", "table":"TSystem1", "link": ["435f275c-cb30-4ea7-81ac-f452c520410fzoom"]},' .. 
   '{"id": "links","title":"Links: Add", "icon": "fa-edit", "table":"TSystem1", "link": ["78A78FCEB1784D1693A9699D30E1ED10"]},' .. 
   '{"parent": 1},' ..
   '{"child": "Presentation"},' .. 
   '{"id": "books_result","title":"Books: view", "icon": "fa-align-justify", "table":"TSystem1", "link": ["BDF6B05C0CF66F46817740CD67DB4ADFzoom"]},' ..
   '{"id": "books_edit","title":"Books: edit", "icon": "fa-edit", "table":"TSystem1", "link": ["87595A00949C31499CE831438BA08D94"]},' .. 
   '{"id": "article","title":"Articles: view", "icon": "fa-align-justify", "table":"TSystem1", "link": ["E09B7E7DFF434EBF9A3E24678E4D8815result"]},' .. 
   '{"id": "article","title":"Articles: edit", "icon": "fa-edit", "table":"TSystem1", "link": ["E9F72F7E7F2E354AB7FC7E2D67684274"]},' .. 
   '{"id": "books_connect","title":"Connect books", "icon": "fa-sitemap", "table":"TSystem1", "link": ["EC6EF6AFA3554865A7DC39DA6222BE95"]},' .. 
   '{"id": "presentation","title":"Presentation: view", "icon": "fa-sitemap", "table":"TSystem1", "link": ["C655699FA17A224F8FB61AE637C9F52Fresult"]},' .. 
   '{"id": "presentation","title":"Presentation: edit", "icon": "fa-sitemap", "table":"TSystem1", "link": ["C655699FA17A224F8FB61AE637C9F52F"]},' .. 
   '{"parent": 1},' .. 
   '{"child": "Configure"},' .. 
   '{"id": "systemversion","title":"Versions: edit", "icon": "fa-edit", "table":"TSystem1", "link": ["DB7C2B1E88DF2B4EA265C49A3D7FB59C"]},' .. 
   '{"id": "properties","title":"Properties: edit", "icon": "fa-edit", "table":"TSystem1", "link": ["4426B10022F6154E914DA4745769BD40"]},' .. 
   '{"id": "connect_customer","title":"Customer: edit connected", "icon": "fa-edit", "table":"TSystem1", "link": ["66E465435EA9B04789754574AE0874D3"]},' .. 
   '{"id": "system","title":"System: Add subs", "icon": "fa-edit", "table":"TSystem1", "link": ["05CC0280D7A3DB4883C3324C2D355A0A"]}' .. 
   ']') 
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
   </QUERY>
   
   <QUERY ID="System goals: view" KEY="155C43F91CCA4892B4E35E9C8A5259CE">
      <ATTRIBUTE NAME="OUTPUT-LIST">Todo,70</ATTRIBUTE>
      <FIELD ID="TSystemIntent1SystemIntentK" ALIAS="ID" TABLE="TSystemIntent1"/>
      <FIELD ID="TSystemIntent1FBrief" ALIAS="Brief" TABLE="TSystemIntent1">
         <ATTRIBUTES OUTPUT-FORMAT="hashtag|TSystemIntent1.Hashtag" />
      </FIELD>
      <FIELD ID="TSystemIntent1FText" ALIAS="Text" TABLE="TSystemIntent1" >
         <ATTRIBUTES OUTPUT-FORMAT="`hashtag|TSystemIntent1.Hashtag`  `markdown||[row]|padding: 0px; opacity: 0.7; max-height: 100px; overflow-y: auto; overflow-x: auto; overflow-y: auto; white-space: normal;padding-left: 10px;`"
                     OUTPUT-STYLE="column|max-width: 20px;" />
      </FIELD>
      <FIELD ID="TSystemIntent1TypeC" ALIAS="Type" TABLE="TSystemIntent1" />
      <FIELD ID="TSystemIntent1StateC" ALIAS="State" TABLE="TSystemIntent1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSystemIntent1DifficultyC" ALIAS="Difficulty" TABLE="TSystemIntent1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSystemIntent1PriorityC" ALIAS="Priority" TABLE="TSystemIntent1" FIELDFLAGNAMES="edit" />
   </QUERY>
   
   
   <QUERY ID="System goals: edit" KEY="8C0797AC0D60CF44A43E39B0949970ED" FLAGNAMES="NOTLISTED">
      <FIELD ID="TSystemIntent1SystemIntentK" ALIAS="ID" TABLE="TSystemIntent1"/>
      <FIELD ID="TSystemIntent1FBrief" ALIAS="Brief" TABLE="TSystemIntent1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSystemIntent1FText" ALIAS="Text" TABLE="TSystemIntent1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSystemIntent1TypeC" ALIAS="Type" TABLE="TSystemIntent1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSystemIntent1StateC" ALIAS="State" TABLE="TSystemIntent1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSystemIntent1DifficultyC" ALIAS="Difficulty" TABLE="TSystemIntent1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSystemIntent1PriorityC" ALIAS="Priority" TABLE="TSystemIntent1" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="new_systemintent" SIMPLE="System intent" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
DECLARE @iSystem INT = {{==SystemK}};
DECLARE @iUser INT = {#V user "@@user"};
DECLARE @sBrief NVARCHAR(500) = {=FBrief};

INSERT INTO $OTSystemIntent(SystemK,UserK,FBrief,FText,TypeC,StateC,DifficultyC,PriorityC,CreateD,UpdateD) 
VALUES(@iSystem,@iUser,@sBrief,{=FText},{=TypeC},{=StateC},{=DifficultyC},{=PriorityC},GETDATE(),GETDATE())

DECLARE @iSystemIntent BIGINT = (SELECT IDENT_CURRENT('$OTSystemIntent'));
EXEC $OPROCEDURE_UpdateBadge @sBrief, 'TSystemIntent', @iSystemIntent
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTSystemIntent')" />
         </EDIT>
         <EDIT NAME="delete goal" SIMPLE="Delete system goal" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $OTSystemIntent WHERE SystemIntentK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
   </QUERY>

   
   <QUERY ID="Connect Customer" KEY="66E465435EA9B04789754574AE0874D3">
      <FIELD ID="TrSystemXCustomer1rSystemXCustomerK" ALIAS="ID" TABLE="TrSystemXCustomer1" />
      <FIELD ID="TrSystemXCustomer1CustomerK" ALIAS="Customer" TABLE="TrSystemXCustomer1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TrSystemXCustomer1TypeC" ALIAS="Type" TABLE="TrSystemXCustomer1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TrSystemXCustomer1FDescription" ALIAS="Description" TABLE="TrSystemXCustomer1" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="new_systemversion" SIMPLE="System version" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
DECLARE @iSystem INT = {{==SystemK}};                  
INSERT INTO $OTrSystemXCustomer(SystemK,CustomerK,TypeC,FDescription) 
VALUES(@iSystem,{==CustomerK},{=TypeC"0"},{=FDescription})
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTrSystemXCustomer')" />
         </EDIT>
         <EDIT NAME="delete system" SIMPLE="Delete System - Customer relation" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $OTrSystemXCustomer WHERE rSystemXCustomerK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   
   <QUERY ID="Versions" KEY="3DBCCD178CE77241A0FE9D2A73EE69EB">
      <ATTRIBUTE NAME="OUTPUT-LIST">Important</ATTRIBUTE>
      <FIELD ID="TSystemVersion1SystemVersionK" ALIAS="ID" TABLE="TSystemVersion1"/>
      <FIELD ID="TSystem1FName" ALIAS="System" TABLE="TSystem1" />
      <FIELD ID="TSystemVersion1FName" ALIAS="Name" TABLE="TSystemVersion1" />
      <FIELD ID="TSystemVersion1TypeC" ALIAS="Type" TABLE="TSystemVersion1" />
      <FIELD ID="TSystemVersion1FVersion1" ALIAS="Major" TABLE="TSystemVersion1">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 30px;" />
      </FIELD>
      <FIELD ID="TSystemVersion1FVersion2" ALIAS="Minor" TABLE="TSystemVersion1">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 30px;" />
      </FIELD>
      <FIELD ID="TSystemVersion1FVersion3" ALIAS="Patch" TABLE="TSystemVersion1">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 30px;" />
      </FIELD>
      <FIELD ID="TSystemVersion1FReleased" ALIAS="Released" TABLE="TSystemVersion1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSystemVersion1FDeleted" ALIAS="Deleted" TABLE="TSystemVersion1" FIELDFLAGNAMES="edit" />
      <CONDITION ID="TSystemVersion1FReleased" TABLE="TSystemVersion1" OPERATOR="0" SIMPLEVALUE="NO" VALUE="0"/>
      <CONDITION ID="TSystemVersion1FDeleted" TABLE="TSystemVersion1" OPERATOR="0" SIMPLEVALUE="NO" VALUE="0"/>
      <CONDITIONS ID="Active versions" SELECTED="1">
         <CONDITION ID="TSystemVersion1FReleased" TABLE="TSystemVersion1" OPERATOR="0" SIMPLEVALUE="NO" VALUE="0"/>
         <CONDITION ID="TSystemVersion1FDeleted" TABLE="TSystemVersion1" OPERATOR="0" SIMPLEVALUE="NO" VALUE="0"/>
      </CONDITIONS>
      <CONDITIONS ID="All versions">
         <CONDITION ID="TSystemVersion1FDeleted" TABLE="TSystemVersion1" OPERATOR="0" SIMPLEVALUE="NO" VALUE="0"/>
      </CONDITIONS>
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="87c98ed0-ec25-44fb-a32c-f50f4dd94de8"><![CDATA[ return function(g) local R, db, sE=g.result, g.db, g.result:GetParam("event");
if sE == "click" then
   R:SetValue('url','{"link": ["2AC749C19C8F7049BD8E16091EB40214zoom"],"table":"TSystemVersion1"}' )
   return
end
            
   R:SetValue('url','[' .. 
'{"id": "changelog","title":"Changelog", "icon": "fa-align-justify", "table":"TSystemVersion1", "link": ["2AC749C19C8F7049BD8E16091EB40214zoom"]},' ..    
'{"id": "activities","title":"Versioning Activities", "icon": "fa-edit", "table":"TSystemVersion1", "link": ["CA5A5A05098B4040A109E080F3778F10"]}' .. 
   ']') 
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
      <QUERYLINK TYPENAME="children" NAME="Activities"  DESCRIPTION="Connect activities to version" KEY="CA5A5A05098B4040A109E080F3778F10" EXPRESSION="SELECT SystemK value, 'SystemK' AS name, (SELECT TOP 1 FName FROM $OTSystem s WHERE s.SystemK = SystemK) AS simple FROM $OTSystemVersion WHERE SystemVersionK={{==TSystemVersion1}}">
         <PROPERTIES OUTPUT-WIDTH="1200" OUTPUT-HEIGHT="450" OUTPUT-POSITION="left-bottom" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Changelog"  DESCRIPTION="View changelog" KEY="2AC749C19C8F7049BD8E16091EB40214" EXPRESSION="SELECT SystemVersionK value, 'SystemVersionK' AS name, FName + (FORMAT(FVersion1,'0#') + ':' + FORMAT(FVersion2,'0#') + ':' + FORMAT(FVersion3,'00#')) simple  FROM $OTSystemVersion WHERE SystemVersionK={{==TSystemVersion1}}">
         <PROPERTIES OUTPUT-WIDTH="1200" OUTPUT-HEIGHT="300" OUTPUT-POSITION="right-bottom" />
      </QUERYLINK>
   </QUERY>
   
   <QUERY ID="System links" DESCRIPTION="Edit links related to system" KEY="78A78FCEB1784D1693A9699D30E1ED10" FLAGNAMES="NOTLISTED">
      <ATTRIBUTE NAME="OUTPUT-TRUNCATE">[20,50,200]|50</ATTRIBUTE>
      <FIELD ID="TLink1LinkK" ALIAS="ID" TABLE="TLink1"/>
      <FIELD ID="TLink1TypeC" ALIAS="Type" TABLE="TLink1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TLink1FUrl" ALIAS="Url" TABLE="TLink1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TLink1FName" ALIAS="Name" TABLE="TLink1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TLink1FDescription" ALIAS="Description" TABLE="TLink1" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="new_systemversion" SIMPLE="System version" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
DECLARE @iSystem INT = {==SystemK}
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TSystem');
INSERT INTO $OTLink(ParentK,table_number,FUrl,FName,FDescription,TypeC,CreateD,UpdateD) 
VALUES(@iSystem,@iTable,{=FUrl},{=FName},{=FDescription},{=TypeC},GETDATE(),GETDATE())
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTLink')" />
         </EDIT>
         <EDIT NAME="delete system" SIMPLE="Delete System" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $OTLink WHERE LinkK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   <QUERY ID="System: View links" DESCRIPTION="Links related to system" KEY="435f275c-cb30-4ea7-81ac-f452c520410f" FLAGNAMES="NOTLISTED">
      <FIELD ID="TLink1LinkK" ALIAS="ID" TABLE="TLink1"/>
      <FIELD ID="TLink1TypeC" ALIAS="Type" TABLE="TLink1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TLink5FUrl-Goto" ALIAS="Link" TABLE="TLink1" />
      <FIELD ID="TLink1FDescription" ALIAS="Description" TABLE="TLink1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="hashtag|TLink1.Hashtag" />
      </FIELD>
   </QUERY>
   
   
   <QUERY ID="System properties" DESCRIPTION="Properties for system" KEY="4426B10022F6154E914DA4745769BD40" FLAGNAMES="NOTLISTED">
      <FIELD ID="TPropertyName1PropertyNameK" ALIAS="ID (Property name)" TABLE="TPropertyName1"/>
      <FIELD ID="TPropertyName1FName" ALIAS="Name" TABLE="TPropertyName1"/>
      <FIELD ID="TPropertyName1FName" ALIAS="Value" TABLE="TPropertyName1" FORMAT="(SELECT _p.FValue FROM $OTProperty _p WHERE _p.PropertyNameK = $T.PropertyNameK AND _p.table_number = 1010 AND _p.ParentK = ${=SystemK})" FIELDFLAGNAMES="sql_format,edit">
         <EDIT>
DECLARE @sValue NVARCHAR(1000) = {=TPropertyName1FName}
DELETE FROM $OTProperty WHERE table_number = 1010 AND ParentK = {==SystemK} AND PropertyNameK = ${@TPropertyName1PropertyNameK}
IF @sValue IS NOT NULL AND  LEN( @sValue ) > 0
BEGIN
   INSERT INTO $OTProperty (ParentK,table_number,PropertyNameK,FValue) VALUES({==SystemK},1010,${@TPropertyName1PropertyNameK},@sValue)
END
         </EDIT>
      </FIELD>
      <CONDITION ID="TPropertyName1table_number" TABLE="TPropertyName1" OPERATOR="0" SIMPLEVALUE="1010" VALUE="1010" FLAGS="0"/>
   </QUERY>

   
   <QUERY ID="System versions" KEY="DB7C2B1E88DF2B4EA265C49A3D7FB59C" FLAGNAMES="NOTLISTED">
      <FIELD ID="TSystemVersion1SystemVersionK" ALIAS="ID (System version)" TABLE="TSystemVersion1"/>
      <FIELD ID="TSystemVersion1FName" ALIAS="Name" TABLE="TSystemVersion1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSystemVersion1TypeC" ALIAS="Type" TABLE="TSystemVersion1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSystemVersion1FVersion1" ALIAS="Major" TABLE="TSystemVersion1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSystemVersion1FVersion2" ALIAS="Minor" TABLE="TSystemVersion1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSystemVersion1FVersion3" ALIAS="Patch" TABLE="TSystemVersion1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSystemVersion1FTrailing" ALIAS="Trailing" TABLE="TSystemVersion1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSystemVersion1FTested" ALIAS="Tested" TABLE="TSystemVersion1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TSystemVersion1FReleased" ALIAS="Released" TABLE="TSystemVersion1" FIELDFLAGNAMES="edit" />
      <CONDITION ID="TSystemVersion1FDeleted" TABLE="TSystemVersion1" OPERATOR="5" SIMPLEVALUE="1" VALUE="1" FLAGS="0"/>
      <ROWEDIT>
         <EDIT NAME="new_systemversion" SIMPLE="System version" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
DECLARE @iSystem INT = {==SystemK}
DECLARE @iVersion1 INT = {=FVersion1}
DECLARE @iVersion2 INT = {=FVersion2}
DECLARE @iVersion3 INT = {=FVersion3}

DECLARE @OverallCounter BIGINT = (SELECT ISNULL( MAX( OverallCounter ), 0 ) + 1 FROM $OTSystemVersion);
DECLARE @SystemCounter BIGINT = (SELECT ISNULL( MAX( SystemCounter ), 0 ) + 1 FROM $OTSystemVersion WHERE SystemK=@iSystem);

-- Generate version if NULL, if no version then 1 otherwise max number
IF @iVersion1 IS NULL
   SET @iVersion1 = (SELECT ISNULL(MAX(FVersion1),1) FROM $OTSystemVersion WHERE SystemK=@iSystem)

-- retrieve same version as before or 0
IF @iVersion2 IS NULL
   SET @iVersion2 = (SELECT ISNULL( MAX(FVersion2), 0 ) FROM $OTSystemVersion WHERE FVersion1 = @iVersion1 AND SystemK=@iSystem)
   
-- Increases patch number by default if not set   
IF @iVersion3 IS NULL
   SET @iVersion3 = 1 + (SELECT ISNULL( MAX(FVersion3), 0 ) FROM $OTSystemVersion WHERE FVersion1 = @iVersion1 AND FVersion2 = @iVersion2 AND SystemK=@iSystem)
   
                  
INSERT INTO $OTSystemVersion(SystemK,UserK,FName,FVersion1,FVersion2,FVersion3,TypeC,StateC,FTested,FReleased,FDeleted,CreateD,UpdateD,OverallCounter,SystemCounter) 
VALUES(@iSystem,{#V user "@@user"},{=FName"''"},@iVersion1,@iVersion2,@iVersion3,{=TypeC"0"},0,{=FTested"0"},{=FReleased"0"},{=FDeleted"0"}, GETDATE(),GETDATE(),@OverallCounter,@SystemCounter)
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTSystemVersion')" />
         </EDIT>
         <EDIT NAME="delete system" SIMPLE="Delete System" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $OTSystemVersion WHERE SystemVersionK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
   </QUERY>
  
</SELECTION>