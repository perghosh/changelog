<?xml version="1.0" encoding="utf-8"?>
<!--
Motioner = lista över motioner med editering
poll_overview = information about selected poll
poll_overview_related = related polls
poll_links = links connected to poll
poll_question = Single question for selected poll
poll_answer = Answers for question
poll_answer_all = All answers for selected poll
poll_vote_comment = Comments for poll
poll_search = Query used to search for polls
poll_vote = Query used for register vote
poll_hashtags = Get hash-tags for poll's


-->
<SELECTION  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../queries.xsd"
            TYPE="query" DESCRIPTION="Changelog queries">


   <QUERY ID="Koppla motioner" DESCRIPTION="" KEY="8FB1E7238C2B4E45A6304D70C3712B76">
      <FIELD ID="TrPollXPoll1rPollXPollK" ALIAS="ID" TABLE="TrPollXPoll1">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 25px;" />
      </FIELD>
      <FIELD ID="TrPollXPoll1ToPollK" ALIAS="Motion" TABLE="TrPollXPoll1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TrPollXPoll1FDescription" ALIAS="Beskrivning" TABLE="TrPollXPoll1" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="new poll connection" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
DECLARE @iPoll BIGINT = {{=PollK}}
INSERT INTO $O{VOTE}TrPollXPoll(PollK,ToPollK,FDescription)
VALUES(@iPoll,{{==ToPollK}},{=FDescription})
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$O{VOTE}TrPollXPoll')" />
         </EDIT>
         <EDIT NAME="delete connection" SIMPLE="Delete connection" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $O{VOTE}TrPollXPoll WHERE rPollXPollK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   <QUERY ID="Group" DESCRIPTION="" KEY="A753FF26F9D942C98E71916F331B29E9">
      <ATTRIBUTE NAME="OUTPUT-LIST">Huvudfrågor,1</ATTRIBUTE>
      <FIELD ID="TPollGroup1PollGroupK" ALIAS="ID" TABLE="TPollGroup1">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 25px;" />
      </FIELD>
      <FIELD ID="TPollGroup1FName-Indent" ALIAS="Name" TABLE="TPollGroup1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollGroup1FDescription" ALIAS="Description" TABLE="TPollGroup1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollGroup1FUseTie" ALIAS="Tie" TABLE="TPollGroup1" FIELDFLAGNAMES="edit" />
      
      <ORDER FIELD="TPollGroup1PollGroupK" INDEX="0" SQL="(SELECT TOP 1 _th.FThreadId FROM $O{}thread_header _th JOIN $O{}thread _t ON _th.FThreadId = _t.FThreadId AND _t.table_number=11010 WHERE _t.FKey=TPollGroup1.PollGroupK AND _th.table_number=11010)" />
      <ORDER FIELD="TPollGroup1PollGroupK" INDEX="0" SQL="(SELECT TOP 1 _t.FPath FROM $O{}thread _t WHERE _t.FKey=TPollGroup1.PollGroupK AND _t.table_number=11010)" />
      <ORDERS NAME="Thread view">
         <ORDER FIELD="TPollGroup1PollGroupK" INDEX="0" SQL="(SELECT TOP 1 _th.FThreadId FROM $O{}thread_header _th JOIN $O{}thread _t ON _th.FThreadId = _t.FThreadId AND _t.table_number=11010 WHERE _t.FKey=TPollGroup1.PollGroupK AND _th.table_number=11010)" />
         <ORDER FIELD="TPollGroup1PollGroupK" INDEX="0" SQL="(SELECT TOP 1 _t.FPath FROM $O{}thread _t WHERE _t.FKey=TPollGroup1.PollGroupK AND _t.table_number=11010)" />
      </ORDERS>
      
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE CACHE="c47f0d5f-c280-4335-b9cf-3e49a71ffc48"><![CDATA[ return function(g) local R, db, sE=g.result, g.db, g.result:GetParam("event");
   R:SetValue('url','[' .. 
   '{"id": "add_sub","title":"Add sub", "icon": "fa-edit", "table":"TPollGroup1", "link": ["3E4AC376CD7D4DE695B1F18A1E91A86B"]},' ..
   '{"id": "send","title":"Beam group", "icon": "fa-broadcast-tower", "table":"TPollGroup1", "link": ["1b0105ba3f604e95b376994901ab37d9"]}' ..
   ']') 
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
      
      <ROWEDIT>
         <EDIT NAME="new_group" SIMPLE="Poll group" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION CACHE="26EE6ED4-2C8D-4DED-8CAF-B98C2E01249F">
DECLARE @sName NVARCHAR(MAX) = {=FName};
DECLARE @sDescription NVARCHAR(MAX) = {=FDescription};
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TPollGroup' AND "schema" = 'vote' );
   
INSERT INTO $O{VOTE}TPollGroup(TypeC,FName,FDescription,FUseTie,CreateD,UpdateD) 
VALUES({=TypeC"0"},@sName,@sDescription,{{=FUseTie="0"}},GETDATE(),GETDATE());

DECLARE @iPollGroup BIGINT = (SELECT IDENT_CURRENT('$O{VOTE}TPollGroup'));
EXEC $OPROCEDURE_UpdateBadge @sDescription,'vote.TPollGroup', @iPollGroup
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$O{VOTE}TPollGroup')" />
         </EDIT>
         <EDIT NAME="delete poll" SIMPLE="Radera proposition" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $O{VOTE}TPollGroup WHERE PollGroupK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
      <QUERYLINK TYPENAME="children" NAME="Sub system"  KEY="3E4AC376CD7D4DE695B1F18A1E91A86B" EXPRESSION="SELECT PollGroupK value, 'SuperK' AS name, FName AS simple FROM $O{VOTE}TPollGroup WHERE PollGroupK={{==TPollGroup1}}" />
      <QUERYLINK TYPENAME="message" NAME="Connect poll" KEY="1b0105ba3f604e95b376994901ab37d9" EXPRESSION="SELECT PollGroupK value, 'PollGroupK' AS name, FName AS simple FROM $O{VOTE}TPollGroup WHERE PollGroupK={{==TPollGroup1}}">
         <PROPERTIES OUTPUT-COMMAND="send key" />         
      </QUERYLINK>
   </QUERY>
   
   
   <QUERY ID="Group: Add sub" DESCRIPTION="" KEY="3E4AC376CD7D4DE695B1F18A1E91A86B">
      <FIELD ID="TPollGroup1PollGroupK" ALIAS="ID" TABLE="TPollGroup1" />
      <FIELD ID="TPollGroup1SuperK" ALIAS="Parent" TABLE="TPollGroup1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollGroup1FName" ALIAS="Name" TABLE="TPollGroup1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollGroup1FDescription" ALIAS="Description" TABLE="TPollGroup1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPoll1FUseTie" ALIAS="Tie" TABLE="TPollGroup1" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="new_system" SIMPLE="Systems" TYPENAME="new_row">
            <PROPERTY NAME="columns">0,SuperK,FUseTie</PROPERTY>
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION CACHE="ED0A97AC-5AC4-4AA1-B1D7-8F781230063A">
DECLARE @iSuper INT = {{=SuperK}}
IF @iSuper = 0 SET @iSuper = NULL

DECLARE @sName NVARCHAR(MAX) = {=FName};
DECLARE @sDescription NVARCHAR(MAX) = {=FDescription};
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TPollGroup' AND "schema" = 'vote' );
   
INSERT INTO $O{VOTE}TPollGroup(SuperK,TypeC,FName,FDescription,FUseTie,CreateD,UpdateD) 
VALUES(@iSuper,{=TypeC"0"},@sName,@sDescription,{{=FUseTie="0"}},GETDATE(),GETDATE());

DECLARE @iPollGroup BIGINT = (SELECT IDENT_CURRENT('$O{VOTE}TPollGroup'));
EXEC $OPROCEDURE_UpdateBadge @sDescription,'vote.TPollGroup', @iPollGroup
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTSystem')">
               <EXPRESSION>
DECLARE @iPollGroup BIGINT = (SELECT IDENT_CURRENT('$O{VOTE}TPollGroup'))
SELECT PollGroupK, (SELECT t.FName FROM $O{VOTE}TPollGroup t WHERE t.SuperK=PollGroupK), FUseTie FROM $O{VOTE}TPollGroup WHERE PollGroupK = @iPollGroup
               </EXPRESSION>
            </SQL>
         </EDIT>
         <EDIT NAME="delete system" SIMPLE="Delete System" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $OTSystem WHERE SystemK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
      
   </QUERY>
   
      
   <QUERY ID="Motioner" DESCRIPTION="" KEY="91A3AA122FD8490DBF56E8885BDF358C">
      <ATTRIBUTE NAME="OUTPUT-LIST">Huvudfrågor,1</ATTRIBUTE>
      <FIELD ID="TPoll1PollK" ALIAS="ID" TABLE="TPoll1">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 25px;" />
      </FIELD>
      <FIELD ID="TPoll1PollGroupK" ALIAS="Group" TABLE="TPoll1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPoll1FHeader" ALIAS="Rubrik" TABLE="TPoll1" FIELDFLAGNAMES="edit" DESCRIPTION="Short header for poll" />
      <FIELD ID="TPoll1FName" ALIAS="Namn" TABLE="TPoll1" FIELDFLAGNAMES="edit" DESCRIPTION="Poll name, useable searching for polls" />
      <FIELD ID="TPoll1FDescription" ALIAS="Beskrivning" TABLE="TPoll1" FIELDFLAGNAMES="edit">
         <EDIT>{"update":"$O{}PROCEDURE_UpdateBadge {=TPoll1FDescription}, 'vote.TPoll', ${@TPoll1PollK}","formula":"1"}</EDIT>         
      </FIELD>

      <FIELD ID="TPoll1Note" ALIAS="Note" TABLE="TPoll1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="markdown|padding: 3px; font-size: 90%; max-width: 95%; overflow-x: auto; white-space: normal;|[row]|padding-left: 50px;"
                     OUTPUT-STYLE="column|max-width: 25px;" />
         <EDIT>
DECLARE @iTable INT = (SELECT number FROM $O{}table_number WHERE "name" = 'TPoll' AND "schema" = 'vote' );
IF (SELECT COUNT(*) FROM $O{}TNote WHERE RecordK=${@TPoll1PollK} AND table_number=@iTable) = 0
   INSERT INTO $O{}TNote (RecordK, table_number) VALUES(${@TPoll1PollK},@iTable)

UPDATE $O{}TNote SET FNote={=TPoll1Note} WHERE RecordK=${@TPoll1PollK} AND table_number=@iTable
         </EDIT>
      </FIELD>
      
      <FIELD ID="TPoll1FBegin" ALIAS="Startdatum" TABLE="TPoll1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-INPUT="date|YYYY-MM-DD HH:mm|24" />
      </FIELD>
      <FIELD ID="TPoll1FEnd" ALIAS="Slutdatum" TABLE="TPoll1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-INPUT="date|YYYY-MM-DD HH:mm|24" />
      </FIELD>
      <FIELD ID="TPoll1Type" ALIAS="Type" TABLE="TPoll1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPoll1CountQuestion" ALIAS="Antal frågor" TABLE="TPoll1">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 25px;" />
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right;' class='mark_note'|/^[1-9]" />
      </FIELD>
      <ORDER FIELD="TPoll1FBegin" DESC="1"/>
      
      <ROWEDIT>
         <EDIT NAME="new_poll" SIMPLE="Pol" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION CACHE="D088118B-A789-48B3-9825-B5DF0C95B765">
DECLARE @sName NVARCHAR(MAX) = {=FName};
DECLARE @sDescription NVARCHAR(MAX) = {=FDescription};
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TPoll' AND "schema" = 'vote' );
DECLARE @Start DATETIME = {=FStart}
DECLARE @End DATETIME = {=FEnd}
IF @Start IS NULL
   SET @Start = DATEADD(day,0,DATEDIFF(day,0,GETDATE()))

IF @End IS NULL
   SET @End = DATEADD(month,1,@Start)
   
INSERT INTO $O{VOTE}TPoll(PollGroupK,TypeC,FHeader,FName,FDescription,FBegin,FEnd,CreateD,UpdateD) 
VALUES({{=PollGroupK}},{=TypeC"0"},{=FHeader},@sName,@sDescription,@Start,@End,GETDATE(),GETDATE());

DECLARE @iPoll BIGINT = (SELECT IDENT_CURRENT('$O{VOTE}TPoll'));
EXEC $OPROCEDURE_UpdateBadge @sDescription,'vote.TPoll', @iPoll

INSERT INTO $OTNote(RecordK,table_number,FNote,CreateD,UpdateD)
VALUES(@iPoll,@iTable,{=TPoll1Note},GETDATE(),GETDATE());

IF @sName IS NOT NULL
BEGIN
   INSERT INTO $O{VOTE}TPollQuestion(PollK,FName,CreateD,UpdateD) 
   VALUES(@iPoll,@sName,GETDATE(),GETDATE());
END
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$O{VOTE}TPoll')" />
         </EDIT>
         <EDIT NAME="delete poll" SIMPLE="Radera proposition" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $O{VOTE}TPoll WHERE PollK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE><![CDATA[ return function(g) local R, db, sE=g.result, g.db, g.result:GetParam("event");
if sE == "click" then
   local iKeyPressed = R:GetParam("pressed")
   local iColumn = R:GetParam("column")
   if iKeyPressed == 0 then
      if iColumn == 3 then
         R:SetValue('url','{"link": ["13304CE1144D43C292D7589C322863D0zoom"],"table":"TPoll1"}' )  return
      end
   else
      if iColumn == 3 then
         R:SetValue('url','{"title":"Valfrågor - Lägg till","link": ["5599795A83B546C6A8CA34197D87A047"],"table":"TPoll1"}' ) return
      end
   end
end
            
   R:SetValue('url','[' .. 
   '{"id": "edit","title":"Ändra", "icon": "fa-i-cursor", "table":"TPoll1", "link": ["EA672606B1F7427BB293E5606BF8732B"]},' ..
   '{"id": "query","title":"Valfrågor - Visa", "icon": "fa-align-justify", "table":"TPoll1", "link": ["13304CE1144D43C292D7589C322863D0zoom"]},' .. 
   '{"id": "query","title":"Valfrågor - Lägg till", "icon": "fa-edit", "table":"TPoll1", "link": ["5599795A83B546C6A8CA34197D87A047"]},' .. 
   '{"id": "add_link","title":"Länk: Lägg till", "icon": "fa-edit", "table":"TPoll1", "link": ["E2328BC89E074AE48D7E70895C9F36CE"]},' .. 
   '{"id": "connect_poll","title":"Koppla motion", "icon": "fa-edit", "table":"TPoll1", "link": ["8FB1E7238C2B4E45A6304D70C3712B76"]},' .. 
   '{"id": "send_key","title":"Beam poll", "icon": "fa-broadcast-tower", "table":"TPoll1", "link": ["8049DFF5E2D1488BAF55021184F31E2C"]}' .. 
   ']') 
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
      <QUERYLINK TYPENAME="record" NAME="Poll"  DESCRIPTION="Edit activities for system" KEY="EA672606B1F7427BB293E5606BF8732B" QUERY="1DBB7BCEC31F491198A9F365B36150A6">
         <EXPRESSION>
SELECT PollK value, 'PollK' AS name, ISNULL(FHeader,FName) simple FROM $O{VOTE}TPoll WHERE PollK={{==TPoll1}}
         </EXPRESSION>
         <PROPERTIES OUTPUT-WIDTH="1900" OUTPUT-HEIGHT="500" OUTPUT-POSITION="center-bottom" />
      </QUERYLINK>
      
      <QUERYLINK TYPENAME="children" NAME="Question"  DESCRIPTION="Visa frågor" KEY="13304CE1144D43C292D7589C322863D0" QUERY="7DF3032022F64E52A6473C283575ACFF" EXPRESSION="SELECT PollK AS value, 'PollK' AS name, FName AS simple FROM $O{VOTE}TPoll WHERE PollK={{==TPoll1}}">
         <PROPERTIES OUTPUT-WIDTH="900" OUTPUT-HEIGHT="500" OUTPUT-POSITION="right-top|-50,0" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Fråga"  DESCRIPTION="Lägg till frågor" KEY="5599795A83B546C6A8CA34197D87A047" QUERY="358497254151814E8F9273212F0CE565" EXPRESSION="SELECT PollK AS value, 'PollK' AS name, FName AS simple FROM $O{VOTE}TPoll WHERE PollK={{==TPoll1}}">
         <PROPERTIES OUTPUT-WIDTH="1100" OUTPUT-HEIGHT="400" OUTPUT-POSITION="left-top|10,60" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Add link" KEY="E2328BC89E074AE48D7E70895C9F36CE" EXPRESSION="SELECT PollK AS value, 'PollK' AS name, FName AS simple FROM $O{VOTE}TPoll WHERE PollK={{==TPoll1}}" />
      <QUERYLINK TYPENAME="children" NAME="Connect poll" KEY="8FB1E7238C2B4E45A6304D70C3712B76" EXPRESSION="SELECT PollK AS value, 'PollK' AS name, FName AS simple FROM $O{VOTE}TPoll WHERE PollK={{==TPoll1}}" />
      <QUERYLINK TYPENAME="message" NAME="Connect poll" KEY="8049DFF5E2D1488BAF55021184F31E2C" EXPRESSION="SELECT PollK AS value, 'ToPollK' AS name, FName AS simple FROM $O{VOTE}TPoll WHERE PollK={{==TPoll1}}">
         <PROPERTIES OUTPUT-COMMAND="send key" />         
      </QUERYLINK>
   </QUERY>
   
   
   <QUERY ID="Motion - ändra" DESCRIPTION="" KEY="1DBB7BCEC31F491198A9F365B36150A6" FLAGNAMES="NOTLISTED">
      <FIELD ID="TPoll1PollK" ALIAS="ID" TABLE="TPoll1">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 25px;" />
      </FIELD>
      <FIELD ID="TPoll1PollGroupK" ALIAS="Group" TABLE="TPoll1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPoll1FHeader" ALIAS="Heading" TABLE="TPoll1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPoll1FName" ALIAS="Name" TABLE="TPoll1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPoll1FDescription" ALIAS="Beskrivning" TABLE="TPoll1" FIELDFLAGNAMES="edit">
         <EDIT>{"update":"$O{}PROCEDURE_UpdateBadge {=TPoll1FDescription}, 'vote.TPoll', ${@TPoll1PollK}","formula":"1"}</EDIT>         
      </FIELD>

      <FIELD ID="TPoll1Note" ALIAS="Note" TABLE="TPoll1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-FORMAT="markdown|padding: 3px; font-size: 90%; max-width: 95%; overflow-x: auto; white-space: normal;|[row]|padding-left: 50px;"
                     OUTPUT-STYLE="column|max-width: 25px;" />
         <EDIT>
DECLARE @iTable INT = (SELECT number FROM $O{}table_number WHERE "name" = 'TPoll' AND "schema" = 'vote' );
IF (SELECT COUNT(*) FROM $O{}TNote WHERE RecordK=${@TPoll1PollK} AND table_number=@iTable) = 0
   INSERT INTO $O{}TNote (RecordK, table_number) VALUES(${@TPoll1PollK},@iTable)

UPDATE $O{}TNote SET FNote={=TPoll1Note} WHERE RecordK=${@TPoll1PollK} AND table_number=@iTable
         </EDIT>
      </FIELD>
      
      <FIELD ID="TPoll1FBegin" ALIAS="Startdatum" TABLE="TPoll1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-INPUT="date|YYYY-MM-DD HH:mm|24" />
      </FIELD>
      <FIELD ID="TPoll1FEnd" ALIAS="Slutdatum" TABLE="TPoll1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-INPUT="date|YYYY-MM-DD HH:mm|24" />
      </FIELD>
      <FIELD ID="TPoll1Type" ALIAS="Type" TABLE="TPoll1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPoll1FUseTie" ALIAS="Tie" TABLE="TPoll1" FIELDFLAGNAMES="edit" />
      
      <ROWEDIT>
         <EDIT NAME="new_poll" SIMPLE="Pol" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION CACHE="09844699-880E-40B2-934C-51A024989745">
DECLARE @sName NVARCHAR(MAX) = {=FName};
DECLARE @sDescription NVARCHAR(MAX) = {=FDescription};
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TPoll' AND "schema" = 'vote' );
DECLARE @Start DATETIME = {=FStart}
DECLARE @End DATETIME = {=FEnd}
IF @Start IS NULL
   SET @Start = DATEADD(day,0,DATEDIFF(day,0,GETDATE()))

IF @End IS NULL
   SET @End = DATEADD(month,1,@Start)
   
INSERT INTO $O{VOTE}TPoll(PollGroupK,TypeC,FHeader,FName,FDescription,FBegin,FEnd,FUseTie,CreateD,UpdateD) 
VALUES({{=PollGroupK}},{=TypeC"0"},{=FHeader},@sName,@sDescription,@Start,@End,{{=FUseTie="0"},GETDATE(),GETDATE());

DECLARE @iPoll BIGINT = (SELECT IDENT_CURRENT('$O{VOTE}TPoll'));
EXEC $OPROCEDURE_UpdateBadge @sDescription,'vote.TPoll', @iPoll

INSERT INTO $OTNote(RecordK,table_number,FNote,CreateD,UpdateD)
VALUES(@iPoll,@iTable,{=TPoll1Note},GETDATE(),GETDATE());

IF @sName IS NOT NULL
BEGIN
   INSERT INTO $O{VOTE}TPollQuestion(PollK,FName,CreateD,UpdateD) 
   VALUES(@iPoll,@sName,GETDATE(),GETDATE());
END
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$O{VOTE}TPoll')" />
         </EDIT>
         <EDIT NAME="delete poll" SIMPLE="Radera proposition" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $O{VOTE}TPoll WHERE PollK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   
   <QUERY ID="Frågor-visa" TITLE="Valfrågor - Visa" FLAGS="1" KEY="7DF3032022F64E52A6473C283575ACFF" DESCRIPTION="Listar frågor för motion">
      <ATTRIBUTE NAME="OUTPUT-LIST">Valfrågor,2</ATTRIBUTE>
      <FIELD ID="TPollQuestion1PollQuestionK" ALIAS="ID (Question)" TABLE="TPollQuestion1"/>
      <FIELD ID="TPollQuestion1PollK" ALIAS="Motion" TABLE="TPollQuestion1" />
      <FIELD ID="TPollQuestion1FName" ALIAS="Name" TABLE="TPollQuestion1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollQuestion1FDescription" ALIAS="Description" TABLE="TPollQuestion1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollQuestion1CountAnswer" ALIAS="Antal svar" TABLE="TPollQuestion1">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 25px;" />
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right;' class='mark_note'|/^[1-9]" />
      </FIELD>
      <FIELD ID="TPollQuestion1TypeC" ALIAS="TypeC" TABLE="TPollQuestion1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollQuestion1StateC" ALIAS="StateC" TABLE="TPollQuestion1" FIELDFLAGNAMES="edit" />
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE><![CDATA[ return function(g) local R, db, sE=g.result, g.db, g.result:GetParam("event");
if sE == "click" then
   local iKeyPressed = R:GetParam("pressed")
   local iColumn = R:GetParam("column")
   if iKeyPressed == 0 then
      if iColumn == 4 then
         R:SetValue('url','{"link": ["5240B4EFCFFD47D29E43592FB488CA22zoom"],"table":"TPollQuestion1"}' )  return
      end
   else
      if iColumn == 4 then
         R:SetValue('url','{"title":"Svarsalternativ - ändra","link": ["70A70D58EE1048D2A174F5269E839616"],"table":"TPollQuestion1"}' ) return
      end
   end
end
            
   R:SetValue('url','[' .. 
   '{"id": "answer_show","title":"Svarsalternativ - visa", "icon": "fa-edit", "table":"TPollQuestion1", "link": ["5240B4EFCFFD47D29E43592FB488CA22zoom"]},' .. 
   '{"id": "answer_edit","title":"Svarsalternativ - ändra", "icon": "fa-edit", "table":"TPollQuestion1", "link": ["70A70D58EE1048D2A174F5269E839616"]},' .. 
   '{"id": "answer_limit","title":"Konfigurera regler", "icon": "fa-edit", "table":"TPollQuestion1", "link": ["87D61FC1B1D4413ABB855A0D4968D47B"]}' .. 
   ']') 
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
      <QUERYLINK TYPENAME="children" NAME="Svar-visa" KEY="5240B4EFCFFD47D29E43592FB488CA22" QUERY="80147C1CB4CC46ECAE4056BF9B2165D6" EXPRESSION="SELECT PollQuestionK AS value, 'PollQuestionK' AS name, FName AS simple FROM $O{VOTE}TPollQuestion WHERE PollQuestionK={{==TPollQuestion1}}">
         <PROPERTIES OUTPUT-WIDTH="800" OUTPUT-HEIGHT="500" OUTPUT-POSITION="right-top|0,150" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Svar-edit" DESCRIPTION="Svarsalternativ" KEY="70A70D58EE1048D2A174F5269E839616" QUERY="C0B3033897E2CD4EA3395F98512DD495" EXPRESSION="SELECT PollQuestionK AS value, 'PollQuestionK' AS name, FName AS simple FROM $O{VOTE}TPollQuestion WHERE PollQuestionK={{==TPollQuestion1}}">
         <PROPERTIES OUTPUT-WIDTH="1000" OUTPUT-HEIGHT="500" OUTPUT-POSITION="right-bottom" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Regler" DESCRIPTION="Svarsalternativ" KEY="87D61FC1B1D4413ABB855A0D4968D47B" QUERY="15669361EBFA44A4A5E5EFDE857E2BAD" EXPRESSION="SELECT PollQuestionK AS value, 'PollQuestionK' AS name, FName AS simple FROM $O{VOTE}TPollQuestion WHERE PollQuestionK={{==TPollQuestion1}}">
         <PROPERTIES OUTPUT-WIDTH="1000" OUTPUT-HEIGHT="400" OUTPUT-POSITION="left-bottom" />
      </QUERYLINK>
   </QUERY>
   
   
   <QUERY ID="Frågor-ändra" TITLE="Valfrågor - Lägg till" FLAGS="1" KEY="358497254151814E8F9273212F0CE565" DESCRIPTION="Editera frågor för motion">
      <ATTRIBUTE NAME="OUTPUT-LIST">Ändra/Lägg till,100</ATTRIBUTE>
      <FIELD ID="TPollQuestion1PollQuestionK" ALIAS="ID (Question)" TABLE="TPollQuestion1"/>
      <FIELD ID="TPollQuestion1FName" ALIAS="Name" TABLE="TPollQuestion1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollQuestion1FLabel" ALIAS="Label" TABLE="TPollQuestion1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollQuestion1FDescription" ALIAS="Description" TABLE="TPollQuestion1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollQuestion1TypeC" ALIAS="Type" TABLE="TPollQuestion1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollQuestion1StateC" ALIAS="State" TABLE="TPollQuestion1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollQuestion1FOrder" ALIAS="Order" TABLE="TPollQuestion1" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="new_question" SIMPLE="Fråga" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
DECLARE @iPoll INT = {{=PollK}};                  
INSERT INTO $O{VOTE}TPollQuestion(PollK,FName,FLabel,FDescription,TypeC,StateC,FOrder,CreateD,UpdateD) 
VALUES(@iPoll,{=FName"''"},{=FLabel"''"},{=FDescription},{=TypeC},{=StateC},{=FOrder},GETDATE(),GETDATE());
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$O{VOTE}TPollQuestion')" />
         </EDIT>
         <EDIT NAME="delete poll" SIMPLE="Radera proposition" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $O{VOTE}TPollQuestion WHERE PollQuestionK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE><![CDATA[ return function(g) local R, db=g.result, g.db
   R:SetValue('url','[' .. 
   '{"id": "answer","title":"Svarsalternativ", "icon": "fa-edit", "table":"TPollQuestion1", "link": ["70A70D58EE1048D2A174F5269E839616"]}' .. 
   ']') 
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
      <QUERYLINK TYPENAME="children" NAME="Fråga" DESCRIPTION="Svarsalternativ" KEY="70A70D58EE1048D2A174F5269E839616" QUERY="C0B3033897E2CD4EA3395F98512DD495" EXPRESSION="SELECT PollQuestionK AS value, 'PollQuestionK' AS name, FName AS simple FROM $O{VOTE}TPollQuestion WHERE PollK={{==TPollQuestion1}}">
         <PROPERTIES OUTPUT-WIDTH="700" OUTPUT-HEIGHT="700" OUTPUT-POSITION="left-bottom" />
      </QUERYLINK>
   </QUERY>
   
   <QUERY ID="Svarsalternativ-visa" TITLE="Svarsalternativ - Visa" FLAGS="1" KEY="80147C1CB4CC46ECAE4056BF9B2165D6">
      <ATTRIBUTE NAME="OUTPUT-LIST">Valfrågor,2</ATTRIBUTE>
      <FIELD ID="TPollAnswer1PollAnswerK" ALIAS="ID (Answer)" TABLE="TPollAnswer1"/>
      <FIELD ID="TPollAnswer1FName" ALIAS="Name" TABLE="TPollAnswer1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollAnswer1FDescription" ALIAS="Description" TABLE="TPollAnswer1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollAnswer1TypeC" ALIAS="TypeC" TABLE="TPollAnswer1" FIELDFLAGNAMES="edit" />
   </QUERY>   
   
   <QUERY ID="poll_list" FLAGS="1" KEY="00000000000000000000000000000002" DESCRIPTION="List active polls for voter">
      <ATTRIBUTE NAME="OUTPUT-LIST">System,200</ATTRIBUTE>
      <FIELD ID="TPoll1PollK" ALIAS="ID" TABLE="TPoll1" />
      <FIELD ID="TPoll1FName" ALIAS="Namn" TABLE="TPoll1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPoll1FDescription" ALIAS="Beskrivning" TABLE="TPoll1" FIELDFLAGNAMES="edit" />
      <ORDER FIELD="TPoll1PollK" DESC="1" />
   </QUERY>

   <!-- Stats for selected poll, used to infor voter about the poll and if user has voted or not -->
   <QUERY ID="poll_overview" FLAGS="1" KEY="00000000000000000000000000000003">
      <ATTRIBUTE NAME="OUTPUT-LIST">System,200</ATTRIBUTE>
      <FIELD ID="TPoll1PollK" ALIAS="ID" TABLE="TPoll1" />
      <FIELD ID="TPoll1FName" ALIAS="Namn" TABLE="TPoll1" 
             FORMAT="ISNULL( $T.FHeader, $T.FName )" FIELDFLAGNAMES="sql_format" />
      <FIELD ID="TPoll1FDescription" ALIAS="Description" TABLE="TPoll1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPoll1Note" ALIAS="Article" TABLE="TPoll1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPoll1CountQuestion" ALIAS="CountQuestion" TABLE="TPoll1" />
      <FIELD ID="TPoll1CountLink" ALIAS="CountLink" TABLE="TPoll1" />
      <FIELD ID="TPoll1CountMyVoterCount" ALIAS="MyCount" TABLE="TPoll1" />
      <FIELD ID="TPoll1CountIpVoterCount" ALIAS="IpCount" TABLE="TPoll1" />
      <FIELD ID="TPoll1CountPoll" ALIAS="CountPoll" TABLE="TPoll1" />
      <FIELD ID="TPoll1FUseTie" ALIAS="Tie" TABLE="TPoll1" />
      <FIELD ID="TPoll1PollGroupK-Id" ALIAS="GroupId" TABLE="TPoll1" />
      <FIELD ID="TPoll1CountCommentQuestion" ALIAS="CommentEnabled" TABLE="TPoll1" />
   </QUERY>

   <QUERY ID="poll_overview_related" FLAGS="1" KEY="0000000000000000000000000000000C">
      <FIELD ID="TrPollXPoll1rPollXPollK" ALIAS="ID" TABLE="TrPollXPoll1" />
      <FIELD ID="TrPollXPoll1ToPollK-Key" ALIAS="ID_To" TABLE="TrPollXPoll1" />
      <FIELD ID="TrPollXPoll1ToPollK" ALIAS="Name" TABLE="TrPollXPoll1" />
   </QUERY>
   
   <QUERY ID="poll_links" FLAGS="1" KEY="00000000000000000000000000000009">
      <ATTRIBUTE NAME="OUTPUT-LIST">System,200</ATTRIBUTE>
      <FIELD ID="TLink11020LinkK" ALIAS="ID" TABLE="TLink11020" />
      <FIELD ID="TLink11020FUrl" ALIAS="Link" TABLE="TLink11020" />
      <FIELD ID="TLink11020FName" ALIAS="Name" TABLE="TLink11020" />
      <FIELD ID="TLink11020FImage" ALIAS="Image" TABLE="TLink11020" />
      <FIELD ID="TLink11020TypeC" ALIAS="LinkType" TABLE="TLink11020" FORMAT="(SELECT c.type FROM $O{CODE}TCode c WHERE c.CodeK=$T.TypeC)" FIELDFLAGNAMES="sql_format" />
   </QUERY>
   
   <QUERY ID="poll_question_list" FLAGS="1" KEY="00000000000000000000000000000004">
      <ATTRIBUTE NAME="OUTPUT-LIST">System,200</ATTRIBUTE>
      <FIELD ID="TPollQuestion1PollQuestionK" ALIAS="ID" TABLE="TPollQuestion1" />
      <FIELD ID="TPollQuestion1FName" ALIAS="Name" TABLE="TPollQuestion1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollQuestion1FLabel" ALIAS="Label" TABLE="TPollQuestion1" />
      <FIELD ID="TPollQuestion1Min" ALIAS="Min" TABLE="TPollQuestion1" />
      <FIELD ID="TPollQuestion1Max" ALIAS="Max" TABLE="TPollQuestion1" />
      <FIELD ID="TPollQuestion1Comment" ALIAS="Comment" TABLE="TPollQuestion1" />
      <ORDER FIELD="TPollQuestion1PollQuestionK" SQL="$T.FOrder" />
      <ORDER FIELD="TPollQuestion1PollQuestionK" />
   </QUERY>

   <QUERY ID="poll_question" FLAGS="1" KEY="00000000000000000000000000000005">
      <ATTRIBUTE NAME="OUTPUT-LIST">System,200</ATTRIBUTE>
      <FIELD ID="TPollQuestion1PollQuestionK" ALIAS="ID (Question)" TABLE="TPollQuestion1"/>
      <FIELD ID="TPollAnswer1FName" ALIAS="Name" TABLE="TPollAnswer1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollAnswer1FDescription" ALIAS="Description" TABLE="TPollAnswer1" FIELDFLAGNAMES="edit" />
      <ORDER FIELD="TPollQuestion1PollQuestionK" SQL="$T.FOrder" />
      <ORDER FIELD="TPollQuestion1PollQuestionK" />
   </QUERY>   
   
   <!-- List answers in selected poll -->
   <QUERY ID="poll_answer" FLAGS="1" KEY="00000000000000000000000000000006">
      <ATTRIBUTE NAME="OUTPUT-LIST">System,200</ATTRIBUTE>
      <FIELD ID="TPollAnswer1PollQuestionK" ALIAS="ID (Question)" TABLE="TPollAnswer1"/>
      <FIELD ID="TPollAnswer1PollAnswerK" ALIAS="ID (Answer)" TABLE="TPollAnswer1"/>
      <FIELD ID="TPollAnswer1FName" ALIAS="Alternativ" TABLE="TPollAnswer1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollAnswer1FDescription" ALIAS="Beskrivning" TABLE="TPollAnswer1" FIELDFLAGNAMES="edit" />
   </QUERY>
   
   <!-- All answers for selected poll -->
   <QUERY ID="poll_answer_all" FLAGS="1" KEY="0000000000000000000000000000000D">
      <ATTRIBUTE NAME="OUTPUT-LIST">System,200</ATTRIBUTE>
      <FIELD ID="TPollAnswer1PollQuestionK" ALIAS="ID (Question)" TABLE="TPollAnswer1"/>
      <FIELD ID="TPollAnswer1PollAnswerK" ALIAS="ID (Answer)" TABLE="TPollAnswer1"/>
      <FIELD ID="TPollAnswer1FName" ALIAS="Alternativ" TABLE="TPollAnswer1" />
      <FIELD ID="TPollAnswer1FDescription" ALIAS="Beskrivning" TABLE="TPollAnswer1" />
      <ORDER FIELD="TPollAnswer1PollQuestionK" />
      <ORDER FIELD="TPollAnswer1PollFOrder" />
   </QUERY>
   

   <!-- When voter is voting this will register the vote in database -->
   <QUERY ID="poll_vote" FLAGS="1" KEY="00000000000000000000000000000007">
      <ATTRIBUTE NAME="OUTPUT-LIST">System,200</ATTRIBUTE>
      <FIELD ID="TPollVote1PollVoteK" ALIAS="ID (Vote)" TABLE="TPollVote1"/>
      <FIELD ID="TPollVote1PollQuestionK" ALIAS="ID (Question)" TABLE="TPollVote1"  />
      <FIELD ID="TPollVote1PollAnswerK" ALIAS="ID (Answer)" TABLE="TPollVote1" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="prepare" TYPENAME="begin">
            <SQL TYPENAME="variable"><EXPRESSION>
SELECT CONVERT( VARCHAR(50), CAST( NEWID() AS BINARY(16)), 1 ) AS uuid
            </EXPRESSION></SQL>
         </EDIT>
         
         <EDIT NAME="new_vote" TYPENAME="new_row" DESCRIPTION="Add new vote">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION CACHE="191a1af1-3584-421e-8043-1b63ebd57a0c"><![CDATA[
DECLARE @uuid uniqueidentifier = {{=uuid}}
DECLARE @iPoll BIGINT = {{=PollK}}
DECLARE @iVoter BIGINT = {{=VoterK}}
DECLARE @iPollAnswer BIGINT = {{=PollAnswerK}}
DECLARE @iPollQuestion BIGINT = (SELECT PollQuestionK FROM $O{VOTE}TPollAnswer WHERE PollAnswerK=@iPollAnswer)
DECLARE @iSelect INT = {{=FSelect}}
DECLARE @sIp VARCHAR(50) = '{#V user "@@ip"}'
DECLARE @sComment NVARCHAR(500) = {=FComment}

IF LEN( @sComment ) < 10
	SET @sComment = NULL

IF @iSelect IS NULL
   SET @iSelect = 1
   
INSERT INTO $O{VOTE}TPollVote (PollQuestionK, PollAnswerK, VoterK, FSelect, FIp, FComment, CreateD)
VALUES(@iPollQuestion,@iPollAnswer,@iVoter,@iSelect,@sIp,@sComment,GETDATE())

DECLARE @event UNIQUEIDENTIFIER = @uuid;
IF @event IS NOT NULL
BEGIN
   DECLARE @iPollVote BIGINT = (SELECT IDENT_CURRENT('$O{VOTE}TPollVote'));
   INSERT INTO $O{VOTE}tie VALUES( @iPollVote, @event )
   UPDATE $O{VOTE}TPollVote SET FTie=@event WHERE PollVoteK = @iPollVote
END   
            ]]></EXPRESSION>
            </SQL>
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   <!-- When voter is voting this will register the vote in database -->
   <QUERY ID="poll_vote_comment" FLAGS="1" KEY="0000000000000000000000000000000E">
      <FIELD ID="TPollVote1PollVoteK" ALIAS="ID" TABLE="TPollVote1"/>
      <FIELD ID="TPollVote1CreateD-Date" ALIAS="Date" TABLE="TPollVote1"/>
      <FIELD ID="TPollVote1FIp" ALIAS="Ip" TABLE="TPollVote1"/>
      <FIELD ID="PollAnswerK-FName" ALIAS="Answer" TABLE="TPollAnswer1" />
      <FIELD ID="TPollVote1FComment" ALIAS="Comment" TABLE="TPollVote1" />
      <CONDITION ID="TPollVote1FComment" TABLE="TPollVote1" CONDITIONFLAGNAMES="locked" OPERATORNAME="IS NOT NULL"></CONDITION>
      <ORDER INDEX="1" DESC="1" />
      <CONDITIONS ID="all" />
      <CONDITIONS ID="today">
         <CONDITION ID="TPollVote1CreateD" TABLE="TPollVote1" OPERATORNAME="EQUAL" SIMPLEVALUE="from" VALUE="1" EXPRESSION="(DATEDIFF(day,GETDATE(),[$T].[$F]) > -1)" CONDITIONFLAGNAMES="no_value" />
      </CONDITIONS>
      <CONDITIONS ID="week">
         <CONDITION ID="TPollVote1CreateD" TABLE="TPollVote1" OPERATORNAME="EQUAL" SIMPLEVALUE="from" VALUE="1" EXPRESSION="(DATEDIFF(day,GETDATE(),[$T].[$F]) > -7)" CONDITIONFLAGNAMES="no_value" />
      </CONDITIONS>
      <CONDITIONS ID="month">
         <CONDITION ID="TPollVote1CreateD" TABLE="TPollVote1" OPERATORNAME="EQUAL" SIMPLEVALUE="from" VALUE="1" EXPRESSION="(DATEDIFF(day,GETDATE(),[$T].[$F]) > -30)" CONDITIONFLAGNAMES="no_value" />
      </CONDITIONS>
      <ORDERS NAME="new">
         <ORDER FIELD="TPollVote1PollVoteK" INDEX="0" DESC="1" SQL="TPollVote1.CreateD" />
      </ORDERS>
      <ORDERS NAME="old">
         <ORDER FIELD="TPollVote1PollVoteK" INDEX="0" SQL="TPollVote1.CreateD" />
      </ORDERS>
   </QUERY>
   
   
   <!-- Calculate total number of votes for each answer -->
   <QUERY ID="poll_answer_count" FLAGS="1" KEY="00000000000000000000000000000008">
      <ATTRIBUTE NAME="OUTPUT-LIST">System,200</ATTRIBUTE>
      <FIELD ID="TPollAnswer1PollQuestionK" ALIAS="ID (Question)" TABLE="TPollAnswer1"/>
      <FIELD ID="TPollAnswer1PollAnswerK" ALIAS="ID_Answer" TABLE="TPollAnswer1"/>
      <FIELD ID="TPollAnswer1FName" ALIAS="Alternativ" TABLE="TPollAnswer1" />
      <FIELD ID="TPollAnswer1CountVote" ALIAS="Antal röster" TABLE="TPollAnswer1" />
      <ORDER FIELD="TPollAnswer1PollQuestionK" />
   </QUERY>
   
   <!-- Calculate total number of votes for each answer -->
   <QUERY ID="poll_answer_filtercount" FLAGS="1" KEY="0000000000000000000000000000000A">
      <ATTRIBUTE NAME="OUTPUT-LIST">System,200</ATTRIBUTE>
      <FIELD ID="TPollQuestion1PollQuestionK" ALIAS="ID" TABLE="TPollQuestion1" GROUPBY="1"/>
      <FIELD ID="TPollQuestion1FName" ALIAS="Question" TABLE="TPollQuestion1" GROUPBY="1" />
      <FIELD ID="TPollAnswer1FName" ALIAS="Answer" TABLE="TPollAnswer1" GROUPBY="1" />
      <FIELD ID="TPollVote1PollVoteK" ALIAS="Count" TABLE="TPollVote1" FORMAT="COUNT($T.$F)" FIELDFLAGNAMES="sql_format" />
      <ORDER FIELD="TPollQuestion1FName" />
      <ORDER FIELD="TPollVote1PollVoteK" DESC="1" />
   </QUERY>
   

   <QUERY ID="Svarsalternativ-ändra" TITLE="Svarsalternativ - Lägg till" FLAGS="1" KEY="C0B3033897E2CD4EA3395F98512DD495">
      <ATTRIBUTE NAME="OUTPUT-LIST">Ändra/Lägg till,100</ATTRIBUTE>
      <FIELD ID="TPollAnswer1PollAnswerK" ALIAS="ID (Answer)" TABLE="TPollAnswer1"/>
      <FIELD ID="TPollAnswer1FName" ALIAS="Name" TABLE="TPollAnswer1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollAnswer1FDescription" ALIAS="Description" TABLE="TPollAnswer1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollAnswer1FOrder" ALIAS="Order" TABLE="TPollAnswer1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollAnswer1TypeC" ALIAS="Type" TABLE="TPollAnswer1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollAnswer1FWeight" ALIAS="Weight" TABLE="TPollAnswer1" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="new_answer" SIMPLE="Answer" TYPENAME="new_row">
            <PROPERTY NAME="columns">PollAnswerK,FOrder</PROPERTY>
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
DECLARE @iPoll INT                  
DECLARE @iPollQuestionK INT = {{=PollQuestionK}};                  
IF @iPollQuestionK IS NOT NULL
   SET @iPoll = (SELECT PollK FROM $O{VOTE}TPollQuestion WHERE PollQuestionK=@iPollQuestionK)

INSERT INTO $O{VOTE}TPollAnswer(PollK,PollQuestionK,FName,FDescription,TypeC,FOrder,FWeight,CreateD,UpdateD) 
VALUES(@iPoll, @iPollQuestionK,{=FName"''"},{=FDescription},{=TypeC},{{=FOrder"0"}},{{=FWeight}},GETDATE(),GETDATE());
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$O{VOTE}TPollAnswer')">
               <EXPRESSION>
DECLARE @iAnswer BIGINT = (SELECT IDENT_CURRENT('$O{VOTE}TPollAnswer'));
SELECT @iAnswer, FOrder FROM $O{VOTE}TPollAnswer WHERE PollAnswerK = @iAnswer;
               </EXPRESSION>
            </SQL>
         </EDIT>
         <EDIT NAME="delete poll" SIMPLE="Radera proposition" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $O{VOTE}TPollAnswer WHERE PollAnswerK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   <QUERY ID="Konfigurera fråga" KEY="15669361EBFA44A4A5E5EFDE857E2BAD">
      <ATTRIBUTE NAME="OUTPUT-LIST">100</ATTRIBUTE>
      <FIELD ID="TPollLimit1PollLimitK" ALIAS="ID (Answer)" TABLE="TPollLimit1"/>
      <FIELD ID="TPollLimit1limit_type" ALIAS="Type" TABLE="TPollLimit1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollLimit1FLimitInteger" ALIAS="Integer" TABLE="TPollLimit1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollLimit1FDescription" ALIAS="Description" TABLE="TPollLimit1" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="new_limit" SIMPLE="Limit" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
DECLARE @iPollQuestionK BIGINT={{==PollQuestionK}};
DECLARE @iPoll BIGINT = (SELECT PollK FROM $O{VOTE}TPollQuestion WHERE PollQuestionK=@iPollQuestionK)

INSERT INTO $O{VOTE}TPollLimit(PollK,PollQuestionK,limit_type,FLimitInteger,FDescription) 
VALUES(@iPoll, @iPollQuestionK,{{==limit_type}},{{==FLimitInteger}},{=FDescription});
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$O{VOTE}TPollLimit')" />
         </EDIT>
         <EDIT NAME="delete limit" SIMPLE="Radera regel" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $O{VOTE}TPollLimit WHERE PollLimitK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   <QUERY ID="Poll: Edit links" DESCRIPTION="Object links" KEY="E2328BC89E074AE48D7E70895C9F36CE" FLAGNAMES="NOTLISTED">
      <ATTRIBUTE NAME="OUTPUT-TRUNCATE">[20,50,200]|50</ATTRIBUTE>
      <FIELD ID="LinkK" ALIAS="ID" TABLE="TLink11020"/>
      <FIELD ID="TypeC" ALIAS="Type" TABLE="TLink11020" FIELDFLAGNAMES="edit" />
      <FIELD ID="FUrl" ALIAS="Url" TABLE="TLink11020" FIELDFLAGNAMES="edit" />
      <FIELD ID="FName" ALIAS="Name" TABLE="TLink11020" FIELDFLAGNAMES="edit" />
      <FIELD ID="FDescription" ALIAS="Description" TABLE="TLink11020" FIELDFLAGNAMES="edit" />
      <FIELD ID="FImage" ALIAS="Image" TABLE="TLink11020" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="new_link" SIMPLE="Object link" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
DECLARE @iObject BIGINT = {{=PollK}}
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TPoll' AND "schema"='vote' );
INSERT INTO $OTLink(ParentK,table_number,TypeC,FUrl,FImage,FName,FDescription,CreateD,UpdateD)
VALUES(@iObject,@iTable,{=TypeC"0"},{=FUrl},{=FImage},{=FName},{=FDescription},GETDATE(),GETDATE())
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTLink')" />
         </EDIT>
         <EDIT NAME="delete link" SIMPLE="Delete link" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $OTLink WHERE LinkK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   
   <QUERY ID="login" KEY="00000000000000000000000000000001">
      <ATTRIBUTE NAME="OUTPUT-LIST">System,200</ATTRIBUTE>
      <FIELD ID="TVoter1VoterK" ALIAS="ID" TABLE="TVoter1"/>
      <FIELD ID="TVoter1FAlias" ALIAS="Användarnamn" TABLE="TVoter1"/>
      <FIELD ID="TVoter1FName" ALIAS="Namn" TABLE="TVoter1"/>
      <FIELD ID="TVoter1FMail" ALIAS="Mejladress" TABLE="TVoter1"/>
      
      <ROWEDIT>
         <EDIT NAME="new_voter" SIMPLE="Voter" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION><![CDATA[
DECLARE @iUser BIGINT = {#V user "@@user"}
DECLARE @sAlias NVARCHAR(100) = {=FAlias}
DECLARE @sMail NVARCHAR(100) = {=FMail}
IF @sAlias IS NULL OR LEN(@sAlias) < 3 OR LEN(@sAlias) > 30
   THROW 50000, '@@alias Alias value error', 1;
   
IF @sMail IS NULL OR LEN(@sMail) < 8 OR LEN(@sMail) > 90
   THROW 50000, '@@mail Mail error', 1;
   
DECLARE @sUnlock VARCHAR(10) = (SELECT RIGHT( '000000' + CAST( FLOOR( RAND() * 1000000 ) AS VARCHAR(10) ), 6 ) )   
   
INSERT INTO $O{VOTE}TVoter(UserK,FName,FAlias,FMail,FUnlock,CreateD,UpdateD) 
VALUES(@iUser,{=FName},{=FAlias},@sMail,@sUnlock,GETDATE(),GETDATE());
               ]]></EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$O{VOTE}TVoter')" />
         </EDIT>
         <EDIT NAME="delete poll" SIMPLE="Radera proposition" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $O{VOTE}TVoter WHERE VoterK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
   </QUERY>   

   <!-- Get voter key and Name -->
   <QUERY ID="find_voter" KEY="00000000000000000000000000000010">
      <ATTRIBUTE NAME="OUTPUT-LIST">System,200</ATTRIBUTE>
      <ATTRIBUTE NAME="LUA-GETRESULT"><![CDATA[
return function( g )
if g.on == 2 then
   local q = g.q
   local alias = q:GetCondition("FAlias"):GetValue()
   local iVoter = g.db:Ask("SELECT VoterK FROM $O{VOTE}TVoter WHERE FAlias='"..alias.."'");
   if type(iVoter) == "number" then
      g.user:SetVariable( "@@voter", iVoter );
   end
end   
end
      ]]></ATTRIBUTE>
      <FIELD ID="TVoter1VoterK" ALIAS="ID" TABLE="TVoter1"/>
      <FIELD ID="TVoter1FAlias" ALIAS="Alias" TABLE="TVoter1"/>
      <FIELD ID="TVoter1FName" ALIAS="Name" TABLE="TVoter1"/>
   </QUERY>   
   
   <!-- Query used to search for polls -->
   <QUERY ID="poll_search" FLAGS="8" KEY="0000000000000000000000000000000B">
      <ATTRIBUTE NAME="OUTPUT-LIST">System,200</ATTRIBUTE>
      <FIELD ID="TPoll1PollK" ALIAS="ID" TABLE="TPoll1" />
      <FIELD ID="TPoll1FName" ALIAS="Namn" TABLE="TPoll1" />
      <FIELD ID="TPoll1FDescription" ALIAS="Beskrivning" TABLE="TPoll1" />
      <FIELD ID="TPoll1FBegin" ALIAS="Start" TABLE="TPoll1" FORMAT="FORMAT($T.$F,'yyMMdd')" FIELDFLAGNAMES="sql_format" />
      <FIELD ID="TPoll1FEnd" ALIAS="Slut" TABLE="TPoll1" FORMAT="FORMAT($T.$F,'yyMMdd')" FIELDFLAGNAMES="sql_format" />
      <CONDITION ID="TPoll1FBegin" TABLE="TPoll1" OPERATORNAME="GREATEREQUAL" SIMPLEVALUE="from" VALUE="1" EXPRESSION="(GETDATE() &gt;= $T.$F)" CONDITIONFLAGNAMES="no_value" />
      <CONDITION ID="TPoll1FEnd" TABLE="TPoll1" OPERATORNAME="LESSEQUAL" SIMPLEVALUE="to" VALUE="1" EXPRESSION="(GETDATE() &lt;= $T.$F)" CONDITIONFLAGNAMES="no_value" />
      <CONDITION ID="TPoll1TypeC" TABLE="TPoll1" OPERATORNAME="LESSEQUAL" SIMPLEVALUE="Ja/Nej" VALUE="6381" />
      <CONDITIONS ID="all" />
      <CONDITIONS ID="yesno" SELECTED="1">
         <CONDITION ID="TPoll1FBegin" TABLE="TPoll1" OPERATORNAME="GREATEREQUAL" SIMPLEVALUE="from" VALUE="1" EXPRESSION="(GETDATE() &gt;= $T.$F)" CONDITIONFLAGNAMES="no_value" />
         <CONDITION ID="TPoll1FEnd" TABLE="TPoll1" OPERATORNAME="LESSEQUAL" SIMPLEVALUE="to" VALUE="1" EXPRESSION="(GETDATE() &lt;= $T.$F)" CONDITIONFLAGNAMES="no_value" />
         <CONDITION ID="TPoll1TypeC" TABLE="TPoll1" OPERATORNAME="LESSEQUAL" SIMPLEVALUE="Ja/Nej" VALUE="6381" />
      </CONDITIONS>
      <CONDITIONS ID="active">
         <CONDITION ID="TPoll1FBegin" TABLE="TPoll1" OPERATORNAME="GREATEREQUAL" SIMPLEVALUE="from" VALUE="1" EXPRESSION="(GETDATE() &gt;= $T.$F)" CONDITIONFLAGNAMES="no_value" />
         <CONDITION ID="TPoll1FEnd" TABLE="TPoll1" OPERATORNAME="LESSEQUAL" SIMPLEVALUE="to" VALUE="1" EXPRESSION="(GETDATE() &lt;= $T.$F)" CONDITIONFLAGNAMES="no_value" />
      </CONDITIONS>
      <ORDER FIELD="TPoll1FBegin" DESC="1" />

<!--      
      <CONDITIONS ID="Kommande">
         <CONDITION ID="TPoll1FBegin" TABLE="TPoll1" OPERATORNAME="GREATEREQUAL" SIMPLEVALUE="from" VALUE="1" EXPRESSION="(GETDATE() &lt; $T.$F)" CONDITIONFLAGNAMES="no_value" />
      </CONDITIONS>
-->      
   </QUERY>
   
   
   <!-- Calculate total number of votes for each answer -->
   <QUERY ID="poll_hashtags" FLAGS="8" KEY="00000000000000000000000000000011">
      <ATTRIBUTE NAME="OUTPUT-LIST">System,200</ATTRIBUTE>
      <FIELD ID="TrXBadge11020BadgeK" ALIAS="ID" TABLE="TrXBadge11020"/>
      <FIELD ID="TBadge11020FName" ALIAS="Name" TABLE="TBadge11020" />
      <CONDITION ID="TrXBadge11020table_number" TABLE="TrXBadge11020" OPERATOR="0" VALUE="11020" FLAGS="0"/>
   </QUERY>
   
</SELECTION>   
