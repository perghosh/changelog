<?xml version="1.0" encoding="utf-8"?>
<SELECTION  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../queries.xsd"
            TYPE="query" DESCRIPTION="Changelog queries">
   
   <QUERY ID="Motioner" DESCRIPTION="" KEY="91A3AA122FD8490DBF56E8885BDF358C">
      <ATTRIBUTE NAME="OUTPUT-LIST">Huvudfrågor,1</ATTRIBUTE>
      <FIELD ID="TPoll1PollK" ALIAS="ID" TABLE="TPoll1">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 25px;" />
      </FIELD>
      <FIELD ID="TPoll1FHeader" ALIAS="Rubrik" TABLE="TPoll1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPoll1FName" ALIAS="Namn" TABLE="TPoll1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPoll1FDescription" ALIAS="Beskrivning" TABLE="TPoll1" FIELDFLAGNAMES="edit">
         <EDIT>{"update":"$O{}PROCEDURE_UpdateBadge {=TPoll1FDescription}, 'vote.TPoll', ${@TPoll1PollK}","formula":"1"}</EDIT>         
      </FIELD>
      <FIELD ID="TPoll1FBegin" ALIAS="Startdatum" TABLE="TPoll1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-INPUT="date|YYYY-MM-DD HH:mm|24" />
      </FIELD>
      <FIELD ID="TPoll1FEnd" ALIAS="Slutdatum" TABLE="TPoll1" FIELDFLAGNAMES="edit">
         <ATTRIBUTES OUTPUT-INPUT="date|YYYY-MM-DD HH:mm|24" />
      </FIELD>
      <FIELD ID="TPoll1CountQuestion" ALIAS="Antal frågor" TABLE="TPoll1">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 25px;" />
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right;' class='mark_note'|/^[1-9]" />
      </FIELD>
      
      <ROWEDIT>
         <EDIT NAME="new_poll" SIMPLE="Pol" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
DECLARE @sName NVARCHAR(MAX) = {=FName};
DECLARE @sDescription NVARCHAR(MAX) = {=FDescription};
DECLARE @Start DATETIME = {=FStart}
DECLARE @End DATETIME = {=FEnd}
IF @Start IS NULL
   SET @Start = DATEADD(day,0,DATEDIFF(day,0,GETDATE()))

IF @End IS NULL
   SET @End = DATEADD(month,1,@Start)
   
INSERT INTO $O{VOTE}TPoll(FHeader,FName,FDescription,FBegin,FEnd,CreateD,UpdateD) 
VALUES({=FHeader},@sName,@sDescription,@Start,@End,GETDATE(),GETDATE());

DECLARE @iPoll BIGINT = (SELECT IDENT_CURRENT('$O{VOTE}TPoll'));
EXEC $OPROCEDURE_UpdateBadge @sDescription,'vote.TPoll', @iPoll

IF @sName IS NOT NULL
BEGIN
   INSERT INTO $O{VOTE}TPollQuestion(PollK,FName,CreateD,UpdateD) 
   VALUES(@iPoll,@sName,GETDATE(),GETDATE());
END
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$O{VOTE}TPoll')" />
         </EDIT>
         <EDIT NAME="delete poll" SIMPLE="Radera proposition" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $O{VOTE}TPoll WHERE PollK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE><![CDATA[ return function(g) local R, db, sE=g.result, g.db, g.result:GetParam("event");
if sE == "click" then
   local iKeyPressed = R:GetParam("pressed")
   local iColumn = R:GetParam("column")
   if iKeyPressed == 0 then
      if iColumn == 3 then
         R:SetValue('url','{"link": ["13304CE1144D43C292D7589C322863D0zoom"],"table":"TPoll1"}' )  return
      end
   else
      if iColumn == 3 then
         R:SetValue('url','{"title":"Valfrågor - Lägg till","link": ["5599795A83B546C6A8CA34197D87A047"],"table":"TPoll1"}' ) return
      end
   end
end
            
   R:SetValue('url','[' .. 
   '{"id": "query","title":"Valfrågor - Visa", "icon": "fa-align-justify", "table":"TPoll1", "link": ["13304CE1144D43C292D7589C322863D0zoom"]},' .. 
   '{"id": "query","title":"Valfrågor - Lägg till", "icon": "fa-edit", "table":"TPoll1", "link": ["5599795A83B546C6A8CA34197D87A047"]},' .. 
   '{"id": "add_link","title":"Länk: Lägg till", "icon": "fa-edit", "table":"TPoll1", "link": ["E2328BC89E074AE48D7E70895C9F36CE"]}' .. 
   ']') 
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
      <QUERYLINK TYPENAME="children" NAME="Fråga"  DESCRIPTION="Visa frågor" KEY="13304CE1144D43C292D7589C322863D0" QUERY="7DF3032022F64E52A6473C283575ACFF" EXPRESSION="SELECT PollK AS value, 'PollK' AS name, FName AS simple FROM $O{VOTE}TPoll WHERE PollK={{==TPoll1}}">
         <PROPERTIES OUTPUT-WIDTH="900" OUTPUT-HEIGHT="500" OUTPUT-POSITION="right-top|-50,0" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Fråga"  DESCRIPTION="Lägg till frågor" KEY="5599795A83B546C6A8CA34197D87A047" QUERY="358497254151814E8F9273212F0CE565" EXPRESSION="SELECT PollK AS value, 'PollK' AS name, FName AS simple FROM $O{VOTE}TPoll WHERE PollK={{==TPoll1}}">
         <PROPERTIES OUTPUT-WIDTH="900" OUTPUT-HEIGHT="400" OUTPUT-POSITION="left-top|10,60" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Add link"  DESCRIPTION="Add link" KEY="E2328BC89E074AE48D7E70895C9F36CE" EXPRESSION="SELECT PollK AS value, 'PollK' AS name, FName AS simple FROM $O{VOTE}TPoll WHERE PollK={{==TPoll1}}" />
   </QUERY>
   
   <QUERY ID="Frågor-visa" TITLE="Valfrågor - Visa" FLAGS="1" KEY="7DF3032022F64E52A6473C283575ACFF" DESCRIPTION="Listar frågor för motion">
      <ATTRIBUTE NAME="OUTPUT-LIST">Valfrågor,2</ATTRIBUTE>
      <FIELD ID="TPollQuestion1PollQuestionK" ALIAS="ID (Question)" TABLE="TPollQuestion1"/>
      <FIELD ID="TPollQuestion1PollK" ALIAS="Motion" TABLE="TPollQuestion1" />
      <FIELD ID="TPollQuestion1FName" ALIAS="Name" TABLE="TPollQuestion1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollQuestion1FDescription" ALIAS="Description" TABLE="TPollQuestion1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollQuestion1CountAnswer" ALIAS="Antal svar" TABLE="TPollQuestion1">
         <ATTRIBUTES OUTPUT-STYLE="column|max-width: 25px;" />
         <ATTRIBUTES OUTPUT-CELLSTYLE="style='text-align: right;' class='mark_note'|/^[1-9]" />
      </FIELD>
      <FIELD ID="TPollQuestion1TypeC" ALIAS="TypeC" TABLE="TPollQuestion1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollQuestion1StateC" ALIAS="StateC" TABLE="TPollQuestion1" FIELDFLAGNAMES="edit" />
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE><![CDATA[ return function(g) local R, db, sE=g.result, g.db, g.result:GetParam("event");
if sE == "click" then
   local iKeyPressed = R:GetParam("pressed")
   local iColumn = R:GetParam("column")
   if iKeyPressed == 0 then
      if iColumn == 4 then
         R:SetValue('url','{"link": ["5240B4EFCFFD47D29E43592FB488CA22zoom"],"table":"TPollQuestion1"}' )  return
      end
   else
      if iColumn == 4 then
         R:SetValue('url','{"title":"Svarsalternativ - ändra","link": ["70A70D58EE1048D2A174F5269E839616"],"table":"TPollQuestion1"}' ) return
      end
   end
end
            
   R:SetValue('url','[' .. 
   '{"id": "answer","title":"Svarsalternativ - visa", "icon": "fa-edit", "table":"TPollQuestion1", "link": ["5240B4EFCFFD47D29E43592FB488CA22zoom"]},' .. 
   '{"id": "answer","title":"Svarsalternativ - ändra", "icon": "fa-edit", "table":"TPollQuestion1", "link": ["70A70D58EE1048D2A174F5269E839616"]}' .. 
   ']') 
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
      <QUERYLINK TYPENAME="children" NAME="Fråga" DESCRIPTION="Svarsalternativ" KEY="5240B4EFCFFD47D29E43592FB488CA22" QUERY="80147C1CB4CC46ECAE4056BF9B2165D6" EXPRESSION="SELECT PollQuestionK AS value, 'PollQuestionK' AS name, FName AS simple FROM $O{VOTE}TPollQuestion WHERE PollQuestionK={{==TPollQuestion1}}">
         <PROPERTIES OUTPUT-WIDTH="800" OUTPUT-HEIGHT="500" OUTPUT-POSITION="right-top|0,150" />
      </QUERYLINK>
      <QUERYLINK TYPENAME="children" NAME="Fråga" DESCRIPTION="Svarsalternativ" KEY="70A70D58EE1048D2A174F5269E839616" QUERY="C0B3033897E2CD4EA3395F98512DD495" EXPRESSION="SELECT PollQuestionK AS value, 'PollQuestionK' AS name, FName AS simple FROM $O{VOTE}TPollQuestion WHERE PollQuestionK={{==TPollQuestion1}}">
         <PROPERTIES OUTPUT-WIDTH="700" OUTPUT-HEIGHT="500" OUTPUT-POSITION="right-bottom" />
      </QUERYLINK>
   </QUERY>
   
   
   <QUERY ID="Frågor-ändra" TITLE="Valfrågor - Lägg till" FLAGS="1" KEY="358497254151814E8F9273212F0CE565" DESCRIPTION="Editera frågor för motion">
      <ATTRIBUTE NAME="OUTPUT-LIST">Ändra/Lägg till,100</ATTRIBUTE>
      <FIELD ID="TPollQuestion1PollQuestionK" ALIAS="ID (Question)" TABLE="TPollQuestion1"/>
      <FIELD ID="TPollQuestion1FName" ALIAS="Name" TABLE="TPollQuestion1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollQuestion1FDescription" ALIAS="Description" TABLE="TPollQuestion1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollQuestion1TypeC" ALIAS="TypeC" TABLE="TPollQuestion1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollQuestion1StateC" ALIAS="StateC" TABLE="TPollQuestion1" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="new_question" SIMPLE="Fråga" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
DECLARE @iPoll INT = {{=PollK}};                  
INSERT INTO $O{VOTE}TPollQuestion(PollK,FName,FDescription,TypeC,StateC,CreateD,UpdateD) 
VALUES(@iPoll,{=FName"''"},{=FDescription},{=TypeC},{=StateC},GETDATE(),GETDATE());
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$O{VOTE}TPollQuestion')" />
         </EDIT>
         <EDIT NAME="delete poll" SIMPLE="Radera proposition" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $O{VOTE}TPollQuestion WHERE PollQuestionK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
      <SCRIPTS>
         <SCRIPT TYPENAME="action" NAME="RowCommand">
            <CODE><![CDATA[ return function(g) local R, db=g.result, g.db
   R:SetValue('url','[' .. 
   '{"id": "answer","title":"Svarsalternativ", "icon": "fa-edit", "table":"TPollQuestion1", "link": ["70A70D58EE1048D2A174F5269E839616"]}' .. 
   ']') 
end  ]]></CODE>
         </SCRIPT>
      </SCRIPTS>
      <QUERYLINK TYPENAME="children" NAME="Fråga" DESCRIPTION="Svarsalternativ" KEY="70A70D58EE1048D2A174F5269E839616" QUERY="C0B3033897E2CD4EA3395F98512DD495" EXPRESSION="SELECT PollQuestionK AS value, 'PollQuestionK' AS name, FName AS simple FROM $O{VOTE}TPollQuestion WHERE PollK={{==TPollQuestion1}}">
         <PROPERTIES OUTPUT-WIDTH="700" OUTPUT-HEIGHT="700" OUTPUT-POSITION="left-bottom" />
      </QUERYLINK>
   </QUERY>
   
   <QUERY ID="Svarsalternativ-visa" TITLE="Svarsalternativ - Visa" FLAGS="1" KEY="80147C1CB4CC46ECAE4056BF9B2165D6">
      <ATTRIBUTE NAME="OUTPUT-LIST">Valfrågor,2</ATTRIBUTE>
      <FIELD ID="TPollAnswer1PollAnswerK" ALIAS="ID (Answer)" TABLE="TPollAnswer1"/>
      <FIELD ID="TPollAnswer1FName" ALIAS="Name" TABLE="TPollAnswer1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollAnswer1FDescription" ALIAS="Description" TABLE="TPollAnswer1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollAnswer1TypeC" ALIAS="TypeC" TABLE="TPollAnswer1" FIELDFLAGNAMES="edit" />
   </QUERY>   
   
   <QUERY ID="poll_list" FLAGS="1" KEY="00000000000000000000000000000002" DESCRIPTION="List active polls for voter">
      <ATTRIBUTE NAME="OUTPUT-LIST">System,200</ATTRIBUTE>
      <FIELD ID="TPoll1PollK" ALIAS="ID" TABLE="TPoll1" />
      <FIELD ID="TPoll1FName" ALIAS="Namn" TABLE="TPoll1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPoll1FDescription" ALIAS="Beskrivning" TABLE="TPoll1" FIELDFLAGNAMES="edit" />
      <ORDER FIELD="TPoll1PollK" DESC="1" />
   </QUERY>

   <!-- Stats for selected poll, used to infor voter about the poll and if user has voted or not -->
   <QUERY ID="poll_overview" FLAGS="1" KEY="00000000000000000000000000000003">
      <ATTRIBUTE NAME="OUTPUT-LIST">System,200</ATTRIBUTE>
      <FIELD ID="TPoll1PollK" ALIAS="ID" TABLE="TPoll1" />
      <FIELD ID="TPoll1FName" ALIAS="Namn" TABLE="TPoll1" 
             FORMAT="ISNULL( $T.FHeader, $T.FName )" FIELDFLAGNAMES="sql_format" />
      <FIELD ID="TPoll1FDescription" ALIAS="Beskrivning" TABLE="TPoll1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPoll1CountQuestion" ALIAS="CountQuestion" TABLE="TPoll1" />
      <FIELD ID="TPoll1CountLink" ALIAS="CountLink" TABLE="TPoll1" />
      <FIELD ID="TPoll1CountMyVoterCount" ALIAS="MyCount" TABLE="TPoll1" />
      <FIELD ID="TPoll1CountIpVoterCount" ALIAS="IpCount" TABLE="TPoll1" />
   </QUERY>
   
   <QUERY ID="poll_links" FLAGS="1" KEY="00000000000000000000000000000009">
      <ATTRIBUTE NAME="OUTPUT-LIST">System,200</ATTRIBUTE>
      <FIELD ID="TLink11020LinkK" ALIAS="ID" TABLE="TLink11020" />
      <FIELD ID="TLink11020FUrl-Goto" ALIAS="Link" TABLE="TLink11020" />
      <FIELD ID="TLink11020FDescription" ALIAS="Description" TABLE="TLink11020" FIELDFLAGNAMES="edit" />
   </QUERY>
   

   <QUERY ID="poll_question_list" FLAGS="1" KEY="00000000000000000000000000000004">
      <ATTRIBUTE NAME="OUTPUT-LIST">System,200</ATTRIBUTE>
      <FIELD ID="TPollQuestion1PollQuestionK" ALIAS="ID" TABLE="TPollQuestion1" />
      <FIELD ID="TPollQuestion1FName" ALIAS="Name" TABLE="TPollQuestion1" FIELDFLAGNAMES="edit" />
   </QUERY>

   <QUERY ID="poll_question" FLAGS="1" KEY="00000000000000000000000000000005">
      <ATTRIBUTE NAME="OUTPUT-LIST">System,200</ATTRIBUTE>
      <FIELD ID="TPollQuestion1PollQuestionK" ALIAS="ID (Question)" TABLE="TPollQuestion1"/>
      <FIELD ID="TPollAnswer1FName" ALIAS="Name" TABLE="TPollAnswer1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollAnswer1FDescription" ALIAS="Description" TABLE="TPollAnswer1" FIELDFLAGNAMES="edit" />
   </QUERY>   
   
   <!-- List answers in selected poll -->
   <QUERY ID="poll_answer" FLAGS="1" KEY="00000000000000000000000000000006">
      <ATTRIBUTE NAME="OUTPUT-LIST">System,200</ATTRIBUTE>
      <FIELD ID="TPollAnswer1PollQuestionK" ALIAS="ID (Question)" TABLE="TPollAnswer1"/>
      <FIELD ID="TPollAnswer1PollAnswerK" ALIAS="ID (Answer)" TABLE="TPollAnswer1"/>
      <FIELD ID="TPollAnswer1FName" ALIAS="Alternativ" TABLE="TPollAnswer1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollAnswer1FDescription" ALIAS="Beskrivning" TABLE="TPollAnswer1" FIELDFLAGNAMES="edit" />
   </QUERY>

   <!-- When voter is voting this will register the vote in database -->
   <QUERY ID="poll_vote" FLAGS="1" KEY="00000000000000000000000000000007">
      <ATTRIBUTE NAME="OUTPUT-LIST">System,200</ATTRIBUTE>
      <FIELD ID="TPollVote1PollVoteK" ALIAS="ID (Vote)" TABLE="TPollVote1"/>
      <FIELD ID="TPollVote1PollQuestionK" ALIAS="ID (Question)" TABLE="TPollVote1"  />
      <FIELD ID="TPollVote1PollAnswerK" ALIAS="ID (Answer)" TABLE="TPollVote1" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="new_vote" TYPENAME="begin" DESCRIPTION="Add new vote">
            <SQL TYPENAME="insert">
               <EXPRESSION><![CDATA[
DROP TABLE IF EXISTS #event;            
CREATE TABLE #event(v UNIQUEIDENTIFIER)
INSERT INTO #event VALUES(NEWID())
            ]]></EXPRESSION>
            </SQL>
         </EDIT>
         
         <EDIT NAME="new_vote" TYPENAME="new_row" DESCRIPTION="Add new vote">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION><![CDATA[
DECLARE @iPoll BIGINT = {{=PollK}}
DECLARE @iVoter BIGINT = {{=VoterK}}
DECLARE @iPollAnswer BIGINT = {{=PollAnswerK}}
DECLARE @iPollQuestion BIGINT = (SELECT PollQuestionK FROM $O{VOTE}TPollAnswer WHERE PollAnswerK=@iPollAnswer)
DECLARE @iSelect INT = {{=FSelect}}

IF @iSelect IS NULL
   SET @iSelect = 1
   
IF @iVoter IS NOT NULL
BEGIN
   IF (SELECT COUNT(*) FROM $O{VOTE}TPollVote WHERE VoterK=@iVoter AND PollQuestionK IN(SELECT PollQuestionK FROM $O{VOTE}TPollAnswer WHERE PollK=@iPoll) ) > 0
      THROW 50001, 'Voter can not vote more than once', 1;
END

INSERT INTO $O{VOTE}TPollVote (PollQuestionK, PollAnswerK, VoterK, FSelect, FIp, CreateD)
VALUES(@iPollQuestion,@iPollAnswer,@iVoter,@iSelect,'{#V user "@@ip"}',GETDATE())

DECLARE @event UNIQUEIDENTIFIER = (SELECT TOP 1 v FROM #event);
DECLARE @iPollVote BIGINT = (SELECT IDENT_CURRENT('$O{VOTE}TPollVote'));
INSERT INTO $O{VOTE}tie VALUES( @iPollVote, @event )
UPDATE $O{VOTE}TPollVote SET FTie=@event WHERE PollVoteK = @iPollVote
            ]]></EXPRESSION>
            </SQL>
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   <!-- Calculate total number of votes for each answer -->
   <QUERY ID="poll_answer_count" FLAGS="1" KEY="00000000000000000000000000000008">
      <ATTRIBUTE NAME="OUTPUT-LIST">System,200</ATTRIBUTE>
      <FIELD ID="TPollAnswer1PollQuestionK" ALIAS="ID (Question)" TABLE="TPollAnswer1"/>
      <FIELD ID="TPollAnswer1PollAnswerK" ALIAS="ID_Answer" TABLE="TPollAnswer1"/>
      <FIELD ID="TPollAnswer1FName" ALIAS="Alternativ" TABLE="TPollAnswer1" />
      <FIELD ID="TPollAnswer1CountVote" ALIAS="Antal röster" TABLE="TPollAnswer1" />
   </QUERY>
   
   <!-- Calculate total number of votes for each answer -->
   <QUERY ID="poll_answer_filtercount" FLAGS="1" KEY="0000000000000000000000000000000A">
      <ATTRIBUTE NAME="OUTPUT-LIST">System,200</ATTRIBUTE>
      <FIELD ID="TPollQuestion1PollQuestionK" ALIAS="ID" TABLE="TPollQuestion1" GROUPBY="1"/>
      <FIELD ID="TPollQuestion1FName" ALIAS="Question" TABLE="TPollQuestion1" GROUPBY="1" />
      <FIELD ID="TPollAnswer1FName" ALIAS="Answer" TABLE="TPollAnswer1" GROUPBY="1" />
      <FIELD ID="TPollVote1PollVoteK" ALIAS="Count" TABLE="TPollVote1" FORMAT="COUNT($T.$F)" FIELDFLAGNAMES="sql_format" />
      <ORDER FIELD="TPollQuestion1FName" />
      <ORDER FIELD="TPollVote1PollVoteK" DESC="1" />
   </QUERY>
   

   <QUERY ID="Svarsalternativ-ändra" TITLE="Svarsalternativ - Lägg till" FLAGS="1" KEY="C0B3033897E2CD4EA3395F98512DD495">
      <ATTRIBUTE NAME="OUTPUT-LIST">Ändra/Lägg till,100</ATTRIBUTE>
      <FIELD ID="TPollAnswer1PollAnswerK" ALIAS="ID (Answer)" TABLE="TPollAnswer1"/>
      <FIELD ID="TPollAnswer1FName" ALIAS="Name" TABLE="TPollAnswer1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollAnswer1FDescription" ALIAS="Description" TABLE="TPollAnswer1" FIELDFLAGNAMES="edit" />
      <FIELD ID="TPollAnswer1TypeC" ALIAS="TypeC" TABLE="TPollAnswer1" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="new_answer" SIMPLE="Answer" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
DECLARE @iPoll INT                  
DECLARE @iPollQuestionK INT = {{=PollQuestionK}};                  
IF @iPollQuestionK IS NOT NULL
   SET @iPoll = (SELECT PollK FROM $O{VOTE}TPollQuestion WHERE PollQuestionK=@iPollQuestionK)

INSERT INTO $O{VOTE}TPollAnswer(PollK,PollQuestionK,FName,FDescription,TypeC,CreateD,UpdateD) 
VALUES(@iPoll, @iPollQuestionK,{=FName"''"},{=FDescription},{=TypeC},GETDATE(),GETDATE());
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$O{VOTE}TPollAnswer')" />
         </EDIT>
         <EDIT NAME="delete poll" SIMPLE="Radera proposition" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $O{VOTE}TPollAnswer WHERE PollAnswerK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   <QUERY ID="Poll: Edit links" DESCRIPTION="Object links" KEY="E2328BC89E074AE48D7E70895C9F36CE" FLAGNAMES="NOTLISTED">
      <ATTRIBUTE NAME="OUTPUT-TRUNCATE">[20,50,200]|50</ATTRIBUTE>
      <FIELD ID="LinkK" ALIAS="ID" TABLE="TLink11020"/>
      <FIELD ID="TypeC" ALIAS="Type" TABLE="TLink11020" FIELDFLAGNAMES="edit" />
      <FIELD ID="FUrl" ALIAS="Url" TABLE="TLink11020" FIELDFLAGNAMES="edit" />
      <FIELD ID="FName" ALIAS="Name" TABLE="TLink11020" FIELDFLAGNAMES="edit" />
      <FIELD ID="FDescription" ALIAS="Description" TABLE="TLink11020" FIELDFLAGNAMES="edit" />
      <ROWEDIT>
         <EDIT NAME="new_link" SIMPLE="Object link" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION>
DECLARE @iObject BIGINT = {{=PollK}}
DECLARE @iTable INT = (SELECT number FROM $Otable_number WHERE "name" = 'TPoll' AND "schema"='vote' );
INSERT INTO $OTLink(ParentK,table_number,TypeC,FUrl,FName,FDescription,CreateD,UpdateD)
VALUES(@iObject,@iTable,{=TypeC"0"},{=FUrl},{=FName},{=FDescription},GETDATE(),GETDATE())
               </EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$OTLink')" />
         </EDIT>
         <EDIT NAME="delete link" SIMPLE="Delete link" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $OTLink WHERE LinkK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
   </QUERY>
   
   
   <QUERY ID="login" KEY="00000000000000000000000000000001">
      <ATTRIBUTE NAME="OUTPUT-LIST">System,200</ATTRIBUTE>
      <FIELD ID="TVoter1VoterK" ALIAS="ID" TABLE="TVoter1"/>
      <FIELD ID="TVoter1FAlias" ALIAS="Användarnamn" TABLE="TVoter1"/>
      <FIELD ID="TVoter1FName" ALIAS="Namn" TABLE="TVoter1"/>
      <FIELD ID="TVoter1FMail" ALIAS="Mejladress" TABLE="TVoter1"/>
      <ROWEDIT>
         <EDIT NAME="new_voter" SIMPLE="Voter" TYPENAME="new_row">
            <SQL TYPENAME="insert" COMMAND="insert-row">
               <EXPRESSION><![CDATA[
DECLARE @iUser BIGINT = {#V user "@@user"}
DECLARE @sAlias NVARCHAR(100) = {=FAlias}
IF @sAlias IS NULL OR LEN(@sAlias) < 3 OR LEN(@sAlias) > 30
   THROW 50000, 'Alias value error', 1;
INSERT INTO $O{VOTE}TVoter(UserK,FName,FAlias,FMail,CreateD,UpdateD) 
VALUES(@iUser,{=FName},{=FAlias},{=FMail},GETDATE(),GETDATE());
               ]]></EXPRESSION>
            </SQL>
            <SQL TYPENAME="select" COMMAND="select-key" EXPRESSION="SELECT IDENT_CURRENT('$O{VOTE}TVoter')" />
         </EDIT>
         <EDIT NAME="delete poll" SIMPLE="Radera proposition" TYPENAME="delete_row">
            <SQL TYPENAME="delete" COMMAND="delete-row" EXPRESSION='DELETE FROM $O{VOTE}TVoter WHERE VoterK={{=[0]}}' />
         </EDIT>
      </ROWEDIT>
   </QUERY>   

   <!-- Get voter key and Name -->
   <QUERY ID="find_voter" KEY="00000000000000000000000000000010">
      <ATTRIBUTE NAME="OUTPUT-LIST">System,200</ATTRIBUTE>
      <ATTRIBUTE NAME="LUA-GETRESULT"><![CDATA[
return function( g )
if g.on == 2 then
   local q = g.q
   local alias = q:GetCondition("FAlias"):GetValue()
   local iVoter = g.db:Ask("SELECT VoterK FROM $O{VOTE}TVoter WHERE FAlias='"..alias.."'");
   if type(iVoter) == "number" then
      g.user:SetVariable( "@@voter", iVoter );
   end
end   
end
      ]]></ATTRIBUTE>
      <FIELD ID="TVoter1VoterK" ALIAS="ID" TABLE="TVoter1"/>
      <FIELD ID="TVoter1FAlias" ALIAS="Alias" TABLE="TVoter1"/>
      <FIELD ID="TVoter1FName" ALIAS="Name" TABLE="TVoter1"/>
   </QUERY>   
   
   <!-- Calculate total number of votes for each answer -->
   <QUERY ID="poll_search" FLAGS="8" KEY="0000000000000000000000000000000B">
      <ATTRIBUTE NAME="OUTPUT-LIST">System,200</ATTRIBUTE>
      <FIELD ID="TPoll1PollK" ALIAS="ID" TABLE="TPoll1" />
      <FIELD ID="TPoll1FName" ALIAS="Namn" TABLE="TPoll1" />
      <FIELD ID="TPoll1FDescription" ALIAS="Beskrivning" TABLE="TPoll1" />
      <FIELD ID="TPoll1FBegin" ALIAS="Start" TABLE="TPoll1" FORMAT="FORMAT($T.$F,'yyMMdd')" FIELDFLAGNAMES="sql_format" />
      <FIELD ID="TPoll1FEnd" ALIAS="Slut" TABLE="TPoll1" FORMAT="FORMAT($T.$F,'yyMMdd')" FIELDFLAGNAMES="sql_format" />
      <CONDITIONS ID="Alla" SELECTED="1" />
      <CONDITIONS ID="Aktiva omröstningar">
         <CONDITION ID="TPoll1FBegin" TABLE="TPoll1" OPERATORNAME="GREATEREQUAL" SIMPLEVALUE="from" VALUE="1" EXPRESSION="(GETDATE() &gt;= $T.$F)" CONDITIONFLAGNAMES="no_value" />
         <CONDITION ID="TPoll1FEnd" TABLE="TPoll1" OPERATORNAME="LESSEQUAL" SIMPLEVALUE="to" VALUE="1" EXPRESSION="(GETDATE() &lt;= $T.$F)" CONDITIONFLAGNAMES="no_value" />
      </CONDITIONS>
      <CONDITIONS ID="Kommande">
         <CONDITION ID="TPoll1FBegin" TABLE="TPoll1" OPERATORNAME="GREATEREQUAL" SIMPLEVALUE="from" VALUE="1" EXPRESSION="(GETDATE() &lt; $T.$F)" CONDITIONFLAGNAMES="no_value" />
      </CONDITIONS>
   </QUERY>
   
   
   <!-- Calculate total number of votes for each answer -->
   <QUERY ID="poll_hashtags" FLAGS="8" KEY="00000000000000000000000000000011">
      <ATTRIBUTE NAME="OUTPUT-LIST">System,200</ATTRIBUTE>
      <FIELD ID="TrXBadge11020BadgeK" ALIAS="ID" TABLE="TrXBadge11020"/>
      <FIELD ID="TBadge11020FName" ALIAS="Name" TABLE="TBadge11020" />
      <CONDITION ID="TrXBadge11020table_number" TABLE="TrXBadge11020" OPERATOR="0" VALUE="11020" FLAGS="0"/>
   </QUERY>
   
</SELECTION>   
